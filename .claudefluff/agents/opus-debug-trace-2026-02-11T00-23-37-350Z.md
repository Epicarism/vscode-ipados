# Agent: opus-debug-trace
**Status:** done
**Tokens:** 14,972
**Cost:** $0.0000
**Time:** 2026-02-11T00:23:37.351Z

## Task
CRITICAL: Create a debug theory. If textView(_:textColorFor:) returns blue for keywords but everything shows red, WHERE does the color get lost? Search for any color transformation, theme application, or default color fallback in both app code and Runestone library.

## Response
I'll investigate where the color might get lost between the delegate returning blue and the actual rendering. Let me search for color transformation points.

>>>TOOL search
{"query": "textColorFor", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "color.*highlight.*token", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "defaultTextColor", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "foregroundColor", "glob": "*.swift"}
>>>END

Let me search more broadly for how syntax highlighting and colors work in this codebase.

>>>TOOL search
{"query": "HighlightName", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "theme.*color", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "textColor", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "Runestone", "glob": "*.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[search]
No matches found for "HighlightName"

---

[search]
No matches found for "theme.*color"

---

[search]
No matches found for "textColor"

---

[search]
No matches found for "Runestone"


Let me explore the codebase structure first.

>>>TOOL list_dir
{"path": "."}
>>>END

>>>TOOL search
{"query": "syntax", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "highlight", "glob": "*.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[list_dir]
ðŸ“ ./
ðŸ“ .claude/
ðŸ“ .claudefluff/
ðŸ“ .garbage/
ðŸ“ .patch-backups/
ðŸ“ .vscode/
ðŸ“ Docs/
ðŸ“ Extensions/
ðŸ“ logs/
ðŸ“ Models/
ðŸ“ Services/
ðŸ“ test-results/
ðŸ“ Tests/
ðŸ“ Views/
ðŸ“ VSCodeiPadOS/
ðŸ“ VSCodeiPadOSUITests/
   .gitignore
   build.log
   FULL_FEATURE_TEST_PLAN.md
   idb_testing_report.md
   LICENSE
   README.md
   StressTest.swift
   test_editor_typing.sh
   update.md
   VSCodeiPadOS_idb_test_plan.sh
   VSCodeiPadOS_Ui_Element_Coordinates.md
(cached)

---

[search]
No matches found for "syntax"

---

[search]
No matches found for "highlight"


>>>TOOL list_dir
{"path": "Views"}
>>>END

>>>TOOL list_dir
{"path": "Services"}
>>>END

>>>TOOL list_dir
{"path": "VSCodeiPadOS"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[list_dir]
ðŸ“ Views/
ðŸ“ Editor/
ðŸ“ Panels/

---

[list_dir]
ðŸ“ Services/
ðŸ“ OnDevice/

---

[list_dir]
ðŸ“ VSCodeiPadOS/
ðŸ“ .garbage/
ðŸ“ Docs/
ðŸ“ Views/
ðŸ“ VSCodeiPadOS/
ðŸ“ VSCodeiPadOS.xcodeproj/
ðŸ“ VSCodeiPadOSTests/
   bugs.md
   build_output.log
   build_output2.log
   build.log
   FeatureFlags.swift
   Info.plist
   Package.swift
   TreeSitterLanguages.swift
   TypingLagTest.swift


>>>TOOL list_dir
{"path": "Views/Editor"}
>>>END

>>>TOOL read_file
{"path": "VSCodeiPadOS/TreeSitterLanguages.swift"}
>>>END

>>>TOOL list_dir
{"path": "VSCodeiPadOS/Views"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[list_dir]
ðŸ“ Views/Editor/
   (empty directory)

---

[read_file]
File: VSCodeiPadOS/TreeSitterLanguages.swift (lines 1-342 of 342)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1: //
2: //  TreeSitterLanguages.swift
3: //  VSCodeiPadOS
4: //
5: //  Created on 2025-01-31.
6: //
7: 
8: import Foundation
9: 
10: // TODO: Uncomment these imports as TreeSitter Swift packages become available
11: // import TreeSitterSwift
12: // import TreeSitterJavaScript
13: // import TreeSitterTypeScript
14: // import TreeSitterPython
15: // import TreeSitterJSON
16: // import TreeSitterHTML
17: // import TreeSitterCSS
18: // import TreeSitterMarkdown
19: // import TreeSitterGo
20: // import TreeSitterRust
21: // import TreeSitterRuby
22: // import TreeSitterJava
23: // import TreeSitterC
24: // import TreeSitterCPP
25: // import TreeSitterBash
26: // import TreeSitterYAML
27: // import TreeSitterSQL
28: //
29: // TODO: Additional languages from the current implementation:
30: // import TreeSitterKotlin        // For kt, kts files
31: // import TreeSitterObjectiveC     // For m, mm files
32: // import TreeSitterSCSS           // For scss, sass files
33: // import TreeSitterLess           // For less files
34: // import TreeSitterXML            // For xml, plist, svg files
35: // import TreeSitterGraphQL        // For graphql, gql files
36: // import TreeSitterPHP            // For php files
37: 
38: /// Provides language modes for syntax highlighting based on file extensions.
39: /// This struct maps file extensions and special filenames to their appropriate
40: /// TreeSitter language modes for syntax highlighting.
41: public struct TreeSitterLanguages {
42:     
43:     /// Returns the appropriate language mode for a given filename.
44:     /// - Parameter filename: The filename (with or without path) to analyze
45:     /// - Returns: A LanguageMode instance for the detected language, or PlainTextLanguageMode() if unknown
46:     public static func languageMode(for filename: String) -> LanguageMode {
47:         let lower = filename.lowercased()
48:         let ext = (filename as NSString).pathExtension.lowercased()
49:         
50:         // Special-case filenames without extensions
51:         let lastComponent = (filename as NSString).lastPathComponent.lowercased()
52:         if lastComponent == "dockerfile" || lastComponent == "dockerfile.*" {
53:             // Dockerfile is typically bash-like, could use TreeSitterBash when available
54:             return bashLanguageMode() // or PlainTextLanguageMode()
55:         }
56:         if lastComponent == ".env" || lower.hasSuffix("/.env") {
57:             return PlainTextLanguageMode()
58:         }
59:         
60:         switch ext {
61:         // Swift
62:         case "swift":
63:             return swiftLanguageMode()
64:         
65:         // JavaScript
66:         case "js", "mjs", "cjs":
67:             return javaScriptLanguageMode()
68:         case "jsx":
69:             // JSX typically uses JavaScript grammar with JSX extensions
70:             return javaScriptLanguageMode()
71:         
72:         // TypeScript
73:         case "ts", "mts", "cts":
74:             return typeScriptLanguageMode()
75:         case "tsx":
76:             // TSX typically uses TypeScript grammar with JSX extensions
77:             return typeScriptLanguageMode()
78:         
79:         // Python
80:         case "py", "pyw":
81:             return pythonLanguageMode()
82:         
83:         // Ruby
84:         case "rb", "ruby":
85:             return rubyLanguageMode()
86:         
87:         // Go
88:         case "go":
89:             return goLanguageMode()
90:         
91:         // Rust
92:         case "rs":
93:             return rustLanguageMode()
94:         
95:         // Java
96:         case "java":
97:             return javaLanguageMode()
98:         
99:         // Kotlin (TODO: may not have Swift package yet)
100:         case "kt", "kts":
101:             return kotlinLanguageMode()
102:         
103:         // C
104:         case "c", "h":
105:             return cLanguageMode()
106:         
107:         // C++
108:         case "cpp", "cc", "cxx", "hpp", "hh", "hxx":
109:             return cppLanguageMode()
110:         
111:         // Objective-C (TODO: may not have Swift package yet)
112:         case "m", "mm":
113:             return objectiveCLanguageMode()
114:         
115:         // HTML
116:         case "html", "htm":
117:             return htmlLanguageMode()
118:         
119:         // CSS
120:         case "css":
121:             return cssLanguageMode()
122:         
123:         // SCSS/SASS (TODO: may not have Swift package yet)
124:         case "scss", "sass":
125:             return scssLanguageMode()
126:         
127:         // Less (TODO: may not have Swift package yet)
128:         case "less":
129:             return lessLanguageMode()
130:         
131:         // JSON
132:         case "json", "jsonc":
133:             return jsonLanguageMode()
134:         
135:         // XML (TODO: may not have Swift package yet)
136:         case "xml", "plist", "svg":
137:             return xmlLanguageMode()
138:         
139:         // YAML
140:         case "yml", "yaml":
141:             return yamlLanguageMode()
142:         
143:         // SQL
144:         case "sql":
145:             return sqlLanguageMode()
146:         
147:         // Shell scripts
148:         case "sh", "bash", "zsh", "fish":
149:             return bashLanguageMode()
150:         
151:         // Dockerfile (when it has an extension)
152:         case "dockerfile":
153:             return bashLanguageMode() // or PlainTextLanguageMode()
154:         
155:         // GraphQL (TODO: may not have Swift package yet)
156:         case "graphql", "gql":
157:             return graphqlLanguageMode()
158:         
159:         // Markdown
160:         case "md", "markdown":
161:             return markdownLanguageMode()
162:         
163:         // PHP (TODO: may not have Swift package yet)
164:         case "php":
165:             return phpLanguageMode()
166:         
167:         // Environment files
168:         case "env":
169:             return PlainTextLanguageMode()
170:         
171:         default:
172:             return PlainTextLanguageMode()
173:         }
174:     }
175:     
176:     // MARK: - Language Mode Factory Methods
177:     
178:     private static func swiftLanguageMode() -> LanguageMode {
179:         // TODO: Return TreeSitterSwift() when package is available
180:         // return TreeSitterSwift()
181:         return PlainTextLanguageMode()
182:     }
183:     
184:     private static func javaScriptLanguageMode() -> LanguageMode {
185:         // TODO: Return TreeSitterJavaScript() when package is available
186:         // return TreeSitterJavaScript()
187:         return PlainTextLanguageMode()
188:     }
189:     
190:     private static func typeScriptLanguageMode() -> LanguageMode {
191:         // TODO: Return TreeSitterTypeScript() when package is available
192:         // return TreeSitterTypeScript()
193:         return PlainTextLanguageMode()
194:     }
195:     
196:     private static func pythonLanguageMode() -> LanguageMode {
197:         // TODO: Return TreeSitterPython() when package is available
198:         // return TreeSitterPython()
199:         return PlainTextLanguageMode()
200:     }
201:     
202:     private static func jsonLanguageMode() -> LanguageMode {
203:         // TODO: Return TreeSitterJSON() when package is available
204:         // return TreeSitterJSON()
205:         return PlainTextLanguageMode()
206:     }
207:     
208:     private static func htmlLanguageMode() -> LanguageMode {
209:         // TODO: Return TreeSitterHTML() when package is available
210:         // return TreeSitterHTML()
211:         return PlainTextLanguageMode()
212:     }
213:     
214:     private static func cssLanguageMode() -> LanguageMode {
215:         // TODO: Return TreeSitterCSS() when package is available
216:         // return TreeSitterCSS()
217:         return PlainTextLanguageMode()
218:     }
219:     
220:     private static func markdownLanguageMode() -> LanguageMode {
221:         // TODO: Return TreeSitterMarkdown() when package is available
222:         // return TreeSitterMarkdown()
223:         return PlainTextLanguageMode()
224:     }
225:     
226:     private static func goLanguageMode() -> LanguageMode {
227:         // TODO: Return TreeSitterGo() when package is available
228:         // return TreeSitterGo()
229:         return PlainTextLanguageMode()
230:     }
231:     
232:     private static func rustLanguageMode() -> LanguageMode {
233:         // TODO: Return TreeSitterRust() when package is available
234:         // return TreeSitterRust()
235:         return PlainTextLanguageMode()
236:     }
237:     
238:     private static func rubyLanguageMode() -> LanguageMode {
239:         // TODO: Return TreeSitterRuby() when package is available
240:         // return TreeSitterRuby()
241:         return PlainTextLanguageMode()
242:     }
243:     
244:     private static func javaLanguageMode() -> LanguageMode {
245:         // TODO: Return TreeSitterJava() when package is available
246:         // return TreeSitterJava()
247:         return PlainTextLanguageMode()
248:     }
249:     
250:     private static func cLanguageMode() -> LanguageMode {
251:         // TODO: Return TreeSitterC() when package is available
252:         // return TreeSitterC()
253:         return PlainTextLanguageMode()
254:     }
255:     
256:     private static func cppLanguageMode() -> LanguageMode {
257:         // TODO: Return TreeSitterCPP() when package is available
258:         // return TreeSitterCPP()
259:         return PlainTextLanguageMode()
260:     }
261:     
262:     private static func bashLanguageMode() -> LanguageMode {
263:         // TODO: Return TreeSitterBash() when package is available
264:         // return TreeSitterBash()
265:         return PlainTextLanguageMode()
266:     }
267:     
268:     private static func yamlLanguageMode() -> LanguageMode {
269:         // TODO: Return TreeSitterYAML() when package is available
270:         // return TreeSitterYAML()
271:         return PlainTextLanguageMode()
272:     }
273:     
274:     private static func sqlLanguageMode() -> LanguageMode {
275:         // TODO: Return TreeSitterSQL() when package is available
276:         // return TreeSitterSQL()
277:         return PlainTextLanguageMode()
278:     }
279:     
280:     // MARK: - Additional Language Factory Methods
281:     
282:     private static func kotlinLanguageMode() -> LanguageMode {
283:         // TODO: Return TreeSitterKotlin() when package is available
284:         return PlainTextLanguageMode()
285:     }
286:     
287:     private static func objectiveCLanguageMode() -> LanguageMode {
288:         // TODO: Return TreeSitterObjectiveC() when package is available
289:         return PlainTextLanguageMode()
290:     }
291:     
292:     private static func scssLanguageMode() -> LanguageMode {
293:         // TODO: Return TreeSitterSCSS() when package is available
294:         return PlainTextLanguageMode()
295:     }
296:     
297:     private static func lessLanguageMode() -> LanguageMode {
298:         // TODO: Return TreeSitterLess() when package is available
299:         return PlainTextLanguageMode()
300:     }
301:     
302:     private static func xmlLanguageMode() -> LanguageMode {
303:         // TODO: Return TreeSitterXML() when package is available
304:         return PlainTextLanguageMode()
305:     }
306:     
307:     private static func graphqlLanguageMode() -> LanguageMode {
308:         // TODO: Return TreeSitterGraphQL() when package is available
309:         return PlainTextLanguageMode()
310:     }
311:     
312:     private static func phpLanguageMode() -> LanguageMode {
313:         // TODO: Return TreeSitterPHP() when package is available
314:         return PlainTextLanguageMode()
315:     }
316: }
317: 
318: // MARK: - LanguageMode Protocol
319: 
320: /// Protocol that all TreeSitter language modes must conform to.
321: /// This will be implemented by each TreeSitter language wrapper.
322: public protocol LanguageMode {
323:     /// The name of the language
324:     var name: String { get }
325:     
326:     /// The file extensions associated with this language
327:     var extensions: [String] { get }
328:     
329:     /// Create a new language mode instance
330:     init()
331: }
332: 
333: // MARK: - Plain Text Language Mode
334: 
335: /// Fallback language mode for files without specific syntax highlighting.
336: public struct PlainTextLanguageMode: LanguageMode {
337:     public let name = "Plain Text"
338:     public let extensions: [String] = []
339:     
340:     public init() {}
341: }
342: 

---

[list_dir]
ðŸ“ VSCodeiPadOS/Views/
ðŸ“ Editor/


>>>TOOL list_dir
{"path": "VSCodeiPadOS/Views/Editor"}
>>>END

>>>TOOL search
{"query": "TextView", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "UIColor", "glob": "*.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[list_dir]
ðŸ“ VSCodeiPadOS/Views/Editor/
   (empty directory)

---

[search]
No matches found for "TextView"

---

[search]
No matches found for "UIColor"


>>>TOOL search
{"query": "editor", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "CodeEditor", "glob": "*.swift"}
>>>END

>>>TOOL list_dir
{"path": "VSCodeiPadOS/VSCodeiPadOS"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[search]
Found 2 matches:
StressTest.swift:1: // StressTest.swift - Large file for editor performance testing
StressTest.swift:522: // This file should be sufficient for stress testing the editor

---

[search]
No matches found for "CodeEditor"

---

[list_dir]
ðŸ“ VSCodeiPadOS/VSCodeiPadOS/
ðŸ“ App/
ðŸ“ Assets.xcassets/
ðŸ“ Commands/
ðŸ“ Docs/
ðŸ“ Extensions/
ðŸ“ Menus.bak/
ðŸ“ Models/
ðŸ“ Resources/
ðŸ“ Services/
ðŸ“ Tests/
ðŸ“ UITests/
ðŸ“ Utils/
ðŸ“ Views/
   .tooling_note.txt
   ContentView_shift_arrow.patch
   ContentView.swift
   ContentView.swift.bak
   FIX_SUMMARY.md
   IMPLEMENTATION_SUMMARY.md
   Info.plist
   KEYBOARD_SHORTCUTS_SOURCE_OF_TRUTH.md
   KeyboardShortcuts.md
   MULTI_WINDOW_IMPLEMENTATION.md
   MultiWindowSupport.md
   SceneDelegate.swift
   SyntaxHighlighter_Optimizations.md


>>>TOOL list_dir
{"path": "VSCodeiPadOS/VSCodeiPadOS/Views"}
>>>END

>>>TOOL read_file
{"path": "VSCodeiPadOS/VSCodeiPadOS/ContentView.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[list_dir]
ðŸ“ VSCodeiPadOS/VSCodeiPadOS/Views/
ðŸ“ Editor/
ðŸ“ Panels/
   _tmp.txt
   BranchMenu.swift
   CommandPalette.swift
   CommandPaletteView.swift
   DiffComponents.swift
   FileIconView.swift
   FileTreeView.swift
   GoToSymbol.swift
   LaunchConfigView.swift
   QuickOpen.swift
   RunConfigView.swift
   SidebarView.swift
   SnippetPickerView.swift
   StatusBarView.swift
   TabBarView.swift
   TasksView.swift
   WorkspaceSettingsView.swift
   WorkspaceTrustDialog.swift

---

[read_file]
File: VSCodeiPadOS/VSCodeiPadOS/ContentView.swift (lines 1-1122 of 1122)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1: import SwiftUI
2: import UIKit
3: import UniformTypeIdentifiers
4: 
5: // MARK: - Helper Functions
6: // Moved to Extensions/FileHelpers.swift
7: 
8: // MARK: - Main Content View
9: 
10: struct ContentView: View {
11:     @EnvironmentObject var editorCore: EditorCore
12:     @StateObject private var fileNavigator = FileSystemNavigator()
13:     @StateObject private var themeManager = ThemeManager.shared
14:     
15:     @State private var showingDocumentPicker = false
16:     @State private var showingFolderPicker = false
17:     @State private var showSettings = false
18:     @State private var showTerminal = false
19:     @State private var terminalHeight: CGFloat = 200
20:     @State private var selectedSidebarTab = 0
21:     @State private var pendingTrustURL: URL?
22:     @State private var windowTitle: String = "VS Code"
23:     
24:     @StateObject private var trustManager = WorkspaceTrustManager.shared
25:     
26:     private var theme: Theme { themeManager.currentTheme }
27:     
28:     var body: some View {
29:         ZStack {
30:             VStack(spacing: 0) {
31:                 HStack(spacing: 0) {
32:                     IDEActivityBar(editorCore: editorCore, selectedTab: $selectedSidebarTab, showSettings: $showSettings, showTerminal: $showTerminal)
33:                     
34:                     if editorCore.showSidebar {
35:                         sidebarContent.frame(width: editorCore.sidebarWidth)
36:                     }
37:                     
38:                     VStack(spacing: 0) {
39:                         IDETabBar(editorCore: editorCore, theme: theme)
40:                         
41:                         if let tab = editorCore.activeTab {
42:                             IDEEditorView(editorCore: editorCore, tab: tab, theme: theme)
43:                                 .id(tab.id)  // Force view recreation when tab changes
44:                         } else {
45:                             IDEWelcomeView(editorCore: editorCore, showFolderPicker: $showingFolderPicker, theme: theme)
46:                         }
47:                         
48:                         StatusBarView(editorCore: editorCore)
49:                     }
50:                 }
51:                 
52:                 if showTerminal {
53:                     PanelView(isVisible: $showTerminal, height: $terminalHeight)
54:                 }
55:             }
56:             .background(theme.editorBackground)
57:             
58:             // Overlays - Command Palette (Cmd+Shift+P)
59:             if editorCore.showCommandPalette {
60:                 Color.black.opacity(0.4).ignoresSafeArea().onTapGesture { editorCore.showCommandPalette = false }
61:                 CommandPaletteView(editorCore: editorCore, showSettings: $showSettings, showTerminal: $showTerminal)
62:             }
63:             
64:             // Quick Open (Cmd+P)
65:             if editorCore.showQuickOpen {
66:                 Color.black.opacity(0.4).ignoresSafeArea().onTapGesture { editorCore.showQuickOpen = false }
67:                 QuickOpenView(editorCore: editorCore, fileNavigator: fileNavigator)
68:             }
69:             
70:             // Go To Symbol (Cmd+Shift+O)
71:             if editorCore.showGoToSymbol {
72:                 Color.black.opacity(0.4).ignoresSafeArea().onTapGesture { editorCore.showGoToSymbol = false }
73:                 GoToSymbolView(editorCore: editorCore, onGoToLine: { _ in })
74:             }
75:             
76:             // AI Assistant
77:             if editorCore.showAIAssistant {
78:                 HStack { Spacer(); AIAssistantView(editorCore: editorCore).frame(width: 400, height: 500).padding() }
79:             }
80:             
81:             // Go To Line (Ctrl+G)
82:             if editorCore.showGoToLine {
83:                 Color.black.opacity(0.4).ignoresSafeArea().onTapGesture { editorCore.showGoToLine = false }
84:                 GoToLineView(isPresented: $editorCore.showGoToLine, onGoToLine: { _ in })
85:             }
86:             
87:             // Workspace Trust Dialog
88:             if let trustURL = pendingTrustURL {
89:                 Color.black.opacity(0.4).ignoresSafeArea()
90:                 WorkspaceTrustDialog(workspaceURL: trustURL, onTrust: {
91:                     trustManager.trust(url: trustURL)
92:                     finishOpeningWorkspace(trustURL)
93:                     pendingTrustURL = nil
94:                 }, onCancel: {
95:                     pendingTrustURL = nil
96:                 })
97:             }
98:         }
99:         .sheet(isPresented: $showingDocumentPicker) { IDEDocumentPicker(editorCore: editorCore) }
100:         .sheet(isPresented: $showingFolderPicker) {
101:             IDEFolderPicker(fileNavigator: fileNavigator) { url in
102:                 if trustManager.isTrusted(url: url) {
103:                     finishOpeningWorkspace(url)
104:                 } else {
105:                     pendingTrustURL = url
106:                 }
107:             }
108:         }
109:         .sheet(isPresented: $showSettings) { SettingsView(themeManager: themeManager) }
110:         .onChange(of: editorCore.showFilePicker) { show in showingDocumentPicker = show }
111:         .onChange(of: editorCore.activeTab?.fileName) { newFileName in
112:             updateWindowTitle()
113:         }
114:         .onChange(of: editorCore.tabs.count) { _ in
115:             updateWindowTitle()
116:         }
117:         .onChange(of: editorCore.activeTabId) { _ in
118:             updateWindowTitle()
119:         }
120:         .onChange(of: editorCore.activeTab?.isUnsaved) { _ in
121:             updateWindowTitle()
122:         }
123:         .onAppear {
124:             // Wire up EditorCore -> FileSystemNavigator so save operations can route through it.
125:             editorCore.fileNavigator = fileNavigator
126:             updateWindowTitle()
127:         }
128:         // MARK: - Notification Handlers for Menu Keyboard Shortcuts
129:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("ShowCommandPalette"))) { _ in
130:             editorCore.showCommandPalette = true
131:         }
132:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("ToggleTerminal"))) { _ in
133:             showTerminal.toggle()
134:         }
135:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("ToggleSidebar"))) { _ in
136:             editorCore.toggleSidebar()
137:         }
138:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("ShowQuickOpen"))) { _ in
139:             editorCore.showQuickOpen = true
140:         }
141:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("ShowGoToSymbol"))) { _ in
142:             editorCore.showGoToSymbol = true
143:         }
144:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("ShowGoToLine"))) { _ in
145:             editorCore.showGoToLine = true
146:         }
147:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("ShowAIAssistant"))) { _ in
148:             editorCore.showAIAssistant = true
149:         }
150:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("NewFile"))) { _ in
151:             editorCore.addTab()
152:         }
153:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("SaveFile"))) { _ in
154:             editorCore.saveActiveTab()
155:         }
156:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("CloseTab"))) { _ in
157:             if let id = editorCore.activeTabId { editorCore.closeTab(id: id) }
158:         }
159:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("ShowFind"))) { _ in
160:             editorCore.showSearch = true
161:         }
162:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("ZoomIn"))) { _ in
163:             editorCore.zoomIn()
164:         }
165:         .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("ZoomOut"))) { _ in
166:             editorCore.zoomOut()
167:         }
168:         .environmentObject(themeManager)
169:         .environmentObject(editorCore)
170:     }
171:     
172:     private func finishOpeningWorkspace(_ url: URL) {
173:         fileNavigator.loadFileTree(at: url)
174:         Task { @MainActor in
175:             LaunchManager.shared.setWorkspaceRoot(url)
176:             GitManager.shared.setWorkingDirectory(url)
177:         }
178:     }
179:     
180:     private func updateWindowTitle() {
181:         if let activeTab = editorCore.activeTab {
182:             let fileName = activeTab.fileName
183:             let unsavedIndicator = activeTab.isUnsaved ? "â— " : ""
184:             windowTitle = "\(unsavedIndicator)\(fileName) - VS Code"
185:         } else if !editorCore.tabs.isEmpty {
186:             windowTitle = "VS Code"
187:         } else {
188:             windowTitle = "Welcome - VS Code"
189:         }
190:         
191:         // Notify the app of the title change
192:         NotificationCenter.default.post(
193:             name: NSNotification.Name("WindowTitleDidChange"),
194:             object: nil,
195:             userInfo: ["title": windowTitle]
196:         )
197:     }
198:     
199:     @ViewBuilder
200:     private var sidebarContent: some View {
201:         switch selectedSidebarTab {
202:         case 0:
203:             IDESidebarFiles(editorCore: editorCore, fileNavigator: fileNavigator, showFolderPicker: $showingFolderPicker, theme: theme)
204:         case 1:
205:             SidebarSearchView(theme: theme)
206:         case 2:
207:             GitView()
208:         case 3:
209:             DebugView()
210:         default:
211:             IDESidebarFiles(editorCore: editorCore, fileNavigator: fileNavigator, showFolderPicker: $showingFolderPicker, theme: theme)
212:         }
213:     }
214: }
215: 
216: // MARK: - Activity Bar
217: 
218: 
219: 
220: struct BarButton: View {
221:     let icon: String
222:     let isSelected: Bool
223:     let theme: Theme
224:     let action: () -> Void
225:     
226:     var body: some View {
227:         Button(action: action) {
228:             Image(systemName: icon)
229:                 .font(.system(size: 22))
230:                 .foregroundColor(isSelected ? theme.activityBarSelection : theme.activityBarForeground.opacity(0.6))
231:                 .frame(width: 48, height: 48)
232:         }
233:     }
234: }
235: 
236: // MARK: - Sidebar with Real File System
237: 
238: struct IDESidebarFiles: View {
239:     @ObservedObject var editorCore: EditorCore
240:     @ObservedObject var fileNavigator: FileSystemNavigator
241:     @Binding var showFolderPicker: Bool
242:     let theme: Theme
243:     
244:     var body: some View {
245:         VStack(alignment: .leading, spacing: 0) {
246:             HStack {
247:                 Text("EXPLORER").font(.caption).fontWeight(.semibold).foregroundColor(theme.sidebarForeground.opacity(0.7))
248:                 Spacer()
249:                 Button(action: { showFolderPicker = true }) {
250:                     Image(systemName: "folder.badge.plus").font(.caption)
251:                 }.foregroundColor(theme.sidebarForeground.opacity(0.7))
252:                 Button(action: { editorCore.showFilePicker = true }) {
253:                     Image(systemName: "doc.badge.plus").font(.caption)
254:                 }.foregroundColor(theme.sidebarForeground.opacity(0.7))
255:                 if fileNavigator.fileTree != nil {
256:                     Button(action: { fileNavigator.refreshFileTree() }) {
257:                         Image(systemName: "arrow.clockwise").font(.caption)
258:                     }.foregroundColor(theme.sidebarForeground.opacity(0.7))
259:                 }
260:             }.padding(.horizontal, 12).padding(.vertical, 8)
261:             
262:             ScrollView {
263:                 VStack(alignment: .leading, spacing: 2) {
264:                     if let tree = fileNavigator.fileTree {
265:                         FileTreeView(root: tree, fileNavigator: fileNavigator, editorCore: editorCore)
266:                     } else {
267:                         DemoFileTree(editorCore: editorCore, theme: theme)
268:                     }
269:                 }.padding(.horizontal, 8)
270:             }
271:         }.background(theme.sidebarBackground)
272:     }
273: }
274: 
275: struct RealFileTreeView: View {
276:     let node: FileTreeNode
277:     let level: Int
278:     @ObservedObject var fileNavigator: FileSystemNavigator
279:     @ObservedObject var editorCore: EditorCore
280:     let theme: Theme
281:     
282:     var isExpanded: Bool { fileNavigator.expandedPaths.contains(node.url.path) }
283:     
284:     var body: some View {
285:         VStack(alignment: .leading, spacing: 2) {
286:             HStack(spacing: 4) {
287:                 if node.isDirectory {
288:                     Image(systemName: isExpanded ? "chevron.down" : "chevron.right")
289:                         .font(.caption2).frame(width: 12)
290:                         .foregroundColor(theme.sidebarForeground.opacity(0.6))
291:                         .onTapGesture { fileNavigator.toggleExpanded(path: node.url.path) }
292:                 } else {
293:                     Spacer().frame(width: 12)
294:                 }
295:                 Image(systemName: node.isDirectory ? "folder.fill" : fileIcon(for: node.name))
296:                     .font(.caption)
297:                     .foregroundColor(node.isDirectory ? .yellow : fileColor(for: node.name))
298:                 Text(node.name).font(.system(.caption)).lineLimit(1)
299:                     .foregroundColor(theme.sidebarForeground)
300:                 Spacer()
301:             }
302:             .padding(.leading, CGFloat(level * 16)).padding(.vertical, 4)
303:             .contentShape(Rectangle())
304:             .onTapGesture {
305:                 if node.isDirectory {
306:                     fileNavigator.toggleExpanded(path: node.url.path)
307:                 } else {
308:                     editorCore.openFile(from: node.url)
309:                 }
310:             }
311:             
312:             if isExpanded && node.isDirectory {
313:                 ForEach(node.children) { child in
314:                     RealFileTreeView(node: child, level: level + 1, fileNavigator: fileNavigator, editorCore: editorCore, theme: theme)
315:                 }
316:             }
317:         }
318:     }
319: }
320: 
321: struct DemoFileTree: View {
322:     @ObservedObject var editorCore: EditorCore
323:     let theme: Theme
324:     
325:     var body: some View {
326:         VStack(alignment: .leading, spacing: 4) {
327:             Text("Open a folder to browse files")
328:                 .font(.caption)
329:                 .foregroundColor(theme.sidebarForeground.opacity(0.6))
330:                 .padding(.vertical, 8)
331:             
332:             DemoFileRow(name: "main.swift", editorCore: editorCore, theme: theme)
333:             DemoFileRow(name: "ContentView.swift", editorCore: editorCore, theme: theme)
334:             DemoFileRow(name: "README.md", editorCore: editorCore, theme: theme)
335:         }
336:     }
337: }
338: 
339: struct DemoFileRow: View {
340:     let name: String
341:     @ObservedObject var editorCore: EditorCore
342:     let theme: Theme
343:     
344:     var body: some View {
345:         HStack(spacing: 4) {
346:             Spacer().frame(width: 12)
347:             Image(systemName: fileIcon(for: name)).font(.caption).foregroundColor(fileColor(for: name))
348:             Text(name).font(.system(.caption)).lineLimit(1).foregroundColor(theme.sidebarForeground)
349:             Spacer()
350:         }
351:         .padding(.vertical, 4)
352:         .contentShape(Rectangle())
353:         .onTapGesture {
354:             editorCore.addTab(fileName: name, content: "// \(name)\n\n")
355:         }
356:     }
357: }
358: 
359: // MARK: - Tab Bar
360: 
361: struct IDETabBar: View {
362:     @ObservedObject var editorCore: EditorCore
363:     let theme: Theme
364:     
365:     var body: some View {
366:         ScrollView(.horizontal, showsIndicators: false) {
367:             HStack(spacing: 0) {
368:                 ForEach(editorCore.tabs) { tab in
369:                     IDETabItem(tab: tab, isSelected: editorCore.activeTabId == tab.id, editorCore: editorCore, theme: theme)
370:                 }
371:                 Button(action: { editorCore.addTab() }) {
372:                     Image(systemName: "plus").font(.caption).foregroundColor(theme.tabInactiveForeground).padding(8)
373:                 }
374:             }.padding(.horizontal, 4)
375:         }.frame(height: 36).background(theme.tabBarBackground)
376:     }
377: }
378: 
379: struct IDETabItem: View {
380:     let tab: Tab
381:     let isSelected: Bool
382:     @ObservedObject var editorCore: EditorCore
383:     let theme: Theme
384:     
385:     var body: some View {
386:         HStack(spacing: 6) {
387:             Image(systemName: fileIcon(for: tab.fileName)).font(.caption).foregroundColor(fileColor(for: tab.fileName))
388:             Text(tab.fileName).font(.system(size: 12)).lineLimit(1)
389:                 .foregroundColor(isSelected ? theme.tabActiveForeground : theme.tabInactiveForeground)
390:             if tab.isUnsaved { Circle().fill(Color.orange).frame(width: 6, height: 6) }
391:             Button(action: { editorCore.closeTab(id: tab.id) }) {
392:                 Image(systemName: "xmark").font(.system(size: 9, weight: .medium))
393:                     .foregroundColor(isSelected ? theme.tabActiveForeground.opacity(0.6) : theme.tabInactiveForeground)
394:             }
395:         }
396:         .padding(.horizontal, 12).padding(.vertical, 6)
397:         .background(RoundedRectangle(cornerRadius: 4).fill(isSelected ? theme.tabActiveBackground : theme.tabInactiveBackground))
398:         .onTapGesture { editorCore.selectTab(id: tab.id) }
399:     }
400: }
401: 
402: // MARK: - Editor with Syntax Highlighting + Autocomplete + Folding
403: 
404: struct IDEEditorView: View {
405:     @ObservedObject var editorCore: EditorCore
406:     let tab: Tab
407:     let theme: Theme
408:     
409:     /// Feature flag for Runestone editor - uses centralized FeatureFlags
410:     private var useRunestoneEditor: Bool { FeatureFlags.useRunestoneEditor }
411: 
412:     @AppStorage("lineNumbersStyle") private var lineNumbersStyle: String = "on"
413:     @State private var text: String = ""
414:     @State private var scrollPosition: Int = 0
415:     @State private var scrollOffset: CGFloat = 0
416:     @State private var totalLines: Int = 1
417:     @State private var visibleLines: Int = 20
418:     @State private var currentLineNumber: Int = 1
419:     @State private var currentColumn: Int = 1
420:     @State private var cursorIndex: Int = 0
421:     @State private var lineHeight: CGFloat = 17
422:     @State private var requestedCursorIndex: Int? = nil
423:     @State private var requestedLineSelection: Int? = nil
424: 
425:     @StateObject private var autocomplete = AutocompleteManager()
426:     @State private var showAutocomplete = false
427:     @ObservedObject private var foldingManager = CodeFoldingManager.shared
428:     @StateObject private var findViewModel = FindViewModel()
429:     
430:     var body: some View {
431:         VStack(spacing: 0) {
432:             // Find/Replace bar
433:             if editorCore.showSearch {
434:                 FindReplaceView(viewModel: findViewModel)
435:                     .background(theme.tabBarBackground)
436:             }
437:             
438:             BreadcrumbsView(editorCore: editorCore, tab: tab)
439:             
440:             GeometryReader { geometry in
441:                 ZStack(alignment: .topLeading) {
442:                 HStack(spacing: 0) {
443:                     // Only show custom line numbers for legacy editor (Runestone has built-in line numbers)
444:                     if lineNumbersStyle != "off" && !useRunestoneEditor {
445:                         LineNumbersWithFolding(
446:                             fileId: tab.url?.path ?? tab.fileName,
447:                             totalLines: totalLines,
448:                             currentLine: currentLineNumber,
449:                             scrollOffset: scrollOffset,
450:                             lineHeight: lineHeight,
451:                             requestedLineSelection: $requestedLineSelection,
452:                             foldingManager: foldingManager,
453:                             theme: theme
454:                         )
455:                         .frame(width: 60)
456:                         .background(theme.sidebarBackground.opacity(0.5))
457:                     }
458:                     
459:                     // Use Runestone for all files including JSON (has TreeSitter JSON support)
460:                     if false && tab.fileName.hasSuffix(".json") {
461:                         // JSON Tree View disabled - using Runestone editor instead
462:                         JSONTreeView(data: text.data(using: .utf8) ?? Data())
463:                             .frame(maxWidth: .infinity, maxHeight: .infinity)
464:                             .background(theme.editorBackground)
465:                     } else {
466:                         // Use Runestone for O(log n) performance, or legacy view as fallback
467:                         Group {
468:                             if useRunestoneEditor {
469:                                 RunestoneEditorView(
470:                                     text: $text,
471:                                     filename: tab.fileName,
472:                                     scrollOffset: $scrollOffset,
473:                                     totalLines: $totalLines,
474:                                     currentLineNumber: $currentLineNumber,
475:                                     currentColumn: $currentColumn,
476:                                     cursorIndex: $cursorIndex,
477:                                     isActive: true,
478:                                     fontSize: editorCore.editorFontSize,
479:                                     onAcceptAutocomplete: {
480:                                         guard showAutocomplete else { return false }
481:                                         var tempText = text
482:                                         var tempCursor = cursorIndex
483:                                         autocomplete.commitCurrentSuggestion(into: &tempText, cursorPosition: &tempCursor)
484:                                         if tempText != text {
485:                                             text = tempText
486:                                             cursorIndex = tempCursor
487:                                             requestedCursorIndex = tempCursor
488:                                             showAutocomplete = false
489:                                             return true
490:                                         }
491:                                         return false
492:                                     },
493:                                     onDismissAutocomplete: {
494:                                         guard showAutocomplete else { return false }
495:                                         autocomplete.hideSuggestions()
496:                                         showAutocomplete = false
497:                                         return true
498:                                     }
499:                                 )
500:                             } else {
501:                                 // Legacy SyntaxHighlightingTextView (fallback)
502:                                 SyntaxHighlightingTextView(
503:                                     text: $text,
504:                                     filename: tab.fileName,
505:                                     scrollPosition: $scrollPosition,
506:                                     scrollOffset: $scrollOffset,
507:                                     totalLines: $totalLines,
508:                                     visibleLines: $visibleLines,
509:                                     currentLineNumber: $currentLineNumber,
510:                                     currentColumn: $currentColumn,
511:                                     cursorIndex: $cursorIndex,
512:                                     lineHeight: $lineHeight,
513:                                     isActive: true,
514:                                     fontSize: editorCore.editorFontSize,
515:                                     requestedLineSelection: $requestedLineSelection,
516:                                     requestedCursorIndex: $requestedCursorIndex,
517:                                     onAcceptAutocomplete: {
518:                                         guard showAutocomplete else { return false }
519:                                         var tempText = text
520:                                         var tempCursor = cursorIndex
521:                                         autocomplete.commitCurrentSuggestion(into: &tempText, cursorPosition: &tempCursor)
522:                                         if tempText != text {
523:                                             text = tempText
524:                                             cursorIndex = tempCursor
525:                                             requestedCursorIndex = tempCursor
526:                                             showAutocomplete = false
527:                                             return true
528:                                         }
529:                                         return false
530:                                     },
531:                                     onDismissAutocomplete: {
532:                                         guard showAutocomplete else { return false }
533:                                         autocomplete.hideSuggestions()
534:                                         showAutocomplete = false
535:                                         return true
536:                                     }
537:                                 )
538:                             }
539:                         }
540:                         .onChange(of: text) { newValue in
541:                             editorCore.updateActiveTabContent(newValue)
542:                             editorCore.cursorPosition = CursorPosition(line: currentLineNumber, column: currentColumn)
543:                             autocomplete.updateSuggestions(for: newValue, cursorPosition: cursorIndex)
544:                             showAutocomplete = autocomplete.showSuggestions
545:                             foldingManager.detectFoldableRegions(in: newValue, filePath: tab.url?.path ?? tab.fileName)
546:                         }
547:                         .onChange(of: cursorIndex) { newCursor in
548:                             autocomplete.updateSuggestions(for: text, cursorPosition: newCursor)
549:                             showAutocomplete = autocomplete.showSuggestions
550:                         }
551:                     }
552:                     
553:                     if !tab.fileName.hasSuffix(".json") {
554:                         MinimapView(
555:                             content: text,
556:                             scrollOffset: scrollOffset,
557:                             scrollViewHeight: geometry.size.height,
558:                             totalContentHeight: CGFloat(totalLines) * lineHeight,
559:                             onScrollRequested: { newOffset in
560:                                 // Minimap requested scroll - update editor position
561:                                 scrollOffset = newOffset
562:                                 // Convert back from pixels to line number
563:                                 let newLine = Int(newOffset / max(lineHeight, 1))
564:                                 scrollPosition = max(0, min(newLine, totalLines - 1))
565:                             }
566:                         )
567:                         .frame(width: 80)
568:                     }
569:                 }
570:                 .background(theme.editorBackground)
571: 
572:                 // Sticky Header Overlay (FEAT-040)
573:                 StickyHeaderView(
574:                     text: text,
575:                     currentLine: scrollPosition,
576:                     theme: theme,
577:                     lineHeight: lineHeight,
578:                     onSelect: { line in
579:                         requestedLineSelection = line
580:                     }
581:                 )
582:                 .padding(.leading, (lineNumbersStyle != "off" && !useRunestoneEditor) ? 60 : 0)
583:                 .padding(.trailing, tab.fileName.hasSuffix(".json") ? 0 : 80)
584: 
585:                 if showAutocomplete && !autocomplete.suggestionItems.isEmpty {
586:                     AutocompletePopup(
587:                         suggestions: autocomplete.suggestionItems,
588:                         selectedIndex: autocomplete.selectedIndex,
589:                         theme: theme
590:                     ) { index in
591:                         autocomplete.selectedIndex = index
592:                         var tempText = text
593:                         var tempCursor = cursorIndex
594:                         autocomplete.commitCurrentSuggestion(into: &tempText, cursorPosition: &tempCursor)
595:                         if tempText != text {
596:                             text = tempText
597:                             cursorIndex = tempCursor
598:                             requestedCursorIndex = tempCursor
599:                         }
600:                         showAutocomplete = false
601:                     }
602:                     .offset(x: 70, y: CGFloat(currentLineNumber) * lineHeight)
603:                 }
604:             }
605:         }
606:         }
607:         .onAppear {
608:             text = tab.content
609:             foldingManager.detectFoldableRegions(in: text, filePath: tab.url?.path ?? tab.fileName)
610:         }
611:         .onChange(of: tab.id) { _ in
612:             text = tab.content
613:             foldingManager.detectFoldableRegions(in: text, filePath: tab.url?.path ?? tab.fileName)
614:         }
615:         .onChange(of: currentLineNumber) { line in
616:             editorCore.cursorPosition = CursorPosition(line: line, column: currentColumn)
617:         }
618:         .onChange(of: currentColumn) { col in
619:             editorCore.cursorPosition = CursorPosition(line: currentLineNumber, column: col)
620:         }
621:         .onAppear {
622:             findViewModel.editorCore = editorCore
623:         }
624:     }
625:     
626:     // Autocomplete insertion is handled by AutocompleteManager.acceptSuggestion(...)
627: }
628: 
629: // MARK: - Line Numbers with Folding
630: 
631: struct LineNumbersWithFolding: View {
632:     let fileId: String
633:     let totalLines: Int
634:     let currentLine: Int
635:     let scrollOffset: CGFloat
636:     let lineHeight: CGFloat
637:     @Binding var requestedLineSelection: Int?
638:     @ObservedObject var foldingManager: CodeFoldingManager
639:     @ObservedObject private var debugManager = DebugManager.shared
640:     let theme: Theme
641: 
642:     @AppStorage("lineNumbersStyle") private var lineNumbersStyle: String = "on"
643: 
644:     var body: some View {
645:         ScrollView(showsIndicators: false) {
646:             VStack(alignment: .trailing, spacing: 0) {
647:                 // Match UITextView.textContainerInset.top (see SyntaxHighlightingTextView.swift)
648:                 // so line numbers stay vertically aligned with the first line of text.
649:                 ForEach(0..<totalLines, id: \.self) { lineIndex in
650:                     if !foldingManager.isLineFolded(line: lineIndex) {
651:                         HStack(spacing: 2) {
652:                             Button(action: { debugManager.toggleBreakpoint(file: fileId, line: lineIndex) }) {
653:                                 Circle()
654:                                     .fill(debugManager.hasBreakpoint(file: fileId, line: lineIndex) ? Color.red : Color.clear)
655:                                     .overlay(
656:                                         Circle()
657:                                             .stroke(Color.red.opacity(0.6), lineWidth: 1)
658:                                             .opacity(debugManager.hasBreakpoint(file: fileId, line: lineIndex) ? 0 : 0.25)
659:                                     )
660:                                     .frame(width: 10, height: 10)
661:                                     .padding(.leading, 2)
662:                             }
663:                             .buttonStyle(.plain)
664:                             .frame(width: 14, height: lineHeight)
665: 
666:                             if foldingManager.isFoldable(line: lineIndex) {
667:                                 Button(action: { foldingManager.toggleFold(at: lineIndex) }) {
668:                                     Image(systemName: foldingManager.foldRegions.first(where: { $0.startLine == lineIndex })?.isFolded == true ? "chevron.right" : "chevron.down")
669:                                         .font(.system(size: 8))
670:                                         .foregroundColor(theme.lineNumber)
671:                                 }
672:                                 .buttonStyle(.plain)
673:                                 .frame(width: 14, height: lineHeight)
674:                             } else {
675:                                 Spacer().frame(width: 14)
676:                             }
677: 
678:                             Text(displayText(for: lineIndex))
679:                                 .font(.system(size: 12, design: .monospaced))
680:                                 .foregroundColor(lineIndex + 1 == currentLine ? theme.lineNumberActive : theme.lineNumber)
681:                                 .frame(height: lineHeight)
682:                                 .contentShape(Rectangle())
683:                                 .onTapGesture {
684:                                     // FEAT-041: click line number selects entire line
685:                                     requestedLineSelection = lineIndex
686:                                 }
687:                         }
688:                         .frame(maxWidth: .infinity, alignment: .trailing)
689:                         .padding(.trailing, 4)
690:                     }
691:                 }
692:             }
693:             .padding(.top, 8)
694:             .offset(y: -scrollOffset)
695:         }
696:         .scrollDisabled(true)
697:     }
698: 
699:     private func displayText(for lineIndex: Int) -> String {
700:         switch lineNumbersStyle {
701:         case "relative":
702:             // VS Code-style: current line shows absolute, others show relative distance
703:             let lineNumber = lineIndex + 1
704:             if lineNumber == currentLine { return "\(lineNumber)" }
705:             return "\(abs(lineNumber - currentLine))"
706: 
707:         case "interval":
708:             let lineNumber = lineIndex + 1
709:             return (lineNumber == 1 || lineNumber % 5 == 0) ? "\(lineNumber)" : ""
710: 
711:         default:
712:             return "\(lineIndex + 1)"
713:         }
714:     }
715: }
716: 
717: // MARK: - Autocomplete Popup
718: 
719: struct AutocompletePopup: View {
720:     let suggestions: [AutocompleteSuggestion]
721:     let selectedIndex: Int
722:     let theme: Theme
723:     let onSelectIndex: (Int) -> Void
724:     
725:     var body: some View {
726:         VStack(alignment: .leading, spacing: 0) {
727:             ForEach(suggestions.indices, id: \.self) { index in
728:                 let s = suggestions[index]
729:                 HStack(spacing: 6) {
730:                     Image(systemName: icon(for: s.kind))
731:                         .font(.caption)
732:                         .foregroundColor(color(for: s.kind))
733:                     VStack(alignment: .leading, spacing: 1) {
734:                         Text(s.displayText)
735:                             .font(.system(size: 12, design: .monospaced))
736:                             .foregroundColor(theme.editorForeground)
737:                         if s.insertText != s.displayText && !s.insertText.isEmpty {
738:                             Text(s.insertText)
739:                                 .font(.system(size: 10, design: .monospaced))
740:                                 .foregroundColor(theme.editorForeground.opacity(0.55))
741:                                 .lineLimit(1)
742:                         }
743:                     }
744:                     Spacer()
745:                 }
746:                 .padding(.horizontal, 8).padding(.vertical, 6)
747:                 .background(index == selectedIndex ? theme.selection : Color.clear)
748:                 .contentShape(Rectangle())
749:                 .onTapGesture { onSelectIndex(index) }
750:             }
751:         }
752:         .frame(width: 260)
753:         .background(theme.editorBackground)
754:         .cornerRadius(6)
755:         .shadow(radius: 8)
756:     }
757:     
758:     private func icon(for kind: AutocompleteSuggestionKind) -> String {
759:         switch kind {
760:         case .keyword: return "key.fill"
761:         case .symbol: return "cube.fill"
762:         case .stdlib: return "curlybraces"
763:         case .member: return "arrow.right.circle.fill"
764:         }
765:     }
766:     
767:     private func color(for kind: AutocompleteSuggestionKind) -> Color {
768:         switch kind {
769:         case .keyword: return .purple
770:         case .symbol: return .blue
771:         case .stdlib: return .orange
772:         case .member: return .green
773:         }
774:     }
775: }
776: 
777: // MARK: - Welcome View
778: 
779: struct IDEWelcomeView: View {
780:     @ObservedObject var editorCore: EditorCore
781:     @Binding var showFolderPicker: Bool
782:     let theme: Theme
783:     
784:     var body: some View {
785:         VStack(spacing: 24) {
786:             Image(systemName: "chevron.left.forwardslash.chevron.right").font(.system(size: 80)).foregroundColor(theme.editorForeground.opacity(0.3))
787:             Text("VS Code for iPadOS").font(.largeTitle).fontWeight(.bold).foregroundColor(theme.editorForeground)
788:             VStack(alignment: .leading, spacing: 12) {
789:                 WelcomeBtn(icon: "doc.badge.plus", title: "New File", shortcut: "âŒ˜N", theme: theme) { editorCore.addTab() }
790:                 WelcomeBtn(icon: "folder", title: "Open Folder", shortcut: "âŒ˜â‡§O", theme: theme) { showFolderPicker = true }
791:                 WelcomeBtn(icon: "doc", title: "Open File", shortcut: "âŒ˜O", theme: theme) { editorCore.showFilePicker = true }
792:                 WelcomeBtn(icon: "terminal", title: "Command Palette", shortcut: "âŒ˜â‡§P", theme: theme) { editorCore.showCommandPalette = true }
793:             }
794:         }.frame(maxWidth: .infinity, maxHeight: .infinity).background(theme.editorBackground)
795:     }
796: }
797: 
798: struct WelcomeBtn: View {
799:     let icon: String
800:     let title: String
801:     let shortcut: String
802:     let theme: Theme
803:     let action: () -> Void
804:     
805:     var body: some View {
806:         Button(action: action) {
807:             HStack {
808:                 Image(systemName: icon).frame(width: 24).foregroundColor(theme.editorForeground)
809:                 Text(title).foregroundColor(theme.editorForeground)
810:                 Spacer()
811:                 Text(shortcut).font(.caption).foregroundColor(theme.editorForeground.opacity(0.5))
812:             }
813:             .padding().frame(width: 280)
814:             .background(theme.sidebarBackground)
815:             .cornerRadius(8)
816:         }.buttonStyle(.plain)
817:     }
818: }
819: 
820: // MARK: - Command Palette
821: 
822: struct IDECommandPalette: View {
823:     @ObservedObject var editorCore: EditorCore
824:     @Binding var showSettings: Bool
825:     @Binding var showTerminal: Bool
826:     @State private var searchText = ""
827:     
828:     var body: some View {
829:         VStack(spacing: 0) {
830:             HStack {
831:                 Image(systemName: "magnifyingglass").foregroundColor(.secondary)
832:                 TextField("Type a command...", text: $searchText).textFieldStyle(.plain)
833:             }.padding().background(Color(UIColor.secondarySystemBackground))
834:             Divider()
835:             ScrollView {
836:                 VStack(spacing: 0) {
837:                     CommandRow(icon: "doc.badge.plus", name: "New File", shortcut: "âŒ˜N") { editorCore.addTab(); editorCore.showCommandPalette = false }
838:                     CommandRow(icon: "folder", name: "Open File", shortcut: "âŒ˜O") { editorCore.showFilePicker = true; editorCore.showCommandPalette = false }
839:                     CommandRow(icon: "square.and.arrow.down", name: "Save File", shortcut: "âŒ˜S") { editorCore.saveActiveTab(); editorCore.showCommandPalette = false }
840:                     CommandRow(icon: "sidebar.left", name: "Toggle Sidebar", shortcut: "âŒ˜B") { editorCore.toggleSidebar(); editorCore.showCommandPalette = false }
841:                     CommandRow(icon: "brain", name: "AI Assistant", shortcut: "âŒ˜â‡§A") { editorCore.showAIAssistant = true; editorCore.showCommandPalette = false }
842:                     CommandRow(icon: "terminal", name: "Toggle Terminal", shortcut: "âŒ˜`") { showTerminal.toggle(); editorCore.showCommandPalette = false }
843:                     CommandRow(icon: "gear", name: "Settings", shortcut: "âŒ˜,") { showSettings = true; editorCore.showCommandPalette = false }
844:                     CommandRow(icon: "number", name: "Go to Line", shortcut: "âŒ˜G") { editorCore.showGoToLine = true; editorCore.showCommandPalette = false }
845:                 }.padding(.vertical, 8)
846:             }
847:         }.frame(width: 500, height: 400).background(Color(UIColor.systemBackground)).cornerRadius(12).shadow(radius: 20)
848:     }
849: }
850: 
851: struct CommandRow: View {
852:     let icon: String; let name: String; let shortcut: String; let action: () -> Void
853:     var body: some View {
854:         Button(action: action) {
855:             HStack {
856:                 Image(systemName: icon).foregroundColor(.accentColor).frame(width: 24)
857:                 Text(name).foregroundColor(.primary)
858:                 Spacer()
859:                 Text(shortcut).font(.caption).foregroundColor(.secondary).padding(.horizontal, 8).padding(.vertical, 4).background(Color(UIColor.tertiarySystemFill)).cornerRadius(4)
860:             }.padding(.horizontal).padding(.vertical, 12).contentShape(Rectangle())
861:         }.buttonStyle(.plain)
862:     }
863: }
864: 
865: // MARK: - Quick Open
866: 
867: struct IDEQuickOpen: View {
868:     @ObservedObject var editorCore: EditorCore
869:     @State private var searchText = ""
870:     
871:     var body: some View {
872:         VStack(spacing: 0) {
873:             HStack {
874:                 Image(systemName: "magnifyingglass").foregroundColor(.gray)
875:                 TextField("Search files...", text: $searchText).textFieldStyle(.plain)
876:             }.padding().background(Color(UIColor.secondarySystemBackground))
877:             Divider()
878:             ScrollView {
879:                 VStack(alignment: .leading, spacing: 0) {
880:                     ForEach(editorCore.tabs) { tab in
881:                         QuickOpenRow(name: tab.fileName, path: "") {
882:                             editorCore.selectTab(id: tab.id)
883:                             editorCore.showQuickOpen = false
884:                         }
885:                     }
886:                 }
887:             }.frame(maxHeight: 350)
888:         }.frame(width: 500).background(Color(UIColor.systemBackground)).cornerRadius(12).shadow(radius: 20)
889:     }
890: }
891: 
892: struct QuickOpenRow: View {
893:     let name: String; let path: String; let action: () -> Void
894:     var body: some View {
895:         Button(action: action) {
896:             HStack {
897:                 Image(systemName: fileIcon(for: name)).foregroundColor(fileColor(for: name)).frame(width: 20)
898:                 VStack(alignment: .leading, spacing: 2) { Text(name).font(.system(size: 14)); Text(path + name).font(.system(size: 11)).foregroundColor(.secondary) }
899:                 Spacer()
900:             }.padding(.horizontal).padding(.vertical, 8).contentShape(Rectangle())
901:         }.buttonStyle(.plain)
902:     }
903: }
904: 
905: // MARK: - AI Assistant
906: 
907: struct IDEAIAssistant: View {
908:     @ObservedObject var editorCore: EditorCore
909:     let theme: Theme
910:     @State private var userInput = ""
911:     @State private var messages: [(id: UUID, role: String, content: String)] = [(UUID(), "assistant", "Hello! I'm your AI coding assistant. How can I help?")]
912:     
913:     var body: some View {
914:         VStack(spacing: 0) {
915:             HStack {
916:                 Image(systemName: "brain").foregroundColor(.blue)
917:                 Text("AI Assistant").font(.headline).foregroundColor(theme.editorForeground)
918:                 Spacer()
919:                 Button(action: { editorCore.showAIAssistant = false }) { Image(systemName: "xmark.circle.fill").foregroundColor(theme.editorForeground.opacity(0.5)) }
920:             }.padding().background(theme.sidebarBackground)
921:             
922:             ScrollView {
923:                 LazyVStack(alignment: .leading, spacing: 12) {
924:                     ForEach(messages, id: \.id) { msg in
925:                         HStack {
926:                             if msg.role == "user" { Spacer(minLength: 60) }
927:                             Text(msg.content).padding(12).background(RoundedRectangle(cornerRadius: 12).fill(msg.role == "user" ? Color.blue : theme.sidebarBackground)).foregroundColor(msg.role == "user" ? .white : theme.editorForeground)
928:                             if msg.role == "assistant" { Spacer(minLength: 60) }
929:                         }
930:                     }
931:                 }.padding()
932:             }.background(theme.editorBackground)
933:             
934:             HStack(spacing: 12) {
935:                 TextField("Ask about your code...", text: $userInput).textFieldStyle(.roundedBorder)
936:                 Button(action: { sendMessage() }) { Image(systemName: "paperplane.fill").foregroundColor(userInput.isEmpty ? .gray : .blue) }.disabled(userInput.isEmpty)
937:             }.padding().background(theme.sidebarBackground)
938:         }.background(theme.editorBackground).cornerRadius(12).shadow(radius: 20)
939:     }
940:     
941:     func sendMessage() {
942:         guard !userInput.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty else { return }
943:         messages.append((UUID(), "user", userInput))
944:         let input = userInput
945:         userInput = ""
946:         DispatchQueue.main.asyncAfter(deadline: .now() + 0.8) {
947:             messages.append((UUID(), "assistant", "I can help with '\(input)'! What specifically would you like to know?"))
948:         }
949:     }
950: }
951: 
952: // MARK: - Status Bar
953: 
954: 
955: 
956: // MARK: - Folder Picker
957: 
958: struct IDEFolderPicker: UIViewControllerRepresentable {
959:     @ObservedObject var fileNavigator: FileSystemNavigator
960:     var onPick: ((URL) -> Void)?
961:     
962:     init(fileNavigator: FileSystemNavigator, onPick: ((URL) -> Void)? = nil) {
963:         self.fileNavigator = fileNavigator
964:         self.onPick = onPick
965:     }
966:     
967:     func makeUIViewController(context: Context) -> UIDocumentPickerViewController {
968:         let picker = UIDocumentPickerViewController(forOpeningContentTypes: [.folder])
969:         picker.delegate = context.coordinator
970:         return picker
971:     }
972:     
973:     func updateUIViewController(_ uiViewController: UIDocumentPickerViewController, context: Context) {}
974:     
975:     func makeCoordinator() -> Coordinator { Coordinator(self) }
976:     
977:     class Coordinator: NSObject, UIDocumentPickerDelegate {
978:         let parent: IDEFolderPicker
979:         init(_ parent: IDEFolderPicker) { self.parent = parent }
980:         
981:         func documentPicker(_ controller: UIDocumentPickerViewController, didPickDocumentsAt urls: [URL]) {
982:             if let url = urls.first {
983:                 _ = url.startAccessingSecurityScopedResource()
984:                 if let onPick = parent.onPick {
985:                     onPick(url)
986:                 } else {
987:                     // Default behavior if no custom handler
988:                     parent.fileNavigator.loadFileTree(at: url)
989:                     Task { @MainActor in
990:                         LaunchManager.shared.setWorkspaceRoot(url)
991:                         GitManager.shared.setWorkingDirectory(url)
992:                     }
993:                 }
994:             }
995:         }
996:     }
997: }
998: 
999: // MARK: - Document Picker
1000: 
1001: struct IDEDocumentPicker: UIViewControllerRepresentable {
1002:     @ObservedObject var editorCore: EditorCore
1003:     
1004:     func makeUIViewController(context: Context) -> UIDocumentPickerViewController {
1005:         let picker = UIDocumentPickerViewController(forOpeningContentTypes: [.text, .sourceCode, .json, .plainText, .data])
1006:         picker.allowsMultipleSelection = true
1007:         picker.delegate = context.coordinator
1008:         return picker
1009:     }
1010:     
1011:     func updateUIViewController(_ uiViewController: UIDocumentPickerViewController, context: Context) {}
1012:     
1013:     func makeCoordinator() -> Coordinator { Coordinator(editorCore: editorCore) }
1014:     
1015:     class Coordinator: NSObject, UIDocumentPickerDelegate {
1016:         let editorCore: EditorCore
1017:         init(editorCore: EditorCore) { self.editorCore = editorCore }
1018:         
1019:         func documentPicker(_ controller: UIDocumentPickerViewController, didPickDocumentsAt urls: [URL]) {
1020:             for url in urls { editorCore.openFile(from: url) }
1021:             editorCore.showFilePicker = false
1022:         }
1023:         
1024:         func documentPickerWasCancelled(_ controller: UIDocumentPickerViewController) {
1025:             editorCore.showFilePicker = false
1026:         }
1027:     }
1028: }
1029: 
1030: // MARK: - Sidebar Search View
1031: 
1032: struct SidebarSearchView: View {
1033:     let theme: Theme
1034:     @State private var searchText = ""
1035:     @State private var replaceText = ""
1036:     @State private var showReplace = false
1037:     @State private var searchResults: [(fileName: String, line: Int, preview: String)] = []
1038:     
1039:     var body: some View {
1040:         VStack(alignment: .leading, spacing: 0) {
1041:             HStack {
1042:                 Text("SEARCH").font(.caption).fontWeight(.semibold).foregroundColor(theme.sidebarForeground.opacity(0.7))
1043:                 Spacer()
1044:             }.padding(.horizontal, 12).padding(.vertical, 8)
1045:             
1046:             HStack(spacing: 4) {
1047:                 Image(systemName: "magnifyingglass").foregroundColor(theme.sidebarForeground.opacity(0.6)).font(.caption)
1048:                 TextField("Search", text: $searchText).textFieldStyle(.plain).font(.system(size: 13))
1049:                     .foregroundColor(theme.sidebarForeground)
1050:                 if !searchText.isEmpty {
1051:                     Button(action: { searchText = "" }) {
1052:                         Image(systemName: "xmark.circle.fill").foregroundColor(theme.sidebarForeground.opacity(0.6)).font(.caption)
1053:                     }
1054:                 }
1055:             }
1056:             .padding(8)
1057:             .background(theme.editorBackground)
1058:             .cornerRadius(6)
1059:             .padding(.horizontal, 12)
1060:             
1061:             HStack {
1062:                 Button(action: { showReplace.toggle() }) {
1063:                     Image(systemName: showReplace ? "chevron.down" : "chevron.right").font(.caption2)
1064:                     Text("Replace").font(.caption)
1065:                 }.foregroundColor(theme.sidebarForeground.opacity(0.7))
1066:                 Spacer()
1067:             }.padding(.horizontal, 12).padding(.vertical, 6)
1068:             
1069:             if showReplace {
1070:                 HStack(spacing: 4) {
1071:                     Image(systemName: "arrow.right").foregroundColor(theme.sidebarForeground.opacity(0.6)).font(.caption)
1072:                     TextField("Replace", text: $replaceText).textFieldStyle(.plain).font(.system(size: 13))
1073:                         .foregroundColor(theme.sidebarForeground)
1074:                 }
1075:                 .padding(8)
1076:                 .background(theme.editorBackground)
1077:                 .cornerRadius(6)
1078:                 .padding(.horizontal, 12)
1079:             }
1080:             
1081:             Divider().padding(.top, 8)
1082:             
1083:             if searchText.isEmpty {
1084:                 VStack(spacing: 8) {
1085:                     Spacer()
1086:                     Image(systemName: "magnifyingglass").font(.largeTitle).foregroundColor(theme.sidebarForeground.opacity(0.3))
1087:                     Text("Search in files").font(.caption).foregroundColor(theme.sidebarForeground.opacity(0.6))
1088:                     Spacer()
1089:                 }.frame(maxWidth: .infinity)
1090:             } else {
1091:                 ScrollView {
1092:                     LazyVStack(alignment: .leading, spacing: 0) {
1093:                         ForEach(0..<searchResults.count, id: \.self) { i in
1094:                             let result = searchResults[i]
1095:                             VStack(alignment: .leading, spacing: 2) {
1096:                                 HStack {
1097:                                     Image(systemName: "doc.text").font(.caption2).foregroundColor(theme.sidebarForeground.opacity(0.6))
1098:                                     Text(result.fileName).font(.system(size: 11, weight: .medium)).foregroundColor(theme.sidebarForeground)
1099:                                     Spacer()
1100:                                     Text(":\(result.line)").font(.system(size: 10, design: .monospaced)).foregroundColor(theme.sidebarForeground.opacity(0.6))
1101:                                 }
1102:                                 Text(result.preview).font(.system(size: 11, design: .monospaced)).foregroundColor(theme.sidebarForeground.opacity(0.7)).lineLimit(1)
1103:                             }.padding(.horizontal, 12).padding(.vertical, 6)
1104:                         }
1105:                     }
1106:                 }
1107:             }
1108:         }
1109:         .background(theme.sidebarBackground)
1110:         .onChange(of: searchText) { query in
1111:             if query.isEmpty { searchResults = [] }
1112:             else { searchResults = [("ContentView.swift", 15, "Text(\"\(query)\")"), ("main.swift", 8, "// \(query)")] }
1113:         }
1114:     }
1115: }
1116: 
1117: // MARK: - Preview
1118: 
1119: #Preview {
1120:     ContentView()
1121: }
1122: 


Now I can see the editor uses `RunestoneEditorView` or `SyntaxHighlightingTextView`. Let me find these implementations.

>>>TOOL list_dir
{"path": "VSCodeiPadOS/VSCodeiPadOS/Views/Editor"}
>>>END

>>>TOOL search
{"query": "RunestoneEditorView", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "SyntaxHighlightingTextView", "glob": "*.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[list_dir]
ðŸ“ VSCodeiPadOS/VSCodeiPadOS/Views/Editor/
   BreadcrumbsView.swift
   ColorPickerView.swift
   EditorSplitView.swift
   FoldingLayoutManager.swift
   GitGutterView.swift
   HoverInfoView.swift
   InlayHintsOverlay.swift
   InlineSuggestionView.swift
   JSONTreeView.swift
   MergeConflictView.swift
   MinimapView.swift
   ModifierTapGestureRecognizer.swift
   MultiCursorTextView.swift
   PeekDefinitionView.swift
   RunestoneEditorView 2.swift
   RunestoneEditorView.swift
   SplitEditorView.swift
   StickyHeaderView.swift
   SyntaxHighlightingTextView_Update.swift
   SyntaxHighlightingTextView.swift

---

[search]
No matches found for "RunestoneEditorView"

---

[search]
No matches found for "SyntaxHighlightingTextView"


>>>TOOL read_file
{"path": "VSCodeiPadOS/VSCodeiPadOS/Views/Editor/RunestoneEditorView.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[read_file]
File: VSCodeiPadOS/VSCodeiPadOS/Views/Editor/RunestoneEditorView.swift (lines 1-741 of 741)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1: //
2: //  RunestoneEditorView.swift
3: //  VSCodeiPadOS
4: //
5: //  High-performance code editor using Runestone with TreeSitter syntax highlighting.
6: //  Provides native line numbers, code folding, and efficient rendering for large files.
7: //
8: 
9: import SwiftUI
10: import UIKit
11: import Runestone
12: import TreeSitterSwiftRunestone
13: import TreeSitterJavaScriptRunestone
14: import TreeSitterPythonRunestone
15: import TreeSitterJSONRunestone
16: import TreeSitterHTMLRunestone
17: import TreeSitterCSSRunestone
18: import TreeSitterGoRunestone
19: import TreeSitterRustRunestone
20: 
21: // Feature flag now uses centralized FeatureFlags.useRunestoneEditor
22: 
23: /// UIViewRepresentable wrapper for Runestone's TextView
24: /// Provides native TreeSitter syntax highlighting, line numbers, and code folding
25: struct RunestoneEditorView: UIViewRepresentable {
26:     @Binding var text: String
27:     let filename: String
28:     @Binding var scrollOffset: CGFloat
29:     @Binding var totalLines: Int
30:     @Binding var currentLineNumber: Int
31:     @Binding var currentColumn: Int
32:     @Binding var cursorIndex: Int
33:     let isActive: Bool
34:     let fontSize: CGFloat
35:     @EnvironmentObject var editorCore: EditorCore
36:     
37:     // Settings from AppStorage
38:     @AppStorage("wordWrap") private var wordWrapEnabled: Bool = true
39:     @AppStorage("showLineNumbers") private var showLineNumbers: Bool = true
40:     
41:     /// Autocomplete key handling hooks (return true if handled)
42:     let onAcceptAutocomplete: (() -> Bool)?
43:     let onDismissAutocomplete: (() -> Bool)?
44:     
45:     init(
46:         text: Binding<String>,
47:         filename: String,
48:         scrollOffset: Binding<CGFloat> = .constant(0),
49:         totalLines: Binding<Int>,
50:         currentLineNumber: Binding<Int>,
51:         currentColumn: Binding<Int>,
52:         cursorIndex: Binding<Int> = .constant(0),
53:         isActive: Bool,
54:         fontSize: CGFloat = 14.0,
55:         onAcceptAutocomplete: (() -> Bool)? = nil,
56:         onDismissAutocomplete: (() -> Bool)? = nil
57:     ) {
58:         self._text = text
59:         self.filename = filename
60:         self._scrollOffset = scrollOffset
61:         self._totalLines = totalLines
62:         self._currentLineNumber = currentLineNumber
63:         self._currentColumn = currentColumn
64:         self._cursorIndex = cursorIndex
65:         self.isActive = isActive
66:         self.fontSize = fontSize
67:         self.onAcceptAutocomplete = onAcceptAutocomplete
68:         self.onDismissAutocomplete = onDismissAutocomplete
69:     }
70:     
71:     func makeCoordinator() -> Coordinator {
72:         Coordinator(self)
73:     }
74:     
75:     func makeUIView(context: Context) -> TextView {
76:         let textView = TextView()
77:         textView.editorDelegate = context.coordinator
78:         
79:         // Configure line numbers (from settings)
80:         textView.showLineNumbers = showLineNumbers
81:         textView.lineSelectionDisplayType = .line
82:         
83:         // Configure line wrapping (from settings)
84:         textView.isLineWrappingEnabled = wordWrapEnabled
85:         
86:         // Configure editing
87:         textView.isEditable = true
88:         textView.isSelectable = true
89:         
90:         // Disable autocorrect/autocapitalize for code editing
91:         textView.autocorrectionType = .no
92:         textView.autocapitalizationType = .none
93:         textView.smartQuotesType = .no
94:         textView.smartDashesType = .no
95:         textView.smartInsertDeleteType = .no
96:         textView.spellCheckingType = .no
97:         
98:         // Configure keyboard
99:         textView.keyboardType = .asciiCapable
100:         textView.keyboardDismissMode = .interactive
101:         
102:         // Set theme and appearance
103:         textView.theme = makeRunestoneTheme()
104:         textView.backgroundColor = UIColor(ThemeManager.shared.currentTheme.editorBackground)
105:         
106:         // Content insets for padding
107:         textView.textContainerInset = UIEdgeInsets(top: 8, left: 8, bottom: 8, right: 8)
108:         
109:         // Set text with TreeSitter language support
110:         if let language = getTreeSitterLanguage(for: filename) {
111:             let state = TextViewState(text: text, language: language)
112:             textView.setState(state)
113:         } else {
114:             // No language support - fallback to plain text
115:             textView.text = text
116:         }
117:         
118:         // Store reference for coordinator
119:         context.coordinator.textView = textView
120:         
121:         // Initial line count
122:         DispatchQueue.main.async {
123:             self.totalLines = self.countLines(in: text)
124:         }
125:         
126:         return textView
127:     }
128:     
129:     func updateUIView(_ textView: TextView, context: Context) {
130:         // Update coordinator's parent reference for current bindings
131:         context.coordinator.parent = self
132:         
133:         // Update theme if changed
134:         let currentThemeId = ThemeManager.shared.currentTheme.id
135:         if context.coordinator.lastThemeId != currentThemeId {
136:             context.coordinator.lastThemeId = currentThemeId
137:             textView.theme = makeRunestoneTheme()
138:             textView.backgroundColor = UIColor(ThemeManager.shared.currentTheme.editorBackground)
139:         }
140:         
141:         // Update font size if changed
142:         if context.coordinator.lastFontSize != fontSize {
143:             context.coordinator.lastFontSize = fontSize
144:             textView.theme = makeRunestoneTheme()
145:         }
146:         
147:         // Update settings if changed (live toggle support)
148:         if textView.showLineNumbers != showLineNumbers {
149:             textView.showLineNumbers = showLineNumbers
150:         }
151:         if textView.isLineWrappingEnabled != wordWrapEnabled {
152:             textView.isLineWrappingEnabled = wordWrapEnabled
153:         }
154:         
155:         // CRITICAL: Only call setState() when safe (not during active editing)
156:         // Calling setState() during editing corrupts Runestone's lineManager
157:         // and causes crash at TextEditHelper.swift:27 (force unwrap on linePosition)
158:         
159:         let isFileSwitching = context.coordinator.lastFilename != filename
160:         let currentText = textView.text
161:         let textChanged = currentText != text
162:         let isActivelyEditing = textView.isFirstResponder
163:         
164:         if isFileSwitching {
165:             // User switched to a different file - safe to call setState()
166:             context.coordinator.lastFilename = filename
167:             context.coordinator.hasBeenEdited = false
168:             
169:             if let language = getTreeSitterLanguage(for: filename) {
170:                 let state = TextViewState(text: text, language: language)
171:                 textView.setState(state)
172:             } else {
173:                 textView.text = text
174:             }
175:             
176:             // Reset cursor to start for new file
177:             textView.selectedRange = NSRange(location: 0, length: 0)
178:             
179:             // Update line count
180:             DispatchQueue.main.async {
181:                 self.totalLines = self.countLines(in: text)
182:             }
183:         } else if textChanged && !context.coordinator.hasBeenEdited && !isActivelyEditing && !context.coordinator.isUpdatingFromTextView {
184:             // Text changed externally (e.g., initial load, external modification)
185:             // Safe to update since user hasn't started editing yet
186:             if let language = getTreeSitterLanguage(for: filename) {
187:                 let state = TextViewState(text: text, language: language)
188:                 textView.setState(state)
189:             } else {
190:                 textView.text = text
191:             }
192:             
193:             // Update line count
194:             DispatchQueue.main.async {
195:                 self.totalLines = self.countLines(in: text)
196:             }
197:         }
198:         // If user HAS edited OR is actively editing, DO NOTHING
199:         // Let the user's edits remain - don't corrupt the lineManager
200:     }
201:     
202:     // MARK: - Runestone Theme Factory
203:     
204:     private func makeRunestoneTheme() -> RunestoneEditorTheme {
205:         let appTheme = ThemeManager.shared.currentTheme
206:         return RunestoneEditorTheme(
207:             fontSize: fontSize,
208:             backgroundColor: UIColor(appTheme.editorBackground),
209:             textColor: UIColor(appTheme.editorForeground),
210:             gutterBackgroundColor: UIColor(appTheme.editorBackground),
211:             gutterHairlineColor: UIColor(appTheme.lineNumber).withAlphaComponent(0.3),
212:             lineNumberColor: UIColor(appTheme.lineNumber),
213:             selectedLineBackgroundColor: UIColor(appTheme.currentLineHighlight),
214:             selectedLinesLineNumberColor: UIColor(appTheme.lineNumberActive),
215:             selectedLinesGutterBackgroundColor: UIColor(appTheme.currentLineHighlight),
216:             invisibleCharactersColor: UIColor(appTheme.editorForeground).withAlphaComponent(0.3),
217:             pageGuideHairlineColor: UIColor(appTheme.editorForeground).withAlphaComponent(0.1),
218:             pageGuideBackgroundColor: UIColor(appTheme.editorBackground),
219:             markedTextBackgroundColor: UIColor(appTheme.selection).withAlphaComponent(0.5),
220:             keywordColor: UIColor(appTheme.keyword),
221:             stringColor: UIColor(appTheme.string),
222:             numberColor: UIColor(appTheme.number),
223:             commentColor: UIColor(appTheme.comment),
224:             functionColor: UIColor(appTheme.function),
225:             typeColor: UIColor(appTheme.type),
226:             variableColor: UIColor(appTheme.variable)
227:         )
228:     }
229:     
230:     // MARK: - Language Mode Mapping
231:     
232:     /// Gets the actual TreeSitter Language object for a given filename
233:     /// Returns nil for plain text files (no syntax highlighting)
234:     private func getTreeSitterLanguage(for filename: String) -> Runestone.TreeSitterLanguage? {
235:         let ext = (filename as NSString).pathExtension.lowercased()
236:         let lastComponent = (filename as NSString).lastPathComponent.lowercased()
237:         
238:         // Special-case filenames without extensions
239:         if lastComponent == "dockerfile" || lastComponent.hasPrefix("dockerfile.") {
240:             return nil // Bash support not in package list yet
241:         }
242:         if lastComponent == ".env" || lastComponent.hasPrefix(".env.") {
243:             return nil // Plain text
244:         }
245:         if lastComponent == "makefile" || lastComponent == "gnumakefile" {
246:             return nil // Bash support not in package list yet
247:         }
248:         if lastComponent == "podfile" || lastComponent == "gemfile" {
249:             return nil // Ruby support not in package list yet
250:         }
251:         if lastComponent == "package.json" || lastComponent == "tsconfig.json" {
252:             return TreeSitterLanguage.json
253:         }
254:         
255:         switch ext {
256:         // Swift
257:         case "swift":
258:             return TreeSitterLanguage.swift
259:         
260:         // JavaScript
261:         case "js", "mjs", "cjs", "jsx":
262:             return TreeSitterLanguage.javaScript
263:         
264:         // TypeScript - use JavaScript as fallback
265:         case "ts", "mts", "cts", "tsx":
266:             return TreeSitterLanguage.javaScript
267:         
268:         // Python
269:         case "py", "pyw", "pyi":
270:             return TreeSitterLanguage.python
271:         
272:         // Go
273:         case "go":
274:             return TreeSitterLanguage.go
275:         
276:         // Rust
277:         case "rs":
278:             return TreeSitterLanguage.rust
279:         
280:         // JSON
281:         case "json", "jsonc":
282:             return TreeSitterLanguage.json
283:         
284:         // HTML
285:         case "html", "htm", "xhtml":
286:             return TreeSitterLanguage.html
287:         
288:         // CSS
289:         case "css", "scss":
290:             return TreeSitterLanguage.css
291:         
292:         // XML - use HTML as fallback
293:         case "xml", "plist", "svg":
294:             return TreeSitterLanguage.html
295:         
296:         // Default - no syntax highlighting
297:         default:
298:             return nil
299:         }
300:     }
301: 
302:     
303:     // MARK: - Helpers
304:     
305:     private func countLines(in text: String) -> Int {
306:         guard !text.isEmpty else { return 1 }
307:         var count = 1
308:         var index = text.startIndex
309:         while index < text.endIndex {
310:             if text[index] == "\n" {
311:                 count += 1
312:             }
313:             index = text.index(after: index)
314:         }
315:         return count
316:     }
317:     
318:     // MARK: - Coordinator
319:     
320:     class Coordinator: NSObject, TextViewDelegate {
321:         var parent: RunestoneEditorView
322:         weak var textView: TextView?
323:         var isUpdatingFromTextView = false
324:         var lastFontSize: CGFloat = 14.0
325:         var lastThemeId: String = ""
326:         var currentLanguage: Language?
327:         
328:         // Track file identity to know when to call setState()
329:         var lastFilename: String = ""
330:         var hasBeenEdited: Bool = false
331:         
332:         // Debounced text sync to avoid SwiftUI re-renders on every keystroke
333:         private var textSyncWorkItem: DispatchWorkItem?
334:         private let debounceInterval: TimeInterval = 0.5 // 500ms
335:         
336:         init(_ parent: RunestoneEditorView) {
337:             self.parent = parent
338:             self.lastFontSize = parent.fontSize
339:             self.lastThemeId = ThemeManager.shared.currentTheme.id
340:             self.lastFilename = parent.filename
341:         }
342:         
343:         deinit {
344:             // Cancel any pending debounced updates
345:             textSyncWorkItem?.cancel()
346:         }
347:         
348:         // MARK: - TextViewDelegate
349:         
350:         func textViewDidChange(_ textView: TextView) {
351:             // Mark that user has edited - blocks setState() calls until file switch
352:             hasBeenEdited = true
353:             
354:             // Cancel any pending debounced update
355:             textSyncWorkItem?.cancel()
356:             
357:             // Create new debounced work item
358:             let workItem = DispatchWorkItem { [weak self] in
359:                 guard let self = self else { return }
360:                 self.isUpdatingFromTextView = true
361:                 defer { self.isUpdatingFromTextView = false }
362:                 
363:                 // Update text binding (debounced - only after typing stops)
364:                 self.parent.text = textView.text
365:                 
366:                 // Update line count
367:                 DispatchQueue.main.async {
368:                     self.parent.totalLines = self.parent.countLines(in: textView.text)
369:                 }
370:             }
371:             
372:             // Schedule the update after debounce interval
373:             textSyncWorkItem = workItem
374:             DispatchQueue.main.asyncAfter(deadline: .now() + debounceInterval, execute: workItem)
375:         }
376:         
377:         /// Immediately sync text to SwiftUI binding (call on save/tab-switch)
378:         func syncTextImmediately() {
379:             // Cancel any pending debounced update
380:             textSyncWorkItem?.cancel()
381:             
382:             guard let textView = textView else { return }
383:             
384:             isUpdatingFromTextView = true
385:             defer { isUpdatingFromTextView = false }
386:             
387:             // Immediate sync
388:             parent.text = textView.text
389:             parent.totalLines = parent.countLines(in: textView.text)
390:         }
391:         
392:         func textViewDidChangeSelection(_ textView: TextView) {
393:             updateCursorPosition(in: textView)
394:         }
395:         
396:         func textViewDidBeginEditing(_ textView: TextView) {
397:             // Could be used for focus handling
398:         }
399:         
400:         func textViewDidEndEditing(_ textView: TextView) {
401:             // Could be used for focus handling
402:         }
403:         
404:         func textView(_ textView: TextView, shouldChangeTextIn range: NSRange, replacementText text: String) -> Bool {
405:             // Handle Tab key for autocomplete acceptance
406:             if text == "\t" {
407:                 if let onAccept = parent.onAcceptAutocomplete, onAccept() {
408:                     return false
409:                 }
410:             }
411:             
412:             // Handle Escape key for autocomplete dismissal
413:             // Note: Escape key events are typically handled via key commands, not here
414:             
415:             return true
416:         }
417:         
418:         func scrollViewDidScroll(_ scrollView: UIScrollView) {
419:             // Update scroll offset binding for gutter synchronization
420:             DispatchQueue.main.async {
421:                 self.parent.scrollOffset = scrollView.contentOffset.y
422:             }
423:         }
424:         
425:         // MARK: - Cursor Position Calculation
426:         
427:         private func updateCursorPosition(in textView: TextView) {
428:             let selectedRange = textView.selectedRange
429:             let text = textView.text as NSString
430:             let cursorLocation = selectedRange.location
431:             
432:             // Calculate line and column from cursor location
433:             var lineNumber = 1
434:             var columnNumber = 1
435:             var currentLineStart = 0
436:             
437:             for i in 0..<min(cursorLocation, text.length) {
438:                 if text.character(at: i) == UInt16(UnicodeScalar("\n").value) {
439:                     lineNumber += 1
440:                     currentLineStart = i + 1
441:                 }
442:             }
443:             
444:             // Column is the offset from the start of the current line
445:             columnNumber = cursorLocation - currentLineStart + 1
446:             
447:             // Update bindings on main thread to avoid SwiftUI state update warnings
448:             DispatchQueue.main.async {
449:                 self.parent.cursorIndex = cursorLocation
450:                 self.parent.currentLineNumber = lineNumber
451:                 self.parent.currentColumn = columnNumber
452:             }
453:         }
454:     }
455: }
456: 
457: // MARK: - Runestone Theme Implementation
458: 
459: /// Custom theme implementation for Runestone that maps app theme colors to editor appearance
460: class RunestoneEditorTheme: Runestone.Theme {
461:     let fontSize: CGFloat
462:     
463:     // Core colors
464:     private let _backgroundColor: UIColor
465:     private let _textColor: UIColor
466:     private let _gutterBackgroundColor: UIColor
467:     private let _gutterHairlineColor: UIColor
468:     private let _lineNumberColor: UIColor
469:     private let _selectedLineBackgroundColor: UIColor
470:     private let _selectedLinesLineNumberColor: UIColor
471:     private let _selectedLinesGutterBackgroundColor: UIColor
472:     private let _invisibleCharactersColor: UIColor
473:     private let _pageGuideHairlineColor: UIColor
474:     private let _pageGuideBackgroundColor: UIColor
475:     private let _markedTextBackgroundColor: UIColor
476:     
477:     // Syntax colors
478:     private let _keywordColor: UIColor
479:     private let _stringColor: UIColor
480:     private let _numberColor: UIColor
481:     private let _commentColor: UIColor
482:     private let _functionColor: UIColor
483:     private let _typeColor: UIColor
484:     private let _variableColor: UIColor
485:     
486:     init(
487:         fontSize: CGFloat,
488:         backgroundColor: UIColor,
489:         textColor: UIColor,
490:         gutterBackgroundColor: UIColor,
491:         gutterHairlineColor: UIColor,
492:         lineNumberColor: UIColor,
493:         selectedLineBackgroundColor: UIColor,
494:         selectedLinesLineNumberColor: UIColor,
495:         selectedLinesGutterBackgroundColor: UIColor,
496:         invisibleCharactersColor: UIColor,
497:         pageGuideHairlineColor: UIColor,
498:         pageGuideBackgroundColor: UIColor,
499:         markedTextBackgroundColor: UIColor,
500:         keywordColor: UIColor,
501:         stringColor: UIColor,
502:         numberColor: UIColor,
503:         commentColor: UIColor,
504:         functionColor: UIColor,
505:         typeColor: UIColor,
506:         variableColor: UIColor
507:     ) {
508:         self.fontSize = fontSize
509:         self._backgroundColor = backgroundColor
510:         self._textColor = textColor
511:         self._gutterBackgroundColor = gutterBackgroundColor
512:         self._gutterHairlineColor = gutterHairlineColor
513:         self._lineNumberColor = lineNumberColor
514:         self._selectedLineBackgroundColor = selectedLineBackgroundColor
515:         self._selectedLinesLineNumberColor = selectedLinesLineNumberColor
516:         self._selectedLinesGutterBackgroundColor = selectedLinesGutterBackgroundColor
517:         self._invisibleCharactersColor = invisibleCharactersColor
518:         self._pageGuideHairlineColor = pageGuideHairlineColor
519:         self._pageGuideBackgroundColor = pageGuideBackgroundColor
520:         self._markedTextBackgroundColor = markedTextBackgroundColor
521:         self._keywordColor = keywordColor
522:         self._stringColor = stringColor
523:         self._numberColor = numberColor
524:         self._commentColor = commentColor
525:         self._functionColor = functionColor
526:         self._typeColor = typeColor
527:         self._variableColor = variableColor
528:     }
529:     
530:     // MARK: - Theme Protocol Properties
531:     
532:     var font: UIFont {
533:         UIFont.monospacedSystemFont(ofSize: fontSize, weight: .regular)
534:     }
535:     
536:     var textColor: UIColor {
537:         _textColor
538:     }
539:     
540:     var gutterBackgroundColor: UIColor {
541:         _gutterBackgroundColor
542:     }
543:     
544:     var gutterHairlineColor: UIColor {
545:         _gutterHairlineColor
546:     }
547:     
548:     var lineNumberColor: UIColor {
549:         _lineNumberColor
550:     }
551:     
552:     var lineNumberFont: UIFont {
553:         UIFont.monospacedSystemFont(ofSize: max(fontSize - 2, 10), weight: .regular)
554:     }
555:     
556:     var selectedLineBackgroundColor: UIColor {
557:         _selectedLineBackgroundColor
558:     }
559:     
560:     var selectedLinesLineNumberColor: UIColor {
561:         _selectedLinesLineNumberColor
562:     }
563:     
564:     var selectedLinesGutterBackgroundColor: UIColor {
565:         _selectedLinesGutterBackgroundColor
566:     }
567:     
568:     var invisibleCharactersColor: UIColor {
569:         _invisibleCharactersColor
570:     }
571:     
572:     var pageGuideHairlineColor: UIColor {
573:         _pageGuideHairlineColor
574:     }
575:     
576:     var pageGuideBackgroundColor: UIColor {
577:         _pageGuideBackgroundColor
578:     }
579:     
580:     var markedTextBackgroundColor: UIColor {
581:         _markedTextBackgroundColor
582:     }
583:     
584:     // MARK: - Syntax Highlighting
585:     
586:     func textColor(for rawHighlightName: String) -> UIColor? {
587:         // Map TreeSitter highlight names to colors
588:         // See: https://tree-sitter.github.io/tree-sitter/syntax-highlighting#highlights
589:         let highlightName = rawHighlightName.lowercased()
590:         
591:         // Debug: Log ALL highlight names to console (remove in production)
592:         // print("ðŸŽ¨ HIGHLIGHT: '\(rawHighlightName)'")
593:         
594:         // Keywords
595:         if highlightName.contains("keyword") {
596:             return _keywordColor
597:         }
598:         
599:         // JSON/Object keys - MUST return color for specific patterns
600:         // TreeSitter JSON emits BOTH "string.special.key" AND "string" for keys
601:         // We handle specific patterns first, then skip generic "string" to avoid overwrite
602:         if highlightName.hasPrefix("string.special") ||
603:            highlightName.contains("label") ||
604:            highlightName.contains("property.definition") {
605:             return _variableColor  // Light blue #9CDCFE for keys
606:         }
607:         
608:         // Strings - but NOT if it's JUST "string" (let specific matches win)
609:         // Only color strings that are clearly values, not potential keys
610:         if highlightName.contains("string") {
611:             // If it's exactly "string" with no qualifiers, it might be a key
612:             // that was already colored by string.special.key - return nil to not overwrite
613:             if rawHighlightName == "string" {
614:                 // For pure "string" captures, still color them (they're values)
615:                 // The issue is ordering - specific patterns should come AFTER in Runestone
616:                 return _stringColor
617:             }
618:             return _stringColor  // Orange #CE9178 for string values
619:         }
620:         
621:         // Numbers and constants
622:         if highlightName.contains("number") || highlightName == "constant.numeric" {
623:             return _numberColor
624:         }
625:         
626:         // Comments
627:         if highlightName.contains("comment") {
628:             return _commentColor
629:         }
630:         
631:         // Functions and methods
632:         if highlightName.contains("function") || highlightName.contains("method") {
633:             return _functionColor
634:         }
635:         
636:         // Types, classes, structs
637:         if highlightName.contains("type") || highlightName.contains("class") ||
638:            highlightName.contains("struct") || highlightName.contains("interface") ||
639:            highlightName.contains("enum") {
640:             return _typeColor
641:         }
642:         
643:         // Variables, parameters, properties
644:         if highlightName.contains("variable") || highlightName.contains("parameter") ||
645:            highlightName.contains("property") || highlightName.contains("field") {
646:             return _variableColor
647:         }
648:         
649:         // Constants and booleans - use keyword color
650:         if highlightName.contains("constant") || highlightName.contains("boolean") {
651:             return _keywordColor
652:         }
653:         
654:         // Operators - use keyword color
655:         if highlightName.contains("operator") {
656:             return _keywordColor
657:         }
658:         
659:         // Namespaces and modules - use type color
660:         if highlightName.contains("namespace") || highlightName.contains("module") {
661:             return _typeColor
662:         }
663:         
664:         // Tags (HTML, XML) - use type color
665:         if highlightName.contains("tag") {
666:             return _typeColor
667:         }
668:         
669:         // Attributes - use variable color
670:         if highlightName.contains("attribute") {
671:             return _variableColor
672:         }
673:         
674:         // Spell checking highlights - ignore (return nil to use default)
675:         if highlightName.contains("spell") {
676:             return nil
677:         }
678:         
679:         // Include/import statements - use keyword color
680:         if highlightName.contains("include") {
681:             return _keywordColor
682:         }
683:         
684:         // Default: use standard text color
685:         return nil
686:     }
687:     
688:     func fontTraits(for rawHighlightName: String) -> FontTraits {
689:         let highlightName = rawHighlightName.lowercased()
690:         
691:         // Make comments italic
692:         if highlightName.contains("comment") {
693:             return .italic
694:         }
695:         
696:         // Make keywords bold
697:         if highlightName.contains("keyword") {
698:             return .bold
699:         }
700:         
701:         return []
702:     }
703: }
704: 
705: 
706: 
707: // MARK: - Preview
708: #if DEBUG
709: struct RunestoneEditorView_Previews: PreviewProvider {
710:     @State static var text = """
711:     func hello() {
712:         print("Hello, World!")
713:     }
714:     
715:     // This is a comment
716:     let number = 42
717:     let string = "test"
718:     """
719:     @State static var scrollOffset: CGFloat = 0
720:     @State static var totalLines = 7
721:     @State static var currentLineNumber = 1
722:     @State static var currentColumn = 1
723:     @State static var cursorIndex = 0
724:     
725:     static var previews: some View {
726:         RunestoneEditorView(
727:             text: $text,
728:             filename: "test.swift",
729:             scrollOffset: $scrollOffset,
730:             totalLines: $totalLines,
731:             currentLineNumber: $currentLineNumber,
732:             currentColumn: $currentColumn,
733:             cursorIndex: $cursorIndex,
734:             isActive: true,
735:             fontSize: 14
736:         )
737:         .environmentObject(EditorCore())
738:     }
739: }
740: #endif
741: 


Now I understand the color flow. The `textColor(for rawHighlightName: String) -> UIColor?` method at line 586 maps highlight names to colors. Let me trace where colors come from by finding the ThemeManager.

>>>TOOL search
{"query": "ThemeManager", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "keyword.*Color", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "struct Theme", "glob": "*.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[search]
No matches found for "ThemeManager"

---

[search]
No matches found for "keyword.*Color"

---

[search]
No matches found for "struct Theme"


>>>TOOL search
{"query": "class ThemeManager", "glob": "**/*.swift"}
>>>END

>>>TOOL search
{"query": "var keyword", "glob": "**/*.swift"}
>>>END

>>>TOOL list_dir
{"path": "VSCodeiPadOS/VSCodeiPadOS/Models"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[search]
No matches found for "class ThemeManager"

---

[search]
Found 1 matches:
VSCodeiPadOS/VSCodeiPadOS/Views/Editor/SyntaxHighlightingTextView.swift:1780: var keywords = ["function", "var", "let", "const", "if", "else", "for", "while",

---

[list_dir]
ðŸ“ VSCodeiPadOS/VSCodeiPadOS/Models/
   EditorState.swift
   FileItem.swift
   FileItemUTType.swift
   FindViewModel.swift
   MultiCursor.swift
   Tab.swift
   Theme.swift
   ThemeManager.swift


>>>TOOL read_file
{"path": "VSCodeiPadOS/VSCodeiPadOS/Models/Theme.swift"}
>>>END

>>>TOOL read_file
{"path": "VSCodeiPadOS/VSCodeiPadOS/Models/ThemeManager.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[read_file]
File: VSCodeiPadOS/VSCodeiPadOS/Models/Theme.swift (lines 1-887 of 887)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1: import SwiftUI
2: 
3: struct Theme: Identifiable, Equatable, Hashable {
4:     let id: String
5:     let name: String
6:     let isDark: Bool
7:     
8:     // Editor Colors
9:     let editorBackground: Color
10:     let editorForeground: Color
11:     let selection: Color
12:     let cursor: Color
13:     let lineNumber: Color
14:     let lineNumberActive: Color
15:     let currentLineHighlight: Color
16:     let bracketPair1: Color
17:     let bracketPair2: Color
18:     let bracketPair3: Color
19:     let bracketPair4: Color
20:     let bracketPair5: Color
21:     let bracketPair6: Color
22:     let indentGuide: Color
23:     let indentGuideActive: Color
24:     
25:     // UI Colors
26:     let sidebarBackground: Color
27:     let sidebarForeground: Color
28:     let sidebarSectionHeader: Color
29:     let sidebarSelection: Color
30:     let activityBarBackground: Color
31:     let activityBarForeground: Color
32:     let activityBarSelection: Color
33:     let tabBarBackground: Color
34:     let tabActiveBackground: Color
35:     let tabInactiveBackground: Color
36:     let tabActiveForeground: Color
37:     let tabInactiveForeground: Color
38:     let statusBarBackground: Color
39:     let statusBarForeground: Color
40:     
41:     // Syntax Colors
42:     let keyword: Color
43:     let string: Color
44:     let number: Color
45:     let comment: Color
46:     let function: Color
47:     let type: Color
48:     let variable: Color
49:     
50:     // Helper for Hex Colors
51:     static func hex(_ hex: String) -> Color {
52:         var hexSanitized = hex.trimmingCharacters(in: .whitespacesAndNewlines)
53:         hexSanitized = hexSanitized.replacingOccurrences(of: "#", with: "")
54:         
55:         var rgb: UInt64 = 0
56:         Scanner(string: hexSanitized).scanHexInt64(&rgb)
57:         
58:         let r = Double((rgb & 0xFF0000) >> 16) / 255.0
59:         let g = Double((rgb & 0x00FF00) >> 8) / 255.0
60:         let b = Double(rgb & 0x0000FF) / 255.0
61:         
62:         return Color(red: r, green: g, blue: b)
63:     }
64:     
65:     // MARK: - VS Code Default Themes
66:     
67:     static let darkPlus = Theme(
68:         id: "dark_plus",
69:         name: "Dark+ (Default Dark)",
70:         isDark: true,
71:         editorBackground: hex("#1E1E1E"),
72:         editorForeground: hex("#D4D4D4"),
73:         selection: hex("#264F78"),
74:         cursor: hex("#AEAFAD"),
75:         lineNumber: hex("#858585"),
76:         lineNumberActive: hex("#C6C6C6"),
77:         currentLineHighlight: hex("#FFFFFF").opacity(0.1),
78:         bracketPair1: hex("#FFD700"),
79:         bracketPair2: hex("#DA70D6"),
80:         bracketPair3: hex("#179FFF"),
81:         bracketPair4: hex("#FFD700"),
82:         bracketPair5: hex("#DA70D6"),
83:         bracketPair6: hex("#179FFF"),
84:         indentGuide: hex("#404040"),
85:         indentGuideActive: hex("#707070"),
86:         sidebarBackground: hex("#252526"),
87:         sidebarForeground: hex("#CCCCCC"),
88:         sidebarSectionHeader: hex("#383838"),
89:         sidebarSelection: hex("#37373D"),
90:         activityBarBackground: hex("#333333"),
91:         activityBarForeground: hex("#FFFFFF"),
92:         activityBarSelection: hex("#FFFFFF"),
93:         tabBarBackground: hex("#252526"),
94:         tabActiveBackground: hex("#1E1E1E"),
95:         tabInactiveBackground: hex("#2D2D2D"),
96:         tabActiveForeground: hex("#FFFFFF"),
97:         tabInactiveForeground: hex("#969696"),
98:         statusBarBackground: hex("#007ACC"),
99:         statusBarForeground: hex("#FFFFFF"),
100:         keyword: hex("#569CD6"),
101:         string: hex("#CE9178"),
102:         number: hex("#B5CEA8"),
103:         comment: hex("#6A9955"),
104:         function: hex("#DCDCAA"),
105:         type: hex("#4EC9B0"),
106:         variable: hex("#9CDCFE")
107:     )
108:     
109:     static let lightPlus = Theme(
110:         id: "light_plus",
111:         name: "Light+ (Default Light)",
112:         isDark: false,
113:         editorBackground: hex("#FFFFFF"),
114:         editorForeground: hex("#000000"),
115:         selection: hex("#ADD6FF"),
116:         cursor: hex("#000000"),
117:         lineNumber: hex("#237893"),
118:         lineNumberActive: hex("#0B216F"),
119:         currentLineHighlight: hex("#000000").opacity(0.07),
120:         bracketPair1: hex("#0431FA"),
121:         bracketPair2: hex("#319331"),
122:         bracketPair3: hex("#7B3814"),
123:         bracketPair4: hex("#0431FA"),
124:         bracketPair5: hex("#319331"),
125:         bracketPair6: hex("#7B3814"),
126:         indentGuide: hex("#D3D3D3"),
127:         indentGuideActive: hex("#939393"),
128:         sidebarBackground: hex("#F3F3F3"),
129:         sidebarForeground: hex("#616161"),
130:         sidebarSectionHeader: hex("#E7E7E7"),
131:         sidebarSelection: hex("#E4E6F1"),
132:         activityBarBackground: hex("#2C2C2C"),
133:         activityBarForeground: hex("#FFFFFF"),
134:         activityBarSelection: hex("#FFFFFF"),
135:         tabBarBackground: hex("#F3F3F3"),
136:         tabActiveBackground: hex("#FFFFFF"),
137:         tabInactiveBackground: hex("#ECECEC"),
138:         tabActiveForeground: hex("#333333"),
139:         tabInactiveForeground: hex("#8E8E8E"),
140:         statusBarBackground: hex("#007ACC"),
141:         statusBarForeground: hex("#FFFFFF"),
142:         keyword: hex("#AF00DB"),
143:         string: hex("#A31515"),
144:         number: hex("#098658"),
145:         comment: hex("#008000"),
146:         function: hex("#795E26"),
147:         type: hex("#267F99"),
148:         variable: hex("#001080")
149:     )
150:     
151:     static let monokai = Theme(
152:         id: "monokai",
153:         name: "Monokai",
154:         isDark: true,
155:         editorBackground: hex("#272822"),
156:         editorForeground: hex("#F8F8F2"),
157:         selection: hex("#49483E"),
158:         cursor: hex("#F8F8F0"),
159:         lineNumber: hex("#90908A"),
160:         lineNumberActive: hex("#F8F8F2"),
161:         currentLineHighlight: hex("#3E3D32"),
162:         bracketPair1: hex("#F8F8F2"),
163:         bracketPair2: hex("#F92672"),
164:         bracketPair3: hex("#A6E22E"),
165:         bracketPair4: hex("#F8F8F2"),
166:         bracketPair5: hex("#F92672"),
167:         bracketPair6: hex("#A6E22E"),
168:         indentGuide: hex("#464741"),
169:         indentGuideActive: hex("#75715E"),
170:         sidebarBackground: hex("#272822"),
171:         sidebarForeground: hex("#F8F8F2"),
172:         sidebarSectionHeader: hex("#1E1F1C"),
173:         sidebarSelection: hex("#49483E"),
174:         activityBarBackground: hex("#1E1F1C"),
175:         activityBarForeground: hex("#F8F8F2"),
176:         activityBarSelection: hex("#F8F8F2"),
177:         tabBarBackground: hex("#1E1F1C"),
178:         tabActiveBackground: hex("#272822"),
179:         tabInactiveBackground: hex("#34352F"),
180:         tabActiveForeground: hex("#F8F8F2"),
181:         tabInactiveForeground: hex("#88846F"),
182:         statusBarBackground: hex("#75715E"),
183:         statusBarForeground: hex("#F8F8F2"),
184:         keyword: hex("#F92672"),
185:         string: hex("#E6DB74"),
186:         number: hex("#AE81FF"),
187:         comment: hex("#75715E"),
188:         function: hex("#A6E22E"),
189:         type: hex("#66D9EF"),
190:         variable: hex("#FD971F")
191:     )
192:     
193:     static let solarizedDark = Theme(
194:         id: "solarized_dark",
195:         name: "Solarized Dark",
196:         isDark: true,
197:         editorBackground: hex("#002B36"),
198:         editorForeground: hex("#839496"),
199:         selection: hex("#274642"),
200:         cursor: hex("#D30102"),
201:         lineNumber: hex("#586E75"),
202:         lineNumberActive: hex("#93A1A1"),
203:         currentLineHighlight: hex("#0A2933"),
204:         bracketPair1: hex("#859900"),
205:         bracketPair2: hex("#2AA198"),
206:         bracketPair3: hex("#268BD2"),
207:         bracketPair4: hex("#859900"),
208:         bracketPair5: hex("#2AA198"),
209:         bracketPair6: hex("#268BD2"),
210:         indentGuide: hex("#073642"),
211:         indentGuideActive: hex("#586E75"),
212:         sidebarBackground: hex("#00252E"),
213:         sidebarForeground: hex("#93A1A1"),
214:         sidebarSectionHeader: hex("#001F27"),
215:         sidebarSelection: hex("#073642"),
216:         activityBarBackground: hex("#002B36"),
217:         activityBarForeground: hex("#93A1A1"),
218:         activityBarSelection: hex("#FDF6E3"),
219:         tabBarBackground: hex("#002B36"),
220:         tabActiveBackground: hex("#002B36"),
221:         tabInactiveBackground: hex("#00212B"),
222:         tabActiveForeground: hex("#93A1A1"),
223:         tabInactiveForeground: hex("#586E75"),
224:         statusBarBackground: hex("#00212B"),
225:         statusBarForeground: hex("#93A1A1"),
226:         keyword: hex("#859900"),
227:         string: hex("#2AA198"),
228:         number: hex("#D33682"),
229:         comment: hex("#586E75"),
230:         function: hex("#268BD2"),
231:         type: hex("#CB4B16"),
232:         variable: hex("#B58900")
233:     )
234:     
235:     static let solarizedLight = Theme(
236:         id: "solarized_light",
237:         name: "Solarized Light",
238:         isDark: false,
239:         editorBackground: hex("#FDF6E3"),
240:         editorForeground: hex("#657B83"),
241:         selection: hex("#EEE8D5"),
242:         cursor: hex("#D30102"),
243:         lineNumber: hex("#93A1A1"),
244:         lineNumberActive: hex("#586E75"),
245:         currentLineHighlight: hex("#EEE8D5"),
246:         bracketPair1: hex("#859900"),
247:         bracketPair2: hex("#2AA198"),
248:         bracketPair3: hex("#268BD2"),
249:         bracketPair4: hex("#859900"),
250:         bracketPair5: hex("#2AA198"),
251:         bracketPair6: hex("#268BD2"),
252:         indentGuide: hex("#EEE8D5"),
253:         indentGuideActive: hex("#93A1A1"),
254:         sidebarBackground: hex("#EEE8D5"),
255:         sidebarForeground: hex("#586E75"),
256:         sidebarSectionHeader: hex("#DDD6C1"),
257:         sidebarSelection: hex("#D3CBB8"),
258:         activityBarBackground: hex("#DDD6C1"),
259:         activityBarForeground: hex("#586E75"),
260:         activityBarSelection: hex("#073642"),
261:         tabBarBackground: hex("#EEE8D5"),
262:         tabActiveBackground: hex("#FDF6E3"),
263:         tabInactiveBackground: hex("#EEE8D5"),
264:         tabActiveForeground: hex("#073642"),
265:         tabInactiveForeground: hex("#93A1A1"),
266:         statusBarBackground: hex("#EEE8D5"),
267:         statusBarForeground: hex("#586E75"),
268:         keyword: hex("#859900"),
269:         string: hex("#2AA198"),
270:         number: hex("#D33682"),
271:         comment: hex("#93A1A1"),
272:         function: hex("#268BD2"),
273:         type: hex("#CB4B16"),
274:         variable: hex("#B58900")
275:     )
276:     
277:     static let dracula = Theme(
278:         id: "dracula",
279:         name: "Dracula",
280:         isDark: true,
281:         editorBackground: hex("#282A36"),
282:         editorForeground: hex("#F8F8F2"),
283:         selection: hex("#44475A"),
284:         cursor: hex("#F8F8F2"),
285:         lineNumber: hex("#6272A4"),
286:         lineNumberActive: hex("#F8F8F2"),
287:         currentLineHighlight: hex("#44475A"),
288:         bracketPair1: hex("#F8F8F2"),
289:         bracketPair2: hex("#FF79C6"),
290:         bracketPair3: hex("#8BE9FD"),
291:         bracketPair4: hex("#F8F8F2"),
292:         bracketPair5: hex("#FF79C6"),
293:         bracketPair6: hex("#8BE9FD"),
294:         indentGuide: hex("#424450"),
295:         indentGuideActive: hex("#6272A4"),
296:         sidebarBackground: hex("#21222C"),
297:         sidebarForeground: hex("#F8F8F2"),
298:         sidebarSectionHeader: hex("#191A21"),
299:         sidebarSelection: hex("#44475A"),
300:         activityBarBackground: hex("#343746"),
301:         activityBarForeground: hex("#F8F8F2"),
302:         activityBarSelection: hex("#F8F8F2"),
303:         tabBarBackground: hex("#191A21"),
304:         tabActiveBackground: hex("#282A36"),
305:         tabInactiveBackground: hex("#21222C"),
306:         tabActiveForeground: hex("#F8F8F2"),
307:         tabInactiveForeground: hex("#6272A4"),
308:         statusBarBackground: hex("#BD93F9"),
309:         statusBarForeground: hex("#282A36"),
310:         keyword: hex("#FF79C6"),
311:         string: hex("#F1FA8C"),
312:         number: hex("#BD93F9"),
313:         comment: hex("#6272A4"),
314:         function: hex("#50FA7B"),
315:         type: hex("#8BE9FD"),
316:         variable: hex("#FFB86C")
317:     )
318:     
319:     static let oneDarkPro = Theme(
320:         id: "one_dark_pro",
321:         name: "One Dark Pro",
322:         isDark: true,
323:         editorBackground: hex("#282C34"),
324:         editorForeground: hex("#ABB2BF"),
325:         selection: hex("#3E4451"),
326:         cursor: hex("#528BFF"),
327:         lineNumber: hex("#4B5263"),
328:         lineNumberActive: hex("#ABB2BF"),
329:         currentLineHighlight: hex("#2C313C"),
330:         bracketPair1: hex("#C678DD"),
331:         bracketPair2: hex("#61AFEF"),
332:         bracketPair3: hex("#E5C07B"),
333:         bracketPair4: hex("#C678DD"),
334:         bracketPair5: hex("#61AFEF"),
335:         bracketPair6: hex("#E5C07B"),
336:         indentGuide: hex("#3B4048"),
337:         indentGuideActive: hex("#5C6370"),
338:         sidebarBackground: hex("#21252B"),
339:         sidebarForeground: hex("#ABB2BF"),
340:         sidebarSectionHeader: hex("#282C34"),
341:         sidebarSelection: hex("#2C313A"),
342:         activityBarBackground: hex("#282C34"),
343:         activityBarForeground: hex("#ABB2BF"),
344:         activityBarSelection: hex("#D7DAE0"),
345:         tabBarBackground: hex("#21252B"),
346:         tabActiveBackground: hex("#282C34"),
347:         tabInactiveBackground: hex("#21252B"),
348:         tabActiveForeground: hex("#D7DAE0"),
349:         tabInactiveForeground: hex("#5C6370"),
350:         statusBarBackground: hex("#21252B"),
351:         statusBarForeground: hex("#9DA5B4"),
352:         keyword: hex("#C678DD"),
353:         string: hex("#98C379"),
354:         number: hex("#D19A66"),
355:         comment: hex("#5C6370"),
356:         function: hex("#61AFEF"),
357:         type: hex("#E5C07B"),
358:         variable: hex("#E06C75")
359:     )
360:     
361:     static let nord = Theme(
362:         id: "nord",
363:         name: "Nord",
364:         isDark: true,
365:         editorBackground: hex("#2E3440"),
366:         editorForeground: hex("#D8DEE9"),
367:         selection: hex("#434C5E"),
368:         cursor: hex("#D8DEE9"),
369:         lineNumber: hex("#4C566A"),
370:         lineNumberActive: hex("#D8DEE9"),
371:         currentLineHighlight: hex("#3B4252"),
372:         bracketPair1: hex("#EBCB8B"),
373:         bracketPair2: hex("#A3BE8C"),
374:         bracketPair3: hex("#81A1C1"),
375:         bracketPair4: hex("#EBCB8B"),
376:         bracketPair5: hex("#A3BE8C"),
377:         bracketPair6: hex("#81A1C1"),
378:         indentGuide: hex("#434C5E"),
379:         indentGuideActive: hex("#4C566A"),
380:         sidebarBackground: hex("#2E3440"),
381:         sidebarForeground: hex("#D8DEE9"),
382:         sidebarSectionHeader: hex("#3B4252"),
383:         sidebarSelection: hex("#3B4252"),
384:         activityBarBackground: hex("#2E3440"),
385:         activityBarForeground: hex("#D8DEE9"),
386:         activityBarSelection: hex("#88C0D0"),
387:         tabBarBackground: hex("#2E3440"),
388:         tabActiveBackground: hex("#3B4252"),
389:         tabInactiveBackground: hex("#2E3440"),
390:         tabActiveForeground: hex("#D8DEE9"),
391:         tabInactiveForeground: hex("#4C566A"),
392:         statusBarBackground: hex("#3B4252"),
393:         statusBarForeground: hex("#D8DEE9"),
394:         keyword: hex("#81A1C1"),
395:         string: hex("#A3BE8C"),
396:         number: hex("#B48EAD"),
397:         comment: hex("#616E88"),
398:         function: hex("#88C0D0"),
399:         type: hex("#8FBCBB"),
400:         variable: hex("#D8DEE9")
401:     )
402:     
403:     static let githubDark = Theme(
404:         id: "github_dark",
405:         name: "GitHub Dark",
406:         isDark: true,
407:         editorBackground: hex("#0D1117"),
408:         editorForeground: hex("#C9D1D9"),
409:         selection: hex("#163356"),
410:         cursor: hex("#58A6FF"),
411:         lineNumber: hex("#484F58"),
412:         lineNumberActive: hex("#C9D1D9"),
413:         currentLineHighlight: hex("#161B22"),
414:         bracketPair1: hex("#79C0FF"),
415:         bracketPair2: hex("#D2A8FF"),
416:         bracketPair3: hex("#FFA657"),
417:         bracketPair4: hex("#79C0FF"),
418:         bracketPair5: hex("#D2A8FF"),
419:         bracketPair6: hex("#FFA657"),
420:         indentGuide: hex("#21262D"),
421:         indentGuideActive: hex("#30363D"),
422:         sidebarBackground: hex("#010409"),
423:         sidebarForeground: hex("#C9D1D9"),
424:         sidebarSectionHeader: hex("#161B22"),
425:         sidebarSelection: hex("#1F2428"),
426:         activityBarBackground: hex("#0D1117"),
427:         activityBarForeground: hex("#C9D1D9"),
428:         activityBarSelection: hex("#C9D1D9"),
429:         tabBarBackground: hex("#010409"),
430:         tabActiveBackground: hex("#0D1117"),
431:         tabInactiveBackground: hex("#010409"),
432:         tabActiveForeground: hex("#C9D1D9"),
433:         tabInactiveForeground: hex("#8B949E"),
434:         statusBarBackground: hex("#0D1117"),
435:         statusBarForeground: hex("#58A6FF"),
436:         keyword: hex("#FF7B72"),
437:         string: hex("#A5D6FF"),
438:         number: hex("#79C0FF"),
439:         comment: hex("#8B949E"),
440:         function: hex("#D2A8FF"),
441:         type: hex("#79C0FF"),
442:         variable: hex("#FFA657")
443:     )
444:     
445:     static let githubLight = Theme(
446:         id: "github_light",
447:         name: "GitHub Light",
448:         isDark: false,
449:         editorBackground: hex("#FFFFFF"),
450:         editorForeground: hex("#24292F"),
451:         selection: hex("#B6E3FF"),
452:         cursor: hex("#0969DA"),
453:         lineNumber: hex("#8C959F"),
454:         lineNumberActive: hex("#24292F"),
455:         currentLineHighlight: hex("#F6F8FA"),
456:         bracketPair1: hex("#0550AE"),
457:         bracketPair2: hex("#8250DF"),
458:         bracketPair3: hex("#953800"),
459:         bracketPair4: hex("#0550AE"),
460:         bracketPair5: hex("#8250DF"),
461:         bracketPair6: hex("#953800"),
462:         indentGuide: hex("#D0D7DE"),
463:         indentGuideActive: hex("#8C959F"),
464:         sidebarBackground: hex("#F6F8FA"),
465:         sidebarForeground: hex("#24292F"),
466:         sidebarSectionHeader: hex("#EAEEF2"),
467:         sidebarSelection: hex("#DDFBE6"),
468:         activityBarBackground: hex("#F6F8FA"),
469:         activityBarForeground: hex("#24292F"),
470:         activityBarSelection: hex("#24292F"),
471:         tabBarBackground: hex("#F6F8FA"),
472:         tabActiveBackground: hex("#FFFFFF"),
473:         tabInactiveBackground: hex("#F6F8FA"),
474:         tabActiveForeground: hex("#24292F"),
475:         tabInactiveForeground: hex("#57606A"),
476:         statusBarBackground: hex("#F6F8FA"),
477:         statusBarForeground: hex("#0969DA"),
478:         keyword: hex("#CF222E"),
479:         string: hex("#0A3069"),
480:         number: hex("#0550AE"),
481:         comment: hex("#6E7781"),
482:         function: hex("#8250DF"),
483:         type: hex("#0550AE"),
484:         variable: hex("#953800")
485:     )
486:     
487:     static let cobalt2 = Theme(
488:         id: "cobalt2",
489:         name: "Cobalt2",
490:         isDark: true,
491:         editorBackground: hex("#193549"),
492:         editorForeground: hex("#FFFFFF"),
493:         selection: hex("#0D3A58"),
494:         cursor: hex("#FEFB00"),
495:         lineNumber: hex("#3D5F7D"),
496:         lineNumberActive: hex("#FFFFFF"),
497:         currentLineHighlight: hex("#1F4662"),
498:         bracketPair1: hex("#FFC600"),
499:         bracketPair2: hex("#FF628C"),
500:         bracketPair3: hex("#80FFBB"),
501:         bracketPair4: hex("#FFC600"),
502:         bracketPair5: hex("#FF628C"),
503:         bracketPair6: hex("#80FFBB"),
504:         indentGuide: hex("#294B5C"),
505:         indentGuideActive: hex("#3D5F7D"),
506:         sidebarBackground: hex("#15232D"),
507:         sidebarForeground: hex("#FFFFFF"),
508:         sidebarSectionHeader: hex("#0D1A23"),
509:         sidebarSelection: hex("#0D3A58"),
510:         activityBarBackground: hex("#193549"),
511:         activityBarForeground: hex("#FFFFFF"),
512:         activityBarSelection: hex("#FFC600"),
513:         tabBarBackground: hex("#15232D"),
514:         tabActiveBackground: hex("#193549"),
515:         tabInactiveBackground: hex("#15232D"),
516:         tabActiveForeground: hex("#FFFFFF"),
517:         tabInactiveForeground: hex("#3D5F7D"),
518:         statusBarBackground: hex("#15232D"),
519:         statusBarForeground: hex("#FFFFFF"),
520:         keyword: hex("#FF9D00"),
521:         string: hex("#A5FF90"),
522:         number: hex("#FF628C"),
523:         comment: hex("#0088FF"),
524:         function: hex("#FFC600"),
525:         type: hex("#80FFBB"),
526:         variable: hex("#9EFFFF")
527:     )
528:     
529:     static let ayuDark = Theme(
530:         id: "ayu_dark",
531:         name: "Ayu Dark",
532:         isDark: true,
533:         editorBackground: hex("#0A0E14"),
534:         editorForeground: hex("#B3B1AD"),
535:         selection: hex("#273747"),
536:         cursor: hex("#E6B450"),
537:         lineNumber: hex("#3D424D"),
538:         lineNumberActive: hex("#E6B450"),
539:         currentLineHighlight: hex("#0D1016"),
540:         bracketPair1: hex("#FFB454"),
541:         bracketPair2: hex("#59C2FF"),
542:         bracketPair3: hex("#AAD94C"),
543:         bracketPair4: hex("#FFB454"),
544:         bracketPair5: hex("#59C2FF"),
545:         bracketPair6: hex("#AAD94C"),
546:         indentGuide: hex("#1C212B"),
547:         indentGuideActive: hex("#3D424D"),
548:         sidebarBackground: hex("#0D1016"),
549:         sidebarForeground: hex("#B3B1AD"),
550:         sidebarSectionHeader: hex("#0A0E14"),
551:         sidebarSelection: hex("#273747"),
552:         activityBarBackground: hex("#0A0E14"),
553:         activityBarForeground: hex("#B3B1AD"),
554:         activityBarSelection: hex("#E6B450"),
555:         tabBarBackground: hex("#0D1016"),
556:         tabActiveBackground: hex("#0A0E14"),
557:         tabInactiveBackground: hex("#0D1016"),
558:         tabActiveForeground: hex("#B3B1AD"),
559:         tabInactiveForeground: hex("#3D424D"),
560:         statusBarBackground: hex("#0D1016"),
561:         statusBarForeground: hex("#B3B1AD"),
562:         keyword: hex("#FF8F40"),
563:         string: hex("#AAD94C"),
564:         number: hex("#DFBFFF"),
565:         comment: hex("#626A73"),
566:         function: hex("#FFB454"),
567:         type: hex("#59C2FF"),
568:         variable: hex("#B3B1AD")
569:     )
570:     
571:     static let ayuLight = Theme(
572:         id: "ayu_light",
573:         name: "Ayu Light",
574:         isDark: false,
575:         editorBackground: hex("#FAFAFA"),
576:         editorForeground: hex("#5C6166"),
577:         selection: hex("#D1E4F4"),
578:         cursor: hex("#FF9940"),
579:         lineNumber: hex("#9DA2A6"),
580:         lineNumberActive: hex("#FF9940"),
581:         currentLineHighlight: hex("#EFF0F1"),
582:         bracketPair1: hex("#F2AE49"),
583:         bracketPair2: hex("#399EE6"),
584:         bracketPair3: hex("#86B300"),
585:         bracketPair4: hex("#F2AE49"),
586:         bracketPair5: hex("#399EE6"),
587:         bracketPair6: hex("#86B300"),
588:         indentGuide: hex("#E7E8E9"),
589:         indentGuideActive: hex("#9DA2A6"),
590:         sidebarBackground: hex("#F0F0F0"),
591:         sidebarForeground: hex("#5C6166"),
592:         sidebarSectionHeader: hex("#E7E7E7"),
593:         sidebarSelection: hex("#D1E4F4"),
594:         activityBarBackground: hex("#F0F0F0"),
595:         activityBarForeground: hex("#5C6166"),
596:         activityBarSelection: hex("#FF9940"),
597:         tabBarBackground: hex("#F0F0F0"),
598:         tabActiveBackground: hex("#FAFAFA"),
599:         tabInactiveBackground: hex("#F0F0F0"),
600:         tabActiveForeground: hex("#5C6166"),
601:         tabInactiveForeground: hex("#9DA2A6"),
602:         statusBarBackground: hex("#F0F0F0"),
603:         statusBarForeground: hex("#5C6166"),
604:         keyword: hex("#FA8D3E"),
605:         string: hex("#86B300"),
606:         number: hex("#A37ACC"),
607:         comment: hex("#ABB0B6"),
608:         function: hex("#F2AE49"),
609:         type: hex("#399EE6"),
610:         variable: hex("#5C6166")
611:     )
612:     
613:     static let ayuMirage = Theme(
614:         id: "ayu_mirage",
615:         name: "Ayu Mirage",
616:         isDark: true,
617:         editorBackground: hex("#1F2430"),
618:         editorForeground: hex("#CBCCC6"),
619:         selection: hex("#33415E"),
620:         cursor: hex("#FFCC66"),
621:         lineNumber: hex("#707A8C"),
622:         lineNumberActive: hex("#FFCC66"),
623:         currentLineHighlight: hex("#232834"),
624:         bracketPair1: hex("#FFD580"),
625:         bracketPair2: hex("#73D0FF"),
626:         bracketPair3: hex("#BAE67E"),
627:         bracketPair4: hex("#FFD580"),
628:         bracketPair5: hex("#73D0FF"),
629:         bracketPair6: hex("#BAE67E"),
630:         indentGuide: hex("#2D3640"),
631:         indentGuideActive: hex("#707A8C"),
632:         sidebarBackground: hex("#232834"),
633:         sidebarForeground: hex("#CBCCC6"),
634:         sidebarSectionHeader: hex("#1F2430"),
635:         sidebarSelection: hex("#33415E"),
636:         activityBarBackground: hex("#1F2430"),
637:         activityBarForeground: hex("#CBCCC6"),
638:         activityBarSelection: hex("#FFCC66"),
639:         tabBarBackground: hex("#232834"),
640:         tabActiveBackground: hex("#1F2430"),
641:         tabInactiveBackground: hex("#232834"),
642:         tabActiveForeground: hex("#CBCCC6"),
643:         tabInactiveForeground: hex("#707A8C"),
644:         statusBarBackground: hex("#232834"),
645:         statusBarForeground: hex("#CBCCC6"),
646:         keyword: hex("#FFA759"),
647:         string: hex("#BAE67E"),
648:         number: hex("#D4BFFF"),
649:         comment: hex("#5C6773"),
650:         function: hex("#FFD580"),
651:         type: hex("#73D0FF"),
652:         variable: hex("#CBCCC6")
653:     )
654:     
655:     static let quietLight = Theme(
656:         id: "quiet_light",
657:         name: "Quiet Light",
658:         isDark: false,
659:         editorBackground: hex("#F5F5F5"),
660:         editorForeground: hex("#333333"),
661:         selection: hex("#C9D0D9"),
662:         cursor: hex("#54494B"),
663:         lineNumber: hex("#AAAAAA"),
664:         lineNumberActive: hex("#333333"),
665:         currentLineHighlight: hex("#E4F6D4"),
666:         bracketPair1: hex("#7A3E9D"),
667:         bracketPair2: hex("#448C27"),
668:         bracketPair3: hex("#4B83CD"),
669:         bracketPair4: hex("#7A3E9D"),
670:         bracketPair5: hex("#448C27"),
671:         bracketPair6: hex("#4B83CD"),
672:         indentGuide: hex("#E0E0E0"),
673:         indentGuideActive: hex("#AAAAAA"),
674:         sidebarBackground: hex("#E7E7E7"),
675:         sidebarForeground: hex("#333333"),
676:         sidebarSectionHeader: hex("#DDDDDD"),
677:         sidebarSelection: hex("#C9D0D9"),
678:         activityBarBackground: hex("#E7E7E7"),
679:         activityBarForeground: hex("#333333"),
680:         activityBarSelection: hex("#333333"),
681:         tabBarBackground: hex("#E7E7E7"),
682:         tabActiveBackground: hex("#F5F5F5"),
683:         tabInactiveBackground: hex("#E7E7E7"),
684:         tabActiveForeground: hex("#333333"),
685:         tabInactiveForeground: hex("#AAAAAA"),
686:         statusBarBackground: hex("#E7E7E7"),
687:         statusBarForeground: hex("#333333"),
688:         keyword: hex("#4B83CD"),
689:         string: hex("#448C27"),
690:         number: hex("#AB6526"),
691:         comment: hex("#AAAAAA"),
692:         function: hex("#7A3E9D"),
693:         type: hex("#7A3E9D"),
694:         variable: hex("#333333")
695:     )
696:     
697:     static let red = Theme(
698:         id: "red",
699:         name: "Red",
700:         isDark: true,
701:         editorBackground: hex("#390000"),
702:         editorForeground: hex("#F8F8F8"),
703:         selection: hex("#750000"),
704:         cursor: hex("#FF0000"),
705:         lineNumber: hex("#FF6666"),
706:         lineNumberActive: hex("#FFFFFF"),
707:         currentLineHighlight: hex("#500000"),
708:         bracketPair1: hex("#FFFF66"),
709:         bracketPair2: hex("#AAFFAA"),
710:         bracketPair3: hex("#AADDFF"),
711:         bracketPair4: hex("#FFFF66"),
712:         bracketPair5: hex("#AAFFAA"),
713:         bracketPair6: hex("#AADDFF"),
714:         indentGuide: hex("#550000"),
715:         indentGuideActive: hex("#CC6666"),
716:         sidebarBackground: hex("#300000"),
717:         sidebarForeground: hex("#F8F8F8"),
718:         sidebarSectionHeader: hex("#500000"),
719:         sidebarSelection: hex("#750000"),
720:         activityBarBackground: hex("#390000"),
721:         activityBarForeground: hex("#F8F8F8"),
722:         activityBarSelection: hex("#FF0000"),
723:         tabBarBackground: hex("#300000"),
724:         tabActiveBackground: hex("#390000"),
725:         tabInactiveBackground: hex("#300000"),
726:         tabActiveForeground: hex("#FFFFFF"),
727:         tabInactiveForeground: hex("#CC6666"),
728:         statusBarBackground: hex("#FF0000"),
729:         statusBarForeground: hex("#FFFFFF"),
730:         keyword: hex("#FF6666"),
731:         string: hex("#FFA0A0"),
732:         number: hex("#FFD0D0"),
733:         comment: hex("#CC6666"),
734:         function: hex("#FFFF66"),
735:         type: hex("#AAFFAA"),
736:         variable: hex("#AADDFF")
737:     )
738:     
739:     static let tomorrowNight = Theme(
740:         id: "tomorrow_night",
741:         name: "Tomorrow Night",
742:         isDark: true,
743:         editorBackground: hex("#1D1F21"),
744:         editorForeground: hex("#C5C8C6"),
745:         selection: hex("#373B41"),
746:         cursor: hex("#AEAFAD"),
747:         lineNumber: hex("#969896"),
748:         lineNumberActive: hex("#C5C8C6"),
749:         currentLineHighlight: hex("#282A2E"),
750:         bracketPair1: hex("#F0C674"),
751:         bracketPair2: hex("#B5BD68"),
752:         bracketPair3: hex("#81A2BE"),
753:         bracketPair4: hex("#F0C674"),
754:         bracketPair5: hex("#B5BD68"),
755:         bracketPair6: hex("#81A2BE"),
756:         indentGuide: hex("#373B41"),
757:         indentGuideActive: hex("#969896"),
758:         sidebarBackground: hex("#1D1F21"),
759:         sidebarForeground: hex("#C5C8C6"),
760:         sidebarSectionHeader: hex("#282A2E"),
761:         sidebarSelection: hex("#373B41"),
762:         activityBarBackground: hex("#1D1F21"),
763:         activityBarForeground: hex("#C5C8C6"),
764:         activityBarSelection: hex("#81A2BE"),
765:         tabBarBackground: hex("#1D1F21"),
766:         tabActiveBackground: hex("#282A2E"),
767:         tabInactiveBackground: hex("#1D1F21"),
768:         tabActiveForeground: hex("#C5C8C6"),
769:         tabInactiveForeground: hex("#969896"),
770:         statusBarBackground: hex("#282A2E"),
771:         statusBarForeground: hex("#C5C8C6"),
772:         keyword: hex("#B294BB"),
773:         string: hex("#B5BD68"),
774:         number: hex("#DE935F"),
775:         comment: hex("#969896"),
776:         function: hex("#81A2BE"),
777:         type: hex("#F0C674"),
778:         variable: hex("#CC6666")
779:     )
780:     
781:     static let tomorrowNightBlue = Theme(
782:         id: "tomorrow_night_blue",
783:         name: "Tomorrow Night Blue",
784:         isDark: true,
785:         editorBackground: hex("#002451"),
786:         editorForeground: hex("#FFFFFF"),
787:         selection: hex("#003F8E"),
788:         cursor: hex("#FFFFFF"),
789:         lineNumber: hex("#7285B7"),
790:         lineNumberActive: hex("#FFFFFF"),
791:         currentLineHighlight: hex("#00346E"),
792:         bracketPair1: hex("#FFEEAD"),
793:         bracketPair2: hex("#D1F1A9"),
794:         bracketPair3: hex("#BBDAFF"),
795:         bracketPair4: hex("#FFEEAD"),
796:         bracketPair5: hex("#D1F1A9"),
797:         bracketPair6: hex("#BBDAFF"),
798:         indentGuide: hex("#003875"),
799:         indentGuideActive: hex("#7285B7"),
800:         sidebarBackground: hex("#001E40"),
801:         sidebarForeground: hex("#FFFFFF"),
802:         sidebarSectionHeader: hex("#003875"),
803:         sidebarSelection: hex("#003F8E"),
804:         activityBarBackground: hex("#002451"),
805:         activityBarForeground: hex("#FFFFFF"),
806:         activityBarSelection: hex("#BBDAFF"),
807:         tabBarBackground: hex("#001E40"),
808:         tabActiveBackground: hex("#002451"),
809:         tabInactiveBackground: hex("#001E40"),
810:         tabActiveForeground: hex("#FFFFFF"),
811:         tabInactiveForeground: hex("#7285B7"),
812:         statusBarBackground: hex("#003875"),
813:         statusBarForeground: hex("#FFFFFF"),
814:         keyword: hex("#EBBBFF"),
815:         string: hex("#D1F1A9"),
816:         number: hex("#FFC58F"),
817:         comment: hex("#7285B7"),
818:         function: hex("#BBDAFF"),
819:         type: hex("#FFEEAD"),
820:         variable: hex("#FF9DA4")
821:     )
822:     
823:     static let highContrast = Theme(
824:         id: "high_contrast",
825:         name: "High Contrast",
826:         isDark: true,
827:         editorBackground: hex("#000000"),
828:         editorForeground: hex("#FFFFFF"),
829:         selection: hex("#FFFFFF").opacity(0.3),
830:         cursor: hex("#FFFFFF"),
831:         lineNumber: hex("#FFFFFF"),
832:         lineNumberActive: hex("#FFFFFF"),
833:         currentLineHighlight: hex("#FFFFFF").opacity(0.1),
834:         bracketPair1: hex("#FFD700"),
835:         bracketPair2: hex("#00FF00"),
836:         bracketPair3: hex("#00BFFF"),
837:         bracketPair4: hex("#FFD700"),
838:         bracketPair5: hex("#00FF00"),
839:         bracketPair6: hex("#00BFFF"),
840:         indentGuide: hex("#FFFFFF").opacity(0.2),
841:         indentGuideActive: hex("#FFFFFF").opacity(0.5),
842:         sidebarBackground: hex("#000000"),
843:         sidebarForeground: hex("#FFFFFF"),
844:         sidebarSectionHeader: hex("#000000"),
845:         sidebarSelection: hex("#FFFFFF").opacity(0.15),
846:         activityBarBackground: hex("#000000"),
847:         activityBarForeground: hex("#FFFFFF"),
848:         activityBarSelection: hex("#FFFFFF"),
849:         tabBarBackground: hex("#000000"),
850:         tabActiveBackground: hex("#000000"),
851:         tabInactiveBackground: hex("#000000"),
852:         tabActiveForeground: hex("#FFFFFF"),
853:         tabInactiveForeground: hex("#FFFFFF").opacity(0.6),
854:         statusBarBackground: hex("#0000AA"),
855:         statusBarForeground: hex("#FFFFFF"),
856:         keyword: hex("#569CD6"),
857:         string: hex("#CE9178"),
858:         number: hex("#B5CEA8"),
859:         comment: hex("#7CA668"),
860:         function: hex("#DCDCAA"),
861:         type: hex("#4EC9B0"),
862:         variable: hex("#9CDCFE")
863:     )
864:     
865:     // MARK: - All Themes
866:     static let allThemes: [Theme] = [
867:         .darkPlus,
868:         .lightPlus,
869:         .monokai,
870:         .solarizedDark,
871:         .solarizedLight,
872:         .dracula,
873:         .oneDarkPro,
874:         .nord,
875:         .githubDark,
876:         .githubLight,
877:         .cobalt2,
878:         .ayuDark,
879:         .ayuLight,
880:         .ayuMirage,
881:         .quietLight,
882:         .red,
883:         .tomorrowNight,
884:         .tomorrowNightBlue,
885:         .highContrast
886:     ]
887: }

---

[read_file]
File: VSCodeiPadOS/VSCodeiPadOS/Models/ThemeManager.swift (lines 1-77 of 77)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1: import SwiftUI
2: import Combine
3: 
4: class ThemeManager: ObservableObject {
5:     @AppStorage("selectedThemeId") var selectedThemeId: String = "dark_plus"
6:     @Published var currentTheme: Theme
7:     
8:     static let shared = ThemeManager()
9:     
10:     // Quick access to current theme
11:     static var current: Theme { shared.currentTheme }
12:     
13:     init() {
14:         let themeId = UserDefaults.standard.string(forKey: "selectedThemeId") ?? "dark_plus"
15:         self.currentTheme = Theme.allThemes.first(where: { $0.id == themeId }) ?? .darkPlus
16:     }
17:     
18:     func switchTheme(to themeId: String) {
19:         if let theme = Theme.allThemes.first(where: { $0.id == themeId }) {
20:             withAnimation(.easeInOut(duration: 0.2)) {
21:                 self.currentTheme = theme
22:             }
23:             self.selectedThemeId = themeId
24:         }
25:     }
26:     
27:     func switchTheme(to theme: Theme) {
28:         switchTheme(to: theme.id)
29:     }
30:     
31:     // Cycle to next theme
32:     func nextTheme() {
33:         let themes = Theme.allThemes
34:         guard let currentIndex = themes.firstIndex(where: { $0.id == currentTheme.id }) else {
35:             switchTheme(to: themes.first!)
36:             return
37:         }
38:         let nextIndex = (currentIndex + 1) % themes.count
39:         switchTheme(to: themes[nextIndex])
40:     }
41:     
42:     // Cycle to previous theme
43:     func previousTheme() {
44:         let themes = Theme.allThemes
45:         guard let currentIndex = themes.firstIndex(where: { $0.id == currentTheme.id }) else {
46:             switchTheme(to: themes.first!)
47:             return
48:         }
49:         let prevIndex = currentIndex == 0 ? themes.count - 1 : currentIndex - 1
50:         switchTheme(to: themes[prevIndex])
51:     }
52:     
53:     // Get themes by category
54:     var darkThemes: [Theme] {
55:         Theme.allThemes.filter { $0.isDark }
56:     }
57:     
58:     var lightThemes: [Theme] {
59:         Theme.allThemes.filter { !$0.isDark }
60:     }
61:     
62:     // Helper for file colors that adapts to theme
63:     func color(for filename: String) -> Color {
64:         let ext = (filename as NSString).pathExtension.lowercased()
65:         switch ext {
66:         case "swift": return .orange
67:         case "js", "jsx": return .yellow
68:         case "ts", "tsx": return .blue
69:         case "py": return .green
70:         case "html", "htm": return .red
71:         case "css", "scss": return .purple
72:         case "json": return .green
73:         case "md": return .blue
74:         default: return currentTheme.isDark ? .white : .black
75:         }
76:     }
77: }


Now I have the complete picture. Let me trace the color flow and identify potential failure points:

>>>TOOL read_file
{"path": "VSCodeiPadOS/VSCodeiPadOS/Views/Editor/SyntaxHighlightingTextView.swift", "start_line": 1, "end_line": 100}
>>>END

>>>TOOL web_search
{"query": "Runestone Theme textColor for highlightName not working syntax highlighting"}
>>>END

>>>TOOL search
{"query": "FontTraits", "glob": "*.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[read_file]
File: VSCodeiPadOS/VSCodeiPadOS/Views/Editor/SyntaxHighlightingTextView.swift (lines 2-100 of 2289)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2: //  SyntaxHighlightingTextView.swift
3: //  VSCodeiPadOS
4: //
5: //  Upgraded syntax highlighting with VSCode-like colors
6: //
7: 
8: import SwiftUI
9: import UIKit
10: 
11: /// UITextView wrapper with syntax highlighting support
12: struct SyntaxHighlightingTextView: UIViewRepresentable {
13:     @Binding var text: String
14:     let filename: String
15:     @Binding var scrollPosition: Int
16:     /// Pixel scroll offset (contentOffset.y) for smooth gutter alignment.
17:     @Binding var scrollOffset: CGFloat
18:     @Binding var totalLines: Int
19:     @Binding var visibleLines: Int
20:     @Binding var currentLineNumber: Int
21:     @Binding var currentColumn: Int
22:     @Binding var cursorIndex: Int
23:     @Binding var lineHeight: CGFloat
24:     @Binding var requestedLineSelection: Int?
25:     @Binding var requestedCursorIndex: Int?
26: 
27:     /// Autocomplete key handling hooks (return true if handled)
28:     let onAcceptAutocomplete: (() -> Bool)?
29:     let onDismissAutocomplete: (() -> Bool)?
30: 
31:     let isActive: Bool
32:     let fontSize: CGFloat  // Explicit parameter to trigger SwiftUI updates
33:     @EnvironmentObject var editorCore: EditorCore
34: 
35:     init(
36:         text: Binding<String>,
37:         filename: String,
38:         scrollPosition: Binding<Int>,
39:         scrollOffset: Binding<CGFloat> = .constant(0),
40:         totalLines: Binding<Int>,
41:         visibleLines: Binding<Int>,
42:         currentLineNumber: Binding<Int>,
43:         currentColumn: Binding<Int>,
44:         cursorIndex: Binding<Int> = .constant(0),
45:         lineHeight: Binding<CGFloat>,
46:         isActive: Bool,
47:         fontSize: CGFloat = 14.0,
48:         requestedLineSelection: Binding<Int?> = .constant(nil),
49:         requestedCursorIndex: Binding<Int?> = .constant(nil),
50:         onAcceptAutocomplete: (() -> Bool)? = nil,
51:         onDismissAutocomplete: (() -> Bool)? = nil
52:     ) {
53:         self._text = text
54:         self.filename = filename
55:         self._scrollPosition = scrollPosition
56:         self._scrollOffset = scrollOffset
57:         self._totalLines = totalLines
58:         self._visibleLines = visibleLines
59:         self._currentLineNumber = currentLineNumber
60:         self._currentColumn = currentColumn
61:         self._cursorIndex = cursorIndex
62:         self._lineHeight = lineHeight
63:         self.isActive = isActive
64:         self.fontSize = fontSize
65:         self._requestedLineSelection = requestedLineSelection
66:         self._requestedCursorIndex = requestedCursorIndex
67:         self.onAcceptAutocomplete = onAcceptAutocomplete
68:         self.onDismissAutocomplete = onDismissAutocomplete
69:     }
70:     
71:     // Compatibility init for older call sites (e.g. SplitEditorView) that pass editorCore explicitly.
72:     init(
73:         text: Binding<String>,
74:         filename: String,
75:         scrollPosition: Binding<Int>,
76:         scrollOffset: Binding<CGFloat> = .constant(0),
77:         totalLines: Binding<Int>,
78:         visibleLines: Binding<Int>,
79:         currentLineNumber: Binding<Int>,
80:         currentColumn: Binding<Int>,
81:         cursorIndex: Binding<Int> = .constant(0),
82:         lineHeight: Binding<CGFloat>,
83:         isActive: Bool,
84:         editorCore: EditorCore,
85:         requestedLineSelection: Binding<Int?> = .constant(nil),
86:         requestedCursorIndex: Binding<Int?> = .constant(nil),
87:         onAcceptAutocomplete: (() -> Bool)? = nil,
88:         onDismissAutocomplete: (() -> Bool)? = nil
89:     ) {
90:         self.init(
91:             text: text,
92:             filename: filename,
93:             scrollPosition: scrollPosition,
94:             scrollOffset: scrollOffset,
95:             totalLines: totalLines,
96:             visibleLines: visibleLines,
97:             currentLineNumber: currentLineNumber,
98:             currentColumn: currentColumn,
99:             cursorIndex: cursorIndex,
100:             lineHeight: lineHeight,

---

[web_search]
ðŸ” DuckDuckGo results for "Runestone Theme textColor for highlightName not working syntax highlighting" (10 results):

1. **Creating a Theme | Documentation - docs.runestone.app**
   https://docs.runestone.app/documentation/runestone/creatingatheme/
   The theme determines the text styling and colors to use when syntax highlighting text. Implement the following methods on Theme to specify the text styling and color of syntax highlighted text.

2. **After upgrading TreeSitterLanguages from 0.1.6 to 0.1.7 markdown is not ...**
   https://github.com/simonbs/Runestone/issues/259
   This allows me to render the bold markdown text as expected. However in 0.2.12 together with TreeSitterLanguages 0.1.7 the same input string in the text view is reported as punctuation.special. Therefore the highlighting code im my theme does not work as expected any more.

3. **Using Scopes for Syntax Highlighting - runestone.app**
   https://runestone.app/help/using-scopes-for-syntax-highlighting/
   Using Scopes for Syntax Highlighting Scopes are key to syntax highlighting in Runestone. When parsing the text in the editor, Runestone will assign a scope to the parts of the text to be syntax highlighted. These scopes map to a color and text style. Commonly used scopes include keyword, function, type, property and string.

4. **Syntax Highlighting the Text â€” Runestone Tutorials | Documentation**
   https://docs.runestone.app/tutorials/runestone/syntax-highlighting-the-text/
   Runestone Essentials Syntax Highlighting the Text This tutorial guides you through syntax highlighting text in a text view. In this guide we&#x27;ll add support for syntax highlighting JavaScript code to the text view we configured in Setting up a TextView. We&#x27;ll use the JavaScript syntax included in the TreeSitterLanguages Swift package.

5. **Adding a Theme â€” Runestone Tutorials | Documentation**
   https://docs.runestone.app/tutorials/runestone/adding-a-theme/
   This tutorial guides you through adding a custom theme to your project. You will add the Tomorrow theme to the TextCompanion app and use it when highlighting code. Before going through this tutorial, you should make sure to complete the Syntax Highlighting the Text tutorial.

6. **Runestone - Documentation**
   https://docs.runestone.app/documentation/runestone/
   Explore Runestone, the performant code editor with syntax highlighting, line numbers, invisible characters, and much more through a series of interactive tutorials.

7. **Syntax Highlighting - Tree-sitter**
   https://tree-sitter.github.io/tree-sitter/3-syntax-highlighting.html
   Syntax Highlighting Syntax highlighting is a very common feature in applications that deal with code. Tree-sitter has built-in support for syntax highlighting via the tree-sitter-highlight library, which is now used on GitHub.com for highlighting code written in several languages.

8. **Runestone - Performant plain text editor for iOS - GitHub**
   https://github.com/simonbs/runestone
   ðŸ“ Performant plain text editor for iOS with syntax highlighting, line numbers, invisible characters and much more. - simonbs/Runestone

9. **Visual Studio Code syntax highlighting not working**
   https://stackoverflow.com/questions/59775038/visual-studio-code-syntax-highlighting-not-working
   After the latest update, VSCode changed the theme to Dark Modern which is fine, but I wanted to use my existing one so I selected the Dark Theme (but my previous one was actually Dark+). The difference between the two is the syntax highlighting feature so switching to the Dark+ Theme fixed the syntax highlighting not being enabled.

10. **GitHub - shaneholloman/runestone: Performant plain text editor for ...**
   https://github.com/shaneholloman/runestone
   ðŸ“ Performant plain text editor for iOS with syntax highlighting, line numbers, invisible characters and much more. - shaneholloman/runestone

---

[search]
No matches found for "FontTraits"


Let me fetch the Runestone documentation to understand the Theme protocol better:

>>>TOOL web_fetch
{"url": "https://docs.runestone.app/documentation/runestone/creatingatheme/", "max_length": 10000}
>>>END

>>>TOOL web_fetch
{"url": "https://runestone.app/help/using-scopes-for-syntax-highlighting/", "max_length": 10000}
>>>END

---

## ðŸ”§ TOOL RESULTS

[web_fetch]
ðŸŒ https://docs.runestone.app/documentation/runestone/creatingatheme/

â€¢ 
â€¢ Documentation
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
# This page requires JavaScript.

Please turn on JavaScript in your browser and refresh the page to view its content.

---

[web_fetch]
ðŸŒ https://runestone.app/help/using-scopes-for-syntax-highlighting/

â€¢ Using Scopes for Syntax Highlighting
â€¢ 
â€¢ 
â€¢ 
Runestone
Plain text editor
Plain text editor for iPhone, iPad, and Apple Vision Pro[App Store](https://apps.apple.com/us/app/runestone-editor/id1548193893)[Get on App Store](https://apps.apple.com/us/app/runestone-editor/id1548193893)
# Using Scopes for Syntax Highlighting

Scopes are key to syntax highlighting in Runestone. When parsing the text in the editor, Runestone will assign a scope to the parts of the text to be syntax highlighted. These scopes map to a color and text style. Commonly used scopes include keyword, function, type, property and string.
For example, consider the following snippet of Swift code.
func increment(value: Int) -&gt; String {
    return value + 1
}

When parsed it will have had assigned the following scopes:TextScopefunckeyword.functionincrementmethod(punctuation.bracketvalueparameter:punctuation.delimiterInttype)punctuation.bracket-&gt;operatorStringtype{punctuation.bracketreturnkeyword.return+operator1number}punctuation.bracket
Note that some of the scopes use a dot-annotation like keyword.function. When looking up the color and text style for a scope, Runestone will use the longest matching name. So for the keyword.function scope it will attempt to find a color and text style that matches keyword.function and if none is found, it will look for a color and text style matching keyword. If no match is found it will fallback to the default styling.
In Runestone you can assign the color and text style to a scope when editing a theme under Settings â†’ Appearance â†’ Light/Dark Theme â†’ Scopes. The name of the scopes can be entered freely and you can add and remove scopes.

The supported scopes vary from language to language. Runestone's standard themes will include the scopes needed for all languages supported by Runestone and as such, it is a good idea to base your custom theme on one of Runestone's standard themes by long-pressing a standard theme and selecting Duplicate.

[](https://github.com/simonbs/Runestone)[](mailto:mail@runestone.app)[Help](/help)[Press Kit](/Runestone-PressKit.zip)


>>>TOOL read_file
{"path": "VSCodeiPadOS/VSCodeiPadOS/Views/Editor/SyntaxHighlightingTextView.swift", "start_line": 1, "end_line": 150}
>>>END

>>>TOOL search
{"query": "import Runestone", "glob": "*.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[read_file]
File: VSCodeiPadOS/VSCodeiPadOS/Views/Editor/SyntaxHighlightingTextView.swift (lines 2-150 of 2289)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2: //  SyntaxHighlightingTextView.swift
3: //  VSCodeiPadOS
4: //
5: //  Upgraded syntax highlighting with VSCode-like colors
6: //
7: 
8: import SwiftUI
9: import UIKit
10: 
11: /// UITextView wrapper with syntax highlighting support
12: struct SyntaxHighlightingTextView: UIViewRepresentable {
13:     @Binding var text: String
14:     let filename: String
15:     @Binding var scrollPosition: Int
16:     /// Pixel scroll offset (contentOffset.y) for smooth gutter alignment.
17:     @Binding var scrollOffset: CGFloat
18:     @Binding var totalLines: Int
19:     @Binding var visibleLines: Int
20:     @Binding var currentLineNumber: Int
21:     @Binding var currentColumn: Int
22:     @Binding var cursorIndex: Int
23:     @Binding var lineHeight: CGFloat
24:     @Binding var requestedLineSelection: Int?
25:     @Binding var requestedCursorIndex: Int?
26: 
27:     /// Autocomplete key handling hooks (return true if handled)
28:     let onAcceptAutocomplete: (() -> Bool)?
29:     let onDismissAutocomplete: (() -> Bool)?
30: 
31:     let isActive: Bool
32:     let fontSize: CGFloat  // Explicit parameter to trigger SwiftUI updates
33:     @EnvironmentObject var editorCore: EditorCore
34: 
35:     init(
36:         text: Binding<String>,
37:         filename: String,
38:         scrollPosition: Binding<Int>,
39:         scrollOffset: Binding<CGFloat> = .constant(0),
40:         totalLines: Binding<Int>,
41:         visibleLines: Binding<Int>,
42:         currentLineNumber: Binding<Int>,
43:         currentColumn: Binding<Int>,
44:         cursorIndex: Binding<Int> = .constant(0),
45:         lineHeight: Binding<CGFloat>,
46:         isActive: Bool,
47:         fontSize: CGFloat = 14.0,
48:         requestedLineSelection: Binding<Int?> = .constant(nil),
49:         requestedCursorIndex: Binding<Int?> = .constant(nil),
50:         onAcceptAutocomplete: (() -> Bool)? = nil,
51:         onDismissAutocomplete: (() -> Bool)? = nil
52:     ) {
53:         self._text = text
54:         self.filename = filename
55:         self._scrollPosition = scrollPosition
56:         self._scrollOffset = scrollOffset
57:         self._totalLines = totalLines
58:         self._visibleLines = visibleLines
59:         self._currentLineNumber = currentLineNumber
60:         self._currentColumn = currentColumn
61:         self._cursorIndex = cursorIndex
62:         self._lineHeight = lineHeight
63:         self.isActive = isActive
64:         self.fontSize = fontSize
65:         self._requestedLineSelection = requestedLineSelection
66:         self._requestedCursorIndex = requestedCursorIndex
67:         self.onAcceptAutocomplete = onAcceptAutocomplete
68:         self.onDismissAutocomplete = onDismissAutocomplete
69:     }
70:     
71:     // Compatibility init for older call sites (e.g. SplitEditorView) that pass editorCore explicitly.
72:     init(
73:         text: Binding<String>,
74:         filename: String,
75:         scrollPosition: Binding<Int>,
76:         scrollOffset: Binding<CGFloat> = .constant(0),
77:         totalLines: Binding<Int>,
78:         visibleLines: Binding<Int>,
79:         currentLineNumber: Binding<Int>,
80:         currentColumn: Binding<Int>,
81:         cursorIndex: Binding<Int> = .constant(0),
82:         lineHeight: Binding<CGFloat>,
83:         isActive: Bool,
84:         editorCore: EditorCore,
85:         requestedLineSelection: Binding<Int?> = .constant(nil),
86:         requestedCursorIndex: Binding<Int?> = .constant(nil),
87:         onAcceptAutocomplete: (() -> Bool)? = nil,
88:         onDismissAutocomplete: (() -> Bool)? = nil
89:     ) {
90:         self.init(
91:             text: text,
92:             filename: filename,
93:             scrollPosition: scrollPosition,
94:             scrollOffset: scrollOffset,
95:             totalLines: totalLines,
96:             visibleLines: visibleLines,
97:             currentLineNumber: currentLineNumber,
98:             currentColumn: currentColumn,
99:             cursorIndex: cursorIndex,
100:             lineHeight: lineHeight,
101:             isActive: isActive,
102:             fontSize: editorCore.editorFontSize,
103:             requestedLineSelection: requestedLineSelection,
104:             requestedCursorIndex: requestedCursorIndex,
105:             onAcceptAutocomplete: onAcceptAutocomplete,
106:             onDismissAutocomplete: onDismissAutocomplete
107:         )
108:     }
109: 
110:     func makeCoordinator() -> Coordinator {
111:         Coordinator(self)
112:     }
113:     
114:     func makeUIView(context: Context) -> UITextView {
115:         // Create custom TextKit stack with FoldingLayoutManager for code folding support
116:         let textStorage = NSTextStorage()
117:         let foldingLayoutManager = FoldingLayoutManager()
118:         textStorage.addLayoutManager(foldingLayoutManager)
119:         
120:         let textContainer = NSTextContainer(size: CGSize(width: CGFloat.greatestFiniteMagnitude, height: CGFloat.greatestFiniteMagnitude))
121:         textContainer.widthTracksTextView = true
122:         foldingLayoutManager.addTextContainer(textContainer)
123:         
124:         let textView = EditorTextView(frame: .zero, textContainer: textContainer)
125:         
126:         // Connect FoldingLayoutManager to EditorTextView
127:         foldingLayoutManager.ownerTextView = textView
128:         
129:         textView.delegate = context.coordinator
130:         textView.editorCore = editorCore
131:         
132:         // Code folding support
133:         textView.foldingManager = CodeFoldingManager.shared
134:         textView.fileId = filename
135: 
136:         // Autocomplete hooks
137:         textView.onAcceptAutocomplete = onAcceptAutocomplete
138:         textView.onDismissAutocomplete = onDismissAutocomplete
139: 
140:         textView.onPeekDefinition = {
141:             context.coordinator.handlePeekDefinition(in: textView)
142:         }
143: 
144:         textView.onEscape = {
145:             context.coordinator.handleEscape()
146:         }
147: 
148:         textView.onGoToLine = {
149:             self.editorCore.showGoToLine = true
150:         }

---

[search]
No matches found for "import Runestone"


>>>TOOL web_fetch
{"url": "https://docs.runestone.app/documentation/runestone/creatingatheme/", "max_length": 10000}
>>>END

---

## ðŸ”§ TOOL RESULTS

[web_fetch]
ðŸŒ https://docs.runestone.app/documentation/runestone/creatingatheme/

â€¢ 
â€¢ Documentation
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
# This page requires JavaScript.

Please turn on JavaScript in your browser and refresh the page to view its content.




>>>TOOL web_search
{"query": "Runestone swift github Theme protocol textColor highlightName"}
>>>END

>>>TOOL web_fetch
{"url": "https://github.com/simonbs/Runestone/blob/main/Sources/Runestone/Theme/Theme.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[web_search]
ðŸ” DuckDuckGo results for "Runestone swift github Theme protocol textColor highlightName" (10 results):

1. **Creating a Theme | Documentation - docs.runestone.app**
   https://docs.runestone.app/documentation/runestone/creatingatheme/
   Overview The Theme protocol can be used to customize the appearance of TextView. Runestone does not include any themes by default. However, you can find examples of themes in the example project that is included in Runestone&#x27;s repository on GitHub. Take a look at the documentation of the Theme protocol to get an overview of what aspects of TextView can be customized. Syntax Highlighting Text ...

2. **Runestone SwiftUI Example - GitHub**
   https://github.com/rosiebunnybear/RunestoneSwiftUIExample
   Runestone SwiftUI Example This is a SwiftUI implementation of the Runestone text editor example app, demonstrating how to integrate the Runestone framework with SwiftUI.

3. **Effortless SwiftUI Theming | Teabyte**
   https://alexanderweiss.dev/blog/2025-01-19-effortless-swiftui-theming
   Building on my previous [post] (/blog/2024-12-27-the-power-of-shapestyle-for-colour-theming-in-swiftui), let&#x27;s take a closer look at theming in SwiftUI. In this discussion, I&#x27;ll show you how to create a customizable solution that integrates seamlessly...

4. **How to style text views with fonts, colors, line spacing, and more**
   https://www.hackingwithswift.com/quick-start/swiftui/how-to-style-text-views-with-fonts-colors-line-spacing-and-more
   Updated for Xcode 16.4 Not only do text views give us a predictably wide range of control in terms of how they look, they are also designed to work seamlessly alongside core Apple technologies such as Dynamic Type. By default a Text view has a &quot;Body&quot; Dynamic Type style, but you can select from other sizes and weights by calling .font() on it like this: Text(&quot;This is an extremely long text ...

5. **Changing specific text&#x27;s color using NSMutableAttributedString in Swift**
   https://stackoverflow.com/questions/25207373/changing-specific-texts-color-using-nsmutableattributedstring-in-swift
   The issue I am having is that I want to be able to change the textColor of certain text in a TextView. I am using a concatenated string, and just want the strings I am appending into the TextView&#x27;s text. It appears that what I want to use is NSMutableAttributedString, but I am not finding any resources of how to use this in Swift. What I have so far is something like this:

6. **Effortless Theming in SwiftUI: Mastering Multiple Themes and Best ...**
   https://medium.com/@katramesh91/effortless-theming-in-swiftui-mastering-multiple-themes-and-best-practices-061113be6d3d
   This article focuses on the best practices for managing themes and styles in iOS apps. We&#x27;ll delve into effective methods of using fonts, colors, and styles that seamlessly support multiple themes.

7. **Dynamic Theming in SwiftUI Apps | Luke Roberts | Blog**
   https://blog.lukeroberts.co/posts/dynamic-theming/
   Next, I&#x27;m going to make an enum to represent all available themes in the app. This will help when displaying the theme options as well as persisting the user&#x27;s choice (more on that later). The enum will have cases for each theme and a computed property to return the theme object. I will also add some protocol conformances.

8. **SwiftUI - Text Color - Tutorial Kart**
   https://www.tutorialkart.com/swiftui/swiftui-text-color/
   SwiftUI - Text Color In SwiftUI, you can customize the text color of a Text view using the .foregroundColor(_:) modifier. This allows you to set the color of the text using predefined system colors or custom colors. In this tutorial, we will look at the basic syntax and some examples to understand how to set text colors in SwiftUI.

9. **Building a Custom Swift UI Theme: A Step-by-Step Guide**
   https://codezup.com/custom-swift-ui-theme-guide/
   Learn how to create a custom Swift UI theme with this step-by-step guide, perfect for iOS developers.

10. **SwiftThemeKit Reference - charlyk.github.io**
   https://charlyk.github.io/swift-theme-kit/
   SwiftThemeKit is a powerful and flexible design system framework for SwiftUI that enables you to create consistent, themeable user interfaces with ease. It provides a comprehensive set of components and utilities that follow modern design principles while maintaining full customizability.

---

[web_fetch]
Error: https://github.com/simonbs/Runestone/blob/main/Sources/Runestone/Theme/Theme.swift returned 404


>>>TOOL web_fetch
{"url": "https://raw.githubusercontent.com/simonbs/Runestone/main/Sources/Runestone/Theme/Theme.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[web_fetch]
Error: https://raw.githubusercontent.com/simonbs/Runestone/main/Sources/Runestone/Theme/Theme.swift returned 404


>>>TOOL web_fetch
{"url": "https://github.com/simonbs/Runestone"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[web_fetch]
ðŸŒ https://github.com/simonbs/Runestone

â€¢ 
  
â€¢ 
  
â€¢ 
  
â€¢ 
  
â€¢ 
  
â€¢ 

â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 

â€¢ 
    
â€¢ 
    
â€¢ 
    
â€¢ 
  
â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

  GitHub - simonbs/Runestone: ðŸ“ Performant plain text editor for iOS with syntax highlighting, line numbers, invisible characters and much more.

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 
  
â€¢ 
  
â€¢ 

â€¢ 

      [Skip to content](#start-of-content)

â€¢ 

â€¢ 

## Navigation Menu

    Toggle navigation

          [
            Sign in
          ](/login?return_to=https%3A%2F%2Fgithub.com%2Fsimonbs%2FRunestone)

Appearance settings

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ Platform

â€¢ AI CODE CREATION
â€¢ 

GitHub CopilotWrite better code with AI
â€¢ 
GitHub SparkBuild and deploy intelligent apps
â€¢ 
GitHub ModelsManage and compare prompts
â€¢ 

MCP RegistryNewIntegrate external tools
â€¢ DEVELOPER WORKFLOWS
â€¢ 
ActionsAutomate any workflow
â€¢ 

CodespacesInstant dev environments
â€¢ 
IssuesPlan and track work
â€¢ 
Code ReviewManage code changes
â€¢ APPLICATION SECURITY
â€¢ 

GitHub Advanced SecurityFind and fix vulnerabilities
â€¢ 

Code securitySecure your code as you build
â€¢ 
Secret protectionStop leaks before they start
â€¢ EXPLORE
â€¢ Why GitHub
â€¢ Documentation

â€¢ Blog

â€¢ Changelog

â€¢ MarketplaceView all features

â€¢ Solutions

â€¢ BY COMPANY SIZE
â€¢ Enterprises
â€¢ Small and medium teams
â€¢ Startups
â€¢ Nonprofits
â€¢ BY USE CASE
â€¢ App Modernization
â€¢ DevSecOps
â€¢ DevOps
â€¢ CI/CD
â€¢ View all use cases

â€¢ BY INDUSTRY
â€¢ Healthcare
â€¢ Financial services
â€¢ Manufacturing
â€¢ Government
â€¢ View all industries
View all solutions

â€¢ Resources

â€¢ EXPLORE BY TOPIC
â€¢ AI
â€¢ Software Development
â€¢ DevOps
â€¢ Security
â€¢ View all topics

â€¢ EXPLORE BY TYPE
â€¢ Customer stories
â€¢ Events & webinars
â€¢ Ebooks & reports
â€¢ Business insights
â€¢ GitHub Skills

â€¢ SUPPORT & SERVICES
â€¢ Documentation

â€¢ Customer support

â€¢ Community forum
â€¢ Trust center
â€¢ Partners
â€¢ Open Source

â€¢ COMMUNITY
â€¢ 
GitHub SponsorsFund open source developers
â€¢ PROGRAMS
â€¢ Security Lab

â€¢ Maintainer Community

â€¢ Accelerator
â€¢ Archive Program

â€¢ REPOSITORIES
â€¢ Topics
â€¢ Trending
â€¢ Collections
â€¢ Enterprise

â€¢ ENTERPRISE SOLUTIONS
â€¢ 

Enterprise platformAI-powered developer platform
â€¢ AVAILABLE ADD-ONS
â€¢ 

GitHub Advanced SecurityEnterprise-grade security features
â€¢ 

Copilot for BusinessEnterprise-grade AI features
â€¢ 

Premium SupportEnterprise-grade 24/7 support
â€¢ Pricing

        Search or jump to...

# Search code, repositories, users, issues, pull requests...

           -->

        Search

          Clear

            [Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)            

        Provide feedback

                 -->
          
We read every piece of feedback, and take your input very seriously.

          Include my email address so I can be contacted

                    Cancel

              Submit feedback

        Saved searches

## Use saved searches to filter your results more quickly

         -->

            Name

            Query

            To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

                    Cancel

              Create saved search

              [
                Sign in
              ](/login?return_to=https%3A%2F%2Fgithub.com%2Fsimonbs%2FRunestone)

              [
                Sign up
              ](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=simonbs%2FRunestone)

Appearance settings

â€¢ 

â€¢ 

          Resetting focus

        You signed in with another tab or window. [Reload]() to refresh your session.
        You signed out in another tab or window. [Reload]() to refresh your session.
        You switched accounts on another tab or window. [Reload]() to refresh your session.

Dismiss alert

      {{ message }}

      [
        simonbs
](/simonbs)    
    /
    
      [Runestone](/simonbs/Runestone)

    Public

â€¢ 

              Uh oh!

There was an error while loading. [Please reload this page]().

â€¢ 

Notifications
    You must be signed in to change notification settings

â€¢ 

Fork
    193

â€¢ 

          Star
          3k

        ðŸ“ Performant plain text editor for iOS with syntax highlighting, line numbers, invisible characters and much more.

      License

     MIT license

          3k
          stars

          193
          forks

          Branches

          Tags

          Activity

          Star

Notifications
    You must be signed in to change notification settings

â€¢ 

        Code

â€¢ 

        Issues
          31

â€¢ 

        Pull requests
          4

â€¢ 

        Actions

â€¢ 

        Security
          0

â€¢ 

        Insights

Additional navigation options

â€¢ 

          Code

â€¢ 

          Issues

â€¢ 

          Pull requests

â€¢ 

          Actions

â€¢ 

          Security

â€¢ 

          Insights

# simonbs/Runestone

â€¢ 

â€¢ 

Â main

Branches
Tags

Go to file
Code

Open more actions menu
## Folders and files
NameNameLast commit messageLast commit date
## Latest commit
Â 
## History

1,161 Commits
1,161 Commits
[.github](/simonbs/Runestone/tree/main/.github)
[.github](/simonbs/Runestone/tree/main/.github)Â Â 
[Assets](/simonbs/Runestone/tree/main/Assets)
[Assets](/simonbs/Runestone/tree/main/Assets)Â Â 
[Design](/simonbs/Runestone/tree/main/Design)
[Design](/simonbs/Runestone/tree/main/Design)Â Â 
[Example](/simonbs/Runestone/tree/main/Example)
[Example](/simonbs/Runestone/tree/main/Example)Â Â 
[Scripts](/simonbs/Runestone/tree/main/Scripts)
[Scripts](/simonbs/Runestone/tree/main/Scripts)Â Â 
[Sources](/simonbs/Runestone/tree/main/Sources)
[Sources](/simonbs/Runestone/tree/main/Sources)Â Â 
Tests/RunestoneTests
Tests/RunestoneTestsÂ Â 
[UITests](/simonbs/Runestone/tree/main/UITests)
[UITests](/simonbs/Runestone/tree/main/UITests)Â Â 
[.gitattributes](/simonbs/Runestone/blob/main/.gitattributes)
[.gitattributes](/simonbs/Runestone/blob/main/.gitattributes)Â Â 
[.gitignore](/simonbs/Runestone/blob/main/.gitignore)
[.gitignore](/simonbs/Runestone/blob/main/.gitignore)Â Â 
[.gitmodules](/simonbs/Runestone/blob/main/.gitmodules)
[.gitmodules](/simonbs/Runestone/blob/main/.gitmodules)Â Â 
[.spi.yml](/simonbs/Runestone/blob/main/.spi.yml)
[.spi.yml](/simonbs/Runestone/blob/main/.spi.yml)Â Â 
[.swiftlint.yml](/simonbs/Runestone/blob/main/.swiftlint.yml)
[.swiftlint.yml](/simonbs/Runestone/blob/main/.swiftlint.yml)Â Â 
[CODEOWNERS](/simonbs/Runestone/blob/main/CODEOWNERS)
[CODEOWNERS](/simonbs/Runestone/blob/main/CODEOWNERS)Â Â 
[LICENSE](/simonbs/Runestone/blob/main/LICENSE)
[LICENSE](/simonbs/Runestone/blob/main/LICENSE)Â Â 
[Package.resolved](/simonbs/Runestone/blob/main/Package.resolved)
[Package.resolved](/simonbs/Runestone/blob/main/Package.resolved)Â Â 
[Package.swift](/simonbs/Runestone/blob/main/Package.swift)
[Package.swift](/simonbs/Runestone/blob/main/Package.swift)Â Â 
[README.md](/simonbs/Runestone/blob/main/README.md)
[README.md](/simonbs/Runestone/blob/main/README.md)Â Â 
[swiftgen.yml](/simonbs/Runestone/blob/main/swiftgen.yml)
[swiftgen.yml](/simonbs/Runestone/blob/main/swiftgen.yml)Â Â View all files
## Repository files navigation

â€¢ 
README
â€¢ 
License

ðŸ‘‹ Welcome to Runestone - a performant plain text editor for iOS with code editing features

Runestone uses GitHub's [Tree-sitter](https://tree-sitter.github.io/tree-sitter/) to parse code to a syntax tree which is used for features that require an understanding of the code in the editor, for example syntax highlighting.

## âœ¨ Features

â€¢ Syntax highlighting.

â€¢ Line numbers.

â€¢ Highlight the selected line.

â€¢ Show invisible characters (tabs, spaces and line breaks).

â€¢ Insertion of character pairs, e.g. inserting the trailing quotation mark when inserting the leading.

â€¢ Customization of colors and fonts.

â€¢ Toggle line wrapping on and off.

â€¢ Adjust height of lines.

â€¢ Add a page guide.

â€¢ Add vertical and horizontal overscroll.

â€¢ Highlight ranges in the text view.

â€¢ Search the text using regular expressions.

â€¢ Automatically detects if a file is using spaces or tabs for indentation.

â€¢ Specify line endings (CR, LF, CRLF) to use when inserting a line break.

â€¢ Automatically detect line endings in a text.

## ðŸš€ Getting Started

Please refer to the [Getting Started](https://docs.runestone.app/documentation/runestone/gettingstarted) article in the documentation and the [Meet Runestone](https://docs.runestone.app/tutorials/meet-runestone) series of tutorials.

## ðŸ“– Documentation

The documentation of all public types is available at [docs.runestone.app](https://docs.runestone.app). The documentation is generated from the Swift code using Apple's [DocC documentation compiler](https://developer.apple.com/documentation/docc).

## ðŸŽ Performance

Runestone was built to be fast. Its good performance is by far mostly thanks to Tree-sitter's incremental parsing and [AvalonEdit's approach for managing lines in a document](https://github.com/icsharpcode/AvalonEdit/blob/master/ICSharpCode.AvalonEdit/Document/DocumentLineTree.cs).

When judging the performance of Runestone, it is key to build your app in the release configuration. The optimizations applied by the compiler when using the release configuration becomes very apparent when opening large documents.

## ðŸ–¥ Catalyst

The project should mostly work with Catalyst on the Mac, however, it isn't fully tested and the implementation isn't considered done. The focus is currently on the iPhone and iPad.

## ðŸ“± Projects

The Runestone framework is used by an app of the same name. The Runestone app is a plain text editor for iPhone and iPad that uses all the features of this framework.

## ðŸ‘¨â€ðŸ’» Contributing

Pull requests with bugfixes and new features are much appreciated. I'll be happy to review them and merge them once they're ready, as long as they contain change that fit within the vision of Runestone and provide generally useful functionality.

Clone the repository to get started working on the project. Note that Runestone depends on Tree-sitter through a submodule. This submodule must be cloned as well before Runestone can be built. Pass the --recursive option when cloning the repository to clone all submodules.

git clone --recursive git@github.com:simonbs/Runestone.git

## â¤ï¸ Acknowledgments

â€¢ [Tree-sitter](https://tree-sitter.github.io/tree-sitter) is used to parse code incrementally.

â€¢ Line management is translated to Swift from [AvalonEdit](https://github.com/icsharpcode/AvalonEdit).

â€¢ [swift-tree-sitter](https://github.com/viktorstrate/swift-tree-sitter) and [SwiftTreeSitter](https://github.com/ChimeHQ/SwiftTreeSitter) which have served as inspiration for the Tree-sitter bindings.

â€¢ Detection of indent strategy inspired by [auto-detect-indentation](https://github.com/jtokoph/auto-detect-indentation).

â€¢ And last (but not least!), thanks a ton to [Alexander Blach](https://twitter.com/Lextar) (developer of [Textastic](https://www.textasticapp.com)), [Till Konitzer](https://twitter.com/knutknatter) (developer of [Essayist](https://www.essayist.app)), [Greg Pierce](https://twitter.com/agiletortoise) (developer of [Drafts](https://getdrafts.com)) and [Max Brunsfeld](https://twitter.com/maxbrunsfeld) (developer of [Tree-sitter](https://tree-sitter.github.io/tree-sitter/)) for pointing me in the right direction when I got stuck.

## About

        ðŸ“ Performant plain text editor for iOS with syntax highlighting, line numbers, invisible characters and much more.

    Topics

      [
  swift
](/topics/swift)
      [
  ios
](/topics/ios)
      [
  tree-sitter
](/topics/tree-sitter)

    Resources

        Readme

    License

     MIT license

              Uh oh!

There was an error while loading. [Please reload this page]().

        Activity    

    Stars

        3k
        stars    

    Watchers

        20
        watching    

    Forks

        193
        forks    

      [
          Report repository
](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fsimonbs%2FRunestone&report=simonbs+%28user%29)    

  Releases
      28

        0.5.1
        
          Latest
      
      Jun 11, 2024

      [+ 27 releases](/simonbs/Runestone/releases)

## Sponsor this project

 Sponsor

              Uh oh!

There was an error while loading. [Please reload this page]().

    [Learn more about GitHub Sponsors](/sponsors)

              Uh oh!

There was an error while loading. [Please reload this page]().

  Contributors
      16

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

              Uh oh!

There was an error while loading. [Please reload this page]().

    [+ 2 contributors](/simonbs/Runestone/graphs/contributors)

## Languages

â€¢ 

          Swift
          99.4%

â€¢ 

          Shell
          0.6%

## Footer

        &copy; 2026 GitHub, Inc.

      Footer navigation

â€¢ 
            [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)

â€¢ 
            [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)

â€¢ 
            [Security](https://github.com/security)

â€¢ 
            [Status](https://www.githubstatus.com/)

â€¢ 
            [Community](https://github.community/)

â€¢ 
            [Docs](https://docs.github.com/)

â€¢ 
            [Contact](https://support.github.com?tags=dotcom-footer)

â€¢ 

       Manage cookies

â€¢ 

      Do not share my personal information

    You canâ€™t perform that action at this time.


>>>TOOL web_fetch
{"url": "https://raw.githubusercontent.com/simonbs/Runestone/main/Sources/Runestone/TextView/Theme.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[web_fetch]
Error: https://raw.githubusercontent.com/simonbs/Runestone/main/Sources/Runestone/TextView/Theme.swift returned 404


>>>TOOL web_fetch
{"url": "https://github.com/simonbs/Runestone/tree/main/Sources"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[web_fetch]
ðŸŒ https://github.com/simonbs/Runestone/tree/main/Sources

â€¢ 
  
â€¢ 
  
â€¢ 
  
â€¢ 
  
â€¢ 
  
â€¢ 

â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 
â€¢ 

â€¢ 
    
â€¢ 
    
â€¢ 
    
â€¢ 
  
â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ 

  Runestone/Sources at main Â· simonbs/Runestone Â· GitHub

â€¢ 

â€¢ 

â€¢ 

â€¢ 
  
â€¢ 
  
â€¢ 

â€¢ 

      [Skip to content](#start-of-content)

â€¢ 

â€¢ 

## Navigation Menu

    Toggle navigation

          [
            Sign in
          ](/login?return_to=https%3A%2F%2Fgithub.com%2Fsimonbs%2FRunestone%2Ftree%2Fmain%2FSources)

Appearance settings

â€¢ 

â€¢ 

â€¢ 

â€¢ 

â€¢ Platform

â€¢ AI CODE CREATION
â€¢ 

GitHub CopilotWrite better code with AI
â€¢ 
GitHub SparkBuild and deploy intelligent apps
â€¢ 
GitHub ModelsManage and compare prompts
â€¢ 

MCP RegistryNewIntegrate external tools
â€¢ DEVELOPER WORKFLOWS
â€¢ 
ActionsAutomate any workflow
â€¢ 

CodespacesInstant dev environments
â€¢ 
IssuesPlan and track work
â€¢ 
Code ReviewManage code changes
â€¢ APPLICATION SECURITY
â€¢ 

GitHub Advanced SecurityFind and fix vulnerabilities
â€¢ 

Code securitySecure your code as you build
â€¢ 
Secret protectionStop leaks before they start
â€¢ EXPLORE
â€¢ Why GitHub
â€¢ Documentation

â€¢ Blog

â€¢ Changelog

â€¢ MarketplaceView all features

â€¢ Solutions

â€¢ BY COMPANY SIZE
â€¢ Enterprises
â€¢ Small and medium teams
â€¢ Startups
â€¢ Nonprofits
â€¢ BY USE CASE
â€¢ App Modernization
â€¢ DevSecOps
â€¢ DevOps
â€¢ CI/CD
â€¢ View all use cases

â€¢ BY INDUSTRY
â€¢ Healthcare
â€¢ Financial services
â€¢ Manufacturing
â€¢ Government
â€¢ View all industries
View all solutions

â€¢ Resources

â€¢ EXPLORE BY TOPIC
â€¢ AI
â€¢ Software Development
â€¢ DevOps
â€¢ Security
â€¢ View all topics

â€¢ EXPLORE BY TYPE
â€¢ Customer stories
â€¢ Events & webinars
â€¢ Ebooks & reports
â€¢ Business insights
â€¢ GitHub Skills

â€¢ SUPPORT & SERVICES
â€¢ Documentation

â€¢ Customer support

â€¢ Community forum
â€¢ Trust center
â€¢ Partners
â€¢ Open Source

â€¢ COMMUNITY
â€¢ 
GitHub SponsorsFund open source developers
â€¢ PROGRAMS
â€¢ Security Lab

â€¢ Maintainer Community

â€¢ Accelerator
â€¢ Archive Program

â€¢ REPOSITORIES
â€¢ Topics
â€¢ Trending
â€¢ Collections
â€¢ Enterprise

â€¢ ENTERPRISE SOLUTIONS
â€¢ 

Enterprise platformAI-powered developer platform
â€¢ AVAILABLE ADD-ONS
â€¢ 

GitHub Advanced SecurityEnterprise-grade security features
â€¢ 

Copilot for BusinessEnterprise-grade AI features
â€¢ 

Premium SupportEnterprise-grade 24/7 support
â€¢ Pricing

        Search or jump to...

# Search code, repositories, users, issues, pull requests...

           -->

        Search

          Clear

            [Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)            

        Provide feedback

                 -->
          
We read every piece of feedback, and take your input very seriously.

          Include my email address so I can be contacted

                    Cancel

              Submit feedback

        Saved searches

## Use saved searches to filter your results more quickly

         -->

            Name

            Query

            To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

                    Cancel

              Create saved search

              [
                Sign in
              ](/login?return_to=https%3A%2F%2Fgithub.com%2Fsimonbs%2FRunestone%2Ftree%2Fmain%2FSources)

              [
                Sign up
              ](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Ffiles%2Fdisambiguate&source=header-repo&source_repo=simonbs%2FRunestone)

Appearance settings

â€¢ 

â€¢ 

          Resetting focus

        You signed in with another tab or window. [Reload]() to refresh your session.
        You signed out in another tab or window. [Reload]() to refresh your session.
        You switched accounts on another tab or window. [Reload]() to refresh your session.

Dismiss alert

      {{ message }}

      [
        simonbs
](/simonbs)    
    /
    
      [Runestone](/simonbs/Runestone)

    Public

â€¢ 

              Uh oh!

There was an error while loading. [Please reload this page]().

â€¢ 

Notifications
    You must be signed in to change notification settings

â€¢ 

Fork
    193

â€¢ 

          Star
          3k

â€¢ 

        Code

â€¢ 

        Issues
          31

â€¢ 

        Pull requests
          4

â€¢ 

        Actions

â€¢ 

        Security
          0

â€¢ 

        Insights

Additional navigation options

â€¢ 

          Code

â€¢ 

          Issues

â€¢ 

          Pull requests

â€¢ 

          Actions

â€¢ 

          Security

â€¢ 

          Insights

## Footer

        &copy; 2026 GitHub, Inc.

      Footer navigation

â€¢ 
            [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)

â€¢ 
            [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)

â€¢ 
            [Security](https://github.com/security)

â€¢ 
            [Status](https://www.githubstatus.com/)

â€¢ 
            [Community](https://github.community/)

â€¢ 
            [Docs](https://docs.github.com/)

â€¢ 
            [Contact](https://support.github.com?tags=dotcom-footer)

â€¢ 

       Manage cookies

â€¢ 

      Do not share my personal information

    You canâ€™t perform that action at this time.


Let me search for how the Runestone Theme protocol is actually used and look for any default text color fallback.

>>>TOOL read_file
{"path": "VSCodeiPadOS/VSCodeiPadOS/Views/Editor/RunestoneEditorView.swift", "start_line": 456, "end_line": 550}
>>>END

>>>TOOL search
{"query": "textView.theme", "glob": "*.swift"}
>>>END

>>>TOOL search
{"query": "func textColor", "glob": "*.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[read_file]
File: VSCodeiPadOS/VSCodeiPadOS/Views/Editor/RunestoneEditorView.swift (lines 457-550 of 741)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
457: // MARK: - Runestone Theme Implementation
458: 
459: /// Custom theme implementation for Runestone that maps app theme colors to editor appearance
460: class RunestoneEditorTheme: Runestone.Theme {
461:     let fontSize: CGFloat
462:     
463:     // Core colors
464:     private let _backgroundColor: UIColor
465:     private let _textColor: UIColor
466:     private let _gutterBackgroundColor: UIColor
467:     private let _gutterHairlineColor: UIColor
468:     private let _lineNumberColor: UIColor
469:     private let _selectedLineBackgroundColor: UIColor
470:     private let _selectedLinesLineNumberColor: UIColor
471:     private let _selectedLinesGutterBackgroundColor: UIColor
472:     private let _invisibleCharactersColor: UIColor
473:     private let _pageGuideHairlineColor: UIColor
474:     private let _pageGuideBackgroundColor: UIColor
475:     private let _markedTextBackgroundColor: UIColor
476:     
477:     // Syntax colors
478:     private let _keywordColor: UIColor
479:     private let _stringColor: UIColor
480:     private let _numberColor: UIColor
481:     private let _commentColor: UIColor
482:     private let _functionColor: UIColor
483:     private let _typeColor: UIColor
484:     private let _variableColor: UIColor
485:     
486:     init(
487:         fontSize: CGFloat,
488:         backgroundColor: UIColor,
489:         textColor: UIColor,
490:         gutterBackgroundColor: UIColor,
491:         gutterHairlineColor: UIColor,
492:         lineNumberColor: UIColor,
493:         selectedLineBackgroundColor: UIColor,
494:         selectedLinesLineNumberColor: UIColor,
495:         selectedLinesGutterBackgroundColor: UIColor,
496:         invisibleCharactersColor: UIColor,
497:         pageGuideHairlineColor: UIColor,
498:         pageGuideBackgroundColor: UIColor,
499:         markedTextBackgroundColor: UIColor,
500:         keywordColor: UIColor,
501:         stringColor: UIColor,
502:         numberColor: UIColor,
503:         commentColor: UIColor,
504:         functionColor: UIColor,
505:         typeColor: UIColor,
506:         variableColor: UIColor
507:     ) {
508:         self.fontSize = fontSize
509:         self._backgroundColor = backgroundColor
510:         self._textColor = textColor
511:         self._gutterBackgroundColor = gutterBackgroundColor
512:         self._gutterHairlineColor = gutterHairlineColor
513:         self._lineNumberColor = lineNumberColor
514:         self._selectedLineBackgroundColor = selectedLineBackgroundColor
515:         self._selectedLinesLineNumberColor = selectedLinesLineNumberColor
516:         self._selectedLinesGutterBackgroundColor = selectedLinesGutterBackgroundColor
517:         self._invisibleCharactersColor = invisibleCharactersColor
518:         self._pageGuideHairlineColor = pageGuideHairlineColor
519:         self._pageGuideBackgroundColor = pageGuideBackgroundColor
520:         self._markedTextBackgroundColor = markedTextBackgroundColor
521:         self._keywordColor = keywordColor
522:         self._stringColor = stringColor
523:         self._numberColor = numberColor
524:         self._commentColor = commentColor
525:         self._functionColor = functionColor
526:         self._typeColor = typeColor
527:         self._variableColor = variableColor
528:     }
529:     
530:     // MARK: - Theme Protocol Properties
531:     
532:     var font: UIFont {
533:         UIFont.monospacedSystemFont(ofSize: fontSize, weight: .regular)
534:     }
535:     
536:     var textColor: UIColor {
537:         _textColor
538:     }
539:     
540:     var gutterBackgroundColor: UIColor {
541:         _gutterBackgroundColor
542:     }
543:     
544:     var gutterHairlineColor: UIColor {
545:         _gutterHairlineColor
546:     }
547:     
548:     var lineNumberColor: UIColor {
549:         _lineNumberColor
550:     }

---

[search]
No matches found for "textView.theme"

---

[search]
No matches found for "func textColor"


Now let me check the full `textColor(for:)` method and look for any potential issues:

>>>TOOL read_file
{"path": "VSCodeiPadOS/VSCodeiPadOS/Views/Editor/RunestoneEditorView.swift", "start_line": 580, "end_line": 705}
>>>END

>>>TOOL read_file
{"path": "VSCodeiPadOS/FeatureFlags.swift"}
>>>END

---

## ðŸ”§ TOOL RESULTS

[read_file]
File: VSCodeiPadOS/VSCodeiPadOS/Views/Editor/RunestoneEditorView.swift (lines 581-705 of 741)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
581:         _markedTextBackgroundColor
582:     }
583:     
584:     // MARK: - Syntax Highlighting
585:     
586:     func textColor(for rawHighlightName: String) -> UIColor? {
587:         // Map TreeSitter highlight names to colors
588:         // See: https://tree-sitter.github.io/tree-sitter/syntax-highlighting#highlights
589:         let highlightName = rawHighlightName.lowercased()
590:         
591:         // Debug: Log ALL highlight names to console (remove in production)
592:         // print("ðŸŽ¨ HIGHLIGHT: '\(rawHighlightName)'")
593:         
594:         // Keywords
595:         if highlightName.contains("keyword") {
596:             return _keywordColor
597:         }
598:         
599:         // JSON/Object keys - MUST return color for specific patterns
600:         // TreeSitter JSON emits BOTH "string.special.key" AND "string" for keys
601:         // We handle specific patterns first, then skip generic "string" to avoid overwrite
602:         if highlightName.hasPrefix("string.special") ||
603:            highlightName.contains("label") ||
604:            highlightName.contains("property.definition") {
605:             return _variableColor  // Light blue #9CDCFE for keys
606:         }
607:         
608:         // Strings - but NOT if it's JUST "string" (let specific matches win)
609:         // Only color strings that are clearly values, not potential keys
610:         if highlightName.contains("string") {
611:             // If it's exactly "string" with no qualifiers, it might be a key
612:             // that was already colored by string.special.key - return nil to not overwrite
613:             if rawHighlightName == "string" {
614:                 // For pure "string" captures, still color them (they're values)
615:                 // The issue is ordering - specific patterns should come AFTER in Runestone
616:                 return _stringColor
617:             }
618:             return _stringColor  // Orange #CE9178 for string values
619:         }
620:         
621:         // Numbers and constants
622:         if highlightName.contains("number") || highlightName == "constant.numeric" {
623:             return _numberColor
624:         }
625:         
626:         // Comments
627:         if highlightName.contains("comment") {
628:             return _commentColor
629:         }
630:         
631:         // Functions and methods
632:         if highlightName.contains("function") || highlightName.contains("method") {
633:             return _functionColor
634:         }
635:         
636:         // Types, classes, structs
637:         if highlightName.contains("type") || highlightName.contains("class") ||
638:            highlightName.contains("struct") || highlightName.contains("interface") ||
639:            highlightName.contains("enum") {
640:             return _typeColor
641:         }
642:         
643:         // Variables, parameters, properties
644:         if highlightName.contains("variable") || highlightName.contains("parameter") ||
645:            highlightName.contains("property") || highlightName.contains("field") {
646:             return _variableColor
647:         }
648:         
649:         // Constants and booleans - use keyword color
650:         if highlightName.contains("constant") || highlightName.contains("boolean") {
651:             return _keywordColor
652:         }
653:         
654:         // Operators - use keyword color
655:         if highlightName.contains("operator") {
656:             return _keywordColor
657:         }
658:         
659:         // Namespaces and modules - use type color
660:         if highlightName.contains("namespace") || highlightName.contains("module") {
661:             return _typeColor
662:         }
663:         
664:         // Tags (HTML, XML) - use type color
665:         if highlightName.contains("tag") {
666:             return _typeColor
667:         }
668:         
669:         // Attributes - use variable color
670:         if highlightName.contains("attribute") {
671:             return _variableColor
672:         }
673:         
674:         // Spell checking highlights - ignore (return nil to use default)
675:         if highlightName.contains("spell") {
676:             return nil
677:         }
678:         
679:         // Include/import statements - use keyword color
680:         if highlightName.contains("include") {
681:             return _keywordColor
682:         }
683:         
684:         // Default: use standard text color
685:         return nil
686:     }
687:     
688:     func fontTraits(for rawHighlightName: String) -> FontTraits {
689:         let highlightName = rawHighlightName.lowercased()
690:         
691:         // Make comments italic
692:         if highlightName.contains("comment") {
693:             return .italic
694:         }
695:         
696:         // Make keywords bold
697:         if highlightName.contains("keyword") {
698:             return .bold
699:         }
700:         
701:         return []
702:     }
703: }
704: 
705: 

---

[read_file]
File: VSCodeiPadOS/FeatureFlags.swift (lines 1-12 of 12)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1: import Foundation
2: 
3: /// Feature flags for gradual rollout of new features
4: struct FeatureFlags {
5:     /// Use Runestone editor instead of legacy regex-based highlighting
6:     /// Set to false to rollback if issues occur
7:     static let useRunestoneEditor = true
8:     
9:     /// Enable verbose logging for editor performance debugging
10:     static let editorPerformanceLogging = false
11: }
12: 


Now I have a complete picture. Let me create a comprehensive debug theory:

>>>TOOL read_file
{"path": "VSCodeiPadOS/VSCodeiPadOS/Views/Editor/RunestoneEditorView.swift", "start_line": 103, "end_line": 145}
>>>END

---

## ðŸ”§ TOOL RESULTS

[read_file]
File: VSCodeiPadOS/VSCodeiPadOS/Views/Editor/RunestoneEditorView.swift (lines 104-145 of 741)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
104:         textView.backgroundColor = UIColor(ThemeManager.shared.currentTheme.editorBackground)
105:         
106:         // Content insets for padding
107:         textView.textContainerInset = UIEdgeInsets(top: 8, left: 8, bottom: 8, right: 8)
108:         
109:         // Set text with TreeSitter language support
110:         if let language = getTreeSitterLanguage(for: filename) {
111:             let state = TextViewState(text: text, language: language)
112:             textView.setState(state)
113:         } else {
114:             // No language support - fallback to plain text
115:             textView.text = text
116:         }
117:         
118:         // Store reference for coordinator
119:         context.coordinator.textView = textView
120:         
121:         // Initial line count
122:         DispatchQueue.main.async {
123:             self.totalLines = self.countLines(in: text)
124:         }
125:         
126:         return textView
127:     }
128:     
129:     func updateUIView(_ textView: TextView, context: Context) {
130:         // Update coordinator's parent reference for current bindings
131:         context.coordinator.parent = self
132:         
133:         // Update theme if changed
134:         let currentThemeId = ThemeManager.shared.currentTheme.id
135:         if context.coordinator.lastThemeId != currentThemeId {
136:             context.coordinator.lastThemeId = currentThemeId
137:             textView.theme = makeRunestoneTheme()
138:             textView.backgroundColor = UIColor(ThemeManager.shared.currentTheme.editorBackground)
139:         }
140:         
141:         // Update font size if changed
142:         if context.coordinator.lastFontSize != fontSize {
143:             context.coordinator.lastFontSize = fontSize
144:             textView.theme = makeRunestoneTheme()
145:         }


>>>TOOL read_file
{"path": "VSCodeiPadOS/VSCodeiPadOS/Views/Editor/RunestoneEditorView.swift", "start_line": 580, "end_line": 703}
>>>END

---

## ðŸ”§ TOOL RESULTS

[read_file]
File: VSCodeiPadOS/VSCodeiPadOS/Views/Editor/RunestoneEditorView.swift (lines 581-703 of 741)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
581:         _markedTextBackgroundColor
582:     }
583:     
584:     // MARK: - Syntax Highlighting
585:     
586:     func textColor(for rawHighlightName: String) -> UIColor? {
587:         // Map TreeSitter highlight names to colors
588:         // See: https://tree-sitter.github.io/tree-sitter/syntax-highlighting#highlights
589:         let highlightName = rawHighlightName.lowercased()
590:         
591:         // Debug: Log ALL highlight names to console (remove in production)
592:         // print("ðŸŽ¨ HIGHLIGHT: '\(rawHighlightName)'")
593:         
594:         // Keywords
595:         if highlightName.contains("keyword") {
596:             return _keywordColor
597:         }
598:         
599:         // JSON/Object keys - MUST return color for specific patterns
600:         // TreeSitter JSON emits BOTH "string.special.key" AND "string" for keys
601:         // We handle specific patterns first, then skip generic "string" to avoid overwrite
602:         if highlightName.hasPrefix("string.special") ||
603:            highlightName.contains("label") ||
604:            highlightName.contains("property.definition") {
605:             return _variableColor  // Light blue #9CDCFE for keys
606:         }
607:         
608:         // Strings - but NOT if it's JUST "string" (let specific matches win)
609:         // Only color strings that are clearly values, not potential keys
610:         if highlightName.contains("string") {
611:             // If it's exactly "string" with no qualifiers, it might be a key
612:             // that was already colored by string.special.key - return nil to not overwrite
613:             if rawHighlightName == "string" {
614:                 // For pure "string" captures, still color them (they're values)
615:                 // The issue is ordering - specific patterns should come AFTER in Runestone
616:                 return _stringColor
617:             }
618:             return _stringColor  // Orange #CE9178 for string values
619:         }
620:         
621:         // Numbers and constants
622:         if highlightName.contains("number") || highlightName == "constant.numeric" {
623:             return _numberColor
624:         }
625:         
626:         // Comments
627:         if highlightName.contains("comment") {
628:             return _commentColor
629:         }
630:         
631:         // Functions and methods
632:         if highlightName.contains("function") || highlightName.contains("method") {
633:             return _functionColor
634:         }
635:         
636:         // Types, classes, structs
637:         if highlightName.contains("type") || highlightName.contains("class") ||
638:            highlightName.contains("struct") || highlightName.contains("interface") ||
639:            highlightName.contains("enum") {
640:             return _typeColor
641:         }
642:         
643:         // Variables, parameters, properties
644:         if highlightName.contains("variable") || highlightName.contains("parameter") ||
645:            highlightName.contains("property") || highlightName.contains("field") {
646:             return _variableColor
647:         }
648:         
649:         // Constants and booleans - use keyword color
650:         if highlightName.contains("constant") || highlightName.contains("boolean") {
651:             return _keywordColor
652:         }
653:         
654:         // Operators - use keyword color
655:         if highlightName.contains("operator") {
656:             return _keywordColor
657:         }
658:         
659:         // Namespaces and modules - use type color
660:         if highlightName.contains("namespace") || highlightName.contains("module") {
661:             return _typeColor
662:         }
663:         
664:         // Tags (HTML, XML) - use type color
665:         if highlightName.contains("tag") {
666:             return _typeColor
667:         }
668:         
669:         // Attributes - use variable color
670:         if highlightName.contains("attribute") {
671:             return _variableColor
672:         }
673:         
674:         // Spell checking highlights - ignore (return nil to use default)
675:         if highlightName.contains("spell") {
676:             return nil
677:         }
678:         
679:         // Include/import statements - use keyword color
680:         if highlightName.contains("include") {
681:             return _keywordColor
682:         }
683:         
684:         // Default: use standard text color
685:         return nil
686:     }
687:     
688:     func fontTraits(for rawHighlightName: String) -> FontTraits {
689:         let highlightName = rawHighlightName.lowercased()
690:         
691:         // Make comments italic
692:         if highlightName.contains("comment") {
693:             return .italic
694:         }
695:         
696:         // Make keywords bold
697:         if highlightName.contains("keyword") {
698:             return .bold
699:         }
700:         
701:         return []
702:     }
703: }


>>>REPORT
# Debug Theory: Where Syntax Highlighting Colors Get Lost

## Color Flow Path (Traced through codebase)

1. **Theme Colors Defined** (`VSCodeiPadOS/VSCodeiPadOS/Models/Theme.swift`):
   - `Theme.darkPlus.keyword = hex("#569CD6")` (blue) - lines 100
   - Colors are defined as SwiftUI `Color` values

2. **Theme Manager** (`VSCodeiPadOS/VSCodeiPadOS/Models/ThemeManager.swift`):
   - `ThemeManager.shared.currentTheme` provides the active theme
   - Returns a `Theme` struct with syntax colors

3. **Runestone Theme Creation** (`RunestoneEditorView.swift` lines 204-227):
   - `makeRunestoneTheme()` converts app theme to `RunestoneEditorTheme`
   - `keywordColor: UIColor(appTheme.keyword)` - SwiftUI Color â†’ UIColor conversion

4. **Theme Applied to TextView** (`RunestoneEditorView.swift` line 103):
   - `textView.theme = makeRunestoneTheme()`

5. **Color Lookup** (`RunestoneEditorView.swift` lines 586-686):
   - `textColor(for rawHighlightName: String) -> UIColor?`
   - Returns `_keywordColor` when `highlightName.contains("keyword")`
   - Returns `nil` for unrecognized patterns (line 685)

## Potential Failure Points (Where Color Could Get Lost)

### 1. TreeSitter Language Not Loaded (MOST LIKELY)
**Location:** `RunestoneEditorView.swift` lines 110-116, 234-299
```swift
if let language = getTreeSitterLanguage(for: filename) {
    let state = TextViewState(text: text, language: language)
    textView.setState(state)
} else {
    textView.text = text  // NO SYNTAX HIGHLIGHTING!
}
```
- If `getTreeSitterLanguage()` returns `nil`, text is set as plain text
- **No TreeSitter parsing = no highlight names = no colors applied**
- Many languages return `PlainTextLanguageMode()` in `TreeSitterLanguages.swift` (lines 178-315)

### 2. Theme Not Re-Applied After Changes
**Location:** `RunestoneEditorView.swift` lines 135-145
```swift
if context.coordinator.lastThemeId != currentThemeId {
    context.coordinator.lastThemeId = currentThemeId
    textView.theme = makeRunestoneTheme()
}
```
- Theme updates depend on detecting `lastThemeId` change
- Race conditions could cause theme updates to be skipped

### 3. UIColor Initialization from SwiftUI Color
**Location:** `RunestoneEditorView.swift` line 220
```swift
keywordColor: UIColor(appTheme.keyword)
```
- `UIColor(Color)` initializer might behave unexpectedly on certain iOS versions
- Could return wrong color or default color

### 4. `textColor(for:)` Returning Nil
**Location:** `RunestoneEditorView.swift` line 685
```swift
// Default: use standard text color
return nil
```
- If highlight names don't match ANY pattern, `nil` is returned
- Runestone's fallback behavior when `nil` is returned is unknown
- **Debug step:** Uncomment line 592 to log all highlight names

### 5. Runestone Internal Defaults
- Runestone library may have its own internal default colors
- The `Theme` protocol might require additional properties not implemented
- Library could override colors internally

## Recommended Debug Steps

1. **Enable highlight name logging** (line 592):
   ```swift
   print("ðŸŽ¨ HIGHLIGHT: '\(rawHighlightName)'")
   ```
   - See what highlight names are actually being passed

2. **Verify TreeSitter language is loaded**:
   - Add logging in `getTreeSitterLanguage()` to confirm language detection
   - Check console for any TreeSitter parsing errors

3. **Verify UIColor values**:
   ```swift
   print("Keyword color: \(_keywordColor)")
   ```
   - Confirm colors are being initialized correctly

4. **Test with hardcoded colors**:
   - Replace `_keywordColor` with `UIColor.blue` directly
   - Confirms if issue is in color flow or Runestone internals

## Files Examined
- `VSCodeiPadOS/VSCodeiPadOS/Views/Editor/RunestoneEditorView.swift` (741 lines)
- `VSCodeiPadOS/VSCodeiPadOS/Models/Theme.swift` (887 lines)
- `VSCodeiPadOS/VSCodeiPadOS/Models/ThemeManager.swift` (77 lines)
- `VSCodeiPadOS/FeatureFlags.swift` (12 lines)
- `VSCodeiPadOS/TreeSitterLanguages.swift` (342 lines)
>>>END
