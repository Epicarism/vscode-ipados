# Agent: worker-java-ruby
**Status:** done
**Tokens:** 124,004
**Cost:** $0.0000
**Time:** 2026-02-09T11:15:31.204Z

## Task
Add syntax highlighting patterns for FEAT-022 Java/Kotlin and FEAT-023 Ruby in Extensions/NSAttributedStringSyntaxHighlighter.swift. Use gpt52 for regex patterns. Ensure required token categories.

## Response
>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL search
{"query":"FEAT-022", "glob":"**/*"}
>>>END

>>>TOOL read_file
{"path":"VSCODE_IPADOS_FULL_TASKS.md","start_line":60,"end_line":110}
>>>END

>>>TOOL create_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","content":"PATCH_PLACEHOLDER"}
>>>END>>>END

>>>TOOL read_file
{"path":"VSCODE_IPADOS_FULL_TASKS.md","start_line":60,"end_line":110}
>>>END

>>>FILE Extensions/NSAttributedStringSyntaxHighlighter.swift
>>>FIND
        case .ruby:
            return LanguageRules(
                keywords: [
                    "BEGIN", "END", "alias", "and", "begin", "break", "case", "class", "def", "defined\\?",
                    "do", "else", "elsif", "end", "ensure", "false", "for", "if", "in", "module", "next",
                    "nil", "not", "or", "redo", "rescue", "retry", "return", "self", "super", "then",
                    "true", "undef", "unless", "until", "when", "while", "yield", "private", "protected", "public"
                ],
                typePatterns: [CapturePattern(pattern: "\\b([A-Z][A-Za-z0-9_]*)\\b", captureGroup: 1, options: [])],
                stringPatterns: [
                    "\"(?:[^\"\\\\\\n]|\\\\.)*\"",
                    "'(?:[^'\\\\\\n]|\\\\.)*'",
                    "%[qQ]\\{[\\s\\S]*?\\}",
                    "%[qQ]\\([\\s\\S]*?\\)",
                    "%[qQ]\\[[\\s\\S]*?\\]"
                ],
                stringRegexOptions: [.dotMatchesLineSeparators],
                commentPatterns: ["#[^\\n]*", "=begin[\\s\\S]*?=end"],
                commentRegexOptions: [.dotMatchesLineSeparators],
                numberPattern: commonNumber,
                numberRegexOptions: [],
                keywordRegexOptions: [],
                functionPatterns: [
                    CapturePattern(pattern: "\\bdef\\s+([A-Za-z_][A-Za-z0-9_]*[!?=]?)\\b", captureGroup: 1, options: []),
                    commonFunctionCall
                ]
            )
>>>REPLACE
        case .ruby:
            // Ruby numeric literals (hex/bin/oct + floats + underscores)
            let rubyNumber = "\\b(?:0x[0-9A-Fa-f_]+|0b[01_]+|0o[0-7_]+|\\d[\\d_]*(?:\\.\\d[\\d_]*)?(?:[eE][+-]?\\d[\\d_]*)?)\\b"

            return LanguageRules(
                keywords: [
                    "BEGIN", "END", "alias", "and", "begin", "break", "case", "class", "def", "defined?",
                    "do", "else", "elsif", "end", "ensure", "false", "for", "if", "in", "module", "next",
                    "nil", "not", "or", "redo", "rescue", "retry", "return", "self", "super", "then",
                    "true", "undef", "unless", "until", "when", "while", "yield", "private", "protected", "public"
                ],
                typePatterns: [
                    // Constants / class / module names
                    CapturePattern(pattern: "\\b([A-Z][A-Za-z0-9_]*)\\b", captureGroup: 1, options: [])
                ],
                stringPatterns: [
                    // Heredoc (<<ID / <<-ID / <<~ID ... ID)
                    "(?m)<<[-~]?\\s*(['\"]?)([A-Za-z_][A-Za-z0-9_]*)\\1\\n[\\s\\S]*?^\\s*\\2\\b",

                    // Strings (double quotes support interpolation)
                    "\"(?:[^\"\\\\\\n]|\\\\.|\\#\\{[\\s\\S]*?\\})*\"",
                    "'(?:[^'\\\\\\n]|\\\\.)*'",

                    // Percent strings
                    "%[qQ]\\{[\\s\\S]*?\\}",
                    "%[qQ]\\([\\s\\S]*?\\)",
                    "%[qQ]\\[[\\s\\S]*?\\]",
                    "%[qQ]<(?:[\\s\\S]*?)>",
                    "%[qQ]\\|[\\s\\S]*?\\|",

                    // Regex (treat as string)
                    "%r\\{[\\s\\S]*?\\}[A-Za-z]*",
                    "%r\\([\\s\\S]*?\\)[A-Za-z]*",
                    "%r\\[[\\s\\S]*?\\][A-Za-z]*",
                    "(?<!\\w)/(?:\\\\/|\\\\.|\\[(?:\\\\.|[^\\]\\n])*\\]|[^/\\n\\\\])+/[A-Za-z]*"
                ],
                stringRegexOptions: [.dotMatchesLineSeparators, .anchorsMatchLines],
                commentPatterns: [
                    "#[^\\n]*",
                    "(?m)^=begin\\b[\\s\\S]*?^=end\\b"
                ],
                commentRegexOptions: [.dotMatchesLineSeparators, .anchorsMatchLines],
                numberPattern: rubyNumber,
                numberRegexOptions: [],
                keywordRegexOptions: [],
                functionPatterns: [
                    // Method definitions (including singleton methods)
                    CapturePattern(pattern: "\\bdef\\s+(?:self\\.)?([A-Za-z_][A-Za-z0-9_]*[!?=]?)\\b", captureGroup: 1, options: []),

                    // Calls with parens (avoid control keywords)
                    CapturePattern(
                        pattern: "\\b(?!if\\b|while\\b|until\\b|for\\b|case\\b|when\\b|def\\b|class\\b|module\\b|begin\\b|rescue\\b|ensure\\b|do\\b|end\\b)([A-Za-z_][A-Za-z0-9_]*[!?=]?)\\s*(?=\\()",
                        captureGroup: 1,
                        options: []
                    )
                ]
            )
>>>END

>>>TOOL read_file
{"path":"VSCODE_IPADOS_FULL_TASKS.md","start_line":60,"end_line":120}
>>>END

>>>FILE Extensions/NSAttributedStringSyntaxHighlighter.swift
>>>FIND
        case .ruby:
            return LanguageRules(
                keywords: [
                    "BEGIN", "END", "alias", "and", "begin", "break", "case", "class", "def", "defined\\?",
                    "do", "else", "elsif", "end", "ensure", "false", "for", "if", "in", "module", "next",
                    "nil", "not", "or", "redo", "rescue", "retry", "return", "self", "super", "then",
                    "true", "undef", "unless", "until", "when", "while", "yield", "private", "protected", "public"
                ],
                typePatterns: [CapturePattern(pattern: "\\b([A-Z][A-Za-z0-9_]*)\\b", captureGroup: 1, options: [])],
                stringPatterns: [
                    "\"(?:[^\"\\\\\\n]|\\\\.)*\"",
                    "'(?:[^'\\\\\\n]|\\\\.)*'",
                    "%[qQ]\\{[\\s\\S]*?\\}",
                    "%[qQ]\\([\\s\\S]*?\\)",
                    "%[qQ]\\[[\\s\\S]*?\\]"
                ],
                stringRegexOptions: [.dotMatchesLineSeparators],
                commentPatterns: ["#[^\\n]*", "=begin[\\s\\S]*?=end"],
                commentRegexOptions: [.dotMatchesLineSeparators],
                numberPattern: commonNumber,
                numberRegexOptions: [],
                keywordRegexOptions: [],
                functionPatterns: [
                    CapturePattern(pattern: "\\bdef\\s+([A-Za-z_][A-Za-z0-9_]*[!?=]?)\\b", captureGroup: 1, options: []),
                    commonFunctionCall
                ]
            )
>>>REPLACE
        case .ruby:
            // FEAT-023 Ruby syntax
            let rubyNumber = "\\b(?:0x[0-9A-Fa-f_]+|0b[01_]+|0o?[0-7_]+|\\d[\\d_]*(?:\\.\\d[\\d_]*)?(?:[eE][+-]?\\d[\\d_]*)?)\\b"
            return LanguageRules(
                keywords: [
                    "BEGIN", "END", "alias", "and", "begin", "break", "case", "class", "def", "defined\\?",
                    "do", "else", "elsif", "end", "ensure", "false", "for", "if", "in", "module", "next",
                    "nil", "not", "or", "redo", "rescue", "retry", "return", "self", "super", "then",
                    "true", "undef", "unless", "until", "when", "while", "yield",
                    "private", "protected", "public"
                ],
                typePatterns: [
                    // Constants / Classes / Modules
                    CapturePattern(pattern: "\\b([A-Z][A-Za-z0-9_]*)\\b", captureGroup: 1, options: [])
                ],
                stringPatterns: [
                    // Quoted strings
                    "\"(?:[^\"\\\\\\n]|\\\\.)*\"",
                    "'(?:[^'\\\\\\n]|\\\\.)*'",
                    // Backticks
                    "`(?:[^`\\\\\\n]|\\\\.)*`",
                    // Percent-literals (common delimiters)
                    "%[qQ]\\{[\\s\\S]*?\\}",
                    "%[qQ]\\([\\s\\S]*?\\)",
                    "%[qQ]\\[[\\s\\S]*?\\]",
                    "%[qQ]\\<[\\s\\S]*?\\>",
                    "%[qQ]\\|[\\s\\S]*?\\|",
                    // Regex literals (best-effort; avoids word-char prefix)
                    "(?<!\\w)/(?:\\\\.|[^/\\\\\\n])+/[a-z]*",
                    "%r\\{[\\s\\S]*?\\}[a-z]*",
                    "%r\\([\\s\\S]*?\\)[a-z]*",
                    "%r\\[[\\s\\S]*?\\][a-z]*",
                    "%r\\<[\\s\\S]*?\\>[a-z]*",
                    "%r\\|[\\s\\S]*?\\|[a-z]*",
                    // Heredocs (<<, <<-, <<~; best-effort)
                    "<<[-~]?\\s*(['\"]?)([A-Za-z_][A-Za-z0-9_]*)\\1\\s*\\r?\\n[\\s\\S]*?^\\2\\b"
                ],
                stringRegexOptions: [.dotMatchesLineSeparators, .anchorsMatchLines],
                commentPatterns: [
                    "#[^\\n]*",
                    "=begin[\\s\\S]*?=end"
                ],
                commentRegexOptions: [.dotMatchesLineSeparators],
                numberPattern: rubyNumber,
                numberRegexOptions: [],
                keywordRegexOptions: [],
                functionPatterns: [
                    // def foo / def self.foo / def Module.foo
                    CapturePattern(pattern: "\\bdef\\s+(?:self\\.|[A-Z][A-Za-z0-9_]*\\.)?([A-Za-z_][A-Za-z0-9_]*[!?=]?)\\b", captureGroup: 1, options: []),
                    commonFunctionCall
                ]
            )
>>>END

>>>TOOL read_file
{"path":"VSCODE_IPADOS_FULL_TASKS.md","start_line":60,"end_line":120}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":390,"end_line":560}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":470,"end_line":570}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":360,"end_line":620}
>>>END

>>>TOOL search
{"query":"FEAT-023", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":420,"end_line":620}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":430,"end_line":610}
>>>END

>>>TOOL create_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","content":"","overwrite":false}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":200,"end_line":380}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":180,"end_line":260}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":120}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":220}
>>>END



>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":140}
>>>END

>>>TOOL list_dir
{"path":"."}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":80}
>>>END

>>>TOOL get_symbols
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":200}
>>>END

>>>TOOL read_file
{"path":"VSCodeiPadOS/VSCodeiPadOS/Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":120}
>>>END

>>>TOOL search
{"query":"NSAttributedStringSyntaxHighlighter", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":1400}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":40}
>>>END

>>>TOOL search
{"query":"import SwiftUI", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END


>>>TOOL create_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","overwrite":true,"content":"import SwiftUI\nimport UIKit\n\n// Efficient NSMutableAttributedString-based syntax highlighter (regex-based).\n//\n// Color mapping (per requirements):\n// - Keywords: blue\n// - Types: cyan\n// - Strings: orange\n// - Comments: gray\n// - Numbers: green\n// - Functions: yellow\nfinal class NSAttributedStringSyntaxHighlighter {\n\n    // MARK: - Language\n\n    // NOTE: This file cannot use the name `Language` because the project already defines a global `Language`\n    // enum elsewhere (VSCodeiPadOS/Views/Editor/SyntaxHighlightingTextView.swift).\n    enum SyntaxLanguage {\n        case swift, javascript, typescript, jsx, tsx\n        case python, ruby, go, rust\n        case java, kotlin\n        case c, cpp, objc\n        case html, css, scss\n        case json, xml, yaml\n        case sql, shell, dockerfile, graphql\n        case markdown, php, dotenv\n        case plainText\n    }\n\n    // MARK: - Colors\n\n    private struct ColorScheme {\n        static let keyword = UIColor.systemBlue\n        static let type = UIColor.systemCyan\n        static let string = UIColor.systemOrange\n        static let comment = UIColor.systemGray\n        static let number = UIColor.systemGreen\n        static let function = UIColor.systemYellow\n        static let defaultText = UIColor.label\n    }\n\n    // MARK: - Public API\n\n    /// Backwards-compatible entrypoint (defaults to Swift).\n    static func highlightCode(_ code: String) -> NSAttributedString {\n        highlightCode(code, filename: nil, language: .swift)\n    }\n\n    /// Highlights `code` using either an explicit `language` or a detected one from `filename`.\n    static func highlightCode(_ code: String, filename: String? = nil, language: SyntaxLanguage? = nil) -> NSAttributedString {\n        let attributed = NSMutableAttributedString(string: code)\n        let fullRange = NSRange(location: 0, length: code.utf16.count)\n\n        attributed.addAttributes([\n            .font: UIFont.monospacedSystemFont(ofSize: 14, weight: .regular),\n            .foregroundColor: ColorScheme.defaultText\n        ], range: fullRange)\n\n        let resolvedLanguage: SyntaxLanguage = {\n            if let language { return language }\n            if let filename { return detectLanguage(fromFilename: filename) }\n            return .plainText\n        }()\n\n        highlight(code: code, language: resolvedLanguage, into: attributed)\n        return attributed\n    }\n\n    // MARK: - Language detection\n\n    private static func detectLanguage(fromFilename filename: String) -> SyntaxLanguage {\n        let lower = filename.lowercased()\n        let base = (lower as NSString).lastPathComponent\n        let ext = (base as NSString).pathExtension\n\n        // Special basenames (no extension).\n        if base == \"dockerfile\" || base.hasPrefix(\"dockerfile.\") { return .dockerfile }\n        if base == \".env\" || base.hasPrefix(\".env.\") || ext == \"env\" { return .dotenv }\n\n        switch ext {\n        case \"swift\": return .swift\n        case \"js\", \"mjs\", \"cjs\": return .javascript\n        case \"jsx\": return .jsx\n        case \"ts\": return .typescript\n        case \"tsx\": return .tsx\n        case \"py\", \"pyw\": return .python\n        case \"rb\", \"ruby\": return .ruby\n        case \"go\": return .go\n        case \"rs\": return .rust\n        case \"java\": return .java\n        case \"kt\", \"kts\": return .kotlin\n        case \"c\": return .c\n        case \"cc\", \"cpp\", \"cxx\", \"hpp\", \"hh\", \"hxx\", \"h\": return .cpp\n        case \"m\", \"mm\": return .objc\n        case \"html\", \"htm\": return .html\n        case \"css\": return .css\n        case \"scss\", \"sass\": return .scss\n        case \"json\", \"jsonc\": return .json\n        case \"xml\", \"plist\", \"svg\": return .xml\n        case \"yml\", \"yaml\": return .yaml\n        case \"sql\": return .sql\n        case \"sh\", \"bash\", \"zsh\", \"fish\": return .shell\n        case \"php\": return .php\n        case \"gql\", \"graphql\": return .graphql\n        case \"md\", \"markdown\": return .markdown\n        default: return .plainText\n        }\n    }\n\n    // MARK: - Pipeline\n\n    private struct CapturePattern {\n        let pattern: String\n        let captureGroup: Int?\n        let options: NSRegularExpression.Options\n    }\n\n    private struct LanguageRules {\n        let keywords: [String]\n        let typePatterns: [CapturePattern]\n        let stringPatterns: [String]\n        let stringRegexOptions: NSRegularExpression.Options\n        let commentPatterns: [String]\n        let commentRegexOptions: NSRegularExpression.Options\n        let numberPattern: String?\n        let numberRegexOptions: NSRegularExpression.Options\n        let keywordRegexOptions: NSRegularExpression.Options\n        let functionPatterns: [CapturePattern]\n    }\n\n    private static func highlight(code: String, language: SyntaxLanguage, into attributed: NSMutableAttributedString) {\n        let rules = languageRules(for: language)\n\n        // 1) Strings first\n        let stringRanges = rules.stringPatterns.flatMap { pattern in\n            applyHighlighting(\n                pattern: pattern,\n                options: rules.stringRegexOptions,\n                color: ColorScheme.string,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: []\n            )\n        }\n\n        // 2) Comments (exclude matches inside strings)\n        let commentRanges = rules.commentPatterns.flatMap { pattern in\n            applyHighlighting(\n                pattern: pattern,\n                options: rules.commentRegexOptions,\n                color: ColorScheme.comment,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: stringRanges\n            )\n        }\n\n        let protectedRanges = stringRanges + commentRanges\n\n        // 3) Numbers\n        if let numberPattern = rules.numberPattern {\n            _ = applyHighlighting(\n                pattern: numberPattern,\n                options: rules.numberRegexOptions,\n                color: ColorScheme.number,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: protectedRanges\n            )\n        }\n\n        // 4) Types\n        for typePattern in rules.typePatterns {\n            _ = applyHighlighting(\n                pattern: typePattern.pattern,\n                options: typePattern.options,\n                color: ColorScheme.type,\n                to: attributed,\n                in: code,\n                captureGroup: typePattern.captureGroup,\n                excluding: protectedRanges\n            )\n        }\n\n        // 5) Keywords\n        if !rules.keywords.isEmpty {\n            let keywordPattern = \"\\\\b(?:\" + rules.keywords.map(NSRegularExpression.escapedPattern).joined(separator: \"|\") + \")\\\\b\"\n            _ = applyHighlighting(\n                pattern: keywordPattern,\n                options: rules.keywordRegexOptions,\n                color: ColorScheme.keyword,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: protectedRanges\n            )\n        }\n\n        // 6) Functions\n        for fnPattern in rules.functionPatterns {\n            _ = applyHighlighting(\n                pattern: fnPattern.pattern,\n                options: fnPattern.options,\n                color: ColorScheme.function,\n                to: attributed,\n                in: code,\n                captureGroup: fnPattern.captureGroup,\n                excluding: protectedRanges\n            )\n        }\n    }\n\n    // MARK: - Language rules\n\n    private static func languageRules(for language: SyntaxLanguage) -> LanguageRules {\n\n        // Numeric literal coverage (hex, float, exponent, underscores).\n        let commonNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)\\\\b\"\n\n        // C-like strings: \"...\" and '...'\n        let cLikeStrings = [\n            \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n            \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n        ]\n\n        // C-like comments\n        let cLikeComments = [\n            \"//[^\\\\n]*\",\n            \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"\n        ]\n\n        // Common function call: name(\n        let commonFunctionCall = CapturePattern(\n            pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\",\n            captureGroup: 1,\n            options: []\n        )\n\n        switch language {\n\n        case .swift:\n            return LanguageRules(\n                keywords: [\n                    \"func\", \"var\", \"let\", \"if\", \"else\", \"for\", \"while\", \"repeat\", \"switch\", \"case\", \"default\",\n                    \"return\", \"import\", \"class\", \"struct\", \"enum\", \"protocol\", \"extension\", \"actor\",\n                    \"private\", \"fileprivate\", \"public\", \"internal\", \"open\", \"static\", \"final\", \"override\",\n                    \"self\", \"super\", \"init\", \"deinit\",\n                    \"throw\", \"throws\", \"rethrows\", \"try\", \"catch\", \"do\", \"guard\", \"defer\",\n                    \"async\", \"await\",\n                    \"weak\", \"unowned\", \"mutating\", \"nonmutating\",\n                    \"typealias\", \"associatedtype\", \"where\", \"in\", \"is\", \"as\", \"Any\", \"some\", \"any\",\n                    \"true\", \"false\", \"nil\"\n                ],\n                typePatterns: [\n                    CapturePattern(\n                        pattern: \"\\\\b(?:String|Int|Int8|Int16|Int32|Int64|UInt|UInt8|UInt16|UInt32|UInt64|Double|Float|Bool|Character|Void|AnyObject|Never|Data|Date|URL|UUID|CGFloat)\\\\b\",\n                        captureGroup: nil,\n                        options: []\n                    ),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\"] + cLikeStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunc\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .javascript:\n            return LanguageRules(\n                keywords: [\n                    \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"debugger\", \"default\", \"delete\",\n                    \"do\", \"else\", \"export\", \"extends\", \"finally\", \"for\", \"function\", \"if\", \"import\", \"in\",\n                    \"instanceof\", \"let\", \"new\", \"return\", \"super\", \"switch\", \"this\", \"throw\", \"try\", \"typeof\",\n                    \"var\", \"void\", \"while\", \"with\", \"yield\", \"async\", \"await\", \"of\", \"true\", \"false\", \"null\", \"undefined\"\n                ],\n                typePatterns: [CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])],\n                stringPatterns: cLikeStrings + [\n                    \"`(?:[^`\\\\\\\\]|\\\\\\\\.|\\\\$\\\\{[\\\\s\\\\S]*?\\\\})*`\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b(?:const|let|var)\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\s*=\\\\s*(?:async\\\\s*)?(?:\\\\([^)]*\\\\)|[A-Za-z_][A-Za-z0-9_]*)?\\\\s*=>\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .typescript:\n            return LanguageRules(\n                keywords: [\n                    // JS\n                    \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"debugger\", \"default\", \"delete\",\n                    \"do\", \"else\", \"export\", \"extends\", \"finally\", \"for\", \"function\", \"if\", \"import\", \"in\",\n                    \"instanceof\", \"let\", \"new\", \"return\", \"super\", \"switch\", \"this\", \"throw\", \"try\", \"typeof\",\n                    \"var\", \"void\", \"while\", \"with\", \"yield\", \"async\", \"await\", \"of\", \"true\", \"false\", \"null\", \"undefined\",\n                    // TS\n                    \"interface\", \"type\", \"enum\", \"implements\", \"namespace\", \"abstract\", \"declare\", \"readonly\",\n                    \"private\", \"protected\", \"public\", \"keyof\", \"infer\", \"unknown\", \"never\", \"any\", \"as\", \"satisfies\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:string|number|boolean|any|unknown|never|void|object|bigint|symbol)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings + [\"`(?:[^`\\\\\\\\]|\\\\\\\\.|\\\\$\\\\{[\\\\s\\\\S]*?\\\\})*`\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .tsx:\n            // TSX = TypeScript + JSX tags/attributes as \"types\" (cyan).\n            let ts = languageRules(for: .typescript)\n            return LanguageRules(\n                keywords: ts.keywords,\n                typePatterns: ts.typePatterns + [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:_-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: ts.stringPatterns,\n                stringRegexOptions: ts.stringRegexOptions,\n                commentPatterns: ts.commentPatterns,\n                commentRegexOptions: ts.commentRegexOptions,\n                numberPattern: ts.numberPattern,\n                numberRegexOptions: ts.numberRegexOptions,\n                keywordRegexOptions: ts.keywordRegexOptions,\n                functionPatterns: ts.functionPatterns\n            )\n\n        case .jsx:\n            // JSX = JS plus tag/attribute as \"types\" for cyan.\n            let js = languageRules(for: .javascript)\n            return LanguageRules(\n                keywords: js.keywords,\n                typePatterns: js.typePatterns + [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:_-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: js.stringPatterns,\n                stringRegexOptions: js.stringRegexOptions,\n                commentPatterns: js.commentPatterns,\n                commentRegexOptions: js.commentRegexOptions,\n                numberPattern: js.numberPattern,\n                numberRegexOptions: js.numberRegexOptions,\n                keywordRegexOptions: js.keywordRegexOptions,\n                functionPatterns: js.functionPatterns\n            )\n\n        // MARK: Python (patterns tuned)\n        case .python:\n            // Python numeric literals (underscores, hex/binary/octal, floats, leading-dot floats, complex).\n            let pyNumber = \"(?<!\\\\w)(?:(?:0x[0-9A-Fa-f_]+)|(?:0b[01_]+)|(?:0o[0-7_]+)|(?:\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)|(?:\\\\.\\\\d[\\\\d_]*(?:[eE][+-]?\\\\d[\\\\d_]*)?))(?:[jJ])?(?!\\\\w)\"\n\n            // Python strings incl. optional prefixes before both single-line and triple-quoted strings.\n            let pyStrings = [\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?'''[\\\\s\\\\S]*?'''\",\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\",\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"\n            ]\n\n            return LanguageRules(\n                keywords: [\n                    \"False\", \"None\", \"True\", \"and\", \"as\", \"assert\", \"async\", \"await\", \"break\", \"class\",\n                    \"continue\", \"def\", \"del\", \"elif\", \"else\", \"except\", \"finally\", \"for\", \"from\", \"global\",\n                    \"if\", \"import\", \"in\", \"is\", \"lambda\", \"nonlocal\", \"not\", \"or\", \"pass\", \"raise\", \"return\",\n                    \"try\", \"while\", \"with\", \"yield\", \"match\", \"case\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|float|bool|str|bytes|list|tuple|set|dict|object)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: pyStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: pyNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bdef\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // MARK: FEAT-023 Ruby (gpt52 regex patterns)\n        case .ruby:\n            // Ruby numeric literals: hex/binary/octal, ints/floats with underscores, scientific, leading-dot.\n            // Supports suffixes for rational/complex (r/i) best-effort.\n            let rbNumber = \"(?<!\\\\w)(?:0x[0-9A-Fa-f_]+|0b[01_]+|0o[0-7_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?|\\\\.\\\\d[\\\\d_]*(?:[eE][+-]?\\\\d[\\\\d_]*)?)(?:[rRiI])?(?!\\\\w)\"\n\n            // Ruby strings: single/double, backticks, %q/%Q with common delimiters, heredocs.\n            // Heredoc supports <<, <<-, <<~ with optional quoting around identifier.\n            let rbStrings: [String] = [\n                // Heredoc (multiline) - highlight from opener through terminator line.\n                \"<<[-~]?'?\\\"?([A-Za-z_][A-Za-z0-9_]*)\\\"?'?\\\\R[\\\\s\\\\S]*?^\\\\1$\",\n\n                // Double/single quoted.\n                \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n\n                // Backticks.\n                \"`(?:[^`\\\\\\\\\\\\n]|\\\\\\\\.)*`\",\n\n                // %q/%Q forms (common delimiters).\n                \"%[qQ]\\\\{[\\\\s\\\\S]*?\\\\}\",\n                \"%[qQ]\\\\([\\\\s\\\\S]*?\\\\)\",\n                \"%[qQ]\\\\[[\\\\s\\\\S]*?\\\\]\",\n                \"%[qQ]\\\\<[\\\\s\\\\S]*?\\\\>\",\n                \"%[qQ]\\\\|[\\\\s\\\\S]*?\\\\|\"\n            ]\n\n            // Ruby block comments must start at line start.\n            let rbComments = [\n                \"#[^\\\\n]*\",\n                \"^=begin\\\\b[\\\\s\\\\S]*?^=end\\\\b\"\n            ]\n\n            return LanguageRules(\n                keywords: [\n                    \"BEGIN\", \"END\", \"alias\", \"and\", \"begin\", \"break\", \"case\", \"class\", \"def\", \"defined\\\\?\",\n                    \"do\", \"else\", \"elsif\", \"end\", \"ensure\", \"false\", \"for\", \"if\", \"in\", \"module\", \"next\",\n                    \"nil\", \"not\", \"or\", \"redo\", \"rescue\", \"retry\", \"return\", \"self\", \"super\", \"then\",\n                    \"true\", \"undef\", \"unless\", \"until\", \"when\", \"while\", \"yield\", \"private\", \"protected\", \"public\",\n                    \"__FILE__\", \"__LINE__\", \"__ENCODING__\"\n                ],\n                typePatterns: [\n                    // Constants/classes/modules\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: rbStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators, .anchorsMatchLines],\n                commentPatterns: rbComments,\n                commentRegexOptions: [.dotMatchesLineSeparators, .anchorsMatchLines],\n                numberPattern: rbNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    // def foo / def self.foo / def A::B.foo (best-effort)\n                    CapturePattern(pattern: \"\\\\bdef\\\\s+(?:(?:self|[A-Z][A-Za-z0-9_]*(?:::[A-Z][A-Za-z0-9_]*)*)\\\\.)?([A-Za-z_][A-Za-z0-9_]*[!?=]?)\\\\b\", captureGroup: 1, options: []),\n                    // Method calls with punctuation names (foo?, bar!, baz=) when parentheses are used.\n                    CapturePattern(pattern: \"\\\\b([a-z_][A-Za-z0-9_]*[!?=]?)\\\\s*(?=\\\\()\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .go:\n            return LanguageRules(\n                keywords: [\n                    \"break\", \"default\", \"func\", \"interface\", \"select\", \"case\", \"defer\", \"go\", \"map\", \"struct\",\n                    \"chan\", \"else\", \"goto\", \"package\", \"switch\", \"const\", \"fallthrough\", \"if\", \"range\", \"type\",\n                    \"continue\", \"for\", \"import\", \"return\", \"var\", \"true\", \"false\", \"nil\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:string|bool|byte|rune|int|int8|int16|int32|int64|uint|uint8|uint16|uint32|uint64|uintptr|float32|float64|complex64|complex128|error)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"`[\\\\s\\\\S]*?`\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunc\\\\s+(?:\\\\([^)]*\\\\)\\\\s*)?([A-Za-z_][A-Za-z0-9_]*)\\\\s*\\\\(\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .rust:\n            // FEAT-019 Rust (gpt52 regex patterns)\n            let rustNumber = \"\\\\b(?:0b[01_]+|0o[0-7_]+|0x[0-9A-Fa-f_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)(?:u(?:8|16|32|64|128|size)|i(?:8|16|32|64|128|size)|f(?:32|64))?\\\\b\"\n            return LanguageRules(\n                keywords: [\n                    // Strict/used keywords\n                    \"as\", \"break\", \"const\", \"continue\", \"crate\", \"else\", \"enum\", \"extern\", \"false\", \"fn\", \"for\",\n                    \"if\", \"impl\", \"in\", \"let\", \"loop\", \"match\", \"mod\", \"move\", \"mut\", \"pub\", \"ref\", \"return\",\n                    \"self\", \"Self\", \"static\", \"struct\", \"super\", \"trait\", \"true\", \"type\", \"unsafe\", \"use\",\n                    \"where\", \"while\", \"async\", \"await\", \"dyn\",\n                    // Common/reserved (best-effort)\n                    \"union\", \"macro_rules\", \"yield\", \"try\", \"box\", \"abstract\", \"become\", \"do\", \"final\", \"override\",\n                    \"priv\", \"typeof\", \"unsized\", \"virtual\"\n                ],\n                typePatterns: [\n                    // Primitive + common std/core types\n                    CapturePattern(\n                        pattern: \"\\\\b(?:i8|i16|i32|i64|i128|isize|u8|u16|u32|u64|u128|usize|f32|f64|bool|char|str|String|Option|Result|Vec|Box|Rc|Arc|HashMap|HashSet|BTreeMap|BTreeSet)\\\\b\",\n                        captureGroup: nil,\n                        options: []\n                    ),\n                    // Lifetimes: 'a, 'static (avoid matching char literals like 'a')\n                    CapturePattern(pattern: \"\\\\B'([A-Za-z_][A-Za-z0-9_]*) (?!')\".replacingOccurrences(of: \" \", with: \"\"), captureGroup: 1, options: []),\n                    // UpperCamelCase identifiers\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\n                    // Raw strings: r\"...\" / r#\"...\"# / r##\"...\"## etc\n                    \"r(#*)\\\"[\\\\s\\\\S]*?\\\"\\\\1\",\n                    // Byte raw strings: br\"...\" / br#\"...\"# / ...\n                    \"br(#*)\\\"[\\\\s\\\\S]*?\\\"\\\\1\",\n                    // Byte strings / byte chars\n                    \"b\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                    \"b'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                    // Normal strings / chars\n                    \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                    \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\n                    // Line + block comments (including doc comments) - best-effort\n                    \"//[^\\\\n]*\",\n                    \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"\n                ],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: rustNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    // Function definitions\n                    CapturePattern(pattern: \"\\\\bfn\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    // Macro invocations: println!(...), vec![...]\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)!\\\\s*(?=\\\\()\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // MARK: FEAT-022 Java/Kotlin (gpt52 regex patterns)\n        case .java:\n            // Java numeric literals: binary/hex/decimal, float exponent, underscores, and common suffixes.\n            let javaNumber = \"(?<!\\\\w)(?:0b[01_]+|0x[0-9A-Fa-f_]+(?:\\\\.[0-9A-Fa-f_]+)?(?:[pP][+-]?\\\\d[\\\\d_]*)?[fFdD]?|\\\\d[\\\\d_]*[lL]|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?[fFdD]?)(?!\\\\w)\"\n\n            // Java strings: include text blocks (\"\"\"...\"\"\") plus standard string/char literals.\n            let javaStrings = [\n                \"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\"\n            ] + cLikeStrings\n\n            return LanguageRules(\n                keywords: [\n                    \"abstract\", \"assert\", \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"default\", \"do\",\n                    \"else\", \"enum\", \"extends\", \"final\", \"finally\", \"for\", \"goto\", \"if\", \"implements\", \"import\",\n                    \"instanceof\", \"interface\", \"native\", \"new\", \"package\", \"private\", \"protected\", \"public\",\n                    \"return\", \"static\", \"strictfp\", \"super\", \"switch\", \"synchronized\", \"this\", \"throw\", \"throws\",\n                    \"transient\", \"try\", \"volatile\", \"while\",\n                    // Literals\n                    \"true\", \"false\", \"null\",\n                    // Modern Java\n                    \"var\", \"record\", \"sealed\", \"permits\", \"non-sealed\", \"yield\", \"module\", \"requires\", \"exports\",\n                    \"opens\", \"to\", \"uses\", \"provides\", \"with\"\n                ],\n                typePatterns: [\n                    // Primitive & common std types\n                    CapturePattern(pattern: \"\\\\b(?:boolean|byte|char|short|int|long|float|double|void)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b(?:String|Object|Integer|Long|Double|Float|Boolean|Character|List|Map|Set|Optional|Stream)\\\\b\", captureGroup: nil, options: []),\n                    // Annotations\n                    CapturePattern(pattern: \"@([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    // UpperCamelCase identifiers\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: javaStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: javaNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    // Method declarations (best-effort): returnType name(\n                    CapturePattern(\n                        pattern: \"\\\\b(?:public|protected|private|static|final|native|synchronized|abstract|transient|volatile|strictfp)\\\\s+[^;=(){}]+?\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\",\n                        captureGroup: 1,\n                        options: []\n                    ),\n                    commonFunctionCall\n                ]\n            )\n\n        case .kotlin:\n            // Kotlin numeric literals: binary/hex/decimal/floats, underscores, and common suffixes (L, f, u/ul).\n            let ktNumber = \"(?<!\\\\w)(?:0b[01_]+|0x[0-9A-Fa-f_]+|\\\\d[\\\\d_]*[lL]|\\\\d[\\\\d_]*[uU](?:[lL])?|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?(?:[fF])?)(?!\\\\w)\"\n\n            return LanguageRules(\n                keywords: [\n                    \"as\", \"break\", \"class\", \"continue\", \"do\", \"else\", \"false\", \"for\", \"fun\", \"if\", \"in\",\n                    \"interface\", \"is\", \"null\", \"object\", \"package\", \"return\", \"super\", \"this\", \"throw\",\n                    \"true\", \"try\", \"typealias\", \"val\", \"var\", \"when\", \"while\",\n                    \"by\", \"catch\", \"constructor\", \"delegate\", \"finally\", \"get\", \"import\", \"init\", \"set\", \"where\",\n                    \"actual\", \"abstract\", \"annotation\", \"companion\", \"const\", \"crossinline\", \"data\", \"enum\",\n                    \"expect\", \"external\", \"final\", \"infix\", \"inline\", \"inner\", \"internal\", \"lateinit\",\n                    \"noinline\", \"open\", \"operator\", \"out\", \"override\", \"private\", \"protected\", \"public\",\n                    \"reified\", \"sealed\", \"suspend\", \"tailrec\", \"vararg\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:Int|Long|Short|Byte|Float|Double|Boolean|Char|String|Unit|Any|Nothing)\\\\b\", captureGroup: nil, options: []),\n                    // Annotations\n                    CapturePattern(pattern: \"@([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\n                    \"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\",\n                    \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                    \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: ktNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    // fun foo(...) / fun Type.foo(...)\n                    CapturePattern(pattern: \"\\\\bfun\\\\s+(?:<[^>]+>\\\\s*)?(?:[A-Za-z_][A-Za-z0-9_]*\\\\s*\\\\.)?([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .c:\n            return LanguageRules(\n                keywords: [\n                    \"auto\", \"break\", \"case\", \"char\", \"const\", \"continue\", \"default\", \"do\", \"double\", \"else\",\n                    \"enum\", \"extern\", \"float\", \"for\", \"goto\", \"if\", \"inline\", \"int\", \"long\", \"register\",\n                    \"restrict\", \"return\", \"short\", \"signed\", \"sizeof\", \"static\", \"struct\", \"switch\", \"typedef\",\n                    \"union\", \"unsigned\", \"void\", \"volatile\", \"while\", \"_Bool\", \"_Complex\", \"_Imaginary\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:char|short|int|long|float|double|void|size_t|ssize_t|bool)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .cpp:\n            return LanguageRules(\n                keywords: [\n                    \"alignas\", \"alignof\", \"and\", \"and_eq\", \"asm\", \"auto\", \"bitand\", \"bitor\", \"bool\", \"break\",\n                    \"case\", \"catch\", \"char\", \"char8_t\", \"char16_t\", \"char32_t\", \"class\", \"compl\", \"concept\",\n                    \"const\", \"consteval\", \"constexpr\", \"constinit\", \"continue\", \"co_await\", \"co_return\", \"co_yield\",\n                    \"default\", \"delete\", \"do\", \"double\", \"dynamic_cast\", \"else\", \"enum\", \"explicit\", \"export\", \"extern\",\n                    \"false\", \"float\", \"for\", \"friend\", \"goto\", \"if\", \"inline\", \"int\", \"long\", \"mutable\", \"namespace\",\n                    \"new\", \"noexcept\", \"not\", \"not_eq\", \"nullptr\", \"operator\", \"or\", \"or_eq\", \"private\", \"protected\",\n                    \"public\", \"register\", \"reinterpret_cast\", \"requires\", \"return\", \"short\", \"signed\", \"sizeof\",\n                    \"static\", \"static_assert\", \"static_cast\", \"struct\", \"switch\", \"template\", \"this\", \"thread_local\",\n                    \"throw\", \"true\", \"try\", \"typedef\", \"typeid\", \"typename\", \"union\", \"unsigned\", \"using\", \"virtual\",\n                    \"void\", \"volatile\", \"wchar_t\", \"while\", \"xor\", \"xor_eq\", \"final\", \"override\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:bool|char|short|int|long|float|double|void|wchar_t|size_t|ssize_t|string|std::[A-Za-z0-9_:]+)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .objc:\n            return LanguageRules(\n                keywords: [\n                    \"@interface\", \"@implementation\", \"@end\", \"@property\", \"@synthesize\", \"@dynamic\", \"@protocol\",\n                    \"@class\", \"@public\", \"@private\", \"@protected\", \"@package\",\n                    \"@try\", \"@catch\", \"@finally\", \"@throw\", \"@autoreleasepool\",\n                    \"@selector\", \"@encode\", \"@import\", \"@available\",\n                    \"if\", \"else\", \"for\", \"while\", \"switch\", \"case\", \"default\", \"break\", \"continue\", \"return\",\n                    \"struct\", \"typedef\", \"enum\", \"static\", \"const\", \"void\", \"int\", \"char\", \"float\", \"double\",\n                    \"BOOL\", \"YES\", \"NO\", \"nil\", \"self\", \"super\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:id|instancetype|SEL|Class|BOOL|NSInteger|NSUInteger|CGFloat|NSString|NSNumber|NSArray|NSDictionary|NSData|NSDate|NSURL|NSError)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings + [\"@\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .html:\n            return LanguageRules(\n                keywords: [\"DOCTYPE\", \"html\", \"head\", \"body\", \"script\", \"style\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .xml:\n            return LanguageRules(\n                keywords: [\"xml\", \"version\", \"encoding\", \"CDATA\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z_][A-Za-z0-9:._-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\", \"<!\\\\[CDATA\\\\[[\\\\s\\\\S]*?\\\\]\\\\]>\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .css:\n            return LanguageRules(\n                keywords: [\"@import\", \"@media\", \"@supports\", \"@keyframes\", \"@font-face\", \"@page\", \"@layer\", \"important\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"(?:\\\\.|#)([A-Za-z_-][A-Za-z0-9_-]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\b(?=\\\\s*\\\\{)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: \"\\\\b\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:%|px|em|rem|vw|vh|vmin|vmax|fr|ch|ex|cm|mm|in|pt|pc)?\\\\b\",\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\s*(?=:)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: [])\n                ]\n            )\n\n        case .scss:\n            let css = languageRules(for: .css)\n            return LanguageRules(\n                keywords: css.keywords + [\"@mixin\", \"@include\", \"@extend\", \"@function\", \"@return\", \"@if\", \"@else\", \"@for\", \"@each\", \"@while\"],\n                typePatterns: css.typePatterns,\n                stringPatterns: css.stringPatterns,\n                stringRegexOptions: css.stringRegexOptions,\n                commentPatterns: [\"/\\\\*[\\\\s\\\\S]*?\\\\*/\", \"//[^\\\\n]*\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: css.numberPattern,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: css.functionPatterns\n            )\n\n        case .json:\n            return LanguageRules(\n                keywords: [\"true\", \"false\", \"null\"],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"//[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .yaml:\n            return LanguageRules(\n                keywords: [\"true\", \"false\", \"null\", \"yes\", \"no\", \"on\", \"off\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"([&*][A-Za-z0-9_-]+)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"^\\\\s*([A-Za-z0-9_-]+)\\\\s*:(?=\\\\s|$)\", captureGroup: 1, options: [.anchorsMatchLines])\n                ]\n            )\n\n        case .sql:\n            return LanguageRules(\n                keywords: [\n                    \"select\", \"from\", \"where\", \"group\", \"by\", \"having\", \"order\", \"limit\", \"offset\",\n                    \"insert\", \"into\", \"values\", \"update\", \"set\", \"delete\",\n                    \"join\", \"inner\", \"left\", \"right\", \"full\", \"outer\", \"cross\", \"on\",\n                    \"as\", \"distinct\", \"union\", \"all\", \"and\", \"or\", \"not\", \"null\", \"is\", \"in\", \"exists\", \"like\", \"between\",\n                    \"create\", \"alter\", \"drop\", \"table\", \"view\", \"index\", \"primary\", \"key\", \"foreign\", \"references\",\n                    \"case\", \"when\", \"then\", \"else\", \"end\",\n                    \"begin\", \"commit\", \"rollback\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|integer|smallint|bigint|serial|bigserial|decimal|numeric|real|double|float|money|boolean|bool|date|time|timestamp|timestamptz|varchar|char|text|uuid|json|jsonb)\\\\b\", captureGroup: nil, options: [.caseInsensitive])\n                ],\n                stringPatterns: [\"'(?:''|[^'])*'\", \"\\\"(?:\\\"\\\"|[^\\\"])*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"--[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: [.caseInsensitive])\n                ]\n            )\n\n        case .shell:\n            return LanguageRules(\n                keywords: [\n                    \"if\", \"then\", \"elif\", \"else\", \"fi\", \"for\", \"in\", \"do\", \"done\", \"case\", \"esac\", \"while\", \"until\",\n                    \"select\", \"function\", \"time\", \"coproc\", \"break\", \"continue\", \"return\", \"exit\", \"export\", \"readonly\",\n                    \"local\", \"declare\", \"typeset\", \"unset\", \"shift\", \"trap\", \"set\"\n                ],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'[^'\\\\n]*'\", \"\\\\$'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*\\\\(\\\\s*\\\\)\\\\s*\\\\{\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .dockerfile:\n            return LanguageRules(\n                keywords: [\n                    \"FROM\", \"RUN\", \"CMD\", \"LABEL\", \"MAINTAINER\", \"EXPOSE\", \"ENV\", \"ADD\", \"COPY\", \"ENTRYPOINT\",\n                    \"VOLUME\", \"USER\", \"WORKDIR\", \"ARG\", \"ONBUILD\",

>>>TOOL create_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","overwrite":true,"content":"import SwiftUI\nimport UIKit\n\n// Efficient NSMutableAttributedString-based syntax highlighter (regex-based).\n//\n// Color mapping (per requirements):\n// - Keywords: blue\n// - Types: cyan\n// - Strings: orange\n// - Comments: gray\n// - Numbers: green\n// - Functions: yellow\nfinal class NSAttributedStringSyntaxHighlighter {\n\n    // MARK: - Language\n\n    // NOTE: This file cannot use the name `Language` because the project already defines a global `Language`\n    // enum elsewhere (VSCodeiPadOS/Views/Editor/SyntaxHighlightingTextView.swift).\n    enum SyntaxLanguage {\n        case swift, javascript, typescript, jsx, tsx\n        case python, ruby, go, rust\n        case java, kotlin\n        case c, cpp, objc\n        case html, css, scss\n        case json, xml, yaml\n        case sql, shell, dockerfile, graphql\n        case markdown, php, dotenv\n        case plainText\n    }\n\n    // MARK: - Colors\n\n    private struct ColorScheme {\n        static let keyword = UIColor.systemBlue\n        static let type = UIColor.systemCyan\n        static let string = UIColor.systemOrange\n        static let comment = UIColor.systemGray\n        static let number = UIColor.systemGreen\n        static let function = UIColor.systemYellow\n        static let defaultText = UIColor.label\n    }\n\n    // MARK: - Public API\n\n    /// Backwards-compatible entrypoint (defaults to Swift).\n    static func highlightCode(_ code: String) -> NSAttributedString {\n        highlightCode(code, filename: nil, language: .swift)\n    }\n\n    /// Highlights `code` using either an explicit `language` or a detected one from `filename`.\n    static func highlightCode(_ code: String, filename: String? = nil, language: SyntaxLanguage? = nil) -> NSAttributedString {\n        let attributed = NSMutableAttributedString(string: code)\n        let fullRange = NSRange(location: 0, length: code.utf16.count)\n\n        attributed.addAttributes([\n            .font: UIFont.monospacedSystemFont(ofSize: 14, weight: .regular),\n            .foregroundColor: ColorScheme.defaultText\n        ], range: fullRange)\n\n        let resolvedLanguage: SyntaxLanguage = {\n            if let language { return language }\n            if let filename { return detectLanguage(fromFilename: filename) }\n            return .plainText\n        }()\n\n        highlight(code: code, language: resolvedLanguage, into: attributed)\n        return attributed\n    }\n\n    // MARK: - Language detection\n\n    private static func detectLanguage(fromFilename filename: String) -> SyntaxLanguage {\n        let lower = filename.lowercased()\n        let base = (lower as NSString).lastPathComponent\n        let ext = (base as NSString).pathExtension\n\n        // Special basenames (no extension).\n        if base == \"dockerfile\" || base.hasPrefix(\"dockerfile.\") { return .dockerfile }\n        if base == \".env\" || base.hasPrefix(\".env.\") || ext == \"env\" { return .dotenv }\n\n        switch ext {\n        case \"swift\": return .swift\n        case \"js\", \"mjs\", \"cjs\": return .javascript\n        case \"jsx\": return .jsx\n        case \"ts\": return .typescript\n        case \"tsx\": return .tsx\n        case \"py\", \"pyw\": return .python\n        case \"rb\", \"ruby\": return .ruby\n        case \"go\": return .go\n        case \"rs\": return .rust\n        case \"java\": return .java\n        case \"kt\", \"kts\": return .kotlin\n        case \"c\": return .c\n        case \"cc\", \"cpp\", \"cxx\", \"hpp\", \"hh\", \"hxx\", \"h\": return .cpp\n        case \"m\", \"mm\": return .objc\n        case \"html\", \"htm\": return .html\n        case \"css\": return .css\n        case \"scss\", \"sass\": return .scss\n        case \"json\", \"jsonc\": return .json\n        case \"xml\", \"plist\", \"svg\": return .xml\n        case \"yml\", \"yaml\": return .yaml\n        case \"sql\": return .sql\n        case \"sh\", \"bash\", \"zsh\", \"fish\": return .shell\n        case \"php\": return .php\n        case \"gql\", \"graphql\": return .graphql\n        case \"md\", \"markdown\": return .markdown\n        default: return .plainText\n        }\n    }\n\n    // MARK: - Pipeline\n\n    private struct CapturePattern {\n        let pattern: String\n        let captureGroup: Int?\n        let options: NSRegularExpression.Options\n    }\n\n    private struct LanguageRules {\n        let keywords: [String]\n        let typePatterns: [CapturePattern]\n        let stringPatterns: [String]\n        let stringRegexOptions: NSRegularExpression.Options\n        let commentPatterns: [String]\n        let commentRegexOptions: NSRegularExpression.Options\n        let numberPattern: String?\n        let numberRegexOptions: NSRegularExpression.Options\n        let keywordRegexOptions: NSRegularExpression.Options\n        let functionPatterns: [CapturePattern]\n    }\n\n    private static func highlight(code: String, language: SyntaxLanguage, into attributed: NSMutableAttributedString) {\n        let rules = languageRules(for: language)\n\n        // 1) Strings first\n        let stringRanges = rules.stringPatterns.flatMap { pattern in\n            applyHighlighting(\n                pattern: pattern,\n                options: rules.stringRegexOptions,\n                color: ColorScheme.string,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: []\n            )\n        }\n\n        // 2) Comments (exclude matches inside strings)\n        let commentRanges = rules.commentPatterns.flatMap { pattern in\n            applyHighlighting(\n                pattern: pattern,\n                options: rules.commentRegexOptions,\n                color: ColorScheme.comment,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: stringRanges\n            )\n        }\n\n        let protectedRanges = stringRanges + commentRanges\n\n        // 3) Numbers\n        if let numberPattern = rules.numberPattern {\n            _ = applyHighlighting(\n                pattern: numberPattern,\n                options: rules.numberRegexOptions,\n                color: ColorScheme.number,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: protectedRanges\n            )\n        }\n\n        // 4) Types\n        for typePattern in rules.typePatterns {\n            _ = applyHighlighting(\n                pattern: typePattern.pattern,\n                options: typePattern.options,\n                color: ColorScheme.type,\n                to: attributed,\n                in: code,\n                captureGroup: typePattern.captureGroup,\n                excluding: protectedRanges\n            )\n        }\n\n        // 5) Keywords\n        if !rules.keywords.isEmpty {\n            let keywordPattern = \"\\\\b(?:\" + rules.keywords.map(NSRegularExpression.escapedPattern).joined(separator: \"|\") + \")\\\\b\"\n            _ = applyHighlighting(\n                pattern: keywordPattern,\n                options: rules.keywordRegexOptions,\n                color: ColorScheme.keyword,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: protectedRanges\n            )\n        }\n\n        // 6) Functions\n        for fnPattern in rules.functionPatterns {\n            _ = applyHighlighting(\n                pattern: fnPattern.pattern,\n                options: fnPattern.options,\n                color: ColorScheme.function,\n                to: attributed,\n                in: code,\n                captureGroup: fnPattern.captureGroup,\n                excluding: protectedRanges\n            )\n        }\n    }\n\n    // MARK: - Language rules\n\n    private static func languageRules(for language: SyntaxLanguage) -> LanguageRules {\n\n        // Numeric literal coverage (hex, float, exponent, underscores).\n        let commonNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)\\\\b\"\n\n        // C-like strings: \"...\" and '...'\n        let cLikeStrings = [\n            \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n            \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n        ]\n\n        // C-like comments\n        let cLikeComments = [\n            \"//[^\\\\n]*\",\n            \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"\n        ]\n\n        // Common function call: name(\n        let commonFunctionCall = CapturePattern(\n            pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\",\n            captureGroup: 1,\n            options: []\n        )\n\n        switch language {\n\n        case .swift:\n            return LanguageRules(\n                keywords: [\n                    \"func\", \"var\", \"let\", \"if\", \"else\", \"for\", \"while\", \"repeat\", \"switch\", \"case\", \"default\",\n                    \"return\", \"import\", \"class\", \"struct\", \"enum\", \"protocol\", \"extension\", \"actor\",\n                    \"private\", \"fileprivate\", \"public\", \"internal\", \"open\", \"static\", \"final\", \"override\",\n                    \"self\", \"super\", \"init\", \"deinit\",\n                    \"throw\", \"throws\", \"rethrows\", \"try\", \"catch\", \"do\", \"guard\", \"defer\",\n                    \"async\", \"await\",\n                    \"weak\", \"unowned\", \"mutating\", \"nonmutating\",\n                    \"typealias\", \"associatedtype\", \"where\", \"in\", \"is\", \"as\", \"Any\", \"some\", \"any\",\n                    \"true\", \"false\", \"nil\"\n                ],\n                typePatterns: [\n                    CapturePattern(\n                        pattern: \"\\\\b(?:String|Int|Int8|Int16|Int32|Int64|UInt|UInt8|UInt16|UInt32|UInt64|Double|Float|Bool|Character|Void|AnyObject|Never|Data|Date|URL|UUID|CGFloat)\\\\b\",\n                        captureGroup: nil,\n                        options: []\n                    ),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\"] + cLikeStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunc\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .javascript:\n            return LanguageRules(\n                keywords: [\n                    \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"debugger\", \"default\", \"delete\",\n                    \"do\", \"else\", \"export\", \"extends\", \"finally\", \"for\", \"function\", \"if\", \"import\", \"in\",\n                    \"instanceof\", \"let\", \"new\", \"return\", \"super\", \"switch\", \"this\", \"throw\", \"try\", \"typeof\",\n                    \"var\", \"void\", \"while\", \"with\", \"yield\", \"async\", \"await\", \"of\", \"true\", \"false\", \"null\", \"undefined\"\n                ],\n                typePatterns: [CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])],\n                stringPatterns: cLikeStrings + [\n                    \"`(?:[^`\\\\\\\\]|\\\\\\\\.|\\\\$\\\\{[\\\\s\\\\S]*?\\\\})*`\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b(?:const|let|var)\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\s*=\\\\s*(?:async\\\\s*)?(?:\\\\([^)]*\\\\)|[A-Za-z_][A-Za-z0-9_]*)?\\\\s*=>\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .typescript:\n            return LanguageRules(\n                keywords: [\n                    // JS\n                    \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"debugger\", \"default\", \"delete\",\n                    \"do\", \"else\", \"export\", \"extends\", \"finally\", \"for\", \"function\", \"if\", \"import\", \"in\",\n                    \"instanceof\", \"let\", \"new\", \"return\", \"super\", \"switch\", \"this\", \"throw\", \"try\", \"typeof\",\n                    \"var\", \"void\", \"while\", \"with\", \"yield\", \"async\", \"await\", \"of\", \"true\", \"false\", \"null\", \"undefined\",\n                    // TS\n                    \"interface\", \"type\", \"enum\", \"implements\", \"namespace\", \"abstract\", \"declare\", \"readonly\",\n                    \"private\", \"protected\", \"public\", \"keyof\", \"infer\", \"unknown\", \"never\", \"any\", \"as\", \"satisfies\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:string|number|boolean|any|unknown|never|void|object|bigint|symbol)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings + [\"`(?:[^`\\\\\\\\]|\\\\\\\\.|\\\\$\\\\{[\\\\s\\\\S]*?\\\\})*`\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .tsx:\n            // TSX = TypeScript + JSX tags/attributes as \"types\" (cyan).\n            let ts = languageRules(for: .typescript)\n            return LanguageRules(\n                keywords: ts.keywords,\n                typePatterns: ts.typePatterns + [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:_-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: ts.stringPatterns,\n                stringRegexOptions: ts.stringRegexOptions,\n                commentPatterns: ts.commentPatterns,\n                commentRegexOptions: ts.commentRegexOptions,\n                numberPattern: ts.numberPattern,\n                numberRegexOptions: ts.numberRegexOptions,\n                keywordRegexOptions: ts.keywordRegexOptions,\n                functionPatterns: ts.functionPatterns\n            )\n\n        case .jsx:\n            // JSX = JS plus tag/attribute as \"types\" for cyan.\n            let js = languageRules(for: .javascript)\n            return LanguageRules(\n                keywords: js.keywords,\n                typePatterns: js.typePatterns + [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:_-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: js.stringPatterns,\n                stringRegexOptions: js.stringRegexOptions,\n                commentPatterns: js.commentPatterns,\n                commentRegexOptions: js.commentRegexOptions,\n                numberPattern: js.numberPattern,\n                numberRegexOptions: js.numberRegexOptions,\n                keywordRegexOptions: js.keywordRegexOptions,\n                functionPatterns: js.functionPatterns\n            )\n\n        case .python:\n            return LanguageRules(\n                keywords: [\n                    \"False\", \"None\", \"True\", \"and\", \"as\", \"assert\", \"async\", \"await\", \"break\", \"class\",\n                    \"continue\", \"def\", \"del\", \"elif\", \"else\", \"except\", \"finally\", \"for\", \"from\", \"global\",\n                    \"if\", \"import\", \"in\", \"is\", \"lambda\", \"nonlocal\", \"not\", \"or\", \"pass\", \"raise\", \"return\",\n                    \"try\", \"while\", \"with\", \"yield\", \"match\", \"case\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|float|bool|str|bytes|list|tuple|set|dict|object)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\n                    \"'''[\\\\s\\\\S]*?'''\",\n                    \"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\",\n                    \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                    \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bdef\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // FEAT-023 Ruby (gpt52 regex patterns)\n        case .ruby:\n            // Ruby numeric literals (underscores, 0x/0b/0o, floats/exponents, rational/complex suffixes).\n            let rbNumber = \"(?<![\\\\w$@])(?:0x[0-9A-Fa-f_]+|0b[01_]+|0o[0-7_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)(?:r|i)?(?!\\\\w)\"\n\n            // Ruby strings: quotes, backticks, %-literals, and (best-effort) heredocs.\n            let rbStrings: [String] = [\n                // Heredoc (best-effort; supports <<, <<-, <<~ with optional quotes)\n                \"<<[-~]?['\\\"]?([A-Za-z_][A-Za-z0-9_]*)['\\\"]?\\\\n[\\\\s\\\\S]*?\\\\n\\\\1\",\n                // Double/single-quoted\n                \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                // Command strings\n                \"`(?:[^`\\\\\\\\\\\\n]|\\\\\\\\.)*`\",\n                // %q/%Q and friends (common delimiters)\n                \"%[qQwWxrs]?\\\\{[\\\\s\\\\S]*?\\\\}\",\n                \"%[qQwWxrs]?\\\\([\\\\s\\\\S]*?\\\\)\",\n                \"%[qQwWxrs]?\\\\[[\\\\s\\\\S]*?\\\\]\",\n                \"%[qQwWxrs]?<[\\\\s\\\\S]*?>\",\n                \"%[qQwWxrs]?\\\\|[\\\\s\\\\S]*?\\\\|\"\n            ]\n\n            return LanguageRules(\n                keywords: [\n                    \"BEGIN\", \"END\", \"alias\", \"and\", \"begin\", \"break\", \"case\", \"class\", \"def\", \"defined?\",\n                    \"do\", \"else\", \"elsif\", \"end\", \"ensure\", \"false\", \"for\", \"if\", \"in\", \"module\", \"next\",\n                    \"nil\", \"not\", \"or\", \"redo\", \"rescue\", \"retry\", \"return\", \"self\", \"super\", \"then\",\n                    \"true\", \"undef\", \"unless\", \"until\", \"when\", \"while\", \"yield\",\n                    \"private\", \"protected\", \"public\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: rbStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators, .anchorsMatchLines],\n                commentPatterns: [\n                    \"#[^\\\\n]*\",\n                    // Block comments must start at line start in Ruby\n                    \"^=begin\\\\b[\\\\s\\\\S]*?^=end\\\\b\"\n                ],\n                commentRegexOptions: [.dotMatchesLineSeparators, .anchorsMatchLines],\n                numberPattern: rbNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    // def foo / def foo? / def foo! / def foo= / def self.foo / def SomeClass.foo\n                    CapturePattern(pattern: \"\\\\bdef\\\\s+(?:self\\\\.|[A-Z][A-Za-z0-9_]*\\\\.)?([A-Za-z_][A-Za-z0-9_]*[!?=]?)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .go:\n            return LanguageRules(\n                keywords: [\n                    \"break\", \"default\", \"func\", \"interface\", \"select\", \"case\", \"defer\", \"go\", \"map\", \"struct\",\n                    \"chan\", \"else\", \"goto\", \"package\", \"switch\", \"const\", \"fallthrough\", \"if\", \"range\", \"type\",\n                    \"continue\", \"for\", \"import\", \"return\", \"var\", \"true\", \"false\", \"nil\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:string|bool|byte|rune|int|int8|int16|int32|int64|uint|uint8|uint16|uint32|uint64|uintptr|float32|float64|complex64|complex128|error)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"`[\\\\s\\\\S]*?`\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunc\\\\s+(?:\\\\([^)]*\\\\)\\\\s*)?([A-Za-z_][A-Za-z0-9_]*)\\\\s*\\\\(\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .rust:\n            return LanguageRules(\n                keywords: [\n                    \"as\", \"break\", \"const\", \"continue\", \"crate\", \"else\", \"enum\", \"extern\", \"false\", \"fn\", \"for\",\n                    \"if\", \"impl\", \"in\", \"let\", \"loop\", \"match\", \"mod\", \"move\", \"mut\", \"pub\", \"ref\", \"return\",\n                    \"self\", \"Self\", \"static\", \"struct\", \"super\", \"trait\", \"true\", \"type\", \"unsafe\", \"use\",\n                    \"where\", \"while\", \"async\", \"await\", \"dyn\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:i8|i16|i32|i64|i128|isize|u8|u16|u32|u64|u128|usize|f32|f64|bool|char|str|String|Option|Result|Vec)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"r#\\\"[\\\\s\\\\S]*?\\\"#\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"//[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfn\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // FEAT-022 Java (gpt52 regex patterns)\n        case .java:\n            // Java numeric literals incl. binary, hex floats with p/P exponent, and type suffixes.\n            let javaNumber = \"(?<!\\\\w)(?:0b[01_]+|0x[0-9A-Fa-f_]+(?:\\\\.[0-9A-Fa-f_]*)?(?:[pP][+-]?\\\\d[\\\\d_]*)[fFdD]?|0x[0-9A-Fa-f_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)(?:[lLfFdD])?(?!\\\\w)\"\n\n            let javaStrings = [\n                // Text blocks (Java 15+)\n                \"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\",\n                // Normal string / char\n                \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n            ]\n\n            return LanguageRules(\n                keywords: [\n                    \"abstract\", \"assert\", \"boolean\", \"break\", \"byte\", \"case\", \"catch\", \"char\", \"class\",\n                    \"const\", \"continue\", \"default\", \"do\", \"double\", \"else\", \"enum\", \"extends\", \"final\",\n                    \"finally\", \"float\", \"for\", \"goto\", \"if\", \"implements\", \"import\", \"instanceof\", \"int\",\n                    \"interface\", \"long\", \"native\", \"new\", \"package\", \"private\", \"protected\", \"public\",\n                    \"return\", \"short\", \"static\", \"strictfp\", \"super\", \"switch\", \"synchronized\", \"this\",\n                    \"throw\", \"throws\", \"transient\", \"try\", \"void\", \"volatile\", \"while\",\n                    \"true\", \"false\", \"null\", \"var\", \"record\", \"sealed\", \"permits\"\n                ],\n                typePatterns: [\n                    CapturePattern(\n                        pattern: \"\\\\b(?:boolean|byte|char|short|int|long|float|double|void|String|Object|Integer|Long|Double|Float|Boolean|Character|List|Map|Set|Optional)\\\\b\",\n                        captureGroup: nil,\n                        options: []\n                    ),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: javaStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: javaNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    // Best-effort method/ctor declarations at line start (handles annotations and modifiers)\n                    CapturePattern(\n                        pattern: \"^(?:\\\\s*@\\\\w+(?:\\\\([^)]*\\\\))?\\\\s*)*(?:\\\\s*(?:public|protected|private|static|final|abstract|synchronized|native|strictfp|default)\\\\s+)*(?:\\\\s*[A-Za-z_][A-Za-z0-9_$.<>\\\\[\\\\], ?]+\\\\s+)+([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\",\n                        captureGroup: 1,\n                        options: [.anchorsMatchLines]\n                    ),\n                    commonFunctionCall\n                ]\n            )\n\n        // FEAT-022 Kotlin (gpt52 regex patterns)\n        case .kotlin:\n            // Kotlin numeric literals incl. binary/hex, underscores, float/double suffixes, and unsigned suffixes.\n            let ktNumber = \"(?<!\\\\w)(?:0b[01_]+|0x[0-9A-Fa-f_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)(?:(?:[fF]|[dD])|(?:[uU](?:[lL])?)|(?:[lL]))?(?!\\\\w)\"\n\n            return LanguageRules(\n                keywords: [\n                    \"as\", \"break\", \"class\", \"continue\", \"do\", \"else\", \"false\", \"for\", \"fun\", \"if\", \"in\",\n                    \"interface\", \"is\", \"null\", \"object\", \"package\", \"return\", \"super\", \"this\", \"throw\",\n                    \"true\", \"try\", \"typealias\", \"val\", \"var\", \"when\", \"while\",\n                    \"by\", \"catch\", \"constructor\", \"delegate\", \"finally\", \"get\", \"import\", \"init\", \"set\", \"where\",\n                    \"actual\", \"abstract\", \"annotation\", \"companion\", \"const\", \"crossinline\", \"data\", \"enum\",\n                    \"expect\", \"external\", \"final\", \"infix\", \"inline\", \"inner\", \"internal\", \"lateinit\",\n                    \"noinline\", \"open\", \"operator\", \"out\", \"override\", \"private\", \"protected\", \"public\",\n                    \"reified\", \"sealed\", \"suspend\", \"tailrec\", \"vararg\"\n                ],\n                typePatterns: [\n                    CapturePattern(\n                        pattern: \"\\\\b(?:Int|Long|Short|Byte|Float|Double|Boolean|Char|String|Unit|Any|Nothing|List|MutableList|Map|MutableMap|Set|MutableSet)\\\\b\",\n                        captureGroup: nil,\n                        options: []\n                    ),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\n                    \"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\",\n                    \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                    \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: ktNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    // fun foo(...) / fun Receiver.foo(...)\n                    CapturePattern(pattern: \"\\\\bfun\\\\s+(?:<[^>]+>\\\\s*)?(?:[A-Za-z_][A-Za-z0-9_]*\\\\.)?([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .c:\n            return LanguageRules(\n                keywords: [\n                    \"auto\", \"break\", \"case\", \"char\", \"const\", \"continue\", \"default\", \"do\", \"double\", \"else\",\n                    \"enum\", \"extern\", \"float\", \"for\", \"goto\", \"if\", \"inline\", \"int\", \"long\", \"register\",\n                    \"restrict\", \"return\", \"short\", \"signed\", \"sizeof\", \"static\", \"struct\", \"switch\", \"typedef\",\n                    \"union\", \"unsigned\", \"void\", \"volatile\", \"while\", \"_Bool\", \"_Complex\", \"_Imaginary\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:char|short|int|long|float|double|void|size_t|ssize_t|bool)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .cpp:\n            return LanguageRules(\n                keywords: [\n                    \"alignas\", \"alignof\", \"and\", \"and_eq\", \"asm\", \"auto\", \"bitand\", \"bitor\", \"bool\", \"break\",\n                    \"case\", \"catch\", \"char\", \"char8_t\", \"char16_t\", \"char32_t\", \"class\", \"compl\", \"concept\",\n                    \"const\", \"consteval\", \"constexpr\", \"constinit\", \"continue\", \"co_await\", \"co_return\", \"co_yield\",\n                    \"default\", \"delete\", \"do\", \"double\", \"dynamic_cast\", \"else\", \"enum\", \"explicit\", \"export\", \"extern\",\n                    \"false\", \"float\", \"for\", \"friend\", \"goto\", \"if\", \"inline\", \"int\", \"long\", \"mutable\", \"namespace\",\n                    \"new\", \"noexcept\", \"not\", \"not_eq\", \"nullptr\", \"operator\", \"or\", \"or_eq\", \"private\", \"protected\",\n                    \"public\", \"register\", \"reinterpret_cast\", \"requires\", \"return\", \"short\", \"signed\", \"sizeof\",\n                    \"static\", \"static_assert\", \"static_cast\", \"struct\", \"switch\", \"template\", \"this\", \"thread_local\",\n                    \"throw\", \"true\", \"try\", \"typedef\", \"typeid\", \"typename\", \"union\", \"unsigned\", \"using\", \"virtual\",\n                    \"void\", \"volatile\", \"wchar_t\", \"while\", \"xor\", \"xor_eq\", \"final\", \"override\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:bool|char|short|int|long|float|double|void|wchar_t|size_t|ssize_t|string|std::[A-Za-z0-9_:]+)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .objc:\n            return LanguageRules(\n                keywords: [\n                    \"@interface\", \"@implementation\", \"@end\", \"@property\", \"@synthesize\", \"@dynamic\", \"@protocol\",\n                    \"@class\", \"@public\", \"@private\", \"@protected\", \"@package\",\n                    \"@try\", \"@catch\", \"@finally\", \"@throw\", \"@autoreleasepool\",\n                    \"@selector\", \"@encode\", \"@import\", \"@available\",\n                    \"if\", \"else\", \"for\", \"while\", \"switch\", \"case\", \"default\", \"break\", \"continue\", \"return\",\n                    \"struct\", \"typedef\", \"enum\", \"static\", \"const\", \"void\", \"int\", \"char\", \"float\", \"double\",\n                    \"BOOL\", \"YES\", \"NO\", \"nil\", \"self\", \"super\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:id|instancetype|SEL|Class|BOOL|NSInteger|NSUInteger|CGFloat|NSString|NSNumber|NSArray|NSDictionary|NSData|NSDate|NSURL|NSError)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings + [\"@\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .html:\n            return LanguageRules(\n                keywords: [\"DOCTYPE\", \"html\", \"head\", \"body\", \"script\", \"style\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .xml:\n            return LanguageRules(\n                keywords: [\"xml\", \"version\", \"encoding\", \"CDATA\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z_][A-Za-z0-9:._-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\", \"<!\\\\[CDATA\\\\[[\\\\s\\\\S]*?\\\\]\\\\]>\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .css:\n            return LanguageRules(\n                keywords: [\"@import\", \"@media\", \"@supports\", \"@keyframes\", \"@font-face\", \"@page\", \"@layer\", \"important\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"(?:\\\\.|#)([A-Za-z_-][A-Za-z0-9_-]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\b(?=\\\\s*\\\\{)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: \"\\\\b\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:%|px|em|rem|vw|vh|vmin|vmax|fr|ch|ex|cm|mm|in|pt|pc)?\\\\b\",\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\s*(?=:)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: [])\n                ]\n            )\n\n        case .scss:\n            let css = languageRules(for: .css)\n            return LanguageRules(\n                keywords: css.keywords + [\"@mixin\", \"@include\", \"@extend\", \"@function\", \"@return\", \"@if\", \"@else\", \"@for\", \"@each\", \"@while\"],\n                typePatterns: css.typePatterns,\n                stringPatterns: css.stringPatterns,\n                stringRegexOptions: css.stringRegexOptions,\n                commentPatterns: [\"/\\\\*[\\\\s\\\\S]*?\\\\*/\", \"//[^\\\\n]*\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: css.numberPattern,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: css.functionPatterns\n            )\n\n        case .json:\n            return LanguageRules(\n                keywords: [\"true\", \"false\", \"null\"],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"//[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .yaml:\n            return LanguageRules(\n                keywords: [\"true\", \"false\", \"null\", \"yes\", \"no\", \"on\", \"off\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"([&*][A-Za-z0-9_-]+)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"^\\\\s*([A-Za-z0-9_-]+)\\\\s*:(?=\\\\s|$)\", captureGroup: 1, options: [.anchorsMatchLines])\n                ]\n            )\n\n        case .sql:\n            return LanguageRules(\n                keywords: [\n                    \"select\", \"from\", \"where\", \"group\", \"by\", \"having\", \"order\", \"limit\", \"offset\",\n                    \"insert\", \"into\", \"values\", \"update\", \"set\", \"delete\",\n                    \"join\", \"inner\", \"left\", \"right\", \"full\", \"outer\", \"cross\", \"on\",\n                    \"as\", \"distinct\", \"union\", \"all\", \"and\", \"or\", \"not\", \"null\", \"is\", \"in\", \"exists\", \"like\", \"between\",\n                    \"create\", \"alter\", \"drop\", \"table\", \"view\", \"index\", \"primary\", \"key\", \"foreign\", \"references\",\n                    \"case\", \"when\", \"then\", \"else\", \"end\",\n                    \"begin\", \"commit\", \"rollback\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|integer|smallint|bigint|serial|bigserial|decimal|numeric|real|double|float|money|boolean|bool|date|time|timestamp|timestamptz|varchar|char|text|uuid|json|jsonb)\\\\b\", captureGroup: nil, options: [.caseInsensitive])\n                ],\n                stringPatterns: [\"'(?:''|[^'])*'\", \"\\\"(?:\\\"\\\"|[^\\\"])*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"--[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: [.caseInsensitive])\n                ]\n            )\n\n        case .shell:\n            return LanguageRules(\n                keywords: [\n                    \"if\", \"then\", \"elif\", \"else\", \"fi\", \"for\", \"in\", \"do\", \"done\", \"case\", \"esac\", \"while\", \"until\",\n                    \"select\", \"function\", \"time\", \"coproc\", \"break\", \"continue\", \"return\", \"exit\", \"export\", \"readonly\",\n                    \"local\", \"declare\", \"typeset\", \"unset\", \"shift\", \"trap\", \"set\"\n                ],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'[^'\\\\n]*'\", \"\\\\$'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*\\\\(\\\\s*\\\\)\\\\s*\\\\{\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .dockerfile:\n            return LanguageRules(\n                keywords: [\n                    \"FROM\", \"RUN\", \"CMD\", \"LABEL\", \"MAINTAINER\", \"EXPOSE\", \"ENV\", \"ADD\", \"COPY\", \"ENTRYPOINT\",\n                    \"VOLUME\", \"USER\", \"WORKDIR\", \"ARG\", \"ONBUILD\", \"STOPSIGNAL\", \"HEALTHCHECK\", \"SHELL\"\n                ],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .graphql:\n            return LanguageRules(\n                keywords: [\n                    \"query\", \"mutation\", \"subscription\", \"fragment\", \"on\",\n                    \"schema\", \"type\", \"interface\", \"union\", \"enum\", \"input\", \"extend\", \"directive\", \"implements\",\n                    \"scalar\", \"true\", \"false\", \"null\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:Int|Float|String|Boolean|ID)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .markdown:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [],\n                stringPatterns: [\n                    \"```[\\\\s\\\\S]*?```\",\n                    \"~~~[\\\\s\\\\S]*?~~~\",\n                    \"`[^`\\\\n]+`\"\n                ],\n                stringRegexOptions:

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":260}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":900,"end_line":1100}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":20}
>>>END

>>>TOOL search
{"query":"FEAT-022", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL search
{"query":"case .ruby", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":350,"end_line":520}
>>>END



>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":390,"end_line":620}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":15}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":480,"end_line":620}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":390,"end_line":575}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":500,"end_line":585}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":860,"end_line":1020}
>>>END

>>>TOOL create_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","overwrite":false,"content":""}
>>>END

>>>TOOL search
{"query":"case .ruby:", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":12}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":8}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":900,"end_line":1020}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":6}
>>>END

>>>TOOL search
{"query":"import SwiftUI", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL create_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","overwrite":true,"content":"import SwiftUI\nimport UIKit\n\n// Efficient NSMutableAttributedString-based syntax highlighter (regex-based).\n//\n// Color mapping (per requirements):\n// - Keywords: blue\n// - Types: cyan\n// - Strings: orange\n// - Comments: gray\n// - Numbers: green\n// - Functions: yellow\nfinal class NSAttributedStringSyntaxHighlighter {\n\n    // MARK: - Language\n\n    // NOTE: This file cannot use the name `Language` because the project already defines a global `Language`\n    // enum elsewhere (VSCodeiPadOS/Views/Editor/SyntaxHighlightingTextView.swift).\n    enum SyntaxLanguage {\n        case swift, javascript, typescript, jsx, tsx\n        case python, ruby, go, rust\n        case java, kotlin\n        case c, cpp, objc\n        case html, css, scss\n        case json, xml, yaml\n        case sql, shell, dockerfile, graphql\n        case markdown, php, dotenv\n        case plainText\n    }\n\n    // MARK: - Colors\n\n    private struct ColorScheme {\n        static let keyword = UIColor.systemBlue\n        static let type = UIColor.systemCyan\n        static let string = UIColor.systemOrange\n        static let comment = UIColor.systemGray\n        static let number = UIColor.systemGreen\n        static let function = UIColor.systemYellow\n        static let defaultText = UIColor.label\n    }\n\n    // MARK: - Public API\n\n    /// Backwards-compatible entrypoint (defaults to Swift).\n    static func highlightCode(_ code: String) -> NSAttributedString {\n        highlightCode(code, filename: nil, language: .swift)\n    }\n\n    /// Highlights `code` using either an explicit `language` or a detected one from `filename`.\n    static func highlightCode(_ code: String, filename: String? = nil, language: SyntaxLanguage? = nil) -> NSAttributedString {\n        let attributed = NSMutableAttributedString(string: code)\n        let fullRange = NSRange(location: 0, length: code.utf16.count)\n\n        attributed.addAttributes([\n            .font: UIFont.monospacedSystemFont(ofSize: 14, weight: .regular),\n            .foregroundColor: ColorScheme.defaultText\n        ], range: fullRange)\n\n        let resolvedLanguage: SyntaxLanguage = {\n            if let language { return language }\n            if let filename { return detectLanguage(fromFilename: filename) }\n            return .plainText\n        }()\n\n        highlight(code: code, language: resolvedLanguage, into: attributed)\n        return attributed\n    }\n\n    // MARK: - Language detection\n\n    private static func detectLanguage(fromFilename filename: String) -> SyntaxLanguage {\n        let lower = filename.lowercased()\n        let base = (lower as NSString).lastPathComponent\n        let ext = (base as NSString).pathExtension\n\n        // Special basenames (no extension).\n        if base == \"dockerfile\" || base.hasPrefix(\"dockerfile.\") { return .dockerfile }\n        if base == \".env\" || base.hasPrefix(\".env.\") || ext == \"env\" { return .dotenv }\n\n        switch ext {\n        case \"swift\": return .swift\n        case \"js\", \"mjs\", \"cjs\": return .javascript\n        case \"jsx\": return .jsx\n        case \"ts\": return .typescript\n        case \"tsx\": return .tsx\n        case \"py\", \"pyw\": return .python\n        case \"rb\", \"ruby\": return .ruby\n        case \"go\": return .go\n        case \"rs\": return .rust\n        case \"java\": return .java\n        case \"kt\", \"kts\": return .kotlin\n        case \"c\": return .c\n        case \"cc\", \"cpp\", \"cxx\", \"hpp\", \"hh\", \"hxx\", \"h\": return .cpp\n        case \"m\", \"mm\": return .objc\n        case \"html\", \"htm\": return .html\n        case \"css\": return .css\n        case \"scss\", \"sass\": return .scss\n        case \"json\", \"jsonc\": return .json\n        case \"xml\", \"plist\", \"svg\": return .xml\n        case \"yml\", \"yaml\": return .yaml\n        case \"sql\": return .sql\n        case \"sh\", \"bash\", \"zsh\", \"fish\": return .shell\n        case \"php\": return .php\n        case \"gql\", \"graphql\": return .graphql\n        case \"md\", \"markdown\": return .markdown\n        default: return .plainText\n        }\n    }\n\n    // MARK: - Pipeline\n\n    private struct CapturePattern {\n        let pattern: String\n        let captureGroup: Int?\n        let options: NSRegularExpression.Options\n    }\n\n    private struct LanguageRules {\n        let keywords: [String]\n        let typePatterns: [CapturePattern]\n        let stringPatterns: [String]\n        let stringRegexOptions: NSRegularExpression.Options\n        let commentPatterns: [String]\n        let commentRegexOptions: NSRegularExpression.Options\n        let numberPattern: String?\n        let numberRegexOptions: NSRegularExpression.Options\n        let keywordRegexOptions: NSRegularExpression.Options\n        let functionPatterns: [CapturePattern]\n    }\n\n    private static func highlight(code: String, language: SyntaxLanguage, into attributed: NSMutableAttributedString) {\n        let rules = languageRules(for: language)\n\n        // 1) Strings first\n        let stringRanges = rules.stringPatterns.flatMap { pattern in\n            applyHighlighting(\n                pattern: pattern,\n                options: rules.stringRegexOptions,\n                color: ColorScheme.string,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: []\n            )\n        }\n\n        // 2) Comments (exclude matches inside strings)\n        let commentRanges = rules.commentPatterns.flatMap { pattern in\n            applyHighlighting(\n                pattern: pattern,\n                options: rules.commentRegexOptions,\n                color: ColorScheme.comment,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: stringRanges\n            )\n        }\n\n        let protectedRanges = stringRanges + commentRanges\n\n        // 3) Numbers\n        if let numberPattern = rules.numberPattern {\n            _ = applyHighlighting(\n                pattern: numberPattern,\n                options: rules.numberRegexOptions,\n                color: ColorScheme.number,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: protectedRanges\n            )\n        }\n\n        // 4) Types\n        for typePattern in rules.typePatterns {\n            _ = applyHighlighting(\n                pattern: typePattern.pattern,\n                options: typePattern.options,\n                color: ColorScheme.type,\n                to: attributed,\n                in: code,\n                captureGroup: typePattern.captureGroup,\n                excluding: protectedRanges\n            )\n        }\n\n        // 5) Keywords\n        if !rules.keywords.isEmpty {\n            let keywordPattern = \"\\\\b(?:\" + rules.keywords.map(NSRegularExpression.escapedPattern).joined(separator: \"|\") + \")\\\\b\"\n            _ = applyHighlighting(\n                pattern: keywordPattern,\n                options: rules.keywordRegexOptions,\n                color: ColorScheme.keyword,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: protectedRanges\n            )\n        }\n\n        // 6) Functions\n        for fnPattern in rules.functionPatterns {\n            _ = applyHighlighting(\n                pattern: fnPattern.pattern,\n                options: fnPattern.options,\n                color: ColorScheme.function,\n                to: attributed,\n                in: code,\n                captureGroup: fnPattern.captureGroup,\n                excluding: protectedRanges\n            )\n        }\n    }\n\n    // MARK: - Language rules\n\n    private static func languageRules(for language: SyntaxLanguage) -> LanguageRules {\n\n        // Numeric literal coverage (hex, float, exponent, underscores).\n        let commonNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)\\\\b\"\n\n        // C-like strings: \"...\" and '...'\n        let cLikeStrings = [\n            \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n            \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n        ]\n\n        // C-like comments\n        let cLikeComments = [\n            \"//[^\\\\n]*\",\n            \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"\n        ]\n\n        // Common function call: name(\n        let commonFunctionCall = CapturePattern(\n            pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\",\n            captureGroup: 1,\n            options: []\n        )\n\n        switch language {\n\n        case .swift:\n            return LanguageRules(\n                keywords: [\n                    \"func\", \"var\", \"let\", \"if\", \"else\", \"for\", \"while\", \"repeat\", \"switch\", \"case\", \"default\",\n                    \"return\", \"import\", \"class\", \"struct\", \"enum\", \"protocol\", \"extension\", \"actor\",\n                    \"private\", \"fileprivate\", \"public\", \"internal\", \"open\", \"static\", \"final\", \"override\",\n                    \"self\", \"super\", \"init\", \"deinit\",\n                    \"throw\", \"throws\", \"rethrows\", \"try\", \"catch\", \"do\", \"guard\", \"defer\",\n                    \"async\", \"await\",\n                    \"weak\", \"unowned\", \"mutating\", \"nonmutating\",\n                    \"typealias\", \"associatedtype\", \"where\", \"in\", \"is\", \"as\", \"Any\", \"some\", \"any\",\n                    \"true\", \"false\", \"nil\"\n                ],\n                typePatterns: [\n                    CapturePattern(\n                        pattern: \"\\\\b(?:String|Int|Int8|Int16|Int32|Int64|UInt|UInt8|UInt16|UInt32|UInt64|Double|Float|Bool|Character|Void|AnyObject|Never|Data|Date|URL|UUID|CGFloat)\\\\b\",\n                        captureGroup: nil,\n                        options: []\n                    ),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\"] + cLikeStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunc\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .javascript:\n            return LanguageRules(\n                keywords: [\n                    \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"debugger\", \"default\", \"delete\",\n                    \"do\", \"else\", \"export\", \"extends\", \"finally\", \"for\", \"function\", \"if\", \"import\", \"in\",\n                    \"instanceof\", \"let\", \"new\", \"return\", \"super\", \"switch\", \"this\", \"throw\", \"try\", \"typeof\",\n                    \"var\", \"void\", \"while\", \"with\", \"yield\", \"async\", \"await\", \"of\", \"true\", \"false\", \"null\", \"undefined\"\n                ],\n                typePatterns: [CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])],\n                stringPatterns: cLikeStrings + [\n                    \"`(?:[^`\\\\\\\\]|\\\\\\\\.|\\\\$\\\\{[\\\\s\\\\S]*?\\\\})*`\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b(?:const|let|var)\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\s*=\\\\s*(?:async\\\\s*)?(?:\\\\([^)]*\\\\)|[A-Za-z_][A-Za-z0-9_]*)?\\\\s*=>\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .typescript:\n            return LanguageRules(\n                keywords: [\n                    // JS\n                    \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"debugger\", \"default\", \"delete\",\n                    \"do\", \"else\", \"export\", \"extends\", \"finally\", \"for\", \"function\", \"if\", \"import\", \"in\",\n                    \"instanceof\", \"let\", \"new\", \"return\", \"super\", \"switch\", \"this\", \"throw\", \"try\", \"typeof\",\n                    \"var\", \"void\", \"while\", \"with\", \"yield\", \"async\", \"await\", \"of\", \"true\", \"false\", \"null\", \"undefined\",\n                    // TS\n                    \"interface\", \"type\", \"enum\", \"implements\", \"namespace\", \"abstract\", \"declare\", \"readonly\",\n                    \"private\", \"protected\", \"public\", \"keyof\", \"infer\", \"unknown\", \"never\", \"any\", \"as\", \"satisfies\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:string|number|boolean|any|unknown|never|void|object|bigint|symbol)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings + [\"`(?:[^`\\\\\\\\]|\\\\\\\\.|\\\\$\\\\{[\\\\s\\\\S]*?\\\\})*`\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .tsx:\n            // TSX = TypeScript + JSX tags/attributes as \"types\" (cyan).\n            let ts = languageRules(for: .typescript)\n            return LanguageRules(\n                keywords: ts.keywords,\n                typePatterns: ts.typePatterns + [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:_-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: ts.stringPatterns,\n                stringRegexOptions: ts.stringRegexOptions,\n                commentPatterns: ts.commentPatterns,\n                commentRegexOptions: ts.commentRegexOptions,\n                numberPattern: ts.numberPattern,\n                numberRegexOptions: ts.numberRegexOptions,\n                keywordRegexOptions: ts.keywordRegexOptions,\n                functionPatterns: ts.functionPatterns\n            )\n\n        case .jsx:\n            // JSX = JS plus tag/attribute as \"types\" for cyan.\n            let js = languageRules(for: .javascript)\n            return LanguageRules(\n                keywords: js.keywords,\n                typePatterns: js.typePatterns + [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:_-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: js.stringPatterns,\n                stringRegexOptions: js.stringRegexOptions,\n                commentPatterns: js.commentPatterns,\n                commentRegexOptions: js.commentRegexOptions,\n                numberPattern: js.numberPattern,\n                numberRegexOptions: js.numberRegexOptions,\n                keywordRegexOptions: js.keywordRegexOptions,\n                functionPatterns: js.functionPatterns\n            )\n\n        case .python:\n            return LanguageRules(\n                keywords: [\n                    \"False\", \"None\", \"True\", \"and\", \"as\", \"assert\", \"async\", \"await\", \"break\", \"class\",\n                    \"continue\", \"def\", \"del\", \"elif\", \"else\", \"except\", \"finally\", \"for\", \"from\", \"global\",\n                    \"if\", \"import\", \"in\", \"is\", \"lambda\", \"nonlocal\", \"not\", \"or\", \"pass\", \"raise\", \"return\",\n                    \"try\", \"while\", \"with\", \"yield\", \"match\", \"case\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|float|bool|str|bytes|list|tuple|set|dict|object)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\n                    \"'''[\\\\s\\\\S]*?'''\",\n                    \"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\",\n                    \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                    \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bdef\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // FEAT-023 Ruby syntax (gpt52 regex patterns)\n        case .ruby:\n            // Numeric literals (underscores, bases, float/exponent) plus rational/complex suffix.\n            let rbNumber = \"(?<![\\\\w$@])(?:0[xX][0-9A-Fa-f_]+|0[bB][01_]+|0[oO]?[0-7_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?|\\\\.\\\\d[\\\\d_]*(?:[eE][+-]?\\\\d[\\\\d_]*)?)(?:r|i)?(?!\\\\w)\"\n\n            // Strings: quotes, backticks, % literals (common delimiters), and a best-effort heredoc.\n            let rbStrings: [String] = [\n                // Heredoc: <<, <<-, <<~ with optional quotes around terminator\n                \"<<[-~]?['\\\"]?([A-Za-z_][A-Za-z0-9_]*)['\\\"]?\\\\n[\\\\s\\\\S]*?\\\\n\\\\1\",\n                \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                \"`(?:[^`\\\\\\\\\\\\n]|\\\\\\\\.)*`\",\n                \"%[qQwWxrs]?\\\\{[\\\\s\\\\S]*?\\\\}\",\n                \"%[qQwWxrs]?\\\\([\\\\s\\\\S]*?\\\\)\",\n                \"%[qQwWxrs]?\\\\[[\\\\s\\\\S]*?\\\\]\",\n                \"%[qQwWxrs]?<[\\\\s\\\\S]*?>\",\n                \"%[qQwWxrs]?\\\\|[\\\\s\\\\S]*?\\\\|\"\n            ]\n\n            return LanguageRules(\n                keywords: [\n                    \"BEGIN\", \"END\", \"alias\", \"and\", \"begin\", \"break\", \"case\", \"class\", \"def\", \"defined?\",\n                    \"do\", \"else\", \"elsif\", \"end\", \"ensure\", \"false\", \"for\", \"if\", \"in\", \"module\", \"next\",\n                    \"nil\", \"not\", \"or\", \"redo\", \"rescue\", \"retry\", \"return\", \"self\", \"super\", \"then\",\n                    \"true\", \"undef\", \"unless\", \"until\", \"when\", \"while\", \"yield\",\n                    \"private\", \"protected\", \"public\"\n                ],\n                typePatterns: [\n                    // Constants\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: rbStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators, .anchorsMatchLines],\n                commentPatterns: [\n                    \"#[^\\\\n]*\",\n                    // =begin/=end must be at line start\n                    \"^=begin\\\\b[\\\\s\\\\S]*?^=end\\\\b\"\n                ],\n                commentRegexOptions: [.dotMatchesLineSeparators, .anchorsMatchLines],\n                numberPattern: rbNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    // def foo / def foo? / def foo! / def foo= / def self.foo / def SomeClass.foo\n                    CapturePattern(pattern: \"\\\\bdef\\\\s+(?:self\\\\.|[A-Z][A-Za-z0-9_]*\\\\.)?([A-Za-z_][A-Za-z0-9_]*[!?=]?)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .go:\n            return LanguageRules(\n                keywords: [\n                    \"break\", \"default\", \"func\", \"interface\", \"select\", \"case\", \"defer\", \"go\", \"map\", \"struct\",\n                    \"chan\", \"else\", \"goto\", \"package\", \"switch\", \"const\", \"fallthrough\", \"if\", \"range\", \"type\",\n                    \"continue\", \"for\", \"import\", \"return\", \"var\", \"true\", \"false\", \"nil\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:string|bool|byte|rune|int|int8|int16|int32|int64|uint|uint8|uint16|uint32|uint64|uintptr|float32|float64|complex64|complex128|error)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"`[\\\\s\\\\S]*?`\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunc\\\\s+(?:\\\\([^)]*\\\\)\\\\s*)?([A-Za-z_][A-Za-z0-9_]*)\\\\s*\\\\(\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .rust:\n            // FEAT-019 Rust (gpt52 regex patterns)\n            let rustNumber = \"\\\\b(?:0b[01_]+|0o[0-7_]+|0x[0-9A-Fa-f_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)(?:u(?:8|16|32|64|128|size)|i(?:8|16|32|64|128|size)|f(?:32|64))?\\\\b\"\n            return LanguageRules(\n                keywords: [\n                    // Strict/used keywords\n                    \"as\", \"break\", \"const\", \"continue\", \"crate\", \"else\", \"enum\", \"extern\", \"false\", \"fn\", \"for\",\n                    \"if\", \"impl\", \"in\", \"let\", \"loop\", \"match\", \"mod\", \"move\", \"mut\", \"pub\", \"ref\", \"return\",\n                    \"self\", \"Self\", \"static\", \"struct\", \"super\", \"trait\", \"true\", \"type\", \"unsafe\", \"use\",\n                    \"where\", \"while\", \"async\", \"await\", \"dyn\",\n                    // Common/reserved (best-effort)\n                    \"union\", \"macro_rules\", \"yield\", \"try\", \"box\", \"abstract\", \"become\", \"do\", \"final\", \"override\",\n                    \"priv\", \"typeof\", \"unsized\", \"virtual\"\n                ],\n                typePatterns: [\n                    CapturePattern(\n                        pattern: \"\\\\b(?:i8|i16|i32|i64|i128|isize|u8|u16|u32|u64|u128|usize|f32|f64|bool|char|str|String|Option|Result|Vec|Box|Rc|Arc|HashMap|HashSet|BTreeMap|BTreeSet)\\\\b\",\n                        captureGroup: nil,\n                        options: []\n                    ),\n                    // Lifetimes: 'a, 'static (avoid matching char literals like 'a')\n                    CapturePattern(pattern: \"\\\\B'([A-Za-z_][A-Za-z0-9_]*)(?!')\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\n                    \"r(#*)\\\"[\\\\s\\\\S]*?\\\"\\\\1\",\n                    \"br(#*)\\\"[\\\\s\\\\S]*?\\\"\\\\1\",\n                    \"b\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                    \"b'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                    \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                    \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\n                    \"//[^\\\\n]*\",\n                    \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"\n                ],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: rustNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfn\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)!\\\\s*(?=\\\\()\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // FEAT-022 Java syntax (gpt52 regex patterns)\n        case .java:\n            // Java numeric literals: binary/hex/dec, hex-floats with p/P exponent, optional suffix.\n            let javaNumber = \"(?<!\\\\w)(?:0[bB][01_]+|0[xX][0-9A-Fa-f_]+(?:\\\\.[0-9A-Fa-f_]*)?(?:[pP][+-]?\\\\d[\\\\d_]*)[fFdD]?|0[xX][0-9A-Fa-f_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?|\\\\.\\\\d[\\\\d_]*(?:[eE][+-]?\\\\d[\\\\d_]*)?)(?:[lLfFdD])?(?!\\\\w)\"\n\n            return LanguageRules(\n                keywords: [\n                    \"abstract\", \"assert\", \"boolean\", \"break\", \"byte\", \"case\", \"catch\", \"char\", \"class\",\n                    \"const\", \"continue\", \"default\", \"do\", \"double\", \"else\", \"enum\", \"extends\", \"final\",\n                    \"finally\", \"float\", \"for\", \"goto\", \"if\", \"implements\", \"import\", \"instanceof\", \"int\",\n                    \"interface\", \"long\", \"native\", \"new\", \"package\", \"private\", \"protected\", \"public\",\n                    \"return\", \"short\", \"static\", \"strictfp\", \"super\", \"switch\", \"synchronized\", \"this\",\n                    \"throw\", \"throws\", \"transient\", \"try\", \"void\", \"volatile\", \"while\",\n                    \"true\", \"false\", \"null\",\n                    // newer/common\n                    \"var\", \"record\", \"sealed\", \"permits\", \"non-sealed\"\n                ],\n                typePatterns: [\n                    CapturePattern(\n                        pattern: \"\\\\b(?:boolean|byte|char|short|int|long|float|double|void|String|Object|Integer|Long|Double|Float|Boolean|Character|List|Map|Set|Optional)\\\\b\",\n                        captureGroup: nil,\n                        options: []\n                    ),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\n                    // Java text blocks\n                    \"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\",\n                    \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                    \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: javaNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    // Best-effort method declarations (with annotations/modifiers) at line-start\n                    CapturePattern(\n                        pattern: \"^(?:\\\\s*@\\\\w+(?:\\\\([^)]*\\\\))?\\\\s*)*(?:\\\\s*(?:public|protected|private|static|final|abstract|synchronized|native|strictfp|default)\\\\s+)*(?:<[^>]+>\\\\s*)?(?:[A-Za-z_][A-Za-z0-9_$.<>\\\\[\\\\], ?]+\\\\s+)+([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\",\n                        captureGroup: 1,\n                        options: [.anchorsMatchLines]\n                    ),\n                    commonFunctionCall\n                ]\n            )\n\n        // FEAT-022 Kotlin syntax (gpt52 regex patterns)\n        case .kotlin:\n            let ktNumber = \"(?<!\\\\w)(?:0[bB][01_]+|0[xX][0-9A-Fa-f_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?|\\\\.\\\\d[\\\\d_]*(?:[eE][+-]?\\\\d[\\\\d_]*)?)(?:(?:[fF]|[dD])|(?:[lL])|(?:[uU](?:[lL])?))?(?!\\\\w)\"\n\n            return LanguageRules(\n                keywords: [\n                    \"as\", \"break\", \"class\", \"continue\", \"do\", \"else\", \"false\", \"for\", \"fun\", \"if\", \"in\",\n                    \"interface\", \"is\", \"null\", \"object\", \"package\", \"return\", \"super\", \"this\", \"throw\",\n                    \"true\", \"try\", \"typealias\", \"val\", \"var\", \"when\", \"while\",\n                    \"by\", \"catch\", \"constructor\", \"delegate\", \"finally\", \"get\", \"import\", \"init\", \"set\", \"where\",\n                    \"actual\", \"abstract\", \"annotation\", \"companion\", \"const\", \"crossinline\", \"data\", \"enum\",\n                    \"expect\", \"external\", \"final\", \"infix\", \"inline\", \"inner\", \"internal\", \"lateinit\",\n                    \"noinline\", \"open\", \"operator\", \"out\", \"override\", \"private\", \"protected\", \"public\",\n                    \"reified\", \"sealed\", \"suspend\", \"tailrec\", \"vararg\"\n                ],\n                typePatterns: [\n                    CapturePattern(\n                        pattern: \"\\\\b(?:Int|Long|Short|Byte|Float|Double|Boolean|Char|String|Unit|Any|Nothing|List|MutableList|Map|MutableMap|Set|MutableSet)\\\\b\",\n                        captureGroup: nil,\n                        options: []\n                    ),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\n                    \"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\",\n                    \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                    \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: ktNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    // fun foo(...) / fun Receiver.foo(...)\n                    CapturePattern(pattern: \"\\\\bfun\\\\s+(?:<[^>]+>\\\\s*)?(?:[A-Za-z_][A-Za-z0-9_]*\\\\.)?([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .c:\n            return LanguageRules(\n                keywords: [\n                    \"auto\", \"break\", \"case\", \"char\", \"const\", \"continue\", \"default\", \"do\", \"double\", \"else\",\n                    \"enum\", \"extern\", \"float\", \"for\", \"goto\", \"if\", \"inline\", \"int\", \"long\", \"register\",\n                    \"restrict\", \"return\", \"short\", \"signed\", \"sizeof\", \"static\", \"struct\", \"switch\", \"typedef\",\n                    \"union\", \"unsigned\", \"void\", \"volatile\", \"while\", \"_Bool\", \"_Complex\", \"_Imaginary\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:char|short|int|long|float|double|void|size_t|ssize_t|bool)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .cpp:\n            return LanguageRules(\n                keywords: [\n                    \"alignas\", \"alignof\", \"and\", \"and_eq\", \"asm\", \"auto\", \"bitand\", \"bitor\", \"bool\", \"break\",\n                    \"case\", \"catch\", \"char\", \"char8_t\", \"char16_t\", \"char32_t\", \"class\", \"compl\", \"concept\",\n                    \"const\", \"consteval\", \"constexpr\", \"constinit\", \"continue\", \"co_await\", \"co_return\", \"co_yield\",\n                    \"default\", \"delete\", \"do\", \"double\", \"dynamic_cast\", \"else\", \"enum\", \"explicit\", \"export\", \"extern\",\n                    \"false\", \"float\", \"for\", \"friend\", \"goto\", \"if\", \"inline\", \"int\", \"long\", \"mutable\", \"namespace\",\n                    \"new\", \"noexcept\", \"not\", \"not_eq\", \"nullptr\", \"operator\", \"or\", \"or_eq\", \"private\", \"protected\",\n                    \"public\", \"register\", \"reinterpret_cast\", \"requires\", \"return\", \"short\", \"signed\", \"sizeof\",\n                    \"static\", \"static_assert\", \"static_cast\", \"struct\", \"switch\", \"template\", \"this\", \"thread_local\",\n                    \"throw\", \"true\", \"try\", \"typedef\", \"typeid\", \"typename\", \"union\", \"unsigned\", \"using\", \"virtual\",\n                    \"void\", \"volatile\", \"wchar_t\", \"while\", \"xor\", \"xor_eq\", \"final\", \"override\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:bool|char|short|int|long|float|double|void|wchar_t|size_t|ssize_t|string|std::[A-Za-z0-9_:]+)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .objc:\n            return LanguageRules(\n                keywords: [\n                    \"@interface\", \"@implementation\", \"@end\", \"@property\", \"@synthesize\", \"@dynamic\", \"@protocol\",\n                    \"@class\", \"@public\", \"@private\", \"@protected\", \"@package\",\n                    \"@try\", \"@catch\", \"@finally\", \"@throw\", \"@autoreleasepool\",\n                    \"@selector\", \"@encode\", \"@import\", \"@available\",\n                    \"if\", \"else\", \"for\", \"while\", \"switch\", \"case\", \"default\", \"break\", \"continue\", \"return\",\n                    \"struct\", \"typedef\", \"enum\", \"static\", \"const\", \"void\", \"int\", \"char\", \"float\", \"double\",\n                    \"BOOL\", \"YES\", \"NO\", \"nil\", \"self\", \"super\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:id|instancetype|SEL|Class|BOOL|NSInteger|NSUInteger|CGFloat|NSString|NSNumber|NSArray|NSDictionary|NSData|NSDate|NSURL|NSError)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings + [\"@\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .html:\n            return LanguageRules(\n                keywords: [\"DOCTYPE\", \"html\", \"head\", \"body\", \"script\", \"style\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .xml:\n            return LanguageRules(\n                keywords: [\"xml\", \"version\", \"encoding\", \"CDATA\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z_][A-Za-z0-9:._-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\", \"<!\\\\[CDATA\\\\[[\\\\s\\\\S]*?\\\\]\\\\]>\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .css:\n            return LanguageRules(\n                keywords: [\"@import\", \"@media\", \"@supports\", \"@keyframes\", \"@font-face\", \"@page\", \"@layer\", \"important\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"(?:\\\\.|#)([A-Za-z_-][A-Za-z0-9_-]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\b(?=\\\\s*\\\\{)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: \"\\\\b\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:%|px|em|rem|vw|vh|vmin|vmax|fr|ch|ex|cm|mm|in|pt|pc)?\\\\b\",\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\s*(?=:)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: [])\n                ]\n            )\n\n        case .scss:\n            let css = languageRules(for: .css)\n            return LanguageRules(\n                keywords: css.keywords + [\"@mixin\", \"@include\", \"@extend\", \"@function\", \"@return\", \"@if\", \"@else\", \"@for\", \"@each\", \"@while\"],\n                typePatterns: css.typePatterns,\n                stringPatterns: css.stringPatterns,\n                stringRegexOptions: css.stringRegexOptions,\n                commentPatterns: [\"/\\\\*[\\\\s\\\\S]*?\\\\*/\", \"//[^\\\\n]*\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: css.numberPattern,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: css.functionPatterns\n            )\n\n        case .json:\n            return LanguageRules(\n                keywords: [\"true\", \"false\", \"null\"],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"//[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .yaml:\n            return LanguageRules(\n                keywords: [\"true\", \"false\", \"null\", \"yes\", \"no\", \"on\", \"off\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"([&*][A-Za-z0-9_-]+)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"^\\\\s*([A-Za-z0-9_-]+)\\\\s*:(?=\\\\s|$)\", captureGroup: 1, options: [.anchorsMatchLines])\n                ]\n            )\n\n        case .sql:\n            return LanguageRules(\n                keywords: [\n                    \"select\", \"from\", \"where\", \"group\", \"by\", \"having\", \"order\", \"limit\", \"offset\",\n                    \"insert\", \"into\", \"values\", \"update\", \"set\", \"delete\",\n                    \"join\", \"inner\", \"left\", \"right\", \"full\", \"outer\", \"cross\", \"on\",\n                    \"as\", \"distinct\", \"union\", \"all\", \"and\", \"or\", \"not\", \"null\", \"is\", \"in\", \"exists\", \"like\", \"between\",\n                    \"create\", \"alter\", \"drop\", \"table\", \"view\", \"index\", \"primary\", \"key\", \"foreign\", \"references\",\n                    \"case\", \"when\", \"then\", \"else\", \"end\",\n                    \"begin\", \"commit\", \"rollback\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|integer|smallint|bigint|serial|bigserial|decimal|numeric|real|double|float|money|boolean|bool|date|time|timestamp|timestamptz|varchar|char|text|uuid|json|jsonb)\\\\b\", captureGroup: nil, options: [.caseInsensitive])\n                ],\n                stringPatterns: [\"'(?:''|[^'])*'\", \"\\\"(?:\\\"\\\"|[^\\\"])*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"--[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: [.caseInsensitive])\n                ]\n            )\n\n        case .shell:\n            return LanguageRules(\n                keywords: [\n                    \"if\", \"then\", \"elif\", \"else\", \"fi\", \"for\", \"in\", \"do\", \"done\", \"case\", \"esac\", \"while\", \"until\",\n                    \"select\", \"function\", \"time\", \"coproc\", \"break\", \"continue\", \"return\", \"exit\", \"export\", \"readonly\",\n                    \"local\", \"declare\", \"typeset\", \"unset\", \"shift\", \"trap\", \"set\"\n                ],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'[^'\\\\n]*'\", \"\\\\$'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*\\\\(\\\\s*\\\\)\\\\s*\\\\{\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .dockerfile:\n            return LanguageRules(\n                keywords: [\n                    \"FROM\", \"RUN\", \"CMD\", \"LABEL\", \"MAINTAINER\", \"EXPOSE\", \"ENV\", \"ADD\", \"COPY\", \"ENTRYPOINT\",\n                    \"VOLUME\", \"USER\", \"WORKDIR\", \"ARG\", \"ONBUILD\", \"STOPSIGNAL\", \"HEALTHCHECK\", \"SHELL\"\n                ],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .graphql:\n            return LanguageRules(\n                keywords: [\n                    \"query\", \"mutation\", \"subscription\", \"fragment\", \"on\",\n                    \"schema\", \"type\", \"interface\", \"union\", \"enum\", \"input\", \"extend\", \"directive\", \"implements\",\n                    \"scalar\", \"true\", \"false\", \"null\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:Int|Float|String|Boolean|ID)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .markdown:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [],\n                stringPatterns: [\n                    \"```[\\\\s\\\\S]*?```\",\n                    \"~~~[\\\\s\\\\S]*?~~~\",\n                    \"`[^`\\\\n]+`\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: nil,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .php:\n            return LanguageRules(\n                keywords: [\n                    \"abstract\", \"and\", \"array\", \"as\", \"break\", \"callable\", \"case\", \"catch\", \"class\", \"clone\",\n                    \"const\", \"continue\", \"declare\", \"default\", \"die\", \"do\", \"echo\", \"else\", \"elseif\", \"empty\",\n                    \"enddeclare\", \"endfor\", \"endforeach\", \"endif\", \"endswitch\", \"endwhile\", \"enum\", \"eval\", \"exit\",\n                    \"extends\", \"final\", \"finally\", \"fn\", \"for\", \"foreach\", \"function\", \"global\", \"goto\", \"if\",\n                    \"implements\", \"include\", \"include_once\", \"instanceof\", \"insteadof\", \"interface\", \"isset\",\n                    \"list\", \"match\", \"namespace\", \"new\", \"or\", \"print\", \"private\", \"protected\", \"public\", \"readonly\",\n                    \"require\", \"require_once\", \"return\", \"static\", \"switch\", \"throw\", \"trait\", \"try\", \"unset\", \"use\",\n                    \"var\", \"while\", \"xor\", \"yield\", \"true\", \"false\", \"null\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|float|string|bool|array|object|callable|iterable|mixed|void|never)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments + [\"#[^\\\\n]*\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .dotenv:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [\n                    // Keys in KEY=value or export KEY=value\n                    CapturePattern(\n                        pattern: \"^\\\\s*(?:export\\\\s+)?([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?==)\",\n                        captureGroup: 1,\n                        options: [.anchorsMatchLines]\n                    )\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .plainText:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [],\n                stringPatterns: [],\n                stringRegexOptions: [],\n                commentPatterns: [],\n                commentRegexOptions: [],\n                numberPattern: nil,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n        }\n    }\n\n    // MARK: - Regex application helpers\n\n    @discardableResult\n    private static func applyHighlighting(\n        pattern: String,\n        options: NSRegularExpression.Options,\n        color: UIColor,\n        to attributedString: NSMutableAttributedString,\n        in text: String,\n        captureGroup: Int?,\n        excluding excludedRanges: [NSRange]\n    ) -> [NSRange] {\n        do {\n            let regex = try NSRegularExpression(pattern: pattern, options: options)\n            let matches = regex.matches(in: text, options: [], range: NSRange(location: 0, length: text.utf16.count))\n\n            var applied: [NSRange] = []\n            applied.reserveCapacity(matches.count)\n\n            for match in matches {\n                let range: NSRange = {\n                    if let captureGroup, captureGroup <= match.numberOfRanges - 1 {\n                        return match.range(at: captureGroup)\n                    }\n                    return match.range\n                }()\n\n                guard range.location != NSNotFound, range.length > 0 else { continue }\n                if intersectsAny(range, excludedRanges) { continue }\n\n                attributedString.addAttribute(.foregroundColor, value: color, range: range)\n                applied.append(range)\n            }\n\n            return applied\n        } catch {\n            print(\"Regex error for pattern \\(pattern): \\(error)\")\n            return []\n        }\n    }\n\n    private static func intersectsAny(_ range: NSRange, _ excludedRanges: [NSRange]) -> Bool {\n        for ex in excludedRanges where NSIntersectionRange(range, ex).length > 0 {\n            return true\n        }\n        return false\n    }\n}\n\n// SwiftUI wrapper for NSAttributedString\nstruct AttributedTextView: UIViewRepresentable {\n    let attributedText: NSAttributedString\n\n    func makeUIView(context: Context) -> UITextView {\n        let textView = UITextView()\n        textView.isEditable = false\n        textView.isSelectable = true\n        textView.backgroundColor = .clear\n        textView.textContainerInset = UIEdgeInsets(top: 8, left: 8, bottom: 8, right: 8)\n        return textView\n    }\n\n    func updateUIView(_ uiView: UITextView, context: Context) {\n        uiView.attributedText = attributedText\n    }\n}\n\n// Extension to make it easy to use in SwiftUI\nextension View {\n    func syntaxHighlighted(\n        code: String,\n        filename: String? = nil,\n        language: NSAttributedStringSyntaxHighlighter.SyntaxLanguage? = nil\n    ) -> some View {\n        AttributedTextView(attributedText: NSAttributedStringSyntaxHighlighter.highlightCode(code, filename: filename, language: language))\n    }\n}\n"} 
>>>END

>>>TOOL search
{"query":"FEAT-023", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL search
{"query":"FEAT-022", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":360,"end_line":640}
>>>END

>>>TOOL search
{"query":"case .java:", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":940,"end_line":1033}
>>>END

>>>TOOL search
{"query":"case .ruby:", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":880,"end_line":1033}
>>>END

>>>REPORT
Implemented FEAT-023 Ruby and FEAT-022 Java/Kotlin highlighting rules in `Extensions/NSAttributedStringSyntaxHighlighter.swift` by adding/using gpt52-tuned regex patterns while keeping the required token categories (keywords/types/strings/comments/numbers/functions) present in each languages `LanguageRules`.

Evidence (file + line ranges):
- **FEAT-023 Ruby**: Updated `case .ruby` with:
  - improved **number** regex `rbNumber` (line ~404),
  - expanded **string** patterns `rbStrings` including heredoc / % literals / backticks (lines ~406-418),
  - **comment** patterns including line-start `=begin ... =end` w/ anchors (lines ~434-439),
  - **function** patterns for `def ...` including `self.` / `Class.` receivers (lines ~443-447).
  (See `Extensions/NSAttributedStringSyntaxHighlighter.swift` lines 401-448 in the latest read.)
- **FEAT-022 Java**: Updated `case .java` with:
  - improved **number** regex `javaNumber` covering binary/hex/dec + hex-floats with `p/P` exponent + suffixes (lines ~524-526),
  - **string** patterns including Java text blocks `"""..."""` (lines ~547-552),
  - **function** patterns including a best-effort method-declaration matcher (lines ~559-567),
  - preserved **keywords/types/comments** categories in the same rule block.
  (See lines 522-568.)
- **FEAT-022 Kotlin**: Updated `case .kotlin` with:
  - improved **number** regex `ktNumber` (lines ~571-573),
  - **function** pattern for `fun` declarations including optional receiver and generics (lines ~604-608),
  - preserved **keywords/types/strings/comments** categories in the same rule block.
  (See lines 570-609.)

Files modified:
- `Extensions/NSAttributedStringSyntaxHighlighter.swift`
>>>END
