# Agent: diagnose-minimap
**Status:** done
**Tokens:** 1,614
**Cost:** $0.0000
**Time:** 2026-02-09T23:11:19.952Z

## Task
The minimap zoom/scale is way off. Read VSCodeiPadOS/VSCodeiPadOS/Views/Editor/MinimapView.swift. Find the scaling calculation and report what's wrong. The minimap should show a small preview of the full document.

## Response
>>>TOOL read_file
{"path": "VSCodeiPadOS/VSCodeiPadOS/Views/Editor/MinimapView.swift"}
>>>END

>>>REPORT
## MinimapView Scaling Issue Found

**File:** `VSCodeiPadOS/VSCodeiPadOS/Views/Editor/MinimapView.swift`

### The Problem

The scaling calculation in `drawMinimapPreview` (lines 185-186) is fundamentally wrong:

```swift
let lineCount = max(lines.count, 1)
let pixelsPerLine = contentHeight / CGFloat(lineCount)
```

**This formula tries to fit the ENTIRE document into the minimap's visible height**, which causes:
- For a 1000-line file with a 500px minimap → each line gets 0.5 pixels (invisible)
- For a 5000-line file → each line gets ~0.1 pixels (completely unusable)

### How VS Code's Minimap Actually Works

VS Code's minimap uses a **fixed scale** (typically 2-4 pixels per line) and **scrolls proportionally** with the main editor. It does NOT try to squeeze the entire document into the minimap height.

### What's Wrong

1. **Line 186:** `pixelsPerLine = contentHeight / CGFloat(lineCount)` - This is the incorrect scaling formula
2. **Lines 196-211 and 221-245:** Both text mode and token-block mode render ALL lines starting from line 0, with no scroll offset applied to the minimap content itself
3. The minimap content never scrolls - only the visible region overlay moves

### The Fix Required

The minimap should:
1. Use a **fixed minimum scale** (e.g., `let pixelsPerLine = max(2.0, contentHeight / CGFloat(lineCount))`)
2. Calculate which lines are visible in the minimap based on scroll position
3. Only render lines that fall within the minimap's viewport, offset by the scroll position

The visible region overlay math (lines 139-151) is correct, but the actual content rendering doesn't account for scrolling - it always draws from line 0.
>>>END
