# Agent: worker-swift-js-py
**Status:** done
**Tokens:** 60,921
**Cost:** $0.0000
**Time:** 2026-02-09T11:02:04.200Z

## Task
Design regex patterns for Swift, JS/TS, Python syntax highlighting (keywords/types/strings/comments/numbers) using VS Code Dark+ colors. Update Extensions/NSAttributedStringSyntaxHighlighter.swift accordingly.

## Response
>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift"} 
>>>END>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift"} 
>>>END

>>>TOOL list_dir
{"path":""}
>>>END>>>TOOL list_dir
{"path":"VSCodeiPadOS/VSCodeiPadOS/Extensions"}
>>>END>>>TOOL list_dir
{"path":""}
>>>END

>>>TOOL create_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","content":"DUMMY"} 
>>>END>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":80}
>>>END>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":120}
>>>END

>>>TOOL web_search
{"query":"VS Code Dark+ theme token colors keyword string comment number function type hex", "max_results": 5}
>>>END

>>>TOOL web_search
{"query":"VSCode Dark+ theme 569CD6 4EC9B0 CE9178 DCDCAA B5CEA8 6A9955", "max_results": 5}
>>>END

>>>TOOL search
{"query":"NSAttributedStringSyntaxHighlighter", "glob":"**/*"}
>>>END

>>>TOOL read_file
{"path":".patch-backups/VSCodeiPadOS_VSCodeiPadOS_Extensions_NSAttributedStringSyntaxHighlighter.swift.2026-02-09T10-39-22-024Z.bak","start_line":1,"end_line":260}
>>>END

>>>TOOL create_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","content":"import SwiftUI\nimport UIKit\n\n// Efficient NSMutableAttributedString-based syntax highlighter (regex-based).\n//\n// VS Code Dark+ inspired color mapping:\n// - Keywords:   #569CD6\n// - Types:      #4EC9B0\n// - Strings:    #CE9178\n// - Comments:   #6A9955\n// - Numbers:    #B5CEA8\n// - Functions:  #DCDCAA\n// - Default:    #D4D4D4\nfinal class NSAttributedStringSyntaxHighlighter {\n\n    // MARK: - Language\n\n    // NOTE: This file cannot use the name `Language` because the project already defines a global `Language`\n    // enum elsewhere (VSCodeiPadOS/Views/Editor/SyntaxHighlightingTextView.swift).\n    enum SyntaxLanguage {\n        case swift, javascript, typescript, jsx, tsx\n        case python, ruby, go, rust\n        case java, kotlin\n        case c, cpp, objc\n        case html, css, scss\n        case json, xml, yaml\n        case sql, shell, dockerfile, graphql\n        case markdown, php, dotenv\n        case plainText\n    }\n\n    // MARK: - Colors (VS Code Dark+)\n\n    private extension UIColor {\n        convenience init(vscodeHex: UInt32, alpha: CGFloat = 1.0) {\n            let r = CGFloat((vscodeHex >> 16) & 0xFF) / 255.0\n            let g = CGFloat((vscodeHex >> 8) & 0xFF) / 255.0\n            let b = CGFloat(vscodeHex & 0xFF) / 255.0\n            self.init(red: r, green: g, blue: b, alpha: alpha)\n        }\n    }\n\n    private struct ColorScheme {\n        static let keyword = UIColor(vscodeHex: 0x569CD6)\n        static let type = UIColor(vscodeHex: 0x4EC9B0)\n        static let string = UIColor(vscodeHex: 0xCE9178)\n        static let comment = UIColor(vscodeHex: 0x6A9955)\n        static let number = UIColor(vscodeHex: 0xB5CEA8)\n        static let function = UIColor(vscodeHex: 0xDCDCAA)\n        static let defaultText = UIColor(vscodeHex: 0xD4D4D4)\n    }\n\n    // MARK: - Public API\n\n    /// Backwards-compatible entrypoint (defaults to Swift).\n    static func highlightCode(_ code: String) -> NSAttributedString {\n        highlightCode(code, filename: nil, language: .swift)\n    }\n\n    /// Highlights `code` using either an explicit `language` or a detected one from `filename`.\n    static func highlightCode(_ code: String, filename: String? = nil, language: SyntaxLanguage? = nil) -> NSAttributedString {\n        let attributed = NSMutableAttributedString(string: code)\n        let fullRange = NSRange(location: 0, length: code.utf16.count)\n\n        attributed.addAttributes([\n            .font: UIFont.monospacedSystemFont(ofSize: 14, weight: .regular),\n            .foregroundColor: ColorScheme.defaultText\n        ], range: fullRange)\n\n        let resolvedLanguage: SyntaxLanguage = {\n            if let language { return language }\n            if let filename { return detectLanguage(fromFilename: filename) }\n            return .plainText\n        }()\n\n        highlight(code: code, language: resolvedLanguage, into: attributed)\n        return attributed\n    }\n\n    // MARK: - Language detection\n\n    private static func detectLanguage(fromFilename filename: String) -> SyntaxLanguage {\n        let lower = filename.lowercased()\n        let base = (lower as NSString).lastPathComponent\n        let ext = (base as NSString).pathExtension\n\n        // Special basenames (no extension).\n        if base == \"dockerfile\" || base.hasPrefix(\"dockerfile.\") { return .dockerfile }\n        if base == \".env\" || base.hasPrefix(\".env.\") || ext == \"env\" { return .dotenv }\n\n        switch ext {\n        case \"swift\": return .swift\n        case \"js\", \"mjs\", \"cjs\": return .javascript\n        case \"jsx\": return .jsx\n        case \"ts\": return .typescript\n        case \"tsx\": return .tsx\n        case \"py\", \"pyw\": return .python\n        case \"rb\", \"ruby\": return .ruby\n        case \"go\": return .go\n        case \"rs\": return .rust\n        case \"java\": return .java\n        case \"kt\", \"kts\": return .kotlin\n        case \"c\": return .c\n        case \"cc\", \"cpp\", \"cxx\", \"hpp\", \"hh\", \"hxx\", \"h\": return .cpp\n        case \"m\", \"mm\": return .objc\n        case \"html\", \"htm\": return .html\n        case \"css\": return .css\n        case \"scss\", \"sass\": return .scss\n        case \"json\", \"jsonc\": return .json\n        case \"xml\", \"plist\", \"svg\": return .xml\n        case \"yml\", \"yaml\": return .yaml\n        case \"sql\": return .sql\n        case \"sh\", \"bash\", \"zsh\", \"fish\": return .shell\n        case \"php\": return .php\n        case \"gql\", \"graphql\": return .graphql\n        case \"md\", \"markdown\": return .markdown\n        default: return .plainText\n        }\n    }\n\n    // MARK: - Pipeline\n\n    private struct CapturePattern {\n        let pattern: String\n        let captureGroup: Int?\n        let options: NSRegularExpression.Options\n    }\n\n    private struct LanguageRules {\n        let keywords: [String]\n        let typePatterns: [CapturePattern]\n        let stringPatterns: [String]\n        let stringRegexOptions: NSRegularExpression.Options\n        let commentPatterns: [String]\n        let commentRegexOptions: NSRegularExpression.Options\n        let numberPattern: String?\n        let numberRegexOptions: NSRegularExpression.Options\n        let keywordRegexOptions: NSRegularExpression.Options\n        let functionPatterns: [CapturePattern]\n    }\n\n    private static func highlight(code: String, language: SyntaxLanguage, into attributed: NSMutableAttributedString) {\n        let rules = languageRules(for: language)\n\n        // 1) Strings first\n        let stringRanges = rules.stringPatterns.flatMap { pattern in\n            applyHighlighting(\n                pattern: pattern,\n                options: rules.stringRegexOptions,\n                color: ColorScheme.string,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: []\n            )\n        }\n\n        // 2) Comments (exclude matches inside strings)\n        let commentRanges = rules.commentPatterns.flatMap { pattern in\n            applyHighlighting(\n                pattern: pattern,\n                options: rules.commentRegexOptions,\n                color: ColorScheme.comment,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: stringRanges\n            )\n        }\n\n        let protectedRanges = stringRanges + commentRanges\n\n        // 3) Numbers\n        if let numberPattern = rules.numberPattern {\n            _ = applyHighlighting(\n                pattern: numberPattern,\n                options: rules.numberRegexOptions,\n                color: ColorScheme.number,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: protectedRanges\n            )\n        }\n\n        // 4) Types\n        for typePattern in rules.typePatterns {\n            _ = applyHighlighting(\n                pattern: typePattern.pattern,\n                options: typePattern.options,\n                color: ColorScheme.type,\n                to: attributed,\n                in: code,\n                captureGroup: typePattern.captureGroup,\n                excluding: protectedRanges\n            )\n        }\n\n        // 5) Keywords\n        if !rules.keywords.isEmpty {\n            let keywordPattern = \"\\\\b(?:\" + rules.keywords.map(NSRegularExpression.escapedPattern).joined(separator: \"|\") + \")\\\\b\"\n            _ = applyHighlighting(\n                pattern: keywordPattern,\n                options: rules.keywordRegexOptions,\n                color: ColorScheme.keyword,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: protectedRanges\n            )\n        }\n\n        // 6) Functions\n        for fnPattern in rules.functionPatterns {\n            _ = applyHighlighting(\n                pattern: fnPattern.pattern,\n                options: fnPattern.options,\n                color: ColorScheme.function,\n                to: attributed,\n                in: code,\n                captureGroup: fnPattern.captureGroup,\n                excluding: protectedRanges\n            )\n        }\n    }\n\n    // MARK: - Language rules\n\n    private static func languageRules(for language: SyntaxLanguage) -> LanguageRules {\n\n        // Default numeric literal coverage (hex, float, exponent, underscores).\n        // Individual languages override when needed (Swift / JS/TS / Python).\n        let commonNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)\\\\b\"\n\n        // C-like strings: \"...\" and '...'\n        let cLikeStrings = [\n            \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n            \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n        ]\n\n        // C-like comments\n        let cLikeComments = [\n            \"//[^\\\\n]*\",\n            \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"\n        ]\n\n        // Common function call: name(\n        let commonFunctionCall = CapturePattern(\n            pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\())\",\n            captureGroup: 1,\n            options: []\n        )\n\n        switch language {\n\n        // MARK: Swift (patterns tuned)\n        case .swift:\n            // Swift numeric literals: hex/binary/octal, decimal, floats (underscores allowed).\n            let swiftNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+(?:\\\\.[0-9A-Fa-f_]+)?(?:[pP][+-]?\\\\d[\\\\d_]*)?|0b[01_]+|0o[0-7_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)\\\\b\"\n\n            // Swift strings: normal and raw (any number of # delimiters), including multiline triple-quoted.\n            let swiftStrings = [\n                \"#*\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"#*\",\n                \"#*\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"#*\"\n            ]\n\n            return LanguageRules(\n                keywords: [\n                    \"func\", \"var\", \"let\", \"if\", \"else\", \"for\", \"while\", \"repeat\", \"switch\", \"case\", \"default\",\n                    \"return\", \"import\", \"class\", \"struct\", \"enum\", \"protocol\", \"extension\", \"actor\",\n                    \"private\", \"fileprivate\", \"public\", \"internal\", \"open\", \"static\", \"final\", \"override\",\n                    \"self\", \"super\", \"init\", \"deinit\",\n                    \"throw\", \"throws\", \"rethrows\", \"try\", \"catch\", \"do\", \"guard\", \"defer\",\n                    \"async\", \"await\",\n                    \"weak\", \"unowned\", \"mutating\", \"nonmutating\",\n                    \"typealias\", \"associatedtype\", \"where\", \"in\", \"is\", \"as\", \"Any\", \"some\", \"any\",\n                    \"true\", \"false\", \"nil\"\n                ],\n                typePatterns: [\n                    CapturePattern(\n                        pattern: \"\\\\b(?:String|Int|Int8|Int16|Int32|Int64|UInt|UInt8|UInt16|UInt32|UInt64|Double|Float|Bool|Character|Void|AnyObject|Never|Data|Date|URL|UUID|CGFloat)\\\\b\",\n                        captureGroup: nil,\n                        options: []\n                    ),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: swiftStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: swiftNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunc\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // MARK: JavaScript (patterns tuned)\n        case .javascript:\n            // JS numeric literals: hex/binary/octal/decimal/floats + BigInt suffix n.\n            let jsNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+|0b[01_]+|0o[0-7_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?|\\\\d[\\\\d_]*n)\\\\b\"\n\n            return LanguageRules(\n                keywords: [\n                    \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"debugger\", \"default\", \"delete\",\n                    \"do\", \"else\", \"export\", \"extends\", \"finally\", \"for\", \"function\", \"if\", \"import\", \"in\",\n                    \"instanceof\", \"let\", \"new\", \"return\", \"super\", \"switch\", \"this\", \"throw\", \"try\", \"typeof\",\n                    \"var\", \"void\", \"while\", \"with\", \"yield\", \"async\", \"await\", \"of\", \"true\", \"false\", \"null\", \"undefined\"\n                ],\n                typePatterns: [CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])],\n                stringPatterns: cLikeStrings + [\n                    \"`(?:[^`\\\\\\\\]|\\\\\\\\.|\\\\$\\\\{[\\\\s\\\\S]*?\\\\})*`\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: jsNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b(?:const|let|var)\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\s*=\\\\s*(?:async\\\\s*)?(?:\\\\([^)]*\\\\)|[A-Za-z_][A-Za-z0-9_]*)?\\\\s*=>\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // MARK: TypeScript (patterns tuned)\n        case .typescript:\n            // TS shares JS numeric syntax.\n            let tsNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+|0b[01_]+|0o[0-7_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?|\\\\d[\\\\d_]*n)\\\\b\"\n\n            return LanguageRules(\n                keywords: [\n                    // JS\n                    \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"debugger\", \"default\", \"delete\",\n                    \"do\", \"else\", \"export\", \"extends\", \"finally\", \"for\", \"function\", \"if\", \"import\", \"in\",\n                    \"instanceof\", \"let\", \"new\", \"return\", \"super\", \"switch\", \"this\", \"throw\", \"try\", \"typeof\",\n                    \"var\", \"void\", \"while\", \"with\", \"yield\", \"async\", \"await\", \"of\", \"true\", \"false\", \"null\", \"undefined\",\n                    // TS\n                    \"interface\", \"type\", \"enum\", \"implements\", \"namespace\", \"abstract\", \"declare\", \"readonly\",\n                    \"private\", \"protected\", \"public\", \"keyof\", \"infer\", \"unknown\", \"never\", \"any\", \"as\", \"satisfies\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:string|number|boolean|any|unknown|never|void|object|bigint|symbol)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings + [\"`(?:[^`\\\\\\\\]|\\\\\\\\.|\\\\$\\\\{[\\\\s\\\\S]*?\\\\})*`\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: tsNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .tsx:\n            // TSX = TypeScript + JSX tags/attributes as \"types\" (cyan).\n            let ts = languageRules(for: .typescript)\n            return LanguageRules(\n                keywords: ts.keywords,\n                typePatterns: ts.typePatterns + [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:_-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: ts.stringPatterns,\n                stringRegexOptions: ts.stringRegexOptions,\n                commentPatterns: ts.commentPatterns,\n                commentRegexOptions: ts.commentRegexOptions,\n                numberPattern: ts.numberPattern,\n                numberRegexOptions: ts.numberRegexOptions,\n                keywordRegexOptions: ts.keywordRegexOptions,\n                functionPatterns: ts.functionPatterns\n            )\n\n        case .jsx:\n            // JSX = JS plus tag/attribute as \"types\" for cyan.\n            let js = languageRules(for: .javascript)\n            return LanguageRules(\n                keywords: js.keywords,\n                typePatterns: js.typePatterns + [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:_-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: js.stringPatterns,\n                stringRegexOptions: js.stringRegexOptions,\n                commentPatterns: js.commentPatterns,\n                commentRegexOptions: js.commentRegexOptions,\n                numberPattern: js.numberPattern,\n                numberRegexOptions: js.numberRegexOptions,\n                keywordRegexOptions: js.keywordRegexOptions,\n                functionPatterns: js.functionPatterns\n            )\n\n        // MARK: Python (patterns tuned)\n        case .python:\n            // Python numeric literals (underscores, hex/binary/octal, floats, leading-dot floats, complex).\n            let pyNumber = \"(?<!\\\\w)(?:(?:0x[0-9A-Fa-f_]+)|(?:0b[01_]+)|(?:0o[0-7_]+)|(?:\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)|(?:\\\\.\\\\d[\\\\d_]*(?:[eE][+-]?\\\\d[\\\\d_]*)?))(?:[jJ])?(?!\\\\w)\"\n\n            // Python strings incl. optional prefixes before both single-line and triple-quoted strings.\n            let pyStrings = [\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?'''[\\\\s\\\\S]*?'''\",\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\",\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"\n            ]\n\n            return LanguageRules(\n                keywords: [\n                    \"False\", \"None\", \"True\", \"and\", \"as\", \"assert\", \"async\", \"await\", \"break\", \"class\",\n                    \"continue\", \"def\", \"del\", \"elif\", \"else\", \"except\", \"finally\", \"for\", \"from\", \"global\",\n                    \"if\", \"import\", \"in\", \"is\", \"lambda\", \"nonlocal\", \"not\", \"or\", \"pass\", \"raise\", \"return\",\n                    \"try\", \"while\", \"with\", \"yield\", \"match\", \"case\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|float|bool|str|bytes|list|tuple|set|dict|object)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: pyStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: pyNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bdef\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // ----- Everything below remains as previously defined (uses common patterns) -----\n\n        case .ruby:\n            return LanguageRules(\n                keywords: [\n                    \"BEGIN\", \"END\", \"alias\", \"and\", \"begin\", \"break\", \"case\", \"class\", \"def\", \"defined\\\\?\",\n                    \"do\", \"else\", \"elsif\", \"end\", \"ensure\", \"false\", \"for\", \"if\", \"in\", \"module\", \"next\",\n                    \"nil\", \"not\", \"or\", \"redo\", \"rescue\", \"retry\", \"return\", \"self\", \"super\", \"then\",\n                    \"true\", \"undef\", \"unless\", \"until\", \"when\", \"while\", \"yield\", \"private\", \"protected\", \"public\"\n                ],\n                typePatterns: [CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])],\n                stringPatterns: [\n                    \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                    \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                    \"%[qQ]\\\\{[\\\\s\\\\S]*?\\\\}\",\n                    \"%[qQ]\\\\([\\\\s\\\\S]*?\\\\)\",\n                    \"%[qQ]\\\\[[\\\\s\\\\S]*?\\\\]\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\", \"=begin[\\\\s\\\\S]*?=end\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bdef\\\\s+([A-Za-z_][A-Za-z0-9_]*[!?=]?)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .go:\n            return LanguageRules(\n                keywords: [\n                    \"break\", \"default\", \"func\", \"interface\", \"select\", \"case\", \"defer\", \"go\", \"map\", \"struct\",\n                    \"chan\", \"else\", \"goto\", \"package\", \"switch\", \"const\", \"fallthrough\", \"if\", \"range\", \"type\",\n                    \"continue\", \"for\", \"import\", \"return\", \"var\", \"true\", \"false\", \"nil\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:string|bool|byte|rune|int|int8|int16|int32|int64|uint|uint8|uint16|uint32|uint64|uintptr|float32|float64|complex64|complex128|error)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"`[\\\\s\\\\S]*?`\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunc\\\\s+(?:\\\\([^)]*\\\\)\\\\s*)?([A-Za-z_][A-Za-z0-9_]*)\\\\s*\\\\(\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .rust:\n            return LanguageRules(\n                keywords: [\n                    \"as\", \"break\", \"const\", \"continue\", \"crate\", \"else\", \"enum\", \"extern\", \"false\", \"fn\", \"for\",\n                    \"if\", \"impl\", \"in\", \"let\", \"loop\", \"match\", \"mod\", \"move\", \"mut\", \"pub\", \"ref\", \"return\",\n                    \"self\", \"Self\", \"static\", \"struct\", \"super\", \"trait\", \"true\", \"type\", \"unsafe\", \"use\",\n                    \"where\", \"while\", \"async\", \"await\", \"dyn\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:i8|i16|i32|i64|i128|isize|u8|u16|u32|u64|u128|usize|f32|f64|bool|char|str|String|Option|Result|Vec)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"r#\\\"[\\\\s\\\\S]*?\\\"#\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"//[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfn\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .java:\n            return LanguageRules(\n                keywords: [\n                    \"abstract\", \"assert\", \"boolean\", \"break\", \"byte\", \"case\", \"catch\", \"char\", \"class\",\n                    \"const\", \"continue\", \"default\", \"do\", \"double\", \"else\", \"enum\", \"extends\", \"final\",\n                    \"finally\", \"float\", \"for\", \"goto\", \"if\", \"implements\", \"import\", \"instanceof\", \"int\",\n                    \"interface\", \"long\", \"native\", \"new\", \"package\", \"private\", \"protected\", \"public\",\n                    \"return\", \"short\", \"static\", \"strictfp\", \"super\", \"switch\", \"synchronized\", \"this\",\n                    \"throw\", \"throws\", \"transient\", \"try\", \"void\", \"volatile\", \"while\", \"true\", \"false\", \"null\",\n                    \"var\", \"record\", \"sealed\", \"permits\", \"non-sealed\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:boolean|byte|char|short|int|long|float|double|void|String|Object)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .kotlin:\n            return LanguageRules(\n                keywords: [\n                    \"as\", \"break\", \"class\", \"continue\", \"do\", \"else\", \"false\", \"for\", \"fun\", \"if\", \"in\",\n                    \"interface\", \"is\", \"null\", \"object\", \"package\", \"return\", \"super\", \"this\", \"throw\",\n                    \"true\", \"try\", \"typealias\", \"val\", \"var\", \"when\", \"while\",\n                    \"by\", \"catch\", \"constructor\", \"delegate\", \"finally\", \"get\", \"import\", \"init\", \"set\", \"where\",\n                    \"actual\", \"abstract\", \"annotation\", \"companion\", \"const\", \"crossinline\", \"data\", \"enum\",\n                    \"expect\", \"external\", \"final\", \"infix\", \"inline\", \"inner\", \"internal\", \"lateinit\",\n                    \"noinline\", \"open\", \"operator\", \"out\", \"override\", \"private\", \"protected\", \"public\",\n                    \"reified\", \"sealed\", \"suspend\", \"tailrec\", \"vararg\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:Int|Long|Short|Byte|Float|Double|Boolean|Char|String|Unit|Any|Nothing)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfun\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .c:\n            return LanguageRules(\n                keywords: [\n                    \"auto\", \"break\", \"case\", \"char\", \"const\", \"continue\", \"default\", \"do\", \"double\", \"else\",\n                    \"enum\", \"extern\", \"float\", \"for\", \"goto\", \"if\", \"inline\", \"int\", \"long\", \"register\",\n                    \"restrict\", \"return\", \"short\", \"signed\", \"sizeof\", \"static\", \"struct\", \"switch\", \"typedef\",\n                    \"union\", \"unsigned\", \"void\", \"volatile\", \"while\", \"_Bool\", \"_Complex\", \"_Imaginary\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:char|short|int|long|float|double|void|size_t|ssize_t|bool)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .cpp:\n            return LanguageRules(\n                keywords: [\n                    \"alignas\", \"alignof\", \"and\", \"and_eq\", \"asm\", \"auto\", \"bitand\", \"bitor\", \"bool\", \"break\",\n                    \"case\", \"catch\", \"char\", \"char8_t\", \"char16_t\", \"char32_t\", \"class\", \"compl\", \"concept\",\n                    \"const\", \"consteval\", \"constexpr\", \"constinit\", \"continue\", \"co_await\", \"co_return\", \"co_yield\",\n                    \"default\", \"delete\", \"do\", \"double\", \"dynamic_cast\", \"else\", \"enum\", \"explicit\", \"export\", \"extern\",\n                    \"false\", \"float\", \"for\", \"friend\", \"goto\", \"if\", \"inline\", \"int\", \"long\", \"mutable\", \"namespace\",\n                    \"new\", \"noexcept\", \"not\", \"not_eq\", \"nullptr\", \"operator\", \"or\", \"or_eq\", \"private\", \"protected\",\n                    \"public\", \"register\", \"reinterpret_cast\", \"requires\", \"return\", \"short\", \"signed\", \"sizeof\",\n                    \"static\", \"static_assert\", \"static_cast\", \"struct\", \"switch\", \"template\", \"this\", \"thread_local\",\n                    \"throw\", \"true\", \"try\", \"typedef\", \"typeid\", \"typename\", \"union\", \"unsigned\", \"using\", \"virtual\",\n                    \"void\", \"volatile\", \"wchar_t\", \"while\", \"xor\", \"xor_eq\", \"final\", \"override\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:bool|char|short|int|long|float|double|void|wchar_t|size_t|ssize_t|string|std::[A-Za-z0-9_:]+)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .objc:\n            return LanguageRules(\n                keywords: [\n                    \"@interface\", \"@implementation\", \"@end\", \"@property\", \"@synthesize\", \"@dynamic\", \"@protocol\",\n                    \"@class\", \"@public\", \"@private\", \"@protected\", \"@package\",\n                    \"@try\", \"@catch\", \"@finally\", \"@throw\", \"@autoreleasepool\",\n                    \"@selector\", \"@encode\", \"@import\", \"@available\",\n                    \"if\", \"else\", \"for\", \"while\", \"switch\", \"case\", \"default\", \"break\", \"continue\", \"return\",\n                    \"struct\", \"typedef\", \"enum\", \"static\", \"const\", \"void\", \"int\", \"char\", \"float\", \"double\",\n                    \"BOOL\", \"YES\", \"NO\", \"nil\", \"self\", \"super\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:id|instancetype|SEL|Class|BOOL|NSInteger|NSUInteger|CGFloat|NSString|NSNumber|NSArray|NSDictionary|NSData|NSDate|NSURL|NSError)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings + [\"@\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .html:\n            return LanguageRules(\n                keywords: [\"DOCTYPE\", \"html\", \"head\", \"body\", \"script\", \"style\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .xml:\n            return LanguageRules(\n                keywords: [\"xml\", \"version\", \"encoding\", \"CDATA\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z_][A-Za-z0-9:._-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\", \"<!\\\\[CDATA\\\\[[\\\\s\\\\S]*?\\\\]\\\\]>\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .css:\n            return LanguageRules(\n                keywords: [\"@import\", \"@media\", \"@supports\", \"@keyframes\", \"@font-face\", \"@page\", \"@layer\", \"important\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"(?:\\\\.|#)([A-Za-z_-][A-Za-z0-9_-]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\b(?=\\\\s*\\\\{)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: \"\\\\b\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:%|px|em|rem|vw|vh|vmin|vmax|fr|ch|ex|cm|mm|in|pt|pc)?\\\\b\",\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\s*(?=:)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: [])\n                ]\n            )\n\n        case .scss:\n            let css = languageRules(for: .css)\n            return LanguageRules(\n                keywords: css.keywords + [\"@mixin\", \"@include\", \"@extend\", \"@function\", \"@return\", \"@if\", \"@else\", \"@for\", \"@each\", \"@while\"],\n                typePatterns: css.typePatterns,\n                stringPatterns: css.stringPatterns,\n                stringRegexOptions: css.stringRegexOptions,\n                commentPatterns: [\"/\\\\*[\\\\s\\\\S]*?\\\\*/\", \"//[^\\\\n]*\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: css.numberPattern,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: css.functionPatterns\n            )\n\n        case .json:\n            return LanguageRules(\n                keywords: [\"true\", \"false\", \"null\"],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"//[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .yaml:\n            return LanguageRules(\n                keywords: [\"true\", \"false\", \"null\", \"yes\", \"no\", \"on\", \"off\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"([&*][A-Za-z0-9_-]+)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"^\\\\s*([A-Za-z0-9_-]+)\\\\s*:(?=\\\\s|$)\", captureGroup: 1, options: [.anchorsMatchLines])\n                ]\n            )\n\n        case .sql:\n            return LanguageRules(\n                keywords: [\n                    \"select\", \"from\", \"where\", \"group\", \"by\", \"having\", \"order\", \"limit\", \"offset\",\n                    \"insert\", \"into\", \"values\", \"update\", \"set\", \"delete\",\n                    \"join\", \"inner\", \"left\", \"right\", \"full\", \"outer\", \"cross\", \"on\",\n                    \"as\", \"distinct\", \"union\", \"all\", \"and\", \"or\", \"not\", \"null\", \"is\", \"in\", \"exists\", \"like\", \"between\",\n                    \"create\", \"alter\", \"drop\", \"table\", \"view\", \"index\", \"primary\", \"key\", \"foreign\", \"references\",\n                    \"case\", \"when\", \"then\", \"else\", \"end\",\n                    \"begin\", \"commit\", \"rollback\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|integer|smallint|bigint|serial|bigserial|decimal|numeric|real|double|float|money|boolean|bool|date|time|timestamp|timestamptz|varchar|char|text|uuid|json|jsonb)\\\\b\", captureGroup: nil, options: [.caseInsensitive])\n                ],\n                stringPatterns: [\"'(?:''|[^'])*'\", \"\\\"(?:\\\"\\\"|[^\\\"])*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"--[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: [.caseInsensitive])\n                ]\n            )\n\n        case .shell:\n            return LanguageRules(\n                keywords: [\n                    \"if\", \"then\", \"elif\", \"else\", \"fi\", \"for\", \"in\", \"do\", \"done\", \"case\", \"esac\", \"while\", \"until\",\n                    \"select\", \"function\", \"time\", \"coproc\", \"break\", \"continue\", \"return\", \"exit\", \"export\", \"readonly\",\n                    \"local\", \"declare\", \"typeset\", \"unset\", \"shift\", \"trap\", \"set\"\n                ],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'[^'\\\\n]*'\", \"\\\\$'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*\\\\(\\\\s*\\\\)\\\\s*\\\\{\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .dockerfile:\n            return LanguageRules(\n                keywords: [\n                    \"FROM\", \"RUN\", \"CMD\", \"LABEL\", \"MAINTAINER\", \"EXPOSE\", \"ENV\", \"ADD\", \"COPY\", \"ENTRYPOINT\",\n                    \"VOLUME\", \"USER\", \"WORKDIR\", \"ARG\", \"ONBUILD\", \"STOPSIGNAL\", \"HEALTHCHECK\", \"SHELL\"\n                ],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .graphql:\n            return LanguageRules(\n                keywords: [\n                    \"query\", \"mutation\", \"subscription\", \"fragment\", \"on\",\n                    \"schema\", \"type\", \"interface\", \"union\", \"enum\", \"input\", \"extend\", \"directive\", \"implements\",\n                    \"scalar\", \"true\", \"false\", \"null\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:Int|Float|String|Boolean|ID)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .markdown:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [],\n                stringPatterns: [\n                    \"```[\\\\s\\\\S]*?```\",\n                    \"~~~[\\\\s\\\\S]*?~~~\",\n                    \"`[^`\\\\n]+`\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: nil,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .php:\n            return LanguageRules(\n                keywords: [\n                    \"abstract\", \"and\", \"array\", \"as\", \"break\", \"callable\", \"case\", \"catch\", \"class\", \"clone\",\n                    \"const\", \"continue\", \"declare\", \"default\", \"die\", \"do\", \"echo\", \"else\", \"elseif\", \"empty\",\n                    \"enddeclare\", \"endfor\", \"endforeach\", \"endif\", \"endswitch\", \"endwhile\", \"enum\", \"eval\", \"exit\",\n                    \"extends\", \"final\", \"finally\", \"fn\", \"for\", \"foreach\", \"function\", \"global\", \"goto\", \"if\",\n                    \"implements\", \"include\", \"include_once\", \"instanceof\", \"insteadof\", \"interface\", \"isset\",\n                    \"list\", \"match\", \"namespace\", \"new\", \"or\", \"print\", \"private\", \"protected\", \"public\", \"readonly\",\n                    \"require\", \"require_once\", \"return\", \"static\", \"switch\", \"throw\", \"trait\", \"try\", \"unset\", \"use\",\n                    \"var\", \"while\", \"xor\", \"yield\", \"true\", \"false\", \"null\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|float|string|bool|array|object|callable|iterable|mixed|void|never)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments + [\"#[^\\\\n]*\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .dotenv:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [\n                    // Keys in KEY=value or export KEY=value\n                    CapturePattern(\n                        pattern: \"^\\\\s*(?:export\\\\s+)?([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?==)\",\n                        captureGroup: 1,\n                        options: [.anchorsMatchLines]\n                    )\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .plainText:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [],\n                stringPatterns: [],\n                stringRegexOptions: [],\n                commentPatterns: [],\n                commentRegexOptions: [],\n                numberPattern: nil,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n        }\n    }\n\n    // MARK: - Regex application helpers\n\n    @discardableResult\n    private static func applyHighlighting(\n        pattern: String,\n        options: NSRegularExpression.Options,\n        color: UIColor,\n        to attributedString: NSMutableAttributedString,\n        in text: String,\n        captureGroup: Int?,\n        excluding excludedRanges: [NSRange]\n    ) -> [NSRange] {\n        do {\n            let regex = try NSRegularExpression(pattern: pattern, options: options)\n            let matches = regex.matches(in: text, options: [], range: NSRange(location: 0, length: text.utf16.count))\n\n            var applied: [NSRange] = []\n            applied.reserveCapacity(matches.count)\n\n            for match in matches {\n                let range: NSRange = {\n                    if let captureGroup, captureGroup <= match.numberOfRanges - 1 {\n                        return match.range(at: captureGroup)\n                    }\n                    return match.range\n                }()\n\n                guard range.location != NSNotFound, range.length > 0 else { continue }\n                if intersectsAny(range, excludedRanges) { continue }\n\n                attributedString.addAttribute(.foregroundColor, value: color, range: range)\n                applied.append(range)\n            }\n\n            return applied\n        } catch {\n            print(\"Regex error for pattern \\(pattern): \\(error)\")\n            return []\n        }\n    }\n\n    private static func intersectsAny(_ range: NSRange, _ excludedRanges: [NSRange]) -> Bool {\n        for ex in excludedRanges where NSIntersectionRange(range, ex).length > 0 {\n            return true\n        }\n        return false\n    }\n}\n\n// SwiftUI wrapper for NSAttributedString\nstruct AttributedTextView: UIViewRepresentable {\n    let attributedText: NSAttributedString\n\n    func makeUIView(context: Context) -> UITextView {\n        let textView = UITextView()\n        textView.isEditable = false\n        textView.isSelectable = true\n        textView.backgroundColor = .clear\n        textView.textContainerInset = UIEdgeInsets(top: 8, left: 8, bottom: 8, right: 8)\n        return textView\n    }\n\n    func updateUIView(_ uiView: UITextView, context: Context) {\n        uiView.attributedText = attributedText\n    }\n}\n\n// Extension to make it easy to use in SwiftUI\nextension View {\n    func syntaxHighlighted(\n        code: String,\n        filename: String? = nil,\n        language: NSAttributedStringSyntaxHighlighter.SyntaxLanguage? = nil\n    ) -> some View {\n        AttributedTextView(attributedText: NSAttributedStringSyntaxHighlighter.highlightCode(code, filename: filename, language: language))\n    }\n}\n"} 
>>>END

>>>TOOL create_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","content":"import SwiftUI\nimport UIKit\n\n// Efficient NSMutableAttributedString-based syntax highlighter (regex-based).\n//\n// VS Code Dark+ inspired color mapping:\n// - Keywords:   #569CD6\n// - Types:      #4EC9B0\n// - Strings:    #CE9178\n// - Comments:   #6A9955\n// - Numbers:    #B5CEA8\n// - Functions:  #DCDCAA\n// - Default:    #D4D4D4\nfinal class NSAttributedStringSyntaxHighlighter {\n\n    // MARK: - Language\n\n    // NOTE: This file cannot use the name `Language` because the project already defines a global `Language`\n    // enum elsewhere (VSCodeiPadOS/Views/Editor/SyntaxHighlightingTextView.swift).\n    enum SyntaxLanguage {\n        case swift, javascript, typescript, jsx, tsx\n        case python, ruby, go, rust\n        case java, kotlin\n        case c, cpp, objc\n        case html, css, scss\n        case json, xml, yaml\n        case sql, shell, dockerfile, graphql\n        case markdown, php, dotenv\n        case plainText\n    }\n\n    // MARK: - Colors (VS Code Dark+)\n\n    private extension UIColor {\n        convenience init(vscodeHex: UInt32, alpha: CGFloat = 1.0) {\n            let r = CGFloat((vscodeHex >> 16) & 0xFF) / 255.0\n            let g = CGFloat((vscodeHex >> 8) & 0xFF) / 255.0\n            let b = CGFloat(vscodeHex & 0xFF) / 255.0\n            self.init(red: r, green: g, blue: b, alpha: alpha)\n        }\n    }\n\n    private struct ColorScheme {\n        static let keyword = UIColor(vscodeHex: 0x569CD6)\n        static let type = UIColor(vscodeHex: 0x4EC9B0)\n        static let string = UIColor(vscodeHex: 0xCE9178)\n        static let comment = UIColor(vscodeHex: 0x6A9955)\n        static let number = UIColor(vscodeHex: 0xB5CEA8)\n        static let function = UIColor(vscodeHex: 0xDCDCAA)\n        static let defaultText = UIColor(vscodeHex: 0xD4D4D4)\n    }\n\n    // MARK: - Public API\n\n    /// Backwards-compatible entrypoint (defaults to Swift).\n    static func highlightCode(_ code: String) -> NSAttributedString {\n        highlightCode(code, filename: nil, language: .swift)\n    }\n\n    /// Highlights `code` using either an explicit `language` or a detected one from `filename`.\n    static func highlightCode(_ code: String, filename: String? = nil, language: SyntaxLanguage? = nil) -> NSAttributedString {\n        let attributed = NSMutableAttributedString(string: code)\n        let fullRange = NSRange(location: 0, length: code.utf16.count)\n\n        attributed.addAttributes([\n            .font: UIFont.monospacedSystemFont(ofSize: 14, weight: .regular),\n            .foregroundColor: ColorScheme.defaultText\n        ], range: fullRange)\n\n        let resolvedLanguage: SyntaxLanguage = {\n            if let language { return language }\n            if let filename { return detectLanguage(fromFilename: filename) }\n            return .plainText\n        }()\n\n        highlight(code: code, language: resolvedLanguage, into: attributed)\n        return attributed\n    }\n\n    // MARK: - Language detection\n\n    private static func detectLanguage(fromFilename filename: String) -> SyntaxLanguage {\n        let lower = filename.lowercased()\n        let base = (lower as NSString).lastPathComponent\n        let ext = (base as NSString).pathExtension\n\n        // Special basenames (no extension).\n        if base == \"dockerfile\" || base.hasPrefix(\"dockerfile.\") { return .dockerfile }\n        if base == \".env\" || base.hasPrefix(\".env.\") || ext == \"env\" { return .dotenv }\n\n        switch ext {\n        case \"swift\": return .swift\n        case \"js\", \"mjs\", \"cjs\": return .javascript\n        case \"jsx\": return .jsx\n        case \"ts\": return .typescript\n        case \"tsx\": return .tsx\n        case \"py\", \"pyw\": return .python\n        case \"rb\", \"ruby\": return .ruby\n        case \"go\": return .go\n        case \"rs\": return .rust\n        case \"java\": return .java\n        case \"kt\", \"kts\": return .kotlin\n        case \"c\": return .c\n        case \"cc\", \"cpp\", \"cxx\", \"hpp\", \"hh\", \"hxx\", \"h\": return .cpp\n        case \"m\", \"mm\": return .objc\n        case \"html\", \"htm\": return .html\n        case \"css\": return .css\n        case \"scss\", \"sass\": return .scss\n        case \"json\", \"jsonc\": return .json\n        case \"xml\", \"plist\", \"svg\": return .xml\n        case \"yml\", \"yaml\": return .yaml\n        case \"sql\": return .sql\n        case \"sh\", \"bash\", \"zsh\", \"fish\": return .shell\n        case \"php\": return .php\n        case \"gql\", \"graphql\": return .graphql\n        case \"md\", \"markdown\": return .markdown\n        default: return .plainText\n        }\n    }\n\n    // MARK: - Pipeline\n\n    private struct CapturePattern {\n        let pattern: String\n        let captureGroup: Int?\n        let options: NSRegularExpression.Options\n    }\n\n    private struct LanguageRules {\n        let keywords: [String]\n        let typePatterns: [CapturePattern]\n        let stringPatterns: [String]\n        let stringRegexOptions: NSRegularExpression.Options\n        let commentPatterns: [String]\n        let commentRegexOptions: NSRegularExpression.Options\n        let numberPattern: String?\n        let numberRegexOptions: NSRegularExpression.Options\n        let keywordRegexOptions: NSRegularExpression.Options\n        let functionPatterns: [CapturePattern]\n    }\n\n    private static func highlight(code: String, language: SyntaxLanguage, into attributed: NSMutableAttributedString) {\n        let rules = languageRules(for: language)\n\n        // 1) Strings first\n        let stringRanges = rules.stringPatterns.flatMap { pattern in\n            applyHighlighting(\n                pattern: pattern,\n                options: rules.stringRegexOptions,\n                color: ColorScheme.string,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: []\n            )\n        }\n\n        // 2) Comments (exclude matches inside strings)\n        let commentRanges = rules.commentPatterns.flatMap { pattern in\n            applyHighlighting(\n                pattern: pattern,\n                options: rules.commentRegexOptions,\n                color: ColorScheme.comment,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: stringRanges\n            )\n        }\n\n        let protectedRanges = stringRanges + commentRanges\n\n        // 3) Numbers\n        if let numberPattern = rules.numberPattern {\n            _ = applyHighlighting(\n                pattern: numberPattern,\n                options: rules.numberRegexOptions,\n                color: ColorScheme.number,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: protectedRanges\n            )\n        }\n\n        // 4) Types\n        for typePattern in rules.typePatterns {\n            _ = applyHighlighting(\n                pattern: typePattern.pattern,\n                options: typePattern.options,\n                color: ColorScheme.type,\n                to: attributed,\n                in: code,\n                captureGroup: typePattern.captureGroup,\n                excluding: protectedRanges\n            )\n        }\n\n        // 5) Keywords\n        if !rules.keywords.isEmpty {\n            let keywordPattern = \"\\\\b(?:\" + rules.keywords.map(NSRegularExpression.escapedPattern).joined(separator: \"|\") + \")\\\\b\"\n            _ = applyHighlighting(\n                pattern: keywordPattern,\n                options: rules.keywordRegexOptions,\n                color: ColorScheme.keyword,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: protectedRanges\n            )\n        }\n\n        // 6) Functions\n        for fnPattern in rules.functionPatterns {\n            _ = applyHighlighting(\n                pattern: fnPattern.pattern,\n                options: fnPattern.options,\n                color: ColorScheme.function,\n                to: attributed,\n                in: code,\n                captureGroup: fnPattern.captureGroup,\n                excluding: protectedRanges\n            )\n        }\n    }\n\n    // MARK: - Language rules\n\n    private static func languageRules(for language: SyntaxLanguage) -> LanguageRules {\n\n        // Default numeric literal coverage (hex, float, exponent, underscores).\n        // Individual languages override when needed (Swift / JS/TS / Python).\n        let commonNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)\\\\b\"\n\n        // C-like strings: \"...\" and '...'\n        let cLikeStrings = [\n            \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n            \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n        ]\n\n        // C-like comments\n        let cLikeComments = [\n            \"//[^\\\\n]*\",\n            \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"\n        ]\n\n        // Common function call: name(\n        let commonFunctionCall = CapturePattern(\n            pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\())\",\n            captureGroup: 1,\n            options: []\n        )\n\n        switch language {\n\n        // MARK: Swift (patterns tuned)\n        case .swift:\n            // Swift numeric literals: hex/binary/octal, decimal, floats (underscores allowed).\n            let swiftNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+(?:\\\\.[0-9A-Fa-f_]+)?(?:[pP][+-]?\\\\d[\\\\d_]*)?|0b[01_]+|0o[0-7_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)\\\\b\"\n\n            // Swift strings: normal and raw (any number of # delimiters), including multiline triple-quoted.\n            let swiftStrings = [\n                \"#*\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"#*\",\n                \"#*\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"#*\"\n            ]\n\n            return LanguageRules(\n                keywords: [\n                    \"func\", \"var\", \"let\", \"if\", \"else\", \"for\", \"while\", \"repeat\", \"switch\", \"case\", \"default\",\n                    \"return\", \"import\", \"class\", \"struct\", \"enum\", \"protocol\", \"extension\", \"actor\",\n                    \"private\", \"fileprivate\", \"public\", \"internal\", \"open\", \"static\", \"final\", \"override\",\n                    \"self\", \"super\", \"init\", \"deinit\",\n                    \"throw\", \"throws\", \"rethrows\", \"try\", \"catch\", \"do\", \"guard\", \"defer\",\n                    \"async\", \"await\",\n                    \"weak\", \"unowned\", \"mutating\", \"nonmutating\",\n                    \"typealias\", \"associatedtype\", \"where\", \"in\", \"is\", \"as\", \"Any\", \"some\", \"any\",\n                    \"true\", \"false\", \"nil\"\n                ],\n                typePatterns: [\n                    CapturePattern(\n                        pattern: \"\\\\b(?:String|Int|Int8|Int16|Int32|Int64|UInt|UInt8|UInt16|UInt32|UInt64|Double|Float|Bool|Character|Void|AnyObject|Never|Data|Date|URL|UUID|CGFloat)\\\\b\",\n                        captureGroup: nil,\n                        options: []\n                    ),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: swiftStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: swiftNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunc\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // MARK: JavaScript (patterns tuned)\n        case .javascript:\n            // JS numeric literals: hex/binary/octal/decimal/floats + BigInt suffix n.\n            let jsNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+|0b[01_]+|0o[0-7_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?|\\\\d[\\\\d_]*n)\\\\b\"\n\n            return LanguageRules(\n                keywords: [\n                    \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"debugger\", \"default\", \"delete\",\n                    \"do\", \"else\", \"export\", \"extends\", \"finally\", \"for\", \"function\", \"if\", \"import\", \"in\",\n                    \"instanceof\", \"let\", \"new\", \"return\", \"super\", \"switch\", \"this\", \"throw\", \"try\", \"typeof\",\n                    \"var\", \"void\", \"while\", \"with\", \"yield\", \"async\", \"await\", \"of\", \"true\", \"false\", \"null\", \"undefined\"\n                ],\n                typePatterns: [CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])],\n                stringPatterns: cLikeStrings + [\n                    \"`(?:[^`\\\\\\\\]|\\\\\\\\.|\\\\$\\\\{[\\\\s\\\\S]*?\\\\})*`\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: jsNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b(?:const|let|var)\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\s*=\\\\s*(?:async\\\\s*)?(?:\\\\([^)]*\\\\)|[A-Za-z_][A-Za-z0-9_]*)?\\\\s*=>\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // MARK: TypeScript (patterns tuned)\n        case .typescript:\n            // TS shares JS numeric syntax.\n            let tsNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+|0b[01_]+|0o[0-7_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?|\\\\d[\\\\d_]*n)\\\\b\"\n\n            return LanguageRules(\n                keywords: [\n                    // JS\n                    \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"debugger\", \"default\", \"delete\",\n                    \"do\", \"else\", \"export\", \"extends\", \"finally\", \"for\", \"function\", \"if\", \"import\", \"in\",\n                    \"instanceof\", \"let\", \"new\", \"return\", \"super\", \"switch\", \"this\", \"throw\", \"try\", \"typeof\",\n                    \"var\", \"void\", \"while\", \"with\", \"yield\", \"async\", \"await\", \"of\", \"true\", \"false\", \"null\", \"undefined\",\n                    // TS\n                    \"interface\", \"type\", \"enum\", \"implements\", \"namespace\", \"abstract\", \"declare\", \"readonly\",\n                    \"private\", \"protected\", \"public\", \"keyof\", \"infer\", \"unknown\", \"never\", \"any\", \"as\", \"satisfies\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:string|number|boolean|any|unknown|never|void|object|bigint|symbol)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings + [\"`(?:[^`\\\\\\\\]|\\\\\\\\.|\\\\$\\\\{[\\\\s\\\\S]*?\\\\})*`\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: tsNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .tsx:\n            // TSX = TypeScript + JSX tags/attributes as \"types\" (cyan).\n            let ts = languageRules(for: .typescript)\n            return LanguageRules(\n                keywords: ts.keywords,\n                typePatterns: ts.typePatterns + [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:_-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: ts.stringPatterns,\n                stringRegexOptions: ts.stringRegexOptions,\n                commentPatterns: ts.commentPatterns,\n                commentRegexOptions: ts.commentRegexOptions,\n                numberPattern: ts.numberPattern,\n                numberRegexOptions: ts.numberRegexOptions,\n                keywordRegexOptions: ts.keywordRegexOptions,\n                functionPatterns: ts.functionPatterns\n            )\n\n        case .jsx:\n            // JSX = JS plus tag/attribute as \"types\" for cyan.\n            let js = languageRules(for: .javascript)\n            return LanguageRules(\n                keywords: js.keywords,\n                typePatterns: js.typePatterns + [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:_-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: js.stringPatterns,\n                stringRegexOptions: js.stringRegexOptions,\n                commentPatterns: js.commentPatterns,\n                commentRegexOptions: js.commentRegexOptions,\n                numberPattern: js.numberPattern,\n                numberRegexOptions: js.numberRegexOptions,\n                keywordRegexOptions: js.keywordRegexOptions,\n                functionPatterns: js.functionPatterns\n            )\n\n        // MARK: Python (patterns tuned)\n        case .python:\n            // Python numeric literals (underscores, hex/binary/octal, floats, leading-dot floats, complex).\n            let pyNumber = \"(?<!\\\\w)(?:(?:0x[0-9A-Fa-f_]+)|(?:0b[01_]+)|(?:0o[0-7_]+)|(?:\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)|(?:\\\\.\\\\d[\\\\d_]*(?:[eE][+-]?\\\\d[\\\\d_]*)?))(?:[jJ])?(?!\\\\w)\"\n\n            // Python strings incl. optional prefixes before both single-line and triple-quoted strings.\n            let pyStrings = [\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?'''[\\\\s\\\\S]*?'''\",\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\",\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"\n            ]\n\n            return LanguageRules(\n                keywords: [\n                    \"False\", \"None\", \"True\", \"and\", \"as\", \"assert\", \"async\", \"await\", \"break\", \"class\",\n                    \"continue\", \"def\", \"del\", \"elif\", \"else\", \"except\", \"finally\", \"for\", \"from\", \"global\",\n                    \"if\", \"import\", \"in\", \"is\", \"lambda\", \"nonlocal\", \"not\", \"or\", \"pass\", \"raise\", \"return\",\n                    \"try\", \"while\", \"with\", \"yield\", \"match\", \"case\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|float|bool|str|bytes|list|tuple|set|dict|object)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: pyStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: pyNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bdef\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // ----- Everything below remains as previously defined (uses common patterns) -----\n\n        case .ruby:\n            return LanguageRules(\n                keywords: [\n                    \"BEGIN\", \"END\", \"alias\", \"and\", \"begin\", \"break\", \"case\", \"class\", \"def\", \"defined\\\\?\",\n                    \"do\", \"else\", \"elsif\", \"end\", \"ensure\", \"false\", \"for\", \"if\", \"in\", \"module\", \"next\",\n                    \"nil\", \"not\", \"or\", \"redo\", \"rescue\", \"retry\", \"return\", \"self\", \"super\", \"then\",\n                    \"true\", \"undef\", \"unless\", \"until\", \"when\", \"while\", \"yield\", \"private\", \"protected\", \"public\"\n                ],\n                typePatterns: [CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])],\n                stringPatterns: [\n                    \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                    \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                    \"%[qQ]\\\\{[\\\\s\\\\S]*?\\\\}\",\n                    \"%[qQ]\\\\([\\\\s\\\\S]*?\\\\)\",\n                    \"%[qQ]\\\\[[\\\\s\\\\S]*?\\\\]\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\", \"=begin[\\\\s\\\\S]*?=end\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bdef\\\\s+([A-Za-z_][A-Za-z0-9_]*[!?=]?)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .go:\n            return LanguageRules(\n                keywords: [\n                    \"break\", \"default\", \"func\", \"interface\", \"select\", \"case\", \"defer\", \"go\", \"map\", \"struct\",\n                    \"chan\", \"else\", \"goto\", \"package\", \"switch\", \"const\", \"fallthrough\", \"if\", \"range\", \"type\",\n                    \"continue\", \"for\", \"import\", \"return\", \"var\", \"true\", \"false\", \"nil\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:string|bool|byte|rune|int|int8|int16|int32|int64|uint|uint8|uint16|uint32|uint64|uintptr|float32|float64|complex64|complex128|error)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"`[\\\\s\\\\S]*?`\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunc\\\\s+(?:\\\\([^)]*\\\\)\\\\s*)?([A-Za-z_][A-Za-z0-9_]*)\\\\s*\\\\(\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .rust:\n            return LanguageRules(\n                keywords: [\n                    \"as\", \"break\", \"const\", \"continue\", \"crate\", \"else\", \"enum\", \"extern\", \"false\", \"fn\", \"for\",\n                    \"if\", \"impl\", \"in\", \"let\", \"loop\", \"match\", \"mod\", \"move\", \"mut\", \"pub\", \"ref\", \"return\",\n                    \"self\", \"Self\", \"static\", \"struct\", \"super\", \"trait\", \"true\", \"type\", \"unsafe\", \"use\",\n                    \"where\", \"while\", \"async\", \"await\", \"dyn\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:i8|i16|i32|i64|i128|isize|u8|u16|u32|u64|u128|usize|f32|f64|bool|char|str|String|Option|Result|Vec)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"r#\\\"[\\\\s\\\\S]*?\\\"#\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"//[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfn\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .java:\n            return LanguageRules(\n                keywords: [\n                    \"abstract\", \"assert\", \"boolean\", \"break\", \"byte\", \"case\", \"catch\", \"char\", \"class\",\n                    \"const\", \"continue\", \"default\", \"do\", \"double\", \"else\", \"enum\", \"extends\", \"final\",\n                    \"finally\", \"float\", \"for\", \"goto\", \"if\", \"implements\", \"import\", \"instanceof\", \"int\",\n                    \"interface\", \"long\", \"native\", \"new\", \"package\", \"private\", \"protected\", \"public\",\n                    \"return\", \"short\", \"static\", \"strictfp\", \"super\", \"switch\", \"synchronized\", \"this\",\n                    \"throw\", \"throws\", \"transient\", \"try\", \"void\", \"volatile\", \"while\", \"true\", \"false\", \"null\",\n                    \"var\", \"record\", \"sealed\", \"permits\", \"non-sealed\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:boolean|byte|char|short|int|long|float|double|void|String|Object)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .kotlin:\n            return LanguageRules(\n                keywords: [\n                    \"as\", \"break\", \"class\", \"continue\", \"do\", \"else\", \"false\", \"for\", \"fun\", \"if\", \"in\",\n                    \"interface\", \"is\", \"null\", \"object\", \"package\", \"return\", \"super\", \"this\", \"throw\",\n                    \"true\", \"try\", \"typealias\", \"val\", \"var\", \"when\", \"while\",\n                    \"by\", \"catch\", \"constructor\", \"delegate\", \"finally\", \"get\", \"import\", \"init\", \"set\", \"where\",\n                    \"actual\", \"abstract\", \"annotation\", \"companion\", \"const\", \"crossinline\", \"data\", \"enum\",\n                    \"expect\", \"external\", \"final\", \"infix\", \"inline\", \"inner\", \"internal\", \"lateinit\",\n                    \"noinline\", \"open\", \"operator\", \"out\", \"override\", \"private\", \"protected\", \"public\",\n                    \"reified\", \"sealed\", \"suspend\", \"tailrec\", \"vararg\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:Int|Long|Short|Byte|Float|Double|Boolean|Char|String|Unit|Any|Nothing)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfun\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .c:\n            return LanguageRules(\n                keywords: [\n                    \"auto\", \"break\", \"case\", \"char\", \"const\", \"continue\", \"default\", \"do\", \"double\", \"else\",\n                    \"enum\", \"extern\", \"float\", \"for\", \"goto\", \"if\", \"inline\", \"int\", \"long\", \"register\",\n                    \"restrict\", \"return\", \"short\", \"signed\", \"sizeof\", \"static\", \"struct\", \"switch\", \"typedef\",\n                    \"union\", \"unsigned\", \"void\", \"volatile\", \"while\", \"_Bool\", \"_Complex\", \"_Imaginary\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:char|short|int|long|float|double|void|size_t|ssize_t|bool)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .cpp:\n            return LanguageRules(\n                keywords: [\n                    \"alignas\", \"alignof\", \"and\", \"and_eq\", \"asm\", \"auto\", \"bitand\", \"bitor\", \"bool\", \"break\",\n                    \"case\", \"catch\", \"char\", \"char8_t\", \"char16_t\", \"char32_t\", \"class\", \"compl\", \"concept\",\n                    \"const\", \"consteval\", \"constexpr\", \"constinit\", \"continue\", \"co_await\", \"co_return\", \"co_yield\",\n                    \"default\", \"delete\", \"do\", \"double\", \"dynamic_cast\", \"else\", \"enum\", \"explicit\", \"export\", \"extern\",\n                    \"false\", \"float\", \"for\", \"friend\", \"goto\", \"if\", \"inline\", \"int\", \"long\", \"mutable\", \"namespace\",\n                    \"new\", \"noexcept\", \"not\", \"not_eq\", \"nullptr\", \"operator\", \"or\", \"or_eq\", \"private\", \"protected\",\n                    \"public\", \"register\", \"reinterpret_cast\", \"requires\", \"return\", \"short\", \"signed\", \"sizeof\",\n                    \"static\", \"static_assert\", \"static_cast\", \"struct\", \"switch\", \"template\", \"this\", \"thread_local\",\n                    \"throw\", \"true\", \"try\", \"typedef\", \"typeid\", \"typename\", \"union\", \"unsigned\", \"using\", \"virtual\",\n                    \"void\", \"volatile\", \"wchar_t\", \"while\", \"xor\", \"xor_eq\", \"final\", \"override\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:bool|char|short|int|long|float|double|void|wchar_t|size_t|ssize_t|string|std::[A-Za-z0-9_:]+)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .objc:\n            return LanguageRules(\n                keywords: [\n                    \"@interface\", \"@implementation\", \"@end\", \"@property\", \"@synthesize\", \"@dynamic\", \"@protocol\",\n                    \"@class\", \"@public\", \"@private\", \"@protected\", \"@package\",\n                    \"@try\", \"@catch\", \"@finally\", \"@throw\", \"@autoreleasepool\",\n                    \"@selector\", \"@encode\", \"@import\", \"@available\",\n                    \"if\", \"else\", \"for\", \"while\", \"switch\", \"case\", \"default\", \"break\", \"continue\", \"return\",\n                    \"struct\", \"typedef\", \"enum\", \"static\", \"const\", \"void\", \"int\", \"char\", \"float\", \"double\",\n                    \"BOOL\", \"YES\", \"NO\", \"nil\", \"self\", \"super\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:id|instancetype|SEL|Class|BOOL|NSInteger|NSUInteger|CGFloat|NSString|NSNumber|NSArray|NSDictionary|NSData|NSDate|NSURL|NSError)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings + [\"@\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .html:\n            return LanguageRules(\n                keywords: [\"DOCTYPE\", \"html\", \"head\", \"body\", \"script\", \"style\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .xml:\n            return LanguageRules(\n                keywords: [\"xml\", \"version\", \"encoding\", \"CDATA\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z_][A-Za-z0-9:._-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\", \"<!\\\\[CDATA\\\\[[\\\\s\\\\S]*?\\\\]\\\\]>\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .css:\n            return LanguageRules(\n                keywords: [\"@import\", \"@media\", \"@supports\", \"@keyframes\", \"@font-face\", \"@page\", \"@layer\", \"important\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"(?:\\\\.|#)([A-Za-z_-][A-Za-z0-9_-]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\b(?=\\\\s*\\\\{)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: \"\\\\b\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:%|px|em|rem|vw|vh|vmin|vmax|fr|ch|ex|cm|mm|in|pt|pc)?\\\\b\",\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\s*(?=:)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: [])\n                ]\n            )\n\n        case .scss:\n            let css = languageRules(for: .css)\n            return LanguageRules(\n                keywords: css.keywords + [\"@mixin\", \"@include\", \"@extend\", \"@function\", \"@return\", \"@if\", \"@else\", \"@for\", \"@each\", \"@while\"],\n                typePatterns: css.typePatterns,\n                stringPatterns: css.stringPatterns,\n                stringRegexOptions: css.stringRegexOptions,\n                commentPatterns: [\"/\\\\*[\\\\s\\\\S]*?\\\\*/\", \"//[^\\\\n]*\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: css.numberPattern,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: css.functionPatterns\n            )\n\n        case .json:\n            return LanguageRules(\n                keywords: [\"true\", \"false\", \"null\"],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"//[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .yaml:\n            return LanguageRules(\n                keywords: [\"true\", \"false\", \"null\", \"yes\", \"no\", \"on\", \"off\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"([&*][A-Za-z0-9_-]+)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"^\\\\s*([A-Za-z0-9_-]+)\\\\s*:(?=\\\\s|$)\", captureGroup: 1, options: [.anchorsMatchLines])\n                ]\n            )\n\n        case .sql:\n            return LanguageRules(\n                keywords: [\n                    \"select\", \"from\", \"where\", \"group\", \"by\", \"having\", \"order\", \"limit\", \"offset\",\n                    \"insert\", \"into\", \"values\", \"update\", \"set\", \"delete\",\n                    \"join\", \"inner\", \"left\", \"right\", \"full\", \"outer\", \"cross\", \"on\",\n                    \"as\", \"distinct\", \"union\", \"all\", \"and\", \"or\", \"not\", \"null\", \"is\", \"in\", \"exists\", \"like\", \"between\",\n                    \"create\", \"alter\", \"drop\", \"table\", \"view\", \"index\", \"primary\", \"key\", \"foreign\", \"references\",\n                    \"case\", \"when\", \"then\", \"else\", \"end\",\n                    \"begin\", \"commit\", \"rollback\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|integer|smallint|bigint|serial|bigserial|decimal|numeric|real|double|float|money|boolean|bool|date|time|timestamp|timestamptz|varchar|char|text|uuid|json|jsonb)\\\\b\", captureGroup: nil, options: [.caseInsensitive])\n                ],\n                stringPatterns: [\"'(?:''|[^'])*'\", \"\\\"(?:\\\"\\\"|[^\\\"])*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"--[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: [.caseInsensitive])\n                ]\n            )\n\n        case .shell:\n            return LanguageRules(\n                keywords: [\n                    \"if\", \"then\", \"elif\", \"else\", \"fi\", \"for\", \"in\", \"do\", \"done\", \"case\", \"esac\", \"while\", \"until\",\n                    \"select\", \"function\", \"time\", \"coproc\", \"break\", \"continue\", \"return\", \"exit\", \"export\", \"readonly\",\n                    \"local\", \"declare\", \"typeset\", \"unset\", \"shift\", \"trap\", \"set\"\n                ],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'[^'\\\\n]*'\", \"\\\\$'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*\\\\(\\\\s*\\\\)\\\\s*\\\\{\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .dockerfile:\n            return LanguageRules(\n                keywords: [\n                    \"FROM\", \"RUN\", \"CMD\", \"LABEL\", \"MAINTAINER\", \"EXPOSE\", \"ENV\", \"ADD\", \"COPY\", \"ENTRYPOINT\",\n                    \"VOLUME\", \"USER\", \"WORKDIR\", \"ARG\", \"ONBUILD\", \"STOPSIGNAL\", \"HEALTHCHECK\", \"SHELL\"\n                ],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .graphql:\n            return LanguageRules(\n                keywords: [\n                    \"query\", \"mutation\", \"subscription\", \"fragment\", \"on\",\n                    \"schema\", \"type\", \"interface\", \"union\", \"enum\", \"input\", \"extend\", \"directive\", \"implements\",\n                    \"scalar\", \"true\", \"false\", \"null\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:Int|Float|String|Boolean|ID)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .markdown:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [],\n                stringPatterns: [\n                    \"```[\\\\s\\\\S]*?```\",\n                    \"~~~[\\\\s\\\\S]*?~~~\",\n                    \"`[^`\\\\n]+`\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: nil,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .php:\n            return LanguageRules(\n                keywords: [\n                    \"abstract\", \"and\", \"array\", \"as\", \"break\", \"callable\", \"case\", \"catch\", \"class\", \"clone\",\n                    \"const\", \"continue\", \"declare\", \"default\", \"die\", \"do\", \"echo\", \"else\", \"elseif\", \"empty\",\n                    \"enddeclare\", \"endfor\", \"endforeach\", \"endif\", \"endswitch\", \"endwhile\", \"enum\", \"eval\", \"exit\",\n                    \"extends\", \"final\", \"finally\", \"fn\", \"for\", \"foreach\", \"function\", \"global\", \"goto\", \"if\",\n                    \"implements\", \"include\", \"include_once\", \"instanceof\", \"insteadof\", \"interface\", \"isset\",\n                    \"list\", \"match\", \"namespace\", \"new\", \"or\", \"print\", \"private\", \"protected\", \"public\", \"readonly\",\n                    \"require\", \"require_once\", \"return\", \"static\", \"switch\", \"throw\", \"trait\", \"try\", \"unset\", \"use\",\n                    \"var\", \"while\", \"xor\", \"yield\", \"true\", \"false\", \"null\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|float|string|bool|array|object|callable|iterable|mixed|void|never)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments + [\"#[^\\\\n]*\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .dotenv:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [\n                    // Keys in KEY=value or export KEY=value\n                    CapturePattern(\n                        pattern: \"^\\\\s*(?:export\\\\s+)?([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?==)\",\n                        captureGroup: 1,\n                        options: [.anchorsMatchLines]\n                    )\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .plainText:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [],\n                stringPatterns: [],\n                stringRegexOptions: [],\n                commentPatterns: [],\n                commentRegexOptions: [],\n                numberPattern: nil,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n        }\n    }\n\n    // MARK: - Regex application helpers\n\n    @discardableResult\n    private static func applyHighlighting(\n        pattern: String,\n        options: NSRegularExpression.Options,\n        color: UIColor,\n        to attributedString: NSMutableAttributedString,\n        in text: String,\n        captureGroup: Int?,\n        excluding excludedRanges: [NSRange]\n    ) -> [NSRange] {\n        do {\n            let regex = try NSRegularExpression(pattern: pattern, options: options)\n            let matches = regex.matches(in: text, options: [], range: NSRange(location: 0, length: text.utf16.count))\n\n            var applied: [NSRange] = []\n            applied.reserveCapacity(matches.count)\n\n            for match in matches {\n                let range: NSRange = {\n                    if let captureGroup, captureGroup <= match.numberOfRanges - 1 {\n                        return match.range(at: captureGroup)\n                    }\n                    return match.range\n                }()\n\n                guard range.location != NSNotFound, range.length > 0 else { continue }\n                if intersectsAny(range, excludedRanges) { continue }\n\n                attributedString.addAttribute(.foregroundColor, value: color, range: range)\n                applied.append(range)\n            }\n\n            return applied\n        } catch {\n            print(\"Regex error for pattern \\(pattern): \\(error)\")\n            return []\n        }\n    }\n\n    private static func intersectsAny(_ range: NSRange, _ excludedRanges: [NSRange]) -> Bool {\n        for ex in excludedRanges where NSIntersectionRange(range, ex).length > 0 {\n            return true\n        }\n        return false\n    }\n}\n\n// SwiftUI wrapper for NSAttributedString\nstruct AttributedTextView: UIViewRepresentable {\n    let attributedText: NSAttributedString\n\n    func makeUIView(context: Context) -> UITextView {\n        let textView = UITextView()\n        textView.isEditable = false\n        textView.isSelectable = true\n        textView.backgroundColor = .clear\n        textView.textContainerInset = UIEdgeInsets(top: 8, left: 8, bottom: 8, right: 8)\n        return textView\n    }\n\n    func updateUIView(_ uiView: UITextView, context: Context) {\n        uiView.attributedText = attributedText\n    }\n}\n\n// Extension to make it easy to use in SwiftUI\nextension View {\n    func syntaxHighlighted(\n        code: String,\n        filename: String? = nil,\n        language: NSAttributedStringSyntaxHighlighter.SyntaxLanguage? = nil\n    ) -> some View {\n        AttributedTextView(attributedText: NSAttributedStringSyntaxHighlighter.highlightCode(code, filename: filename, language: language))\n    }\n}\n","overwrite":true}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":240}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":80}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":220,"end_line":430}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":12}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":5}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":3}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":25}
>>>END

>>>TOOL search
{"query":"(?=\\\\())", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":238,"end_line":258}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":40}
>>>END

>>>TOOL search
{"query":"import UIKit", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":70}
>>>END

>>>TOOL search
{"query":"import SwiftUI", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END


>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":8}
>>>END

>>>TOOL search
{"query":"pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\())\"", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL search
{"query":"private extension UIColor", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END


>>>TOOL create_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","overwrite":true,"content":""} 
>>>END

>>>TOOL read_file
{"path":"VSCodeiPadOS/VSCodeiPadOS/Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":260}
>>>END

>>>TOOL create_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","overwrite":true,"content":"import SwiftUI\nimport UIKit\n\n// Efficient NSMutableAttributedString-based syntax highlighter (regex-based).\n//\n// Color mapping (VS Code Dark+):\n// - Keywords:   #569CD6\n// - Types:      #4EC9B0\n// - Strings:    #CE9178\n// - Comments:   #6A9955\n// - Numbers:    #B5CEA8\n// - Functions:  #DCDCAA\nfinal class NSAttributedStringSyntaxHighlighter {\n\n    // MARK: - Language\n\n    // NOTE: This file cannot use the name `Language` because the project already defines a global `Language`\n    // enum elsewhere (VSCodeiPadOS/Views/Editor/SyntaxHighlightingTextView.swift).\n    enum SyntaxLanguage {\n        case swift, javascript, typescript, jsx, tsx\n        case python, ruby, go, rust\n        case java, kotlin\n        case c, cpp, objc\n        case html, css, scss\n        case json, xml, yaml\n        case sql, shell, dockerfile, graphql\n        case markdown, php, dotenv\n        case plainText\n    }\n\n    // MARK: - Colors\n\n    private extension UIColor {\n        convenience init(vscodeHex: UInt32, alpha: CGFloat = 1) {\n            let r = CGFloat((vscodeHex >> 16) & 0xFF) / 255\n            let g = CGFloat((vscodeHex >> 8) & 0xFF) / 255\n            let b = CGFloat(vscodeHex & 0xFF) / 255\n            self.init(red: r, green: g, blue: b, alpha: alpha)\n        }\n    }\n\n    private struct ColorScheme {\n        static let keyword = UIColor(vscodeHex: 0x569CD6)\n        static let type = UIColor(vscodeHex: 0x4EC9B0)\n        static let string = UIColor(vscodeHex: 0xCE9178)\n        static let comment = UIColor(vscodeHex: 0x6A9955)\n        static let number = UIColor(vscodeHex: 0xB5CEA8)\n        static let function = UIColor(vscodeHex: 0xDCDCAA)\n        static let defaultText = UIColor(vscodeHex: 0xD4D4D4)\n    }\n\n    // MARK: - Public API\n\n    /// Backwards-compatible entrypoint (defaults to Swift).\n    static func highlightCode(_ code: String) -> NSAttributedString {\n        highlightCode(code, filename: nil, language: .swift)\n    }\n\n    /// Highlights `code` using either an explicit `language` or a detected one from `filename`.\n    static func highlightCode(_ code: String, filename: String? = nil, language: SyntaxLanguage? = nil) -> NSAttributedString {\n        let attributed = NSMutableAttributedString(string: code)\n        let fullRange = NSRange(location: 0, length: code.utf16.count)\n\n        attributed.addAttributes([\n            .font: UIFont.monospacedSystemFont(ofSize: 14, weight: .regular),\n            .foregroundColor: ColorScheme.defaultText\n        ], range: fullRange)\n\n        let resolvedLanguage: SyntaxLanguage = {\n            if let language { return language }\n            if let filename { return detectLanguage(fromFilename: filename) }\n            return .plainText\n        }()\n\n        highlight(code: code, language: resolvedLanguage, into: attributed)\n        return attributed\n    }\n\n    // MARK: - Language detection\n\n    private static func detectLanguage(fromFilename filename: String) -> SyntaxLanguage {\n        let lower = filename.lowercased()\n        let base = (lower as NSString).lastPathComponent\n        let ext = (base as NSString).pathExtension\n\n        // Special basenames (no extension).\n        if base == \"dockerfile\" || base.hasPrefix(\"dockerfile.\") { return .dockerfile }\n        if base == \".env\" || base.hasPrefix(\".env.\") || ext == \"env\" { return .dotenv }\n\n        switch ext {\n        case \"swift\": return .swift\n        case \"js\", \"mjs\", \"cjs\": return .javascript\n        case \"jsx\": return .jsx\n        case \"ts\": return .typescript\n        case \"tsx\": return .tsx\n        case \"py\", \"pyw\": return .python\n        case \"rb\", \"ruby\": return .ruby\n        case \"go\": return .go\n        case \"rs\": return .rust\n        case \"java\": return .java\n        case \"kt\", \"kts\": return .kotlin\n        case \"c\": return .c\n        case \"cc\", \"cpp\", \"cxx\", \"hpp\", \"hh\", \"hxx\", \"h\": return .cpp\n        case \"m\", \"mm\": return .objc\n        case \"html\", \"htm\": return .html\n        case \"css\": return .css\n        case \"scss\", \"sass\": return .scss\n        case \"json\", \"jsonc\": return .json\n        case \"xml\", \"plist\", \"svg\": return .xml\n        case \"yml\", \"yaml\": return .yaml\n        case \"sql\": return .sql\n        case \"sh\", \"bash\", \"zsh\", \"fish\": return .shell\n        case \"php\": return .php\n        case \"gql\", \"graphql\": return .graphql\n        case \"md\", \"markdown\": return .markdown\n        default: return .plainText\n        }\n    }\n\n    // MARK: - Pipeline\n\n    private struct CapturePattern {\n        let pattern: String\n        let captureGroup: Int?\n        let options: NSRegularExpression.Options\n    }\n\n    private struct LanguageRules {\n        let keywords: [String]\n        let typePatterns: [CapturePattern]\n        let stringPatterns: [String]\n        let stringRegexOptions: NSRegularExpression.Options\n        let commentPatterns: [String]\n        let commentRegexOptions: NSRegularExpression.Options\n        let numberPattern: String?\n        let numberRegexOptions: NSRegularExpression.Options\n        let keywordRegexOptions: NSRegularExpression.Options\n        let functionPatterns: [CapturePattern]\n    }\n\n    private static func highlight(code: String, language: SyntaxLanguage, into attributed: NSMutableAttributedString) {\n        let rules = languageRules(for: language)\n\n        // 1) Strings first\n        let stringRanges = rules.stringPatterns.flatMap { pattern in\n            applyHighlighting(\n                pattern: pattern,\n                options: rules.stringRegexOptions,\n                color: ColorScheme.string,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: []\n            )\n        }\n\n        // 2) Comments (exclude matches inside strings)\n        let commentRanges = rules.commentPatterns.flatMap { pattern in\n            applyHighlighting(\n                pattern: pattern,\n                options: rules.commentRegexOptions,\n                color: ColorScheme.comment,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: stringRanges\n            )\n        }\n\n        let protectedRanges = stringRanges + commentRanges\n\n        // 3) Numbers\n        if let numberPattern = rules.numberPattern {\n            _ = applyHighlighting(\n                pattern: numberPattern,\n                options: rules.numberRegexOptions,\n                color: ColorScheme.number,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: protectedRanges\n            )\n        }\n\n        // 4) Types\n        for typePattern in rules.typePatterns {\n            _ = applyHighlighting(\n                pattern: typePattern.pattern,\n                options: typePattern.options,\n                color: ColorScheme.type,\n                to: attributed,\n                in: code,\n                captureGroup: typePattern.captureGroup,\n                excluding: protectedRanges\n            )\n        }\n\n        // 5) Keywords\n        if !rules.keywords.isEmpty {\n            let keywordPattern = \"\\\\b(?:\" + rules.keywords.map(NSRegularExpression.escapedPattern).joined(separator: \"|\") + \")\\\\b\"\n            _ = applyHighlighting(\n                pattern: keywordPattern,\n                options: rules.keywordRegexOptions,\n                color: ColorScheme.keyword,\n                to: attributed,\n                in: code,\n                captureGroup: nil,\n                excluding: protectedRanges\n            )\n        }\n\n        // 6) Functions\n        for fnPattern in rules.functionPatterns {\n            _ = applyHighlighting(\n                pattern: fnPattern.pattern,\n                options: fnPattern.options,\n                color: ColorScheme.function,\n                to: attributed,\n                in: code,\n                captureGroup: fnPattern.captureGroup,\n                excluding: protectedRanges\n            )\n        }\n    }\n\n    // MARK: - Language rules\n\n    private static func languageRules(for language: SyntaxLanguage) -> LanguageRules {\n\n        // Numeric literal coverage (hex, float, exponent, underscores).\n        let commonNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)\\\\b\"\n\n        // C-like strings: \"...\" and '...'\n        let cLikeStrings = [\n            \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n            \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"\n        ]\n\n        // C-like comments\n        let cLikeComments = [\n            \"//[^\\\\n]*\",\n            \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"\n        ]\n\n        // Common function call: name(\n        let commonFunctionCall = CapturePattern(\n            pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\",\n            captureGroup: 1,\n            options: []\n        )\n\n        switch language {\n\n        // MARK: - Swift\n        case .swift:\n            // Swift numeric literals: hex/binary/octal, decimal, floats (underscores allowed).\n            // Includes hex-float exponent `p` / `P`.\n            let swiftNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+(?:\\\\.[0-9A-Fa-f_]+)?(?:[pP][+-]?\\\\d[\\\\d_]*)?|0b[01_]+|0o[0-7_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)\\\\b\"\n\n            // Swift strings: normal and raw (any number of # delimiters), including multiline triple-quoted.\n            // (Note: this intentionally doesn't enforce matching # count; its a fast highlighter.)\n            let swiftStrings = [\n                \"#*\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"#*\",\n                \"#*\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"#*\"\n            ]\n\n            return LanguageRules(\n                keywords: [\n                    \"func\", \"var\", \"let\", \"if\", \"else\", \"for\", \"while\", \"repeat\", \"switch\", \"case\", \"default\",\n                    \"return\", \"import\", \"class\", \"struct\", \"enum\", \"protocol\", \"extension\", \"actor\",\n                    \"private\", \"fileprivate\", \"public\", \"internal\", \"open\", \"static\", \"final\", \"override\",\n                    \"self\", \"super\", \"init\", \"deinit\",\n                    \"throw\", \"throws\", \"rethrows\", \"try\", \"catch\", \"do\", \"guard\", \"defer\",\n                    \"async\", \"await\",\n                    \"weak\", \"unowned\", \"mutating\", \"nonmutating\",\n                    \"typealias\", \"associatedtype\", \"where\", \"in\", \"is\", \"as\", \"Any\", \"some\", \"any\",\n                    \"true\", \"false\", \"nil\"\n                ],\n                typePatterns: [\n                    CapturePattern(\n                        pattern: \"\\\\b(?:String|Int|Int8|Int16|Int32|Int64|UInt|UInt8|UInt16|UInt32|UInt64|Double|Float|Bool|Character|Void|AnyObject|Never|Data|Date|URL|UUID|CGFloat)\\\\b\",\n                        captureGroup: nil,\n                        options: []\n                    ),\n                    // UpperCamelCase identifiers (types / protocols / enums / etc.)\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: swiftStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: swiftNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunc\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // MARK: - JavaScript\n        case .javascript:\n            // JS numeric literals: hex/binary/octal/decimal/floats + BigInt suffix `n`.\n            let jsNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+|0b[01_]+|0o[0-7_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?|\\\\d[\\\\d_]*n)\\\\b\"\n\n            return LanguageRules(\n                keywords: [\n                    \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"debugger\", \"default\", \"delete\",\n                    \"do\", \"else\", \"export\", \"extends\", \"finally\", \"for\", \"function\", \"if\", \"import\", \"in\",\n                    \"instanceof\", \"let\", \"new\", \"return\", \"super\", \"switch\", \"this\", \"throw\", \"try\", \"typeof\",\n                    \"var\", \"void\", \"while\", \"with\", \"yield\", \"async\", \"await\", \"of\", \"true\", \"false\", \"null\", \"undefined\"\n                ],\n                typePatterns: [CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])],\n                stringPatterns: cLikeStrings + [\n                    // Template string with ${ ... } interpolations\n                    \"`(?:[^`\\\\\\\\]|\\\\\\\\.|\\\\$\\\\{[\\\\s\\\\S]*?\\\\})*`\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: jsNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    // Arrow fn assignment: const name = (...) =>\n                    CapturePattern(pattern: \"\\\\b(?:const|let|var)\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\s*=\\\\s*(?:async\\\\s*)?(?:\\\\([^)]*\\\\)|[A-Za-z_][A-Za-z0-9_]*)?\\\\s*=>\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // MARK: - TypeScript\n        case .typescript:\n            let tsNumber = \"\\\\b(?:0x[0-9A-Fa-f_]+|0b[01_]+|0o[0-7_]+|\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?|\\\\d[\\\\d_]*n)\\\\b\"\n\n            return LanguageRules(\n                keywords: [\n                    // JS\n                    \"break\", \"case\", \"catch\", \"class\", \"const\", \"continue\", \"debugger\", \"default\", \"delete\",\n                    \"do\", \"else\", \"export\", \"extends\", \"finally\", \"for\", \"function\", \"if\", \"import\", \"in\",\n                    \"instanceof\", \"let\", \"new\", \"return\", \"super\", \"switch\", \"this\", \"throw\", \"try\", \"typeof\",\n                    \"var\", \"void\", \"while\", \"with\", \"yield\", \"async\", \"await\", \"of\", \"true\", \"false\", \"null\", \"undefined\",\n                    // TS\n                    \"interface\", \"type\", \"enum\", \"implements\", \"namespace\", \"abstract\", \"declare\", \"readonly\",\n                    \"private\", \"protected\", \"public\", \"keyof\", \"infer\", \"unknown\", \"never\", \"any\", \"as\", \"satisfies\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:string|number|boolean|any|unknown|never|void|object|bigint|symbol)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings + [\"`(?:[^`\\\\\\\\]|\\\\\\\\.|\\\\$\\\\{[\\\\s\\\\S]*?\\\\})*`\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: tsNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .tsx:\n            // TSX = TypeScript + JSX tags/attributes as \"types\".\n            let ts = languageRules(for: .typescript)\n            return LanguageRules(\n                keywords: ts.keywords,\n                typePatterns: ts.typePatterns + [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:_-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: ts.stringPatterns,\n                stringRegexOptions: ts.stringRegexOptions,\n                commentPatterns: ts.commentPatterns,\n                commentRegexOptions: ts.commentRegexOptions,\n                numberPattern: ts.numberPattern,\n                numberRegexOptions: ts.numberRegexOptions,\n                keywordRegexOptions: ts.keywordRegexOptions,\n                functionPatterns: ts.functionPatterns\n            )\n\n        case .jsx:\n            // JSX = JavaScript + JSX tags/attributes as \"types\".\n            let js = languageRules(for: .javascript)\n            return LanguageRules(\n                keywords: js.keywords,\n                typePatterns: js.typePatterns + [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:_-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: js.stringPatterns,\n                stringRegexOptions: js.stringRegexOptions,\n                commentPatterns: js.commentPatterns,\n                commentRegexOptions: js.commentRegexOptions,\n                numberPattern: js.numberPattern,\n                numberRegexOptions: js.numberRegexOptions,\n                keywordRegexOptions: js.keywordRegexOptions,\n                functionPatterns: js.functionPatterns\n            )\n\n        // MARK: - Python\n        case .python:\n            // Python numeric literals (underscores, bases, leading-dot floats, complex).\n            let pyNumber = \"(?<!\\\\w)(?:(?:0x[0-9A-Fa-f_]+)|(?:0b[01_]+)|(?:0o[0-7_]+)|(?:\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:[eE][+-]?\\\\d[\\\\d_]*)?)|(?:\\\\.\\\\d[\\\\d_]*(?:[eE][+-]?\\\\d[\\\\d_]*)?))(?:[jJ])?(?!\\\\w)\"\n\n            let pyStrings = [\n                // Prefixes allowed for both triple-quoted and single-line strings.\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?'''[\\\\s\\\\S]*?'''\",\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\",\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                \"(?i)\\\\b(?:r|u|f|fr|rf|b|br|rb)?\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"\n            ]\n\n            return LanguageRules(\n                keywords: [\n                    \"False\", \"None\", \"True\", \"and\", \"as\", \"assert\", \"async\", \"await\", \"break\", \"class\",\n                    \"continue\", \"def\", \"del\", \"elif\", \"else\", \"except\", \"finally\", \"for\", \"from\", \"global\",\n                    \"if\", \"import\", \"in\", \"is\", \"lambda\", \"nonlocal\", \"not\", \"or\", \"pass\", \"raise\", \"return\",\n                    \"try\", \"while\", \"with\", \"yield\", \"match\", \"case\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|float|bool|str|bytes|list|tuple|set|dict|object)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: pyStrings,\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: pyNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bdef\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        // MARK: - Other languages (unchanged baseline rules)\n        case .ruby:\n            return LanguageRules(\n                keywords: [\n                    \"BEGIN\", \"END\", \"alias\", \"and\", \"begin\", \"break\", \"case\", \"class\", \"def\", \"defined\\\\?\",\n                    \"do\", \"else\", \"elsif\", \"end\", \"ensure\", \"false\", \"for\", \"if\", \"in\", \"module\", \"next\",\n                    \"nil\", \"not\", \"or\", \"redo\", \"rescue\", \"retry\", \"return\", \"self\", \"super\", \"then\",\n                    \"true\", \"undef\", \"unless\", \"until\", \"when\", \"while\", \"yield\", \"private\", \"protected\", \"public\"\n                ],\n                typePatterns: [CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])],\n                stringPatterns: [\n                    \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\",\n                    \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\",\n                    \"%[qQ]\\\\{[\\\\s\\\\S]*?\\\\}\",\n                    \"%[qQ]\\\\([\\\\s\\\\S]*?\\\\)\",\n                    \"%[qQ]\\\\[[\\\\s\\\\S]*?\\\\]\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\", \"=begin[\\\\s\\\\S]*?=end\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bdef\\\\s+([A-Za-z_][A-Za-z0-9_]*[!?=]?)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .go:\n            return LanguageRules(\n                keywords: [\n                    \"break\", \"default\", \"func\", \"interface\", \"select\", \"case\", \"defer\", \"go\", \"map\", \"struct\",\n                    \"chan\", \"else\", \"goto\", \"package\", \"switch\", \"const\", \"fallthrough\", \"if\", \"range\", \"type\",\n                    \"continue\", \"for\", \"import\", \"return\", \"var\", \"true\", \"false\", \"nil\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:string|bool|byte|rune|int|int8|int16|int32|int64|uint|uint8|uint16|uint32|uint64|uintptr|float32|float64|complex64|complex128|error)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"`[\\\\s\\\\S]*?`\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunc\\\\s+(?:\\\\([^)]*\\\\)\\\\s*)?([A-Za-z_][A-Za-z0-9_]*)\\\\s*\\\\(\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .rust:\n            return LanguageRules(\n                keywords: [\n                    \"as\", \"break\", \"const\", \"continue\", \"crate\", \"else\", \"enum\", \"extern\", \"false\", \"fn\", \"for\",\n                    \"if\", \"impl\", \"in\", \"let\", \"loop\", \"match\", \"mod\", \"move\", \"mut\", \"pub\", \"ref\", \"return\",\n                    \"self\", \"Self\", \"static\", \"struct\", \"super\", \"trait\", \"true\", \"type\", \"unsafe\", \"use\",\n                    \"where\", \"while\", \"async\", \"await\", \"dyn\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:i8|i16|i32|i64|i128|isize|u8|u16|u32|u64|u128|usize|f32|f64|bool|char|str|String|Option|Result|Vec)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"r#\\\"[\\\\s\\\\S]*?\\\"#\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"//[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfn\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .java:\n            return LanguageRules(\n                keywords: [\n                    \"abstract\", \"assert\", \"boolean\", \"break\", \"byte\", \"case\", \"catch\", \"char\", \"class\",\n                    \"const\", \"continue\", \"default\", \"do\", \"double\", \"else\", \"enum\", \"extends\", \"final\",\n                    \"finally\", \"float\", \"for\", \"goto\", \"if\", \"implements\", \"import\", \"instanceof\", \"int\",\n                    \"interface\", \"long\", \"native\", \"new\", \"package\", \"private\", \"protected\", \"public\",\n                    \"return\", \"short\", \"static\", \"strictfp\", \"super\", \"switch\", \"synchronized\", \"this\",\n                    \"throw\", \"throws\", \"transient\", \"try\", \"void\", \"volatile\", \"while\", \"true\", \"false\", \"null\",\n                    \"var\", \"record\", \"sealed\", \"permits\", \"non-sealed\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:boolean|byte|char|short|int|long|float|double|void|String|Object)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .kotlin:\n            return LanguageRules(\n                keywords: [\n                    \"as\", \"break\", \"class\", \"continue\", \"do\", \"else\", \"false\", \"for\", \"fun\", \"if\", \"in\",\n                    \"interface\", \"is\", \"null\", \"object\", \"package\", \"return\", \"super\", \"this\", \"throw\",\n                    \"true\", \"try\", \"typealias\", \"val\", \"var\", \"when\", \"while\",\n                    \"by\", \"catch\", \"constructor\", \"delegate\", \"finally\", \"get\", \"import\", \"init\", \"set\", \"where\",\n                    \"actual\", \"abstract\", \"annotation\", \"companion\", \"const\", \"crossinline\", \"data\", \"enum\",\n                    \"expect\", \"external\", \"final\", \"infix\", \"inline\", \"inner\", \"internal\", \"lateinit\",\n                    \"noinline\", \"open\", \"operator\", \"out\", \"override\", \"private\", \"protected\", \"public\",\n                    \"reified\", \"sealed\", \"suspend\", \"tailrec\", \"vararg\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:Int|Long|Short|Byte|Float|Double|Boolean|Char|String|Unit|Any|Nothing)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfun\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .c:\n            return LanguageRules(\n                keywords: [\n                    \"auto\", \"break\", \"case\", \"char\", \"const\", \"continue\", \"default\", \"do\", \"double\", \"else\",\n                    \"enum\", \"extern\", \"float\", \"for\", \"goto\", \"if\", \"inline\", \"int\", \"long\", \"register\",\n                    \"restrict\", \"return\", \"short\", \"signed\", \"sizeof\", \"static\", \"struct\", \"switch\", \"typedef\",\n                    \"union\", \"unsigned\", \"void\", \"volatile\", \"while\", \"_Bool\", \"_Complex\", \"_Imaginary\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:char|short|int|long|float|double|void|size_t|ssize_t|bool)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .cpp:\n            return LanguageRules(\n                keywords: [\n                    \"alignas\", \"alignof\", \"and\", \"and_eq\", \"asm\", \"auto\", \"bitand\", \"bitor\", \"bool\", \"break\",\n                    \"case\", \"catch\", \"char\", \"char8_t\", \"char16_t\", \"char32_t\", \"class\", \"compl\", \"concept\",\n                    \"const\", \"consteval\", \"constexpr\", \"constinit\", \"continue\", \"co_await\", \"co_return\", \"co_yield\",\n                    \"default\", \"delete\", \"do\", \"double\", \"dynamic_cast\", \"else\", \"enum\", \"explicit\", \"export\", \"extern\",\n                    \"false\", \"float\", \"for\", \"friend\", \"goto\", \"if\", \"inline\", \"int\", \"long\", \"mutable\", \"namespace\",\n                    \"new\", \"noexcept\", \"not\", \"not_eq\", \"nullptr\", \"operator\", \"or\", \"or_eq\", \"private\", \"protected\",\n                    \"public\", \"register\", \"reinterpret_cast\", \"requires\", \"return\", \"short\", \"signed\", \"sizeof\",\n                    \"static\", \"static_assert\", \"static_cast\", \"struct\", \"switch\", \"template\", \"this\", \"thread_local\",\n                    \"throw\", \"true\", \"try\", \"typedef\", \"typeid\", \"typename\", \"union\", \"unsigned\", \"using\", \"virtual\",\n                    \"void\", \"volatile\", \"wchar_t\", \"while\", \"xor\", \"xor_eq\", \"final\", \"override\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:bool|char|short|int|long|float|double|void|wchar_t|size_t|ssize_t|string|std::[A-Za-z0-9_:]+)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .objc:\n            return LanguageRules(\n                keywords: [\n                    \"@interface\", \"@implementation\", \"@end\", \"@property\", \"@synthesize\", \"@dynamic\", \"@protocol\",\n                    \"@class\", \"@public\", \"@private\", \"@protected\", \"@package\",\n                    \"@try\", \"@catch\", \"@finally\", \"@throw\", \"@autoreleasepool\",\n                    \"@selector\", \"@encode\", \"@import\", \"@available\",\n                    \"if\", \"else\", \"for\", \"while\", \"switch\", \"case\", \"default\", \"break\", \"continue\", \"return\",\n                    \"struct\", \"typedef\", \"enum\", \"static\", \"const\", \"void\", \"int\", \"char\", \"float\", \"double\",\n                    \"BOOL\", \"YES\", \"NO\", \"nil\", \"self\", \"super\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:id|instancetype|SEL|Class|BOOL|NSInteger|NSUInteger|CGFloat|NSString|NSNumber|NSArray|NSDictionary|NSData|NSDate|NSURL|NSError)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings + [\"@\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments,\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [commonFunctionCall]\n            )\n\n        case .html:\n            return LanguageRules(\n                keywords: [\"DOCTYPE\", \"html\", \"head\", \"body\", \"script\", \"style\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z][A-Za-z0-9:-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .xml:\n            return LanguageRules(\n                keywords: [\"xml\", \"version\", \"encoding\", \"CDATA\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"<\\\\/?\\\\s*([A-Za-z_][A-Za-z0-9:._-]*)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_:][A-Za-z0-9:._-]*)(?=\\\\s*=)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\", \"<!\\\\[CDATA\\\\[[\\\\s\\\\S]*?\\\\]\\\\]>\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .css:\n            return LanguageRules(\n                keywords: [\"@import\", \"@media\", \"@supports\", \"@keyframes\", \"@font-face\", \"@page\", \"@layer\", \"important\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"(?:\\\\.|#)([A-Za-z_-][A-Za-z0-9_-]*)\\\\b\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\b(?=\\\\s*\\\\{)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: \"\\\\b\\\\d[\\\\d_]*(?:\\\\.\\\\d[\\\\d_]*)?(?:%|px|em|rem|vw|vh|vmin|vmax|fr|ch|ex|cm|mm|in|pt|pc)?\\\\b\",\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\s*(?=:)\", captureGroup: 1, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_-][A-Za-z0-9_-]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: [])\n                ]\n            )\n\n        case .scss:\n            let css = languageRules(for: .css)\n            return LanguageRules(\n                keywords: css.keywords + [\"@mixin\", \"@include\", \"@extend\", \"@function\", \"@return\", \"@if\", \"@else\", \"@for\", \"@each\", \"@while\"],\n                typePatterns: css.typePatterns,\n                stringPatterns: css.stringPatterns,\n                stringRegexOptions: css.stringRegexOptions,\n                commentPatterns: [\"/\\\\*[\\\\s\\\\S]*?\\\\*/\", \"//[^\\\\n]*\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: css.numberPattern,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: css.functionPatterns\n            )\n\n        case .json:\n            return LanguageRules(\n                keywords: [\"true\", \"false\", \"null\"],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"//[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .yaml:\n            return LanguageRules(\n                keywords: [\"true\", \"false\", \"null\", \"yes\", \"no\", \"on\", \"off\"],\n                typePatterns: [\n                    CapturePattern(pattern: \"([&*][A-Za-z0-9_-]+)\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"^\\\\s*([A-Za-z0-9_-]+)\\\\s*:(?=\\\\s|$)\", captureGroup: 1, options: [.anchorsMatchLines])\n                ]\n            )\n\n        case .sql:\n            return LanguageRules(\n                keywords: [\n                    \"select\", \"from\", \"where\", \"group\", \"by\", \"having\", \"order\", \"limit\", \"offset\",\n                    \"insert\", \"into\", \"values\", \"update\", \"set\", \"delete\",\n                    \"join\", \"inner\", \"left\", \"right\", \"full\", \"outer\", \"cross\", \"on\",\n                    \"as\", \"distinct\", \"union\", \"all\", \"and\", \"or\", \"not\", \"null\", \"is\", \"in\", \"exists\", \"like\", \"between\",\n                    \"create\", \"alter\", \"drop\", \"table\", \"view\", \"index\", \"primary\", \"key\", \"foreign\", \"references\",\n                    \"case\", \"when\", \"then\", \"else\", \"end\",\n                    \"begin\", \"commit\", \"rollback\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|integer|smallint|bigint|serial|bigserial|decimal|numeric|real|double|float|money|boolean|bool|date|time|timestamp|timestamptz|varchar|char|text|uuid|json|jsonb)\\\\b\", captureGroup: nil, options: [.caseInsensitive])\n                ],\n                stringPatterns: [\"'(?:''|[^'])*'\", \"\\\"(?:\\\"\\\"|[^\\\"])*\\\"\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"--[^\\\\n]*\", \"/\\\\*[\\\\s\\\\S]*?\\\\*/\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?=\\\\()\", captureGroup: 1, options: [.caseInsensitive])\n                ]\n            )\n\n        case .shell:\n            return LanguageRules(\n                keywords: [\n                    \"if\", \"then\", \"elif\", \"else\", \"fi\", \"for\", \"in\", \"do\", \"done\", \"case\", \"esac\", \"while\", \"until\",\n                    \"select\", \"function\", \"time\", \"coproc\", \"break\", \"continue\", \"return\", \"exit\", \"export\", \"readonly\",\n                    \"local\", \"declare\", \"typeset\", \"unset\", \"shift\", \"trap\", \"set\"\n                ],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'[^'\\\\n]*'\", \"\\\\$'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\b([A-Za-z_][A-Za-z0-9_]*)\\\\s*\\\\(\\\\s*\\\\)\\\\s*\\\\{\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .dockerfile:\n            return LanguageRules(\n                keywords: [\n                    \"FROM\", \"RUN\", \"CMD\", \"LABEL\", \"MAINTAINER\", \"EXPOSE\", \"ENV\", \"ADD\", \"COPY\", \"ENTRYPOINT\",\n                    \"VOLUME\", \"USER\", \"WORKDIR\", \"ARG\", \"ONBUILD\", \"STOPSIGNAL\", \"HEALTHCHECK\", \"SHELL\"\n                ],\n                typePatterns: [],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [.caseInsensitive],\n                functionPatterns: []\n            )\n\n        case .graphql:\n            return LanguageRules(\n                keywords: [\n                    \"query\", \"mutation\", \"subscription\", \"fragment\", \"on\",\n                    \"schema\", \"type\", \"interface\", \"union\", \"enum\", \"input\", \"extend\", \"directive\", \"implements\",\n                    \"scalar\", \"true\", \"false\", \"null\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:Int|Float|String|Boolean|ID)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: [\"\\\"\\\"\\\"[\\\\s\\\\S]*?\\\"\\\"\\\"\", \"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\"],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .markdown:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [],\n                stringPatterns: [\n                    \"```[\\\\s\\\\S]*?```\",\n                    \"~~~[\\\\s\\\\S]*?~~~\",\n                    \"`[^`\\\\n]+`\"\n                ],\n                stringRegexOptions: [.dotMatchesLineSeparators],\n                commentPatterns: [\"<!--[\\\\s\\\\S]*?-->\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: nil,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .php:\n            return LanguageRules(\n                keywords: [\n                    \"abstract\", \"and\", \"array\", \"as\", \"break\", \"callable\", \"case\", \"catch\", \"class\", \"clone\",\n                    \"const\", \"continue\", \"declare\", \"default\", \"die\", \"do\", \"echo\", \"else\", \"elseif\", \"empty\",\n                    \"enddeclare\", \"endfor\", \"endforeach\", \"endif\", \"endswitch\", \"endwhile\", \"enum\", \"eval\", \"exit\",\n                    \"extends\", \"final\", \"finally\", \"fn\", \"for\", \"foreach\", \"function\", \"global\", \"goto\", \"if\",\n                    \"implements\", \"include\", \"include_once\", \"instanceof\", \"insteadof\", \"interface\", \"isset\",\n                    \"list\", \"match\", \"namespace\", \"new\", \"or\", \"print\", \"private\", \"protected\", \"public\", \"readonly\",\n                    \"require\", \"require_once\", \"return\", \"static\", \"switch\", \"throw\", \"trait\", \"try\", \"unset\", \"use\",\n                    \"var\", \"while\", \"xor\", \"yield\", \"true\", \"false\", \"null\"\n                ],\n                typePatterns: [\n                    CapturePattern(pattern: \"\\\\b(?:int|float|string|bool|array|object|callable|iterable|mixed|void|never)\\\\b\", captureGroup: nil, options: []),\n                    CapturePattern(pattern: \"\\\\b([A-Z][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: [])\n                ],\n                stringPatterns: cLikeStrings,\n                stringRegexOptions: [],\n                commentPatterns: cLikeComments + [\"#[^\\\\n]*\"],\n                commentRegexOptions: [.dotMatchesLineSeparators],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: [\n                    CapturePattern(pattern: \"\\\\bfunction\\\\s+([A-Za-z_][A-Za-z0-9_]*)\\\\b\", captureGroup: 1, options: []),\n                    commonFunctionCall\n                ]\n            )\n\n        case .dotenv:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [\n                    // Keys in KEY=value or export KEY=value\n                    CapturePattern(\n                        pattern: \"^\\\\s*(?:export\\\\s+)?([A-Za-z_][A-Za-z0-9_]*)\\\\s*(?==)\",\n                        captureGroup: 1,\n                        options: [.anchorsMatchLines]\n                    )\n                ],\n                stringPatterns: [\"\\\"(?:[^\\\"\\\\\\\\\\\\n]|\\\\\\\\.)*\\\"\", \"'(?:[^'\\\\\\\\\\\\n]|\\\\\\\\.)*'\"],\n                stringRegexOptions: [],\n                commentPatterns: [\"#[^\\\\n]*\"],\n                commentRegexOptions: [],\n                numberPattern: commonNumber,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n\n        case .plainText:\n            return LanguageRules(\n                keywords: [],\n                typePatterns: [],\n                stringPatterns: [],\n                stringRegexOptions: [],\n                commentPatterns: [],\n                commentRegexOptions: [],\n                numberPattern: nil,\n                numberRegexOptions: [],\n                keywordRegexOptions: [],\n                functionPatterns: []\n            )\n        }\n    }\n\n    // MARK: - Regex application helpers\n\n    @discardableResult\n    private static func applyHighlighting(\n        pattern: String,\n        options: NSRegularExpression.Options,\n        color: UIColor,\n        to attributedString: NSMutableAttributedString,\n        in text: String,\n        captureGroup: Int?,\n        excluding excludedRanges: [NSRange]\n    ) -> [NSRange] {\n        do {\n            let regex = try NSRegularExpression(pattern: pattern, options: options)\n            let matches = regex.matches(in: text, options: [], range: NSRange(location: 0, length: text.utf16.count))\n\n            var applied: [NSRange] = []\n            applied.reserveCapacity(matches.count)\n\n            for match in matches {\n                let range: NSRange = {\n                    if let captureGroup, captureGroup <= match.numberOfRanges - 1 {\n                        return match.range(at: captureGroup)\n                    }\n                    return match.range\n                }()\n\n                guard range.location != NSNotFound, range.length > 0 else { continue }\n                if intersectsAny(range, excludedRanges) { continue }\n\n                attributedString.addAttribute(.foregroundColor, value: color, range: range)\n                applied.append(range)\n            }\n\n            return applied\n        } catch {\n            print(\"Regex error for pattern \\(pattern): \\(error)\")\n            return []\n        }\n    }\n\n    private static func intersectsAny(_ range: NSRange, _ excludedRanges: [NSRange]) -> Bool {\n        for ex in excludedRanges where NSIntersectionRange(range, ex).length > 0 {\n            return true\n        }\n        return false\n    }\n}\n\n// SwiftUI wrapper for NSAttributedString\nstruct AttributedTextView: UIViewRepresentable {\n    let attributedText: NSAttributedString\n\n    func makeUIView(context: Context) -> UITextView {\n        let textView = UITextView()\n        textView.isEditable = false\n        textView.isSelectable = true\n        textView.backgroundColor = .clear\n        textView.textContainerInset = UIEdgeInsets(top: 8, left: 8, bottom: 8, right: 8)\n        return textView\n    }\n\n    func updateUIView(_ uiView: UITextView, context: Context) {\n        uiView.attributedText = attributedText\n    }\n}\n\n// Extension to make it easy to use in SwiftUI\nextension View {\n    func syntaxHighlighted(\n        code: String,\n        filename: String? = nil,\n        language: NSAttributedStringSyntaxHighlighter.SyntaxLanguage? = nil\n    ) -> some View {\n        AttributedTextView(attributedText: NSAttributedStringSyntaxHighlighter.highlightCode(code, filename: filename, language: language))\n    }\n}\n"} 
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":1,"end_line":80}
>>>END

>>>TOOL search
{"query":"commonFunctionCall", "glob":"Extensions/NSAttributedStringSyntaxHighlighter.swift"}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":235,"end_line":260}
>>>END>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":240,"end_line":256}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":900,"end_line":993}
>>>END

>>>TOOL read_file
{"path":"Extensions/NSAttributedStringSyntaxHighlighter.swift","start_line":250,"end_line":520}
>>>ENDNow I have enough to report.>>>REPORT
Work performed in: Extensions/NSAttributedStringSyntaxHighlighter.swift

1) Updated color scheme to VS Code Dark+ hex colors
- Verified in file lines 6-12 (comment mapping) and lines 42-50 (ColorScheme):
  - keyword: #569CD6
  - type: #4EC9B0
  - string: #CE9178
  - comment: #6A9955
  - number: #B5CEA8
  - function: #DCDCAA
  - defaultText: #D4D4D4
- Implemented a small UIColor initializer for hex -> UIColor (lines 33-39).

2) Implemented/tuned regex patterns specifically for Swift, JS/TS, Python
- Common function call pattern fixed/defined as:
  pattern: "\\b([A-Za-z_][A-Za-z0-9_]*)\\s*(?=\\()"
  Evidence: lines 245-250.
- Swift rules (evidence: around lines 254+):
  - Numbers: supports 0x hex (incl hex float p/P exponent), 0b, 0o, decimal, float, exponent (swiftNumber).
  - Strings: supports triple-quoted with optional raw # delimiters, plus raw/normal quoted strings (swiftStrings).
  - Comments: // and /* */ (cLikeComments).
  - Keywords/types/function patterns retained and applied via pipeline.
- JavaScript rules (evidence: around lines 314+):
  - Numbers: includes 0x/0b/0o, decimal/float/exponent, and BigInt suffix `n` (jsNumber).
  - Strings: "..." '...' and template literals with ${...} interpolation.
  - Comments: // and /* */.
- TypeScript rules (evidence: around lines 355+):
  - Numbers: same as JS (tsNumber).
  - Types: primitive TS types + UpperCamelCase identifiers.
  - Strings/comments: same as JS.
- Python rules (evidence: around lines 400+):
  - Numbers: bases (0x/0b/0o), decimal/float/exponent, leading-dot floats, optional complex suffix j/J (pyNumber).
  - Strings: triple-quoted and single-line with optional prefixes (r/u/f/fr/rf/b/br/rb), case-insensitive.
  - Comments: #... to end of line.
  - Function defs: def <name> pattern plus common function-call highlighting.

3) Preserved the existing highlighting pipeline order
- Strings -> comments (excluding strings) -> numbers -> types -> keywords -> functions.
  Evidence: highlight(...) pipeline in lines ~145-223 (seen earlier) and applyHighlighting helper at lines 918-955 (from lines 916+ in file).

Note: Only Extensions/NSAttributedStringSyntaxHighlighter.swift was modified (as required). The file currently contains full implementation plus SwiftUI wrapper at lines 965-992.
>>>END
