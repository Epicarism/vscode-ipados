import Foundation
import SwiftUI

// MARK: - Execution Target

enum ExecutionTarget {
    case onDevice
    case remote
}

// MARK: - Supported Languages

/// Languages the app knows how to route to an execution backend.
///
/// - Note: On-device execution is currently supported for **JavaScript only**.
///         Other languages (python, swift, go, rust, etc.) are **remote-only**.
enum SupportedLanguage: String, CaseIterable, Sendable {
    // On-device supported
    case javascript = "javascript"

    // Remote-only (via SSH RemoteRunner)
    case swift = "swift"
    case python = "python"
    case python3 = "python3"
    case node = "node"
    case typescript = "typescript"
    case ruby = "ruby"
    case bash = "bash"
    case sh = "sh"
    case zsh = "zsh"
    case php = "php"
    case go = "go"
    case rust = "rust"
    case java = "java"
    case kotlin = "kotlin"
    case cpp = "c++"
    case c = "c"
    case csharp = "csharp"
    case perl = "perl"
    case lua = "lua"
    case r = "r"
    case objc = "objc"

    static let onDeviceSupported: Set<SupportedLanguage> = [.javascript]
    static let remoteOnly: Set<SupportedLanguage> = Set(Self.allCases).subtracting(Self.onDeviceSupported)
}

// MARK: - RunnerSelector

@MainActor
final class RunnerSelector: ObservableObject {

    private let remoteRunner: RemoteRunner = RemoteRunner()

    /// Returns `true` iff the language can run on-device.
    ///
    /// - Important: Only **javascript** is supported on-device.
    func canRunOnDevice(language: String) -> Bool {
        let normalized = normalize(language)
        return normalized == SupportedLanguage.javascript.rawValue
    }

    /// Selects which execution target should be used for a file.
    func selectRunner(for file: String, preferOnDevice: Bool) -> ExecutionTarget {
        guard preferOnDevice else { return .remote }

        if let language = languageForFile(file) {
            return canRunOnDevice(language: language.rawValue) ? .onDevice : .remote
        }

        return .remote
    }

    /// Returns an on-device runner for the provided language if available.
    ///
    /// - Note: On-device is currently **JavaScript only**.
    func getOnDeviceRunner(for language: String) -> (any CodeRunner)? {
        guard canRunOnDevice(language: language) else { return nil }
        // Current on-device implementation uses the JS mock runner which conforms to the shared CodeRunner protocol.
        return MockJSRunner()
    }

    /// Returns the shared remote runner.
    func getRemoteRunner() -> RemoteRunner {
        remoteRunner
    }

    // MARK: - Helpers

    private func normalize(_ language: String) -> String {
        let trimmed = language.trimmingCharacters(in: .whitespacesAndNewlines).lowercased()
        switch trimmed {
        case "js", "mjs", "cjs", "node", "nodejs":
            return "javascript"
        default:
            return trimmed
        }
    }

    private func languageForFile(_ file: String) -> SupportedLanguage? {
        let ext = (file as NSString).pathExtension.lowercased()
        switch ext {
        case "js", "mjs", "cjs":
            return .javascript
        case "ts", "tsx":
            return .typescript
        case "py", "pyw", "pyi":
            return .python
        case "swift":
            return .swift
        case "go":
            return .go
        case "rs":
            return .rust
        case "rb":
            return .ruby
        case "sh":
            return .bash
        case "zsh":
            return .zsh
        case "php":
            return .php
        case "java":
            return .java
        case "kt":
            return .kotlin
        case "cpp", "cc", "cxx", "hpp", "hh":
            return .cpp
        case "c", "h":
            return .c
        case "cs":
            return .csharp
        case "pl", "pm":
            return .perl
        case "lua":
            return .lua
        case "r":
            return .r
        case "m", "mm":
            return .objc
        default:
            return nil
        }
    }
}
