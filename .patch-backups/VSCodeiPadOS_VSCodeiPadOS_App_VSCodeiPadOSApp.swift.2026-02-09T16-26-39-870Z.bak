import SwiftUI

@main
struct VSCodeiPadOSApp: App {
    @UIApplicationDelegateAdaptor(AppDelegate.self) var appDelegate
    @StateObject private var editorCore = EditorCore()
    @State private var showSettings = false
    @State private var showTerminal = false
    @State private var windowTitle: String = "VS Code"
    
    var body: some Scene {
        WindowGroup {
            ContentView()
                .environmentObject(editorCore)
                .focusedSceneValue(\.menuEditorCore, editorCore)
                .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("WindowTitleDidChange"))) { notification in
                    if let userInfo = notification.userInfo,
                       let title = userInfo["title"] as? String {
                        windowTitle = title
                        updateWindowTitle(title)
                    }
                }
        }
        .commands {
            // VS Code-style menu bar
            FileMenuCommands()
            EditMenuCommands()
            SelectionMenuCommands(editorCore: editorCore)
            ViewMenuCommands()
            GoMenuCommands()
            RunMenuCommands(editorCore: editorCore)
            TerminalMenuCommands()
            HelpMenuCommands()
        }
    }
    
    private func updateWindowTitle(_ title: String) {
        // Update the window title for the scene
        if let windowScene = UIApplication.shared.connectedScenes.first as? UIWindowScene {
            windowScene.title = title
        }
    }
}

struct FileMenuCommands: Commands {
    var body: some Commands {
        CommandMenu("File") {
            Button("New Window") {
                WindowStateManager.shared.requestNewWindow()
            }
            .keyboardShortcut("n", modifiers: [.command, .shift])
            
            Divider()
        }
    }
}

class AppDelegate: NSObject, UIApplicationDelegate {
    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey : Any]? = nil) -> Bool {
        // Set up notification observer for window title changes
        NotificationCenter.default.addObserver(
            forName: NSNotification.Name("WindowTitleDidChange"),
            object: nil,
            queue: .main
        ) { notification in
            if let userInfo = notification.userInfo,
               let title = userInfo["title"] as? String {
                self.updateWindowSceneTitle(title)
            }
        }
        return true
    }
    
    private func updateWindowSceneTitle(_ title: String) {
        // Update the title for all connected window scenes
        UIApplication.shared.connectedScenes.forEach { scene in
            if let windowScene = scene as? UIWindowScene {
                // For iPadOS, we can use the title property to update the window title
                // This affects the window switcher and tab titles
                DispatchQueue.main.async {
                    windowScene.title = title
                }
            }
        }
    }
}
