//
//  AppCommands.swift
//  VSCodeiPadOS
//
//  Defines keyboard commands and menu structure for the app
//

import SwiftUI

// MARK: - App Commands Protocol

@objc protocol AppCommandsProtocol {
    @objc func newFile()
    @objc func openFile()
    @objc func saveFile()
    @objc func saveAllFiles()
    @objc func closeFile()
    @objc func toggleSidebar()
    @objc func toggleTerminal()
    @objc func showCommandPalette()
    @objc func showQuickOpen()
    @objc func showGoToSymbol()
    @objc func showGoToLine()
    @objc func showFind()
    @objc func nextTab()
    @objc func previousTab()
    @objc func toggleAIAssistant()
    @objc func showSettings()
}

// MARK: - App Commands (Menu Bar + Keyboard Shortcuts)

struct AppCommands: Commands {
    @ObservedObject var editorCore: EditorCore
    @Binding var showSettings: Bool
    @Binding var showTerminal: Bool
    
    var body: some Commands {
        // File Menu
        CommandGroup(replacing: .newItem) {
            Button("New File") {
                editorCore.addTab()
            }
            .keyboardShortcut("n", modifiers: .command)
            
            Button("Open File...") {
                editorCore.showFilePicker = true
            }
            .keyboardShortcut("o", modifiers: .command)
            
            Divider()
            
            Button("Save") {
                editorCore.saveActiveTab()
            }
            .keyboardShortcut("s", modifiers: .command)
            
            Button("Save All") {
                editorCore.saveAllTabs()
            }
            .keyboardShortcut("s", modifiers: [.command, .option])
            
            Divider()
            
            Button("Close Editor") {
                if let id = editorCore.activeTabId {
                    editorCore.closeTab(id: id)
                }
            }
            .keyboardShortcut("w", modifiers: .command)
            
            Button("Close All Editors") {
                editorCore.closeAllTabs()
            }
            .keyboardShortcut("w", modifiers: [.command, .option, .shift])
        }
        
        // Edit Menu
        CommandGroup(after: .pasteboard) {
            Divider()
            
            Button("Find") {
                editorCore.showSearch = true
            }
            .keyboardShortcut("f", modifiers: .command)
            
            Button("Find in Files") {
                // TODO: Global search
            }
            .keyboardShortcut("f", modifiers: [.command, .shift])
            
            Button("Replace") {
                editorCore.showSearch = true
            }
            .keyboardShortcut("h", modifiers: [.command, .option])
        }
        
        // View Menu
        CommandGroup(after: .sidebar) {
            Button("Toggle Sidebar") {
                editorCore.toggleSidebar()
            }
            .keyboardShortcut("b", modifiers: .command)
            
            Button("Toggle Terminal") {
                showTerminal.toggle()
            }
            .keyboardShortcut("`", modifiers: .command)
            
            Divider()
            
            Button("Command Palette...") {
                editorCore.showCommandPalette = true
            }
            .keyboardShortcut("p", modifiers: [.command, .shift])
            
            Button("Quick Open...") {
                editorCore.showQuickOpen = true
            }
            .keyboardShortcut("p", modifiers: .command)
        }
        
        // Go Menu
        CommandMenu("Go") {
            Button("Go to File...") {
                editorCore.showQuickOpen = true
            }
            .keyboardShortcut("p", modifiers: .command)
            
            Button("Go to Symbol...") {
                editorCore.showGoToSymbol = true
            }
            .keyboardShortcut("o", modifiers: [.command, .shift])
            
            Button("Go to Line...") {
                editorCore.showGoToLine = true
            }
            .keyboardShortcut("g", modifiers: .command)
            
            Divider()
            
            Button("Go to Definition") {
                editorCore.goToDefinitionAtCursor()
            }
            .keyboardShortcut(.f12)
            
            Button("Peek Definition") {
                editorCore.peekDefinitionAtCursor()
            }
            .keyboardShortcut(.f12, modifiers: .option)
            
            Divider()
            
            Button("Go Back") {
                editorCore.navigateBack()
            }
            .keyboardShortcut("-", modifiers: .control)
            
            Button("Go Forward") {
                editorCore.navigateForward()
            }
            .keyboardShortcut("-", modifiers: [.control, .shift])
            
            Divider()
            
            Button("Next Editor") {
                editorCore.nextTab()
            }
            .keyboardShortcut("]", modifiers: [.command, .shift])
            
            Button("Previous Editor") {
                editorCore.previousTab()
            }
            .keyboardShortcut("[", modifiers: [.command, .shift])
        }
        
        // Help Menu
        CommandGroup(replacing: .help) {
            Button("AI Assistant") {
                editorCore.showAIAssistant = true
            }
            .keyboardShortcut("a", modifiers: [.command, .shift])
            
            Divider()
            
            Button("Settings") {
                showSettings = true
            }
            .keyboardShortcut(",", modifiers: .command)
        }
    }
}

// MARK: - Keyboard Shortcut Definitions

enum KeyboardShortcuts {
    // File
    static let newFile = KeyboardShortcut("n", modifiers: .command)
    static let openFile = KeyboardShortcut("o", modifiers: .command)
    static let save = KeyboardShortcut("s", modifiers: .command)
    static let saveAll = KeyboardShortcut("s", modifiers: [.command, .option])
    static let closeEditor = KeyboardShortcut("w", modifiers: .command)
    
    // Edit
    static let find = KeyboardShortcut("f", modifiers: .command)
    static let replace = KeyboardShortcut("h", modifiers: [.command, .option])
    static let findInFiles = KeyboardShortcut("f", modifiers: [.command, .shift])
    
    // View
    static let toggleSidebar = KeyboardShortcut("b", modifiers: .command)
    static let toggleTerminal = KeyboardShortcut("`", modifiers: .command)
    static let commandPalette = KeyboardShortcut("p", modifiers: [.command, .shift])
    static let quickOpen = KeyboardShortcut("p", modifiers: .command)
    
    // Go
    static let goToSymbol = KeyboardShortcut("o", modifiers: [.command, .shift])
    static let goToLine = KeyboardShortcut("g", modifiers: .command)
    static let goToDefinition = KeyboardShortcut(.f12)
    static let peekDefinition = KeyboardShortcut(.f12, modifiers: .option)
    static let goBack = KeyboardShortcut("-", modifiers: .control)
    static let goForward = KeyboardShortcut("-", modifiers: [.control, .shift])
    static let nextEditor = KeyboardShortcut("]", modifiers: [.command, .shift])
    static let previousEditor = KeyboardShortcut("[", modifiers: [.command, .shift])
    
    // Help
    static let aiAssistant = KeyboardShortcut("a", modifiers: [.command, .shift])
    static let settings = KeyboardShortcut(",", modifiers: .command)
}

// MARK: - Shortcut Display Helper

extension KeyboardShortcut {
    /// Returns a human-readable string representation of the shortcut
    var displayString: String {
        var parts: [String] = []
        
        if modifiers.contains(.command) { parts.append("⌘") }
        if modifiers.contains(.shift) { parts.append("⇧") }
        if modifiers.contains(.option) { parts.append("⌥") }
        if modifiers.contains(.control) { parts.append("⌃") }
        
        // Convert key to display string
        let keyString: String
        switch key {
        case .return: keyString = "↵"
        case .tab: keyString = "⇥"
        case .space: keyString = "␣"
        case .delete: keyString = "⌫"
        case .escape: keyString = "⎋"
        case .upArrow: keyString = "↑"
        case .downArrow: keyString = "↓"
        case .leftArrow: keyString = "←"
        case .rightArrow: keyString = "→"
        default:
            keyString = String(key.character).uppercased()
        }
        
        parts.append(keyString)
        return parts.joined()
    }
}
