//
//  SyntaxHighlightingTextView.swift
//  VSCodeiPadOS
//
//  Upgraded syntax highlighting with VSCode-like colors
//

import SwiftUI
import UIKit

/// UITextView wrapper with syntax highlighting support
struct SyntaxHighlightingTextView: UIViewRepresentable {
    @Binding var text: String
    let filename: String
    @Binding var scrollPosition: Int
    @Binding var totalLines: Int
    @Binding var visibleLines: Int
    @Binding var currentLineNumber: Int
    @Binding var currentColumn: Int
    @Binding var lineHeight: CGFloat
    let isActive: Bool
    @ObservedObject var editorCore: EditorCore
    
    func makeCoordinator() -> Coordinator {
        Coordinator(self)
    }
    
    func makeUIView(context: Context) -> MultiCursorTextView {
        let textView = MultiCursorTextView()
        textView.delegate = context.coordinator
        textView.editorCore = editorCore
        
        // Configure text view
        textView.isEditable = true
        textView.isSelectable = true
        textView.autocapitalizationType = .none
        textView.autocorrectionType = .no
        textView.smartDashesType = .no
        textView.smartQuotesType = .no
        textView.smartInsertDeleteType = .no
        textView.spellCheckingType = .no
        
        // Set font and appearance
        textView.font = UIFont.monospacedSystemFont(ofSize: 14, weight: .regular)
        textView.textColor = .label
        textView.backgroundColor = UIColor.systemBackground
        textView.keyboardType = .default
        textView.textContainerInset = UIEdgeInsets(top: 8, left: 8, bottom: 8, right: 8)
        
        // Enable line wrapping
        textView.textContainer.lineBreakMode = .byCharWrapping
        textView.textContainer.widthTracksTextView = true
        
        // Calculate line height
        if let font = textView.font {
            DispatchQueue.main.async {
                self.lineHeight = font.lineHeight
            }
        }
        
        // Set initial text with syntax highlighting
        textView.text = text
        context.coordinator.applySyntaxHighlighting(to: textView)
        context.coordinator.updateLineCount(textView)
        
        // Add Option+Click gesture for adding cursors
        let optionClickGesture = UITapGestureRecognizer(target: context.coordinator, action: #selector(Coordinator.handleOptionClick(_:)))
        optionClickGesture.numberOfTapsRequired = 1
        optionClickGesture.allowedTouchTypes = [UITouch.TouchType.indirectPointer.rawValue as NSNumber]
        textView.addGestureRecognizer(optionClickGesture)
        context.coordinator.optionClickGesture = optionClickGesture
        
        return textView
    }
    
    func updateUIView(_ textView: MultiCursorTextView, context: Context) {
        // Update text if changed externally
        if textView.text != text {
            let selectedRange = textView.selectedRange
            textView.text = text
            context.coordinator.applySyntaxHighlighting(to: textView)
            textView.selectedRange = selectedRange
        }
        
        // Handle minimap scrolling
        if scrollPosition != context.coordinator.lastKnownScrollPosition && scrollPosition >= 0 {
            context.coordinator.scrollToLine(scrollPosition, in: textView)
        }
        
        context.coordinator.updateLineCount(textView)
        
        // Update multi-cursor display
        textView.updateCursorDisplay()
    }
    
    // MARK: - Coordinator
    
    class Coordinator: NSObject, UITextViewDelegate {
        var parent: SyntaxHighlightingTextView
        var lastKnownScrollPosition: Int = 0
        private var isUpdatingFromMinimap = false
        private var highlightDebouncer: Timer?
        
        init(_ parent: SyntaxHighlightingTextView) {
            self.parent = parent
        }
        
        func textViewDidChange(_ textView: UITextView) {
            // Update parent text
            parent.text = textView.text
            
            // Debounced syntax highlighting for performance
            highlightDebouncer?.invalidate()
            highlightDebouncer = Timer.scheduledTimer(withTimeInterval: 0.15, repeats: false) { [weak self] _ in
                DispatchQueue.main.async {
                    self?.applySyntaxHighlighting(to: textView)
                }
            }
            
            updateLineCount(textView)
            updateCursorPosition(textView)
        }
        
        func textViewDidChangeSelection(_ textView: UITextView) {
            if !isUpdatingFromMinimap {
                updateCursorPosition(textView)
                updateScrollPosition(textView)
            }
        }
        
        func scrollViewDidScroll(_ scrollView: UIScrollView) {
            guard let textView = scrollView as? UITextView, !isUpdatingFromMinimap else { return }
            updateScrollPosition(textView)
        }
        
        func updateLineCount(_ textView: UITextView) {
            let lines = textView.text.components(separatedBy: .newlines)
            DispatchQueue.main.async {
                self.parent.totalLines = max(1, lines.count)
            }
        }
        
        func updateCursorPosition(_ textView: UITextView) {
            guard let selectedRange = textView.selectedTextRange else { return }
            let cursorPosition = textView.offset(from: textView.beginningOfDocument, to: selectedRange.start)
            
            let text = textView.text ?? ""
            let prefix = String(text.prefix(cursorPosition))
            let lines = prefix.components(separatedBy: .newlines)
            
            let lineNumber = lines.count
            let column = (lines.last?.count ?? 0) + 1
            
            DispatchQueue.main.async {
                self.parent.currentLineNumber = lineNumber
                self.parent.currentColumn = column
            }
        }
        
        func updateScrollPosition(_ textView: UITextView) {
            guard let font = textView.font else { return }
            let lineHeight = font.lineHeight
            let scrollOffset = textView.contentOffset.y
            let line = Int(scrollOffset / lineHeight)
            
            lastKnownScrollPosition = line
            DispatchQueue.main.async {
                self.parent.scrollPosition = line
            }
        }
        
        func scrollToLine(_ line: Int, in textView: UITextView) {
            guard !isUpdatingFromMinimap else { return }
            isUpdatingFromMinimap = true
            
            let lines = textView.text.components(separatedBy: .newlines)
            guard line >= 0 && line < lines.count else {
                isUpdatingFromMinimap = false
                return
            }
            
            var characterPosition = 0
            for i in 0..<line {
                characterPosition += lines[i].count + 1
            }
            
            if let position = textView.position(from: textView.beginningOfDocument, offset: characterPosition) {
                let rect = textView.caretRect(for: position)
                let targetY = max(0, rect.origin.y)
                textView.setContentOffset(CGPoint(x: 0, y: targetY), animated: true)
            }
            
            DispatchQueue.main.asyncAfter(deadline: .now() + 0.3) {
                self.isUpdatingFromMinimap = false
            }
        }
        
        func applySyntaxHighlighting(to textView: UITextView) {
            let highlighter = VSCodeSyntaxHighlighter()
            let attributedText = highlighter.highlight(textView.text, filename: parent.filename)
            
            let selectedRange = textView.selectedRange
            textView.attributedText = attributedText
            textView.selectedRange = selectedRange
        }
    }
}

// MARK: - VSCode-Style Syntax Highlighter

enum Language {
    case swift, javascript, typescript, python, html, css, json, markdown, rust, go, java, cpp, ruby, php, shell, yaml, xml, sql, plainText
}

/// VSCode Dark+ inspired color theme
struct VSCodeTheme {
    // Dark+ Theme Colors
    static let keyword = UIColor(red: 0.78, green: 0.47, blue: 0.81, alpha: 1.0)      // #C586C0 - Purple/Pink
    static let controlFlow = UIColor(red: 0.78, green: 0.47, blue: 0.81, alpha: 1.0)  // #C586C0
    static let string = UIColor(red: 0.81, green: 0.54, blue: 0.44, alpha: 1.0)       // #CE9178 - Orange/Brown
    static let number = UIColor(red: 0.71, green: 0.81, blue: 0.65, alpha: 1.0)       // #B5CEA8 - Light Green
    static let comment = UIColor(red: 0.42, green: 0.55, blue: 0.35, alpha: 1.0)      // #6A9955 - Green
    static let function = UIColor(red: 0.86, green: 0.86, blue: 0.67, alpha: 1.0)     // #DCDCAA - Yellow
    static let type = UIColor(red: 0.31, green: 0.79, blue: 0.69, alpha: 1.0)         // #4EC9B0 - Teal
    static let variable = UIColor(red: 0.61, green: 0.82, blue: 0.98, alpha: 1.0)     // #9CDCFE - Light Blue
    static let parameter = UIColor(red: 0.61, green: 0.82, blue: 0.98, alpha: 1.0)    // #9CDCFE
    static let property = UIColor(red: 0.61, green: 0.82, blue: 0.98, alpha: 1.0)     // #9CDCFE
    static let `operator` = UIColor.label                                              // Default
    static let bracket = UIColor(red: 0.85, green: 0.85, blue: 0.00, alpha: 1.0)      // Gold brackets
    static let tag = UIColor(red: 0.34, green: 0.61, blue: 0.84, alpha: 1.0)          // #569CD6 - Blue
    static let attribute = UIColor(red: 0.61, green: 0.82, blue: 0.98, alpha: 1.0)    // #9CDCFE
    static let constant = UIColor(red: 0.34, green: 0.61, blue: 0.84, alpha: 1.0)     // #569CD6 - Blue
    static let decorator = UIColor(red: 0.86, green: 0.86, blue: 0.67, alpha: 1.0)    // #DCDCAA
    static let regex = UIColor(red: 0.82, green: 0.44, blue: 0.44, alpha: 1.0)        // #D16969 - Red
    static let escape = UIColor(red: 0.82, green: 0.86, blue: 0.67, alpha: 1.0)       // #D7BA7D - Gold
}

struct VSCodeSyntaxHighlighter {
    private let baseFontSize: CGFloat = 14
    
    func highlight(_ text: String, filename: String) -> NSAttributedString {
        let language = detectLanguage(from: filename)
        return highlight(text, language: language)
    }
    
    private func detectLanguage(from filename: String) -> Language {
        let ext = (filename as NSString).pathExtension.lowercased()
        switch ext {
        case "swift": return .swift
        case "js", "jsx", "mjs": return .javascript
        case "ts", "tsx": return .typescript
        case "py", "pyw": return .python
        case "html", "htm": return .html
        case "css", "scss", "sass", "less": return .css
        case "json", "jsonc": return .json
        case "md", "markdown": return .markdown
        case "rs": return .rust
        case "go": return .go
        case "java": return .java
        case "c", "cpp", "cc", "cxx", "h", "hpp": return .cpp
        case "rb", "ruby": return .ruby
        case "php": return .php
        case "sh", "bash", "zsh", "fish": return .shell
        case "yml", "yaml": return .yaml
        case "xml", "plist", "svg": return .xml
        case "sql": return .sql
        default: return .plainText
        }
    }
    
    private func highlight(_ text: String, language: Language) -> NSAttributedString {
        let attributed = NSMutableAttributedString(string: text)
        let fullRange = NSRange(location: 0, length: text.utf16.count)
        
        // Base attributes
        let baseFont = UIFont.monospacedSystemFont(ofSize: baseFontSize, weight: .regular)
        attributed.addAttribute(.font, value: baseFont, range: fullRange)
        attributed.addAttribute(.foregroundColor, value: UIColor.label, range: fullRange)
        
        // Apply language-specific highlighting
        switch language {
        case .swift: highlightSwift(attributed, text: text)
        case .javascript, .typescript: highlightJavaScript(attributed, text: text, isTS: language == .typescript)
        case .python: highlightPython(attributed, text: text)
        case .html, .xml: highlightHTML(attributed, text: text)
        case .css: highlightCSS(attributed, text: text)
        case .json: highlightJSON(attributed, text: text)
        case .markdown: highlightMarkdown(attributed, text: text)
        case .rust: highlightRust(attributed, text: text)
        case .go: highlightGo(attributed, text: text)
        case .java: highlightJava(attributed, text: text)
        case .cpp: highlightCpp(attributed, text: text)
        case .ruby: highlightRuby(attributed, text: text)
        case .php: highlightPHP(attributed, text: text)
        case .shell: highlightShell(attributed, text: text)
        case .yaml: highlightYAML(attributed, text: text)
        case .sql: highlightSQL(attributed, text: text)
        case .plainText: break
        }
        
        return attributed
    }
    
    // MARK: - Swift Highlighting
    
    private func highlightSwift(_ attributed: NSMutableAttributedString, text: String) {
        // Keywords (purple/pink)
        let keywords = ["func", "var", "let", "if", "else", "for", "while", "return",
                       "class", "struct", "enum", "protocol", "extension", "import",
                       "private", "public", "internal", "fileprivate", "open",
                       "static", "final", "override", "mutating", "nonmutating",
                       "init", "deinit", "subscript", "typealias", "associatedtype",
                       "where", "throws", "rethrows", "async", "await", "actor",
                       "guard", "defer", "do", "try", "catch", "throw",
                       "switch", "case", "default", "break", "continue", "fallthrough",
                       "in", "is", "as", "inout", "some", "any", "Self",
                       "get", "set", "willSet", "didSet", "lazy", "weak", "unowned",
                       "@State", "@Binding", "@Published", "@ObservedObject", "@StateObject",
                       "@Environment", "@EnvironmentObject", "@ViewBuilder", "@MainActor",
                       "@escaping", "@autoclosure", "@available", "@objc", "@discardableResult"]
        highlightKeywords(attributed, keywords: keywords, color: VSCodeTheme.keyword, text: text)
        
        // Types (teal) - CamelCase words that aren't keywords
        let typePattern = "\\b[A-Z][a-zA-Z0-9]*\\b"
        highlightPattern(attributed, pattern: typePattern, color: VSCodeTheme.type, text: text)
        
        // Function calls (yellow)
        let funcCallPattern = "\\b([a-z][a-zA-Z0-9]*)\\s*\\("
        highlightPattern(attributed, pattern: funcCallPattern, color: VSCodeTheme.function, text: text, captureGroup: 1)
        
        // Constants (blue)
        let constants = ["true", "false", "nil", "self", "super"]
        highlightKeywords(attributed, keywords: constants, color: VSCodeTheme.constant, text: text)
        
        // Comments MUST come late (green) - they override everything
        highlightComments(attributed, text: text, singleLine: "//", multiLineStart: "/*", multiLineEnd: "*/")
        
        // Strings AFTER comments (orange) - but comments in strings stay as comments which is wrong
        // We need to be smarter about this...
        highlightStrings(attributed, text: text)
        
        // Numbers (light green)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - JavaScript/TypeScript Highlighting
    
    private func highlightJavaScript(_ attributed: NSMutableAttributedString, text: String, isTS: Bool) {
        var keywords = ["function", "var", "let", "const", "if", "else", "for", "while",
                       "return", "class", "extends", "new", "this", "super", "import",
                       "export", "default", "from", "as", "async", "await", "yield",
                       "try", "catch", "finally", "throw", "typeof", "instanceof",
                       "switch", "case", "break", "continue", "do", "in", "of",
                       "get", "set", "static", "constructor", "delete", "void",
                       "with", "debugger"]
        
        if isTS {
            keywords += ["interface", "type", "enum", "namespace", "module", "declare",
                        "implements", "public", "private", "protected", "readonly",
                        "abstract", "override", "keyof", "infer", "never", "unknown",
                        "any", "asserts", "is"]
        }
        
        highlightKeywords(attributed, keywords: keywords, color: VSCodeTheme.keyword, text: text)
        
        // Constants
        let constants = ["true", "false", "null", "undefined", "NaN", "Infinity"]
        highlightKeywords(attributed, keywords: constants, color: VSCodeTheme.constant, text: text)
        
        // Arrow functions (yellow)
        let arrowPattern = "([a-zA-Z_$][a-zA-Z0-9_$]*)\\s*(?:=>|\\()"
        highlightPattern(attributed, pattern: arrowPattern, color: VSCodeTheme.function, text: text, captureGroup: 1)
        
        // Types (teal)
        let typePattern = "\\b[A-Z][a-zA-Z0-9]*\\b"
        highlightPattern(attributed, pattern: typePattern, color: VSCodeTheme.type, text: text)
        
        highlightComments(attributed, text: text, singleLine: "//", multiLineStart: "/*", multiLineEnd: "*/")
        highlightStrings(attributed, text: text)
        highlightJSTemplateLiterals(attributed, text: text)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - Python Highlighting
    
    private func highlightPython(_ attributed: NSMutableAttributedString, text: String) {
        let keywords = ["def", "class", "if", "elif", "else", "for", "while", "return",
                       "import", "from", "as", "try", "except", "finally", "raise",
                       "with", "assert", "yield", "lambda", "pass", "break", "continue",
                       "global", "nonlocal", "del", "in", "not", "and", "or", "is",
                       "async", "await", "match", "case"]
        highlightKeywords(attributed, keywords: keywords, color: VSCodeTheme.keyword, text: text)
        
        let constants = ["True", "False", "None", "self", "cls"]
        highlightKeywords(attributed, keywords: constants, color: VSCodeTheme.constant, text: text)
        
        // Decorators (yellow)
        let decoratorPattern = "@[a-zA-Z_][a-zA-Z0-9_\\.]*"
        highlightPattern(attributed, pattern: decoratorPattern, color: VSCodeTheme.decorator, text: text)
        
        // Function definitions (yellow)
        let funcDefPattern = "(?<=def\\s)[a-zA-Z_][a-zA-Z0-9_]*"
        highlightPattern(attributed, pattern: funcDefPattern, color: VSCodeTheme.function, text: text)
        
        // Class names (teal)
        let classPattern = "(?<=class\\s)[a-zA-Z_][a-zA-Z0-9_]*"
        highlightPattern(attributed, pattern: classPattern, color: VSCodeTheme.type, text: text)
        
        // Built-in functions (yellow)
        let builtins = ["print", "len", "range", "str", "int", "float", "list", "dict", "set",
                       "tuple", "bool", "type", "isinstance", "hasattr", "getattr", "setattr",
                       "open", "input", "map", "filter", "reduce", "zip", "enumerate",
                       "sorted", "reversed", "min", "max", "sum", "abs", "round",
                       "super", "object", "Exception", "ValueError", "TypeError"]
        highlightKeywords(attributed, keywords: builtins, color: VSCodeTheme.function, text: text)
        
        highlightComments(attributed, text: text, singleLine: "#", multiLineStart: nil, multiLineEnd: nil)
        highlightPythonStrings(attributed, text: text)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - HTML Highlighting
    
    private func highlightHTML(_ attributed: NSMutableAttributedString, text: String) {
        // Tags (blue)
        let tagPattern = "</?\\s*([a-zA-Z][a-zA-Z0-9-]*)(?=[\\s>])"
        highlightPattern(attributed, pattern: tagPattern, color: VSCodeTheme.tag, text: text)
        
        // Attributes (light blue)
        let attrPattern = "\\s([a-zA-Z][a-zA-Z0-9-]*)\\s*="
        highlightPattern(attributed, pattern: attrPattern, color: VSCodeTheme.attribute, text: text, captureGroup: 1)
        
        // Angle brackets
        let bracketPattern = "[<>/?]"
        highlightPattern(attributed, pattern: bracketPattern, color: UIColor.gray, text: text)
        
        // Comments
        highlightHTMLComments(attributed, text: text)
        
        // Strings
        highlightStrings(attributed, text: text)
    }
    
    // MARK: - CSS Highlighting
    
    private func highlightCSS(_ attributed: NSMutableAttributedString, text: String) {
        // Selectors (yellow)
        let selectorPattern = "([.#]?[a-zA-Z][a-zA-Z0-9_-]*)\\s*\\{"
        highlightPattern(attributed, pattern: selectorPattern, color: VSCodeTheme.function, text: text, captureGroup: 1)
        
        // Properties (light blue)
        let propertyPattern = "([a-zA-Z-]+)\\s*:"
        highlightPattern(attributed, pattern: propertyPattern, color: VSCodeTheme.variable, text: text, captureGroup: 1)
        
        // Values with units
        let unitPattern = "\\b(\\d+)(px|em|rem|%|vh|vw|pt|cm|mm|in)\\b"
        highlightPattern(attributed, pattern: unitPattern, color: VSCodeTheme.number, text: text)
        
        // Colors
        let hexPattern = "#[0-9a-fA-F]{3,8}\\b"
        highlightPattern(attributed, pattern: hexPattern, color: VSCodeTheme.number, text: text)
        
        // Keywords
        let keywords = ["important", "inherit", "initial", "unset", "none", "auto",
                       "block", "inline", "flex", "grid", "absolute", "relative", "fixed"]
        highlightKeywords(attributed, keywords: keywords, color: VSCodeTheme.constant, text: text)
        
        highlightComments(attributed, text: text, singleLine: nil, multiLineStart: "/*", multiLineEnd: "*/")
        highlightStrings(attributed, text: text)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - JSON Highlighting
    
    private func highlightJSON(_ attributed: NSMutableAttributedString, text: String) {
        // Keys (light blue)
        let keyPattern = "\"([^\"]+)\"\\s*:"
        highlightPattern(attributed, pattern: keyPattern, color: VSCodeTheme.variable, text: text, captureGroup: 1)
        
        // String values (orange)
        highlightStrings(attributed, text: text)
        
        // Numbers (light green)
        highlightNumbers(attributed, text: text)
        
        // Booleans and null (blue)
        let constants = ["true", "false", "null"]
        highlightKeywords(attributed, keywords: constants, color: VSCodeTheme.constant, text: text)
    }
    
    // MARK: - Markdown Highlighting
    
    private func highlightMarkdown(_ attributed: NSMutableAttributedString, text: String) {
        // Headers (blue + bold)
        let headerPattern = "^#{1,6}\\s+.+$"
        highlightPattern(attributed, pattern: headerPattern, color: VSCodeTheme.tag, text: text, options: .anchorsMatchLines)
        
        // Bold (orange)
        let boldPattern = "\\*\\*[^*]+\\*\\*|__[^_]+__"
        highlightPattern(attributed, pattern: boldPattern, color: VSCodeTheme.string, text: text)
        
        // Italic
        let italicPattern = "(?<!\\*)\\*[^*]+\\*(?!\\*)|(?<!_)_[^_]+_(?!_)"
        highlightPattern(attributed, pattern: italicPattern, color: UIColor.secondaryLabel, text: text)
        
        // Code blocks (green)
        let codeBlockPattern = "```[\\s\\S]*?```|`[^`]+`"
        highlightPattern(attributed, pattern: codeBlockPattern, color: VSCodeTheme.comment, text: text)
        
        // Links (light blue)
        let linkPattern = "\\[[^\\]]+\\]\\([^)]+\\)"
        highlightPattern(attributed, pattern: linkPattern, color: VSCodeTheme.variable, text: text)
        
        // Lists
        let listPattern = "^\\s*[-*+]\\s"
        highlightPattern(attributed, pattern: listPattern, color: VSCodeTheme.keyword, text: text, options: .anchorsMatchLines)
    }
    
    // MARK: - Rust Highlighting
    
    private func highlightRust(_ attributed: NSMutableAttributedString, text: String) {
        let keywords = ["fn", "let", "mut", "const", "if", "else", "match", "loop", "while", "for",
                       "return", "struct", "enum", "impl", "trait", "type", "use", "mod", "pub",
                       "self", "Self", "super", "crate", "as", "in", "ref", "move", "async", "await",
                       "where", "unsafe", "extern", "dyn", "static", "break", "continue"]
        highlightKeywords(attributed, keywords: keywords, color: VSCodeTheme.keyword, text: text)
        
        let types = ["i8", "i16", "i32", "i64", "i128", "isize", "u8", "u16", "u32", "u64", "u128", "usize",
                    "f32", "f64", "bool", "char", "str", "String", "Vec", "Option", "Result", "Box"]
        highlightKeywords(attributed, keywords: types, color: VSCodeTheme.type, text: text)
        
        let constants = ["true", "false", "None", "Some", "Ok", "Err"]
        highlightKeywords(attributed, keywords: constants, color: VSCodeTheme.constant, text: text)
        
        // Macros (yellow)
        let macroPattern = "[a-zA-Z_][a-zA-Z0-9_]*!"
        highlightPattern(attributed, pattern: macroPattern, color: VSCodeTheme.function, text: text)
        
        // Lifetimes (orange)
        let lifetimePattern = "'[a-zA-Z_][a-zA-Z0-9_]*"
        highlightPattern(attributed, pattern: lifetimePattern, color: VSCodeTheme.string, text: text)
        
        highlightComments(attributed, text: text, singleLine: "//", multiLineStart: "/*", multiLineEnd: "*/")
        highlightStrings(attributed, text: text)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - Go Highlighting
    
    private func highlightGo(_ attributed: NSMutableAttributedString, text: String) {
        let keywords = ["func", "var", "const", "type", "struct", "interface", "map", "chan",
                       "if", "else", "for", "range", "switch", "case", "default", "select",
                       "return", "break", "continue", "goto", "fallthrough", "defer", "go",
                       "package", "import"]
        highlightKeywords(attributed, keywords: keywords, color: VSCodeTheme.keyword, text: text)
        
        let types = ["int", "int8", "int16", "int32", "int64", "uint", "uint8", "uint16", "uint32", "uint64",
                    "float32", "float64", "complex64", "complex128", "byte", "rune", "string", "bool", "error"]
        highlightKeywords(attributed, keywords: types, color: VSCodeTheme.type, text: text)
        
        let constants = ["true", "false", "nil", "iota"]
        highlightKeywords(attributed, keywords: constants, color: VSCodeTheme.constant, text: text)
        
        highlightComments(attributed, text: text, singleLine: "//", multiLineStart: "/*", multiLineEnd: "*/")
        highlightStrings(attributed, text: text)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - Java Highlighting
    
    private func highlightJava(_ attributed: NSMutableAttributedString, text: String) {
        let keywords = ["public", "private", "protected", "class", "interface", "extends", "implements",
                       "static", "final", "abstract", "native", "synchronized", "volatile", "transient",
                       "if", "else", "for", "while", "do", "switch", "case", "default", "break", "continue",
                       "return", "throw", "throws", "try", "catch", "finally", "new", "this", "super",
                       "import", "package", "instanceof", "assert", "enum", "void"]
        highlightKeywords(attributed, keywords: keywords, color: VSCodeTheme.keyword, text: text)
        
        let types = ["int", "long", "short", "byte", "float", "double", "char", "boolean",
                    "String", "Integer", "Long", "Double", "Boolean", "Object", "List", "Map", "Set"]
        highlightKeywords(attributed, keywords: types, color: VSCodeTheme.type, text: text)
        
        let constants = ["true", "false", "null"]
        highlightKeywords(attributed, keywords: constants, color: VSCodeTheme.constant, text: text)
        
        // Annotations
        let annotationPattern = "@[a-zA-Z][a-zA-Z0-9]*"
        highlightPattern(attributed, pattern: annotationPattern, color: VSCodeTheme.decorator, text: text)
        
        highlightComments(attributed, text: text, singleLine: "//", multiLineStart: "/*", multiLineEnd: "*/")
        highlightStrings(attributed, text: text)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - C/C++ Highlighting
    
    private func highlightCpp(_ attributed: NSMutableAttributedString, text: String) {
        let keywords = ["auto", "break", "case", "catch", "class", "const", "continue", "default",
                       "delete", "do", "else", "enum", "explicit", "extern", "for", "friend", "goto",
                       "if", "inline", "mutable", "namespace", "new", "operator", "private", "protected",
                       "public", "register", "return", "sizeof", "static", "struct", "switch", "template",
                       "this", "throw", "try", "typedef", "typename", "union", "using", "virtual",
                       "volatile", "while", "constexpr", "nullptr", "override", "final", "noexcept"]
        highlightKeywords(attributed, keywords: keywords, color: VSCodeTheme.keyword, text: text)
        
        let types = ["void", "int", "long", "short", "char", "float", "double", "bool", "signed", "unsigned",
                    "int8_t", "int16_t", "int32_t", "int64_t", "uint8_t", "uint16_t", "uint32_t", "uint64_t",
                    "size_t", "string", "vector", "map", "set", "unique_ptr", "shared_ptr"]
        highlightKeywords(attributed, keywords: types, color: VSCodeTheme.type, text: text)
        
        let constants = ["true", "false", "NULL", "nullptr"]
        highlightKeywords(attributed, keywords: constants, color: VSCodeTheme.constant, text: text)
        
        // Preprocessor directives
        let preprocPattern = "^\\s*#\\s*(include|define|ifdef|ifndef|endif|if|else|elif|pragma|error|warning).*$"
        highlightPattern(attributed, pattern: preprocPattern, color: VSCodeTheme.keyword, text: text, options: .anchorsMatchLines)
        
        highlightComments(attributed, text: text, singleLine: "//", multiLineStart: "/*", multiLineEnd: "*/")
        highlightStrings(attributed, text: text)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - Ruby Highlighting
    
    private func highlightRuby(_ attributed: NSMutableAttributedString, text: String) {
        let keywords = ["def", "class", "module", "if", "elsif", "else", "unless", "case", "when",
                       "while", "until", "for", "do", "end", "begin", "rescue", "ensure", "raise",
                       "return", "yield", "break", "next", "redo", "retry", "self", "super",
                       "require", "require_relative", "include", "extend", "attr_reader", "attr_writer", "attr_accessor",
                       "public", "private", "protected", "alias", "and", "or", "not", "in"]
        highlightKeywords(attributed, keywords: keywords, color: VSCodeTheme.keyword, text: text)
        
        let constants = ["true", "false", "nil"]
        highlightKeywords(attributed, keywords: constants, color: VSCodeTheme.constant, text: text)
        
        // Symbols (orange)
        let symbolPattern = ":[a-zA-Z_][a-zA-Z0-9_]*"
        highlightPattern(attributed, pattern: symbolPattern, color: VSCodeTheme.string, text: text)
        
        // Instance variables (light blue)
        let ivarPattern = "@[a-zA-Z_][a-zA-Z0-9_]*"
        highlightPattern(attributed, pattern: ivarPattern, color: VSCodeTheme.variable, text: text)
        
        highlightComments(attributed, text: text, singleLine: "#", multiLineStart: "=begin", multiLineEnd: "=end")
        highlightStrings(attributed, text: text)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - PHP Highlighting
    
    private func highlightPHP(_ attributed: NSMutableAttributedString, text: String) {
        let keywords = ["function", "class", "interface", "trait", "extends", "implements", "use",
                       "public", "private", "protected", "static", "final", "abstract", "const",
                       "if", "else", "elseif", "switch", "case", "default", "for", "foreach", "while", "do",
                       "return", "break", "continue", "throw", "try", "catch", "finally",
                       "new", "clone", "instanceof", "echo", "print", "die", "exit",
                       "require", "require_once", "include", "include_once", "namespace"]
        highlightKeywords(attributed, keywords: keywords, color: VSCodeTheme.keyword, text: text)
        
        let constants = ["true", "false", "null", "TRUE", "FALSE", "NULL"]
        highlightKeywords(attributed, keywords: constants, color: VSCodeTheme.constant, text: text)
        
        // Variables (light blue)
        let varPattern = "\\$[a-zA-Z_][a-zA-Z0-9_]*"
        highlightPattern(attributed, pattern: varPattern, color: VSCodeTheme.variable, text: text)
        
        highlightComments(attributed, text: text, singleLine: "//", multiLineStart: "/*", multiLineEnd: "*/")
        highlightStrings(attributed, text: text)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - Shell Highlighting
    
    private func highlightShell(_ attributed: NSMutableAttributedString, text: String) {
        let keywords = ["if", "then", "else", "elif", "fi", "for", "while", "do", "done", "case", "esac",
                       "function", "return", "exit", "break", "continue", "local", "export", "readonly",
                       "source", "alias", "unalias", "set", "unset", "shift", "eval", "exec",
                       "echo", "printf", "read", "cd", "pwd", "ls", "mkdir", "rm", "cp", "mv"]
        highlightKeywords(attributed, keywords: keywords, color: VSCodeTheme.keyword, text: text)
        
        // Variables (light blue)
        let varPattern = "\\$[a-zA-Z_][a-zA-Z0-9_]*|\\$\\{[^}]+\\}"
        highlightPattern(attributed, pattern: varPattern, color: VSCodeTheme.variable, text: text)
        
        highlightComments(attributed, text: text, singleLine: "#", multiLineStart: nil, multiLineEnd: nil)
        highlightStrings(attributed, text: text)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - YAML Highlighting
    
    private func highlightYAML(_ attributed: NSMutableAttributedString, text: String) {
        // Keys (light blue)
        let keyPattern = "^\\s*([a-zA-Z_][a-zA-Z0-9_-]*)\\s*:"
        highlightPattern(attributed, pattern: keyPattern, color: VSCodeTheme.variable, text: text, options: .anchorsMatchLines, captureGroup: 1)
        
        // Booleans and null
        let constants = ["true", "false", "yes", "no", "on", "off", "null", "~"]
        highlightKeywords(attributed, keywords: constants, color: VSCodeTheme.constant, text: text)
        
        highlightComments(attributed, text: text, singleLine: "#", multiLineStart: nil, multiLineEnd: nil)
        highlightStrings(attributed, text: text)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - SQL Highlighting
    
    private func highlightSQL(_ attributed: NSMutableAttributedString, text: String) {
        let keywords = ["SELECT", "FROM", "WHERE", "AND", "OR", "NOT", "IN", "LIKE", "BETWEEN",
                       "INSERT", "INTO", "VALUES", "UPDATE", "SET", "DELETE", "CREATE", "ALTER", "DROP",
                       "TABLE", "INDEX", "VIEW", "DATABASE", "SCHEMA", "PRIMARY", "KEY", "FOREIGN", "REFERENCES",
                       "JOIN", "INNER", "LEFT", "RIGHT", "OUTER", "FULL", "ON", "AS", "DISTINCT",
                       "ORDER", "BY", "ASC", "DESC", "GROUP", "HAVING", "LIMIT", "OFFSET", "UNION",
                       "NULL", "IS", "TRUE", "FALSE", "CASE", "WHEN", "THEN", "ELSE", "END",
                       "COUNT", "SUM", "AVG", "MIN", "MAX", "COALESCE", "CAST",
                       "select", "from", "where", "and", "or", "not", "in", "like", "between",
                       "insert", "into", "values", "update", "set", "delete", "create", "alter", "drop",
                       "table", "index", "view", "database", "schema", "primary", "key", "foreign", "references",
                       "join", "inner", "left", "right", "outer", "full", "on", "as", "distinct",
                       "order", "by", "asc", "desc", "group", "having", "limit", "offset", "union",
                       "null", "is", "true", "false", "case", "when", "then", "else", "end"]
        highlightKeywords(attributed, keywords: keywords, color: VSCodeTheme.keyword, text: text)
        
        let types = ["INT", "INTEGER", "BIGINT", "SMALLINT", "TINYINT", "FLOAT", "DOUBLE", "DECIMAL",
                    "VARCHAR", "CHAR", "TEXT", "BLOB", "DATE", "TIME", "DATETIME", "TIMESTAMP", "BOOLEAN",
                    "int", "integer", "bigint", "smallint", "tinyint", "float", "double", "decimal",
                    "varchar", "char", "text", "blob", "date", "time", "datetime", "timestamp", "boolean"]
        highlightKeywords(attributed, keywords: types, color: VSCodeTheme.type, text: text)
        
        highlightComments(attributed, text: text, singleLine: "--", multiLineStart: "/*", multiLineEnd: "*/")
        highlightStrings(attributed, text: text)
        highlightNumbers(attributed, text: text)
    }
    
    // MARK: - Helper Methods
    
    private func highlightKeywords(_ attributed: NSMutableAttributedString, keywords: [String], color: UIColor, text: String) {
        for keyword in keywords {
            let pattern = "\\b\(NSRegularExpression.escapedPattern(for: keyword))\\b"
            highlightPattern(attributed, pattern: pattern, color: color, text: text)
        }
    }
    
    private func highlightPattern(_ attributed: NSMutableAttributedString, pattern: String, color: UIColor, text: String, options: NSRegularExpression.Options = [], captureGroup: Int = 0) {
        guard let regex = try? NSRegularExpression(pattern: pattern, options: options) else { return }
        let range = NSRange(location: 0, length: text.utf16.count)
        
        regex.enumerateMatches(in: text, options: [], range: range) { match, _, _ in
            guard let match = match else { return }
            let matchRange = captureGroup > 0 && match.numberOfRanges > captureGroup
                ? match.range(at: captureGroup)
                : match.range
            if matchRange.location != NSNotFound {
                attributed.addAttribute(.foregroundColor, value: color, range: matchRange)
            }
        }
    }
    
    private func highlightStrings(_ attributed: NSMutableAttributedString, text: String) {
        // Double-quoted strings
        let doublePattern = "\"(?:[^\"\\\\]|\\\\.)*\""
        highlightPattern(attributed, pattern: doublePattern, color: VSCodeTheme.string, text: text)
        
        // Single-quoted strings
        let singlePattern = "'(?:[^'\\\\]|\\\\.)*'"
        highlightPattern(attributed, pattern: singlePattern, color: VSCodeTheme.string, text: text)
    }
    
    private func highlightPythonStrings(_ attributed: NSMutableAttributedString, text: String) {
        // Triple-quoted strings first
        let tripleDoublePattern = "\"\"\"[\\s\\S]*?\"\"\""
        highlightPattern(attributed, pattern: tripleDoublePattern, color: VSCodeTheme.string, text: text)
        
        let tripleSinglePattern = "'''[\\s\\S]*?'''"
        highlightPattern(attributed, pattern: tripleSinglePattern, color: VSCodeTheme.string, text: text)
        
        // Then regular strings
        highlightStrings(attributed, text: text)
        
        // F-strings (with expressions highlighted differently)
        let fstringPattern = "f\"[^\"]*\"|f'[^']*'"
        highlightPattern(attributed, pattern: fstringPattern, color: VSCodeTheme.string, text: text)
    }
    
    private func highlightJSTemplateLiterals(_ attributed: NSMutableAttributedString, text: String) {
        // Template literals
        let templatePattern = "`[^`]*`"
        highlightPattern(attributed, pattern: templatePattern, color: VSCodeTheme.string, text: text)
    }
    
    private func highlightComments(_ attributed: NSMutableAttributedString, text: String, singleLine: String?, multiLineStart: String?, multiLineEnd: String?) {
        // Single-line comments
        if let single = singleLine {
            let pattern = "\(NSRegularExpression.escapedPattern(for: single)).*$"
            highlightPattern(attributed, pattern: pattern, color: VSCodeTheme.comment, text: text, options: .anchorsMatchLines)
        }
        
        // Multi-line comments
        if let start = multiLineStart, let end = multiLineEnd {
            let pattern = "\(NSRegularExpression.escapedPattern(for: start))[\\s\\S]*?\(NSRegularExpression.escapedPattern(for: end))"
            highlightPattern(attributed, pattern: pattern, color: VSCodeTheme.comment, text: text)
        }
    }
    
    private func highlightHTMLComments(_ attributed: NSMutableAttributedString, text: String) {
        let pattern = "<!--[\\s\\S]*?-->"
        highlightPattern(attributed, pattern: pattern, color: VSCodeTheme.comment, text: text)
    }
    
    private func highlightNumbers(_ attributed: NSMutableAttributedString, text: String) {
        // Hex numbers
        let hexPattern = "\\b0[xX][0-9a-fA-F]+\\b"
        highlightPattern(attributed, pattern: hexPattern, color: VSCodeTheme.number, text: text)
        
        // Binary numbers
        let binPattern = "\\b0[bB][01]+\\b"
        highlightPattern(attributed, pattern: binPattern, color: VSCodeTheme.number, text: text)
        
        // Octal numbers
        let octPattern = "\\b0[oO][0-7]+\\b"
        highlightPattern(attributed, pattern: octPattern, color: VSCodeTheme.number, text: text)
        
        // Decimal numbers (including floats and scientific notation)
        let decPattern = "\\b\\d+\\.?\\d*([eE][+-]?\\d+)?\\b"
        highlightPattern(attributed, pattern: decPattern, color: VSCodeTheme.number, text: text)
    }
}
